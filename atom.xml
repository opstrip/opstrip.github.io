<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>石尧的博客</title>
  <subtitle>精通原创，擅长盗版</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://opstrip.com/"/>
  <updated>2017-11-27T10:00:30.442Z</updated>
  <id>https://opstrip.com/</id>
  
  <author>
    <name>Jeff</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Linux Bash使用小技巧</title>
    <link href="https://opstrip.com/2017/11/27/Linux-Shell-Bash-Tips/"/>
    <id>https://opstrip.com/2017/11/27/Linux-Shell-Bash-Tips/</id>
    <published>2017-11-27T09:43:30.000Z</published>
    <updated>2017-11-27T10:00:30.442Z</updated>
    
    <content type="html"><![CDATA[<p>在bash中检查远程端口是否打开:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &gt;/dev/tcp/8.8.8.8/53 &amp;&amp; echo "open"</div></pre></td></tr></table></figure></p>
<p>将进程挂起:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl + z</div></pre></td></tr></table></figure></p>
<p>将进程移到前台:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fg</div></pre></td></tr></table></figure></p>
<p>（译注，挂起的进程是不执行的，如果希望在后台执行，可以使用<code>bg</code>命令，并且指定通过<code>jobs</code>命令获得的任务号。）</p>
<p>生成随机16进制数字,n是字符的数量:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl rand -hex n</div></pre></td></tr></table></figure></p>
<p>在当前shell中执行一个文件中的命令（译注：这个文件不是一个bash脚本，比如.bashrc、bash_profile等）:</p>
<a id="more"></a>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source /home/user/file.name</div></pre></td></tr></table></figure>
<p>提取字符串的前5个字符:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash">&#123;variable:0:5&#125;</span></div></pre></td></tr></table></figure></p>
<p>打开SSH调试模式（译注：当你遇到SSH连接问题时很有用）:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh -vvv user@ip_address</div></pre></td></tr></table></figure></p>
<p>使用pem key的进行SSH连接：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh user@ip_address -i key.pem</div></pre></td></tr></table></figure></p>
<p>用wget获取完整目录列表到本地目录:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -r --no-parent --reject "index.html*" http://hostname/ -P /home/user/dirs</div></pre></td></tr></table></figure></p>
<p>同时创建多个目录:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p /home/user/&#123;test,test1,test2&#125;</div></pre></td></tr></table></figure></p>
<p>以树状列出进程及子进程:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps axwef</div></pre></td></tr></table></figure></p>
<p>创建war文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jar -cvf name.war file</div></pre></td></tr></table></figure></p>
<p>测试磁盘写速度:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dd if=/dev/zero of=/tmp/output.img bs=8k count=256k conv=fdatasync; rm -rf /tmp/output.img</div></pre></td></tr></table></figure></p>
<p>测试磁盘读速度:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hdparm -Tt /dev/sda</div></pre></td></tr></table></figure></p>
<p>获取文本的md5值:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo -n "text" | md5sum</div></pre></td></tr></table></figure></p>
<p>检测xml语法:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xmllint --noout file.xml</div></pre></td></tr></table></figure></p>
<p>将tar.gz文件解压到指定目录:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar zxvf package.tar.gz -C new_dir</div></pre></td></tr></table></figure></p>
<p>用curl获取HTTP头:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -I http://www.example.com</div></pre></td></tr></table></figure></p>
<p>修改一些文件或目录的时间戳 (格式为：YYMMDDhhmm):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">touch -t 0712250000 file</div></pre></td></tr></table></figure></p>
<p>使用wget从ftp下载:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -m ftp://username:password@hostname</div></pre></td></tr></table></figure></p>
<p>生成随机密码 (本例中16位字符长):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LANG=c &lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c$&#123;1:-16&#125;;echo;</div></pre></td></tr></table></figure></p>
<p>快速创建一个文件的备份（扩展名是.bkp）:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp some_file_name&#123;,.bkp&#125;</div></pre></td></tr></table></figure></p>
<p>访问Windows共享:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">smbclient -U "DOMAINuser" //dc.domain.com/share/test/dir</div></pre></td></tr></table></figure></p>
<p>运行history中的命令 (这里在history中的第100个):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!100</div></pre></td></tr></table></figure></p>
<p>unzip到目录中:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unzip package_name.zip -d dir_name</div></pre></td></tr></table></figure></p>
<p>输入多行文字 (按 CTRL + d 退出):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat &gt; test.txt</div></pre></td></tr></table></figure></p>
<p>创建空白的文件或者清空已存在的文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;</span><span class="bash"> test.txt</span></div></pre></td></tr></table></figure></p>
<p>从Ubuntu NTP服务器上更新日期:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ntpdate ntp.ubuntu.com</div></pre></td></tr></table></figure></p>
<p>netstat 显示所有IPv4的TCP监听的端口:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -lnt4 | awk '&#123;print $4&#125;' | cut -f2 -d: | grep -o '[0-9]*'</div></pre></td></tr></table></figure></p>
<p>将qcow2的镜像转化成raw格式:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">qemu-img convert -f qcow2 -O raw precise-server-cloudimg-amd64-disk1.img \</div><div class="line">                                 precise-server-cloudimg-amd64-disk1.raw</div></pre></td></tr></table></figure></p>
<p>重复运行命令并显示它的输出 (默认2秒重复一次):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">watch ps -ef</div></pre></td></tr></table></figure></p>
<p>显示所有用户:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">getent passwd</div></pre></td></tr></table></figure></p>
<p>以读写模式挂载根文件系统:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -o remount,rw /</div></pre></td></tr></table></figure></p>
<p>挂载目录 (适合于符号链接不能工作的情况下):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount --bind /source /destination</div></pre></td></tr></table></figure></p>
<p>发送DNS动态更新给DNS:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nsupdate &lt;</div></pre></td></tr></table></figure></p>
<p>递归grep所有目录<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -r "some_text" /path/to/dir</div></pre></td></tr></table></figure></p>
<p>列出10个最大的系统中已打开的文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsof / | awk '&#123; if($7 &gt; 1048576) print $7/1048576 "MB "$9 &#125;' | sort -n -u | tail</div></pre></td></tr></table></figure></p>
<p>以MB显示空余内存:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">free -m | grep cache | awk '/[0-9]/&#123; print $4" MB" &#125;'</div></pre></td></tr></table></figure></p>
<p>打开vim并跳转到文件最后:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim + some_file_name</div></pre></td></tr></table></figure></p>
<p>git clone特定branch (本例是master分支):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone git@github.com:name/app.git -b master</div></pre></td></tr></table></figure></p>
<p>git切换到另外一个branch (本例是develop分支):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git checkout develop</div></pre></td></tr></table></figure></p>
<p>git删除一个branch(本例是myfeature):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git branch -d myfeature</div></pre></td></tr></table></figure></p>
<p>Git删除一个远程branch:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push origin :branchName</div></pre></td></tr></table></figure></p>
<p>Git push 新的branch到远程:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git push -u origin mynewfeature</div></pre></td></tr></table></figure></p>
<p>打印history中最后的cat命令<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!cat:p</div></pre></td></tr></table></figure></p>
<p>运行history中的最后的cat命令:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!cat</div></pre></td></tr></table></figure></p>
<p>找出在/home/user中的所有空子目录:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find /home/user -maxdepth 1 -type d -empty</div></pre></td></tr></table></figure></p>
<p>得到test.txt中50到60行的文本:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt; test.txt sed -n '50,60p'</div></pre></td></tr></table></figure></p>
<p>以sudo权限重新运行上一个执行的命令 (如果是: mkdir /root/test, 下面会运行: sudo mkdir /root/test)（译注：当你执行一个命令忘记sudo时，可以这样重新执行，而不必再把完整命令敲一遍）:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo !!</div></pre></td></tr></table></figure></p>
<p>创建临时RAM文件系统 – ramdisk (请先创建 /tmpram 目录):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mount -t tmpfs tmpfs /tmpram -o size=512m</div></pre></td></tr></table></figure></p>
<p>Grep完整的单词（译注：而不是其它单词的一部分）:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -w "name" test.txt</div></pre></td></tr></table></figure></p>
<p>提升权限后在一个文件后追加文本:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo "some text" | sudo tee -a /path/file</div></pre></td></tr></table></figure></p>
<p>列出所有支持的kill信号:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -l</div></pre></td></tr></table></figure></p>
<p>生成随机密码 (本例中16个字符长):<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl rand -base64 16</div></pre></td></tr></table></figure></p>
<p>在bash历史中不记录最后的会话:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -9 $$</div></pre></td></tr></table></figure></p>
<p>扫描网络来找出开放的端口:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nmap -p 8081 172.20.0.0/16</div></pre></td></tr></table></figure></p>
<p>设置git email:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git config --global user.email "me@example.com"</div></pre></td></tr></table></figure></p>
<p>如果你有未提交的commit，与master同步:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git pull --rebase origin master</div></pre></td></tr></table></figure></p>
<p>将文件名中含有txt的所有文件移动到/home/user:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find -iname "*txt*" -exec mv -v &#123;&#125; /home/user \;</div></pre></td></tr></table></figure></p>
<p>按行将两个文件中的对应行合并显示:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">paste test.txt test1.txt</div></pre></td></tr></table></figure></p>
<p>shell中的进度条:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pv data.log</div></pre></td></tr></table></figure></p>
<p>用netcat发送数据给服务器:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo "hosts.sampleHost 10 `date +%s`" | nc 192.168.200.2 3000</div></pre></td></tr></table></figure></p>
<p>转换tab为空格:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">expand test.txt &gt; test1.txt</div></pre></td></tr></table></figure></p>
<p>跳过bash历史:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;&lt;空格&gt;&gt;cmd</div></pre></td></tr></table></figure></p>
<p>回到之前的工作目录:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd -</div></pre></td></tr></table></figure></p>
<p>切割大的tar.gz文件为几个文件 (每个100MB)，并还原:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">split –b 100m /path/to/large/archive /path/to/output/files</div><div class="line">cat files* &gt; archive</div></pre></td></tr></table></figure></p>
<p>用curl获取HTTP状态值:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -sL -w "%&#123;http_code&#125;\n" www.example.com -o /dev/null</div></pre></td></tr></table></figure></p>
<p>当 Ctrl + c 没用时:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Ctrl + \</div></pre></td></tr></table></figure></p>
<p>获取文件所有者:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stat -c %U file.txt</div></pre></td></tr></table></figure></p>
<p>列出块设备:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsblk -f</div></pre></td></tr></table></figure></p>
<p>找出文件中带有末尾空格的文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find . -type f -exec egrep -l " +$" "&#123;&#125;" \;</div></pre></td></tr></table></figure></p>
<p>找出用tab缩进的文件:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find . -type f -exec egrep -l $'t' "&#123;&#125;" \;</div></pre></td></tr></table></figure></p>
<p>用”=”打印水平行<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">printf '%100sn' | tr ' ' =</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      nginx的模拟文件处理与图片特效。
    
    </summary>
    
      <category term="Shell" scheme="https://opstrip.com/categories/Shell/"/>
    
      <category term="Bash" scheme="https://opstrip.com/categories/Shell/Bash/"/>
    
      <category term="小技巧" scheme="https://opstrip.com/categories/Shell/Bash/%E5%B0%8F%E6%8A%80%E5%B7%A7/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/categories/Shell/Bash/%E5%B0%8F%E6%8A%80%E5%B7%A7/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
    
      <category term="Linux" scheme="https://opstrip.com/tags/Linux/"/>
    
      <category term="Shell" scheme="https://opstrip.com/tags/Shell/"/>
    
      <category term="Bash" scheme="https://opstrip.com/tags/Bash/"/>
    
      <category term="小技巧" scheme="https://opstrip.com/tags/%E5%B0%8F%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix：企业微信告警配置</title>
    <link href="https://opstrip.com/2017/11/02/Zabbix-Warning-for-qiyeWeChat/"/>
    <id>https://opstrip.com/2017/11/02/Zabbix-Warning-for-qiyeWeChat/</id>
    <published>2017-11-02T09:02:16.000Z</published>
    <updated>2017-11-03T06:27:56.661Z</updated>
    
    <content type="html"><![CDATA[<p>Zabbix可以通过多种方式把告警信息发送到指定人，常用的有邮件，短信报警方式，但是越来越多的企业开始使用zabbix结合微信作为主要的告警方式，这样可以及时有效的把告警信息推送到接收人，方便告警的及时处理。</p>
<h2 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h2><h3 id="准备事项"><a href="#准备事项" class="headerlink" title="准备事项"></a>准备事项</h3><ul>
<li>微信企业号 </li>
<li>企业号已经被部门成员关注 </li>
<li>企业号有一个可以发送消息的应用，一个授权管理员，可以使用应用给成员发送消息</li>
</ul>
<h3 id="需要得到的信息"><a href="#需要得到的信息" class="headerlink" title="需要得到的信息"></a>需要得到的信息</h3><ul>
<li><code>CorpID</code>和<code>Secret</code>、<code>AgentId</code></li>
<li>记录用户的账号</li>
</ul>
<h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><a id="more"></a>
<p>解释下上面的几个条件。添加一个可以发送消息的应用，就可以给组织中的所有成员发送消息；如果没有权限可以联系企业微信管理员帮忙添加。这里使用的是<code>警报通知</code>。添加应用过程如下：</p>
<h4 id="点击企业应用，新增应用"><a href="#点击企业应用，新增应用" class="headerlink" title="点击企业应用，新增应用"></a>点击<code>企业应用</code>，<code>新增应用</code></h4><p><img src="/assets/blogImg/zabbix-1.png" alt="新增应用"></p>
<h4 id="设置应用"><a href="#设置应用" class="headerlink" title="设置应用"></a>设置应用</h4><p><img src="/assets/blogImg/zabbix-2.png" alt="设置应用"></p>
<h4 id="同样也可以在微信插件里面二维码邀请关注加入通讯录"><a href="#同样也可以在微信插件里面二维码邀请关注加入通讯录" class="headerlink" title="同样也可以在微信插件里面二维码邀请关注加入通讯录"></a>同样也可以在微信插件里面二维码邀请关注加入<code>通讯录</code></h4><p><img src="/assets/blogImg/zabbix-3.png" alt="二维码邀请加入"></p>
<h4 id="创建完成后记录下AgentID及Secret"><a href="#创建完成后记录下AgentID及Secret" class="headerlink" title="创建完成后记录下AgentID及Secret"></a>创建完成后记录下<code>AgentID</code>及<code>Secret</code></h4><p><img src="/assets/blogImg/zabbix-4.png" alt="创建完成"></p>
<h4 id="获取CorpID"><a href="#获取CorpID" class="headerlink" title="获取CorpID"></a><code>获取CorpID</code></h4><p>在<code>我的企业</code>→<code>企业信息</code>里<br><img src="/assets/blogImg/zabbix-5.png" alt="获取CorpID"></p>
<h4 id="获取用户账号"><a href="#获取用户账号" class="headerlink" title="获取用户账号"></a>获取<code>用户账号</code></h4><p>像某位用户发送告警需要知道该用户的账号，可在通讯录中查找。若没有权限，请向您的企业微信管理员查询。<br>打开<code>通讯录</code>，查看<code>成员列表</code><br><img src="/assets/blogImg/zabbix-6.png" alt="通讯录与成员列表"><br>单击成员以查看<code>成员详情</code><br><img src="/assets/blogImg/zabbix-7.png" alt="成员详情"></p>
<font color="gray" size="-2">注：以上图片来自<a href="http://blog.csdn.net/abcdocker/article/details/73295133" target="_blank" rel="external">网络</a>。</font>

<h2 id="配置前的准备"><a href="#配置前的准备" class="headerlink" title="配置前的准备"></a>配置前的准备</h2><h3 id="获取Zabbix脚本路径"><a href="#获取Zabbix脚本路径" class="headerlink" title="获取Zabbix脚本路径"></a>获取Zabbix脚本路径</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com ~]# grep -i alertscripts /etc/zabbix/zabbix_server.conf </div><div class="line">AlertScriptsPath=/usr/lib/zabbix/alertscripts</div></pre></td></tr></table></figure>
<p>我们设置zabbix默认脚本路径，这样在web端就可以获取到脚本</p>
<h3 id="获取告警脚本"><a href="#获取告警脚本" class="headerlink" title="获取告警脚本"></a>获取告警脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com alertscripts]# cd /usr/lib/zabbix/alertscripts</div><div class="line">[root@opstrip.com alertscripts]# wget http://download.zhsir.org/Zabbix/weixin_linux_amd64</div><div class="line">[root@opstrip.com alertscripts]# mv weixin_linux_amd64 wechat</div><div class="line">[root@opstrip.com alertscripts]# chmod 755 wechat </div><div class="line">[root@opstrip.com alertscripts]# chown zabbix:zabbix wechat</div></pre></td></tr></table></figure>
<h3 id="运行脚本进行测试"><a href="#运行脚本进行测试" class="headerlink" title="运行脚本进行测试"></a>运行脚本进行测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com alertscripts]# ./wechat --corpid=wwcxxxxxxxxxxxxxxxx  --corpsecret=Q-HMnIo9HKX8kZwbT4m1SUcS-kmYhmiuRgr4DCLreQA   --msg=&quot;您好,告警测试&quot; --user=testUser --agentid=1000002   </div><div class="line">&#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;,&quot;invaliduser&quot;:&quot;&quot;&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>提示：<br>  --corpid= 我们企业里面的id<br>  --corpsecret=这里就是我们Secret里面的id<br>  --msg=内容<br>  --user=用来接收告警的企业微信账号</p>
</blockquote>
<p>因为脚本是编译过的，无法进行编辑，我们可以使用./wechat -h or –help 查看</p>
<p>测试效果如下图：<br><img src="/assets/blogImg/zabbix-8.png" alt="告警测试效果"></p>
<h2 id="在Zabbix中启用企业微信告警"><a href="#在Zabbix中启用企业微信告警" class="headerlink" title="在Zabbix中启用企业微信告警"></a>在Zabbix中启用企业微信告警</h2><h3 id="创建报警媒介"><a href="#创建报警媒介" class="headerlink" title="创建报警媒介"></a>创建报警媒介</h3><p>依次在Zabbix打开<code>管理</code>→<code>报警媒介类型</code>→<code>创建媒体类型</code>以创建企业微信告警：<br><img src="/assets/blogImg/zabbix-9.png" alt="创建媒体类型"><br>添加企业微信告警：<br><img src="/assets/blogImg/zabbix-10.png" alt="企业微信告警"></p>
<blockquote>
<p>说明：<br>  --corpid=我们企业里面的id，这里是wwcxxxxxxxxxxxxxxxx<br>  --corpsecret=我们Secret里面的id，这里是Q-HMnIo9HKX8kZwbT4m1SUcS-kmYhmiuRgr4DCLreQA<br>  --agentid=Agentld ID，这里是1000002<br>  --user={ALERT.SENDTO}，发送给谁，创建动作时提供<br>  --msg={ALERT.MESSAGE}，发送的信息，由触发器提供</p>
</blockquote>
<h3 id="添加动作"><a href="#添加动作" class="headerlink" title="添加动作"></a>添加动作</h3><p>假定您已完成好Zabbix其他的前期工作，如<code>用户的创建</code>、<code>告警添加</code>、<code>触发器创建</code>等。<br>正常添加动作规则及触发器条件，在操作选项卡里添加以下规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">【告警】 &#123;TRIGGER.NAME&#125; </div><div class="line">    </div><div class="line">告警主机：&#123;HOST.NAME&#125;</div><div class="line">主机IP：  &#123;HOST.IP&#125;</div><div class="line">告警时间：&#123;EVENT.DATE&#125;  &#123;EVENT.TIME&#125;</div><div class="line">告警等级：&#123;TRIGGER.SEVERITY&#125;</div><div class="line">告警信息：&#123;TRIGGER.NAME&#125;</div><div class="line">问题详情：&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;</div><div class="line">事件ID：  &#123;EVENT.ID&#125;</div><div class="line">触发器URL： &#123;TRIGGER.URL&#125;</div><div class="line">    </div><div class="line">Item values:</div><div class="line">    </div><div class="line">1. &#123;ITEM.NAME1&#125; (&#123;HOST.NAME1&#125;:&#123;ITEM.KEY1&#125;): &#123;ITEM.VALUE1&#125;</div><div class="line">2. &#123;ITEM.NAME2&#125; (&#123;HOST.NAME2&#125;:&#123;ITEM.KEY2&#125;): &#123;ITEM.VALUE2&#125;</div><div class="line">3. &#123;ITEM.NAME3&#125; (&#123;HOST.NAME3&#125;:&#123;ITEM.KEY3&#125;): &#123;ITEM.VALUE3&#125;</div></pre></td></tr></table></figure></p>
<p>在<code>操作</code>项中作如下配置：<br><img src="/assets/blogImg/zabbix-11.png" alt="企业微信告警"><br><code>恢复操作</code>及<code>确认操作</code>类似。</p>
<h2 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h2><p>停掉zabbix-agent进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com ~]# systemctl stop zabbix-agent</div></pre></td></tr></table></figure></p>
<p>大概5分钟后，报警如下<br><img src="/assets/blogImg/zabbix-12.png" alt="Zabbix测试告警"><br>打开微信，看到<code>警报通知</code>已经有收到告警了<br><img src="/assets/blogImg/zabbix-13.png" alt="企业微信测试告警"></p>
<p>至此，企业微信告警配置完成。</p>
]]></content>
    
    <summary type="html">
    
      Zabbix可以通过多种方式把告警信息发送到指定人，常用的有邮件，短信报警方式，但是越来越多的企业开始使用zabbix结合微信作为主要的告警方式，这样可以及时有效的把告警信息推送到接收人，方便告警的及时处理。
    
    </summary>
    
      <category term="技术分享" scheme="https://opstrip.com/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
      <category term="zabbix" scheme="https://opstrip.com/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/%E5%A4%87%E5%BF%98%E5%BD%95/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://opstrip.com/tags/zabbix/"/>
    
      <category term="WeChat" scheme="https://opstrip.com/tags/WeChat/"/>
    
      <category term="告警配置" scheme="https://opstrip.com/tags/%E5%91%8A%E8%AD%A6%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>一些nginx配置小技巧</title>
    <link href="https://opstrip.com/2017/08/10/some-nginx-configuration-tips/"/>
    <id>https://opstrip.com/2017/08/10/some-nginx-configuration-tips/</id>
    <published>2017-08-10T08:50:29.000Z</published>
    <updated>2017-11-27T09:54:57.166Z</updated>
    
    <content type="html"><![CDATA[<h2 id="nginx文件处理"><a href="#nginx文件处理" class="headerlink" title="nginx文件处理"></a>nginx文件处理</h2><p>有些时候需要在网站中创建一些文本文件已实现某些功能，如当前获取免费SSL证书的文件验证，又不想在网站新建文件，这时候可以配置nginx返回text/plain格式文本以达到直接访问文件的效果。如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="string">server</span> <span class="string">&#123;</span></div><div class="line">    <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></div><div class="line">    <span class="string">server_name</span> <span class="string">www.example.com;</span></div><div class="line">    <span class="string">access_log</span> <span class="string">/var/log/nginx/www-example-com.log</span> <span class="string">access;</span></div><div class="line">    <span class="string">root</span> <span class="string">/etc/nginx/html;</span></div><div class="line">    </div><div class="line">    <span class="string">......</span></div><div class="line">    </div><div class="line">    <span class="comment">#Aliyun ssl by txt</span></div><div class="line">    <span class="string">location</span> <span class="string">=</span> <span class="string">/.well-known/pki-validation/fileauth.txt</span></div><div class="line">    <span class="string">&#123;</span></div><div class="line">        <span class="string">default_type</span> <span class="string">text/plain;</span></div><div class="line">        <span class="string">return</span> <span class="number">200</span> <span class="string">'201708090000005cpmpl49g1psxj1r86w70mmpi27g61r4f7u2bthwedki0trwtx'</span><span class="string">;</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line">    </div><div class="line">    <span class="string">......</span></div><div class="line">    </div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
<p>访问效果如下：</p>
<a id="more"></a>
<p><img src="/assets/blogImg/nginx-text.png" alt="访问文件效果"></p>
<h2 id="nginx图片处理"><a href="#nginx图片处理" class="headerlink" title="nginx图片处理"></a>nginx图片处理</h2><p>ngxin有很多有一堆的module，当业务量不大服务器的负载较低时，可以简单的用<code>ngxin</code>的<code>Image Filter</code>作为图片缩放、剪裁、旋转等处理的工具。 </p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p><code>image filter</code>依赖<code>libgd2</code>，所以需要先安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install gd gd-devel</div></pre></td></tr></table></figure>
<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><p><code>nginx</code>的<code>module</code>是<code>静态加载</code>的，必须编译到nginx的主文件里面。图片处理需要安装<code>nginx-mod-http-image-filter</code>模块。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install nginx nginx-mod-http-image-filter nginx-all-modules</div></pre></td></tr></table></figure>
<h3 id="配置image-filter"><a href="#配置image-filter" class="headerlink" title="配置image filter"></a>配置image filter</h3><p>网上有很多利用<code>image filter</code>做图片缩放的配置，下面是我写的一个配置（部分代码），比较简陋，另外，目前的问题是jpeg的图片质量参数无法生效，还在找原因。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="string">set</span> <span class="string">$width</span>    <span class="string">"-"</span><span class="string">;</span></div><div class="line"><span class="string">set</span> <span class="string">$height</span>   <span class="string">"-"</span><span class="string">;</span></div><div class="line">    </div><div class="line"><span class="string">if</span> <span class="string">(</span> <span class="string">$arg_w</span> <span class="string">!=</span> <span class="string">""</span> <span class="string">)&#123;</span></div><div class="line">  <span class="string">set</span> <span class="string">$width</span> <span class="string">$arg_w;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line">    </div><div class="line"><span class="string">if</span> <span class="string">(</span> <span class="string">$arg_h</span> <span class="string">!=</span> <span class="string">""</span> <span class="string">)&#123;</span></div><div class="line">  <span class="string">set</span> <span class="string">$height</span> <span class="string">$arg_h;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line">    </div><div class="line"><span class="string">set</span> <span class="string">$rotate</span> <span class="string">"-"</span><span class="string">;</span></div><div class="line">    </div><div class="line"><span class="string">if</span> <span class="string">(</span> <span class="string">$arg_r</span> <span class="string">!=</span> <span class="string">""</span> <span class="string">)&#123;</span></div><div class="line">  <span class="string">set</span> <span class="string">$rotate</span> <span class="string">$arg_r;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line">    </div><div class="line"><span class="string">set</span> <span class="string">$quality</span> <span class="string">"-"</span><span class="string">;</span></div><div class="line">    </div><div class="line"><span class="string">if</span> <span class="string">(</span> <span class="string">$arg_q</span> <span class="string">!=</span> <span class="string">""</span> <span class="string">)&#123;</span></div><div class="line">  <span class="string">set</span> <span class="string">$quality</span> <span class="string">$arg_q;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line">    </div><div class="line"><span class="string">location</span> <span class="string">/images/</span> <span class="string">&#123;</span></div><div class="line">  <span class="string">image_filter</span> <span class="string">resize</span> <span class="string">$width</span> <span class="string">$height;</span>   <span class="comment"># 缩放图片</span></div><div class="line">  <span class="string">image_filter</span> <span class="string">rotate</span> <span class="string">$rotate;</span>          <span class="comment"># 旋转图片</span></div><div class="line">  <span class="string">image_filter_jpeg_quality</span> <span class="string">$quality;</span>   <span class="comment"># jpeg图片质量，没有效果</span></div><div class="line">  <span class="string">image_filter_interlace</span> <span class="string">on;</span>            <span class="comment"># 将jpeg图片转换为可以渐进式加载的格式，这样用户可以尽快看到图片效果</span></div><div class="line">  <span class="string">image_filter_transparency</span> <span class="string">on;</span>         <span class="comment"># 是否保留图片的透明像素，因为我们还有png图，所以这里要打开</span></div><div class="line">  <span class="string">image_filter_buffer</span> <span class="number">8</span><span class="string">M;</span>               <span class="comment"># 这里需要手动设置下图片缓存大小，默认为1M，超出1M的图片服务器会报错。</span></div><div class="line">  <span class="string">error_page</span>   <span class="number">415</span> <span class="string">=</span> <span class="string">/empty;</span>            <span class="comment"># 如果处理图片文件不存在或者处理图片失败，会返回一张空白图</span></div><div class="line"><span class="string">&#125;</span></div><div class="line">    </div><div class="line"><span class="string">location</span> <span class="string">=</span> <span class="string">/empty</span> <span class="string">&#123;</span></div><div class="line"><span class="comment"># 使用`empty_gif`模块，返回一张1x1像素的gif图。建议不要再前端页面中将'/empty'作为占位图，没有必要，前端页面可以使用 'data:image/gif;base64,R0lGODlhCgAKAIAAAMzMzP///yH5BAAAAAAALAAAAAAKAAoAAAIRhI8Qy6zdHlxyVnjjdJv2UAAAOw=='</span></div><div class="line">  <span class="string">empty_gif;</span>                            </div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
<p>这样就可以通过<code>*.jpg?r=90&amp;w=100&amp;h=100</code>这样的参数配置做图片的缩放和旋转了。</p>
<h3 id="其他选择"><a href="#其他选择" class="headerlink" title="其他选择"></a>其他选择</h3><p>nginx 还有一些其他的第三方module可以用于图片缩放。例如：</p>
<ul>
<li>ngx_small_light 可以使用ImageMagick的功能，比image filter强大很多。</li>
<li>ngx_image_thumb是国产的，这个module会自动处理图盘的后缀参数，进行图片剪裁、缩放，配置起来比较容易，同时支持图片水印。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      nginx的模拟文件处理与图片特效。
    
    </summary>
    
      <category term="nginx" scheme="https://opstrip.com/categories/nginx/"/>
    
      <category term="小技巧" scheme="https://opstrip.com/categories/nginx/%E5%B0%8F%E6%8A%80%E5%B7%A7/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/categories/nginx/%E5%B0%8F%E6%8A%80%E5%B7%A7/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
    
      <category term="小技巧" scheme="https://opstrip.com/tags/%E5%B0%8F%E6%8A%80%E5%B7%A7/"/>
    
      <category term="nginx" scheme="https://opstrip.com/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Nginx日志统计分析常用命令</title>
    <link href="https://opstrip.com/2017/07/04/Common-Commands-for-Nginx-Log-Statistics/"/>
    <id>https://opstrip.com/2017/07/04/Common-Commands-for-Nginx-Log-Statistics/</id>
    <published>2017-07-04T06:18:31.000Z</published>
    <updated>2017-07-04T07:16:09.128Z</updated>
    
    <content type="html"><![CDATA[<h2 id="IP相关统计"><a href="#IP相关统计" class="headerlink" title="IP相关统计"></a>IP相关统计</h2><ul>
<li><p>统计IP访问量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $1&#125;'</span> access.log | sort -n | uniq | wc <span class="_">-l</span></div></pre></td></tr></table></figure>
</li>
<li><p>查看某一时间段的IP访问量(4-5点)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">"07/Apr/2017:0[4-5]"</span> access.log | awk <span class="string">'&#123;print $1&#125;'</span> | sort | uniq -c| sort -nr | wc <span class="_">-l</span></div></pre></td></tr></table></figure>
</li>
<li><p>查看访问最频繁的前100个IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $1&#125;'</span> access.log | sort -n |uniq -c | sort -rn | head -n 100</div></pre></td></tr></table></figure>
</li>
<li><p>查看访问100次以上的IP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $1&#125;'</span> access.log | sort -n |uniq -c |awk <span class="string">'&#123;if($1 &gt;100) print $0&#125;'</span>|sort -rn</div></pre></td></tr></table></figure>
</li>
<li><p>查询某个IP的详细访问情况,按访问频率排序</p>
</li>
</ul>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'104.217.108.66'</span> access.log |awk <span class="string">'&#123;print $7&#125;'</span>|sort |uniq -c |sort -rn |head -n 100</div></pre></td></tr></table></figure>
<h2 id="页面访问统计"><a href="#页面访问统计" class="headerlink" title="页面访问统计"></a>页面访问统计</h2><ul>
<li><p>查看访问最频的页面(TOP100)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $7&#125;'</span> access.log | sort |uniq -c | sort -rn | head -n 100</div></pre></td></tr></table></figure>
</li>
<li><p>查看访问最频的页面([排除php页面】(TOP100)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep -v <span class="string">".php"</span>  access.log | awk <span class="string">'&#123;print $7&#125;'</span> | sort |uniq -c | sort -rn | head -n 100</div></pre></td></tr></table></figure>
</li>
<li><p>查看页面访问次数超过100次的页面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat access.log | cut <span class="_">-d</span> <span class="string">' '</span> <span class="_">-f</span> 7 | sort |uniq -c | awk <span class="string">'&#123;if ($1 &gt; 100) print $0&#125;'</span> | less</div></pre></td></tr></table></figure>
</li>
<li><p>查看最近1000条记录，访问量最高的页面</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tail -1000 access.log |awk <span class="string">'&#123;print $7&#125;'</span>|sort|uniq -c|sort -nr|less</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="每秒请求量统计"><a href="#每秒请求量统计" class="headerlink" title="每秒请求量统计"></a>每秒请求量统计</h3><ul>
<li>统计每秒的请求数,top100的时间点(精确到秒)<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $4&#125;'</span> access.log |cut -c 14-21|sort|uniq -c|sort -nr|head -n 100</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="每分钟请求量统计"><a href="#每分钟请求量统计" class="headerlink" title="每分钟请求量统计"></a>每分钟请求量统计</h3><ul>
<li>统计每分钟的请求数,top100的时间点(精确到分钟)<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $4&#125;'</span> access.log |cut -c 14-18|sort|uniq -c|sort -nr|head -n 100</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="每小时请求量统计"><a href="#每小时请求量统计" class="headerlink" title="每小时请求量统计"></a>每小时请求量统计</h3><ul>
<li>统计每小时的请求数,top100的时间点(精确到小时)<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">awk <span class="string">'&#123;print $4&#125;'</span> access.log |cut -c 14-15|sort|uniq -c|sort -nr|head -n 100</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h2><p>在nginx log中最后一个字段加入<code>$request_time</code></p>
<ul>
<li><p>列出传输时间超过<code>3</code>秒的页面，显示前20条</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat access.log|awk <span class="string">'($NF &gt; 3)&#123;print $7&#125;'</span>|sort -n|uniq -c|sort -nr|head -20</div></pre></td></tr></table></figure>
</li>
<li><p>列出php页面请求时间超过3秒的页面，并统计其出现的次数，显示前100条</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat access.log|awk <span class="string">'($NF &gt; 1 &amp;&amp;  $7~/\.php/)&#123;print $7&#125;'</span>|sort -n|uniq -c|sort -nr|head -100</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="蜘蛛抓取统计"><a href="#蜘蛛抓取统计" class="headerlink" title="蜘蛛抓取统计"></a>蜘蛛抓取统计</h2><ul>
<li><p>统计蜘蛛抓取次数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'Baiduspider'</span> access.log |wc <span class="_">-l</span></div></pre></td></tr></table></figure>
</li>
<li><p>统计蜘蛛抓取404的次数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grep <span class="string">'Baiduspider'</span> access.log |grep <span class="string">'404'</span> | wc <span class="_">-l</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="TCP连接统计"><a href="#TCP连接统计" class="headerlink" title="TCP连接统计"></a>TCP连接统计</h2><ul>
<li><p>查看当前TCP连接数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netstat -tan | grep <span class="string">"ESTABLISHED"</span> | grep <span class="string">":80"</span> | wc <span class="_">-l</span></div></pre></td></tr></table></figure>
</li>
<li><p>用tcpdump嗅探80端口的访问看看谁最高</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tcpdump -i eth0 -tnn dst port 80 -c 1000 | awk -F<span class="string">"."</span> <span class="string">'&#123;print $1"."$2"."$3"."$4&#125;'</span> | sort | uniq -c | sort -nr</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="实例脚本"><a href="#实例脚本" class="headerlink" title="实例脚本"></a>实例脚本</h2><ul>
<li><p>获取前一分钟nginx访问日志条数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">    </div><div class="line"><span class="built_in">export</span> LANG=C</div><div class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin</div><div class="line">TIME=$(date <span class="_">-d</span> <span class="string">"1 minute ago"</span> +<span class="string">"%d/%h/%Y:%H:%M"</span>)</div><div class="line">    </div><div class="line">grep <span class="string">"<span class="variable">$TIME</span>"</span> /var/<span class="built_in">log</span>/nginx/access.log | wc <span class="_">-l</span></div></pre></td></tr></table></figure>
</li>
<li><p>获取前一分钟nginx错误日志条数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">    </div><div class="line"><span class="built_in">export</span> LANG=C</div><div class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin</div><div class="line">TIME=$(date <span class="_">-d</span> <span class="string">"1 minute ago"</span> +<span class="string">"%Y-%m-%d %H:%M"</span>)</div><div class="line">    </div><div class="line">grep <span class="string">"<span class="variable">$TIME</span>"</span> /var/<span class="built_in">log</span>/nginx/error.log | wc <span class="_">-l</span></div></pre></td></tr></table></figure></li>
</ul>
]]></content>
    
    <summary type="html">
    
      总结收集了些Nginx日志分析常用命令
    
    </summary>
    
      <category term="nginx" scheme="https://opstrip.com/categories/nginx/"/>
    
      <category term="日志分析" scheme="https://opstrip.com/categories/nginx/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"/>
    
    
      <category term="Nginx" scheme="https://opstrip.com/tags/Nginx/"/>
    
      <category term="日志分析" scheme="https://opstrip.com/tags/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/"/>
    
      <category term="常用命令" scheme="https://opstrip.com/tags/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    
  </entry>
  
  <entry>
    <title>MegaCli:如何使用命令行监控RAID卡状态</title>
    <link href="https://opstrip.com/2017/06/14/howto-monitor-raidCard-status-with-commandline-MegaCli/"/>
    <id>https://opstrip.com/2017/06/14/howto-monitor-raidCard-status-with-commandline-MegaCli/</id>
    <published>2017-06-14T06:30:47.000Z</published>
    <updated>2017-06-14T11:06:41.225Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>MegaCli是一款管理维护硬件RAID软件，可以通过它来了解当前raid卡的所有信息，包括 raid卡的型号，raid的阵列类型，raid 上各磁盘状态，等等。通常，我们对硬盘当前的状态不太好确定，一般通过机房人员巡检来完成，有没有通过软件的方式来检查确定这个问题呢。MegaCli就可以做到，一般通过 MegaCli 的Media Error Count: 0 Other Error Count: 0 这两个数值来确定阵列中磁盘是否有问题；Medai Error Count 表示磁盘可能错误，可能是磁盘有坏道，这个值不为0值得注意，数值越大，危险系数越高，Other Error Count 表示磁盘可能存在松动，可能需要重新再插入。MegaCli 可以对阵列中所有的磁盘进行检测，我们可以通过脚本的方式来检测相关参数，从而通知管理人员。</p>
<h2 id="下载MegCli"><a href="#下载MegCli" class="headerlink" title="下载MegCli"></a>下载MegCli</h2><p>猛击以下链接下载：<a href="/assets/downloads/MegaCli8.07.10.tar.gz">安装包下载</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@localhost opt]# tar xf MegaCli8.07.10.tar.gz</div><div class="line">[root@localhost opt]# rpm -ivh MegaCli8.07.10/Linux/&#123;Lib_Utils-1.00-09,MegaCli-8.02.21-1&#125;.noarch.rpm</div></pre></td></tr></table></figure>
<h2 id="使用命令及参数"><a href="#使用命令及参数" class="headerlink" title="使用命令及参数"></a>使用命令及参数</h2><p><strong>命令使用</strong></p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall <span class="_">-a</span>ALL                                     【查raid级别】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpAllInfo <span class="_">-a</span>ALL                                       【查raid卡信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDList <span class="_">-a</span>ALL                                           【查看硬盘信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd <span class="_">-a</span>All                                        【查看电池信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -FwTermLog -Dsply <span class="_">-a</span>ALL                                 【查看raid卡日志】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -adpCount                                               【显示适配器个数】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpGetTime –aALL                                       【显示适配器时间】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpAllInfo <span class="_">-a</span>All                                       【显示所有适配器信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -LALL <span class="_">-a</span>All                                     【显示所有逻辑磁盘组信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDList <span class="_">-a</span>All                                           【显示所有的物理信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL | grep <span class="string">'Charger Status'</span>  【查看充电状态】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL                          【显示BBU状态信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuCapacityInfo <span class="_">-a</span>ALL                    【显示BBU容量信息】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuDesignInfo <span class="_">-a</span>ALL                      【显示BBU设计参数】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuProperties <span class="_">-a</span>ALL                      【显示当前BBU属性】</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -cfgdsply <span class="_">-a</span>ALL                                         【显示Raid卡型号，Raid设置，Disk相关信息】</div></pre></td></tr></table></figure>
<h3 id="磁带状态的变化"><a href="#磁带状态的变化" class="headerlink" title="磁带状态的变化"></a>磁带状态的变化</h3><p>从拔盘，到插盘的过程中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Device |Normal|Damage|Rebuild|Normal</div><div class="line">Virtual Drive |Optimal|Degraded|Degraded|Optimal</div><div class="line">Physical Drive |Online|Failed –&gt; Unconfigured|Rebuild|Online</div></pre></td></tr></table></figure></p>
<h3 id="查看磁盘缓存策略"><a href="#查看磁盘缓存策略" class="headerlink" title="查看磁盘缓存策略"></a>查看磁盘缓存策略</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -L0 <span class="_">-a</span>0</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -L1 <span class="_">-a</span>0</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -LALL <span class="_">-a</span>0</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -LALL <span class="_">-a</span>ALL</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -DskCache -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
<h3 id="设置磁盘缓存策略"><a href="#设置磁盘缓存策略" class="headerlink" title="设置磁盘缓存策略"></a>设置磁盘缓存策略</h3><p>缓存策略解释：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">WT (Write through</div><div class="line">WB (Write back)</div><div class="line">NORA (No read ahead)</div><div class="line">RA (Read ahead)</div><div class="line">ADRA (Adaptive read ahead)</div><div class="line">Cached</div><div class="line">Direct</div></pre></td></tr></table></figure></p>
<p><code>例子：</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp WT|WB|NORA|RA|ADRA -L0 <span class="_">-a</span>0</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -Cached|-Direct -L0 <span class="_">-a</span>0</div><div class="line"><span class="built_in">enable</span> / <span class="built_in">disable</span> disk cache</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -EnDskCache|-DisDskCache -L0 <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<h3 id="创建一个-raid5-阵列"><a href="#创建一个-raid5-阵列" class="headerlink" title="创建一个 raid5 阵列"></a>创建一个 raid5 阵列</h3><p>由物理盘 2,3,4 构成，该阵列的热备盘是物理盘 5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -C<span class="built_in">fg</span>LdAdd -r5 [1:2,1:3,1:4] WB Direct -Hsp[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<h3 id="创建阵列，不指定热备"><a href="#创建阵列，不指定热备" class="headerlink" title="创建阵列，不指定热备"></a>创建阵列，不指定热备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -C<span class="built_in">fg</span>LdAdd -r5 [1:2,1:3,1:4] WB Direct <span class="_">-a</span>0</div></pre></td></tr></table></figure>
<h3 id="删除阵列"><a href="#删除阵列" class="headerlink" title="删除阵列"></a>删除阵列</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -C<span class="built_in">fg</span>LdDel -L1 <span class="_">-a</span>0</div></pre></td></tr></table></figure>
<h3 id="在线添加磁盘"><a href="#在线添加磁盘" class="headerlink" title="在线添加磁盘"></a>在线添加磁盘</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDRecon -Start -r5 -Add -PhysDrv[1:4] -L1 <span class="_">-a</span>0</div></pre></td></tr></table></figure>
<h3 id="查看进度"><a href="#查看进度" class="headerlink" title="查看进度"></a>查看进度</h3><p>阵列创建完后，会有一个初始化同步块的过程，可以看看其进度。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDInit -ShowProg -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<p>或者以动态可视化文字界面显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDInit -ProgDsply -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<h3 id="查看阵列后台初始化进度"><a href="#查看阵列后台初始化进度" class="headerlink" title="查看阵列后台初始化进度"></a>查看阵列后台初始化进度</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDBI -ShowProg -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
<p>或者以动态可视化文字界面显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -LDBI -ProgDsply -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<h3 id="热备管理"><a href="#热备管理" class="headerlink" title="热备管理"></a>热备管理</h3><ul>
<li><p>指定第5块盘作为全局热备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
<li><p>指定为某个阵列的专用热备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Set [-Dedicated [-Array1]] [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
<li><p>删除全局热备</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Rmv -PhysDrv[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="将某块物理盘下线-上线"><a href="#将某块物理盘下线-上线" class="headerlink" title="将某块物理盘下线/上线"></a>将某块物理盘下线/上线</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDOffline -PhysDrv [1:4] <span class="_">-a</span>0</div><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDOnline -PhysDrv [1:4] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
<h3 id="查看物理磁盘重建进度"><a href="#查看物理磁盘重建进度" class="headerlink" title="查看物理磁盘重建进度"></a>查看物理磁盘重建进度</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ShowProg -PhysDrv [1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
<p>或者以动态可视化文字界面显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ProgDsply -PhysDrv [1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<h3 id="磁带状态的变化-1"><a href="#磁带状态的变化-1" class="headerlink" title="磁带状态的变化"></a>磁带状态的变化</h3><p>从拔盘，到插盘的过程中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Device |Normal|Damage|Rebuild|Normal</div><div class="line">Virtual Drive |Optimal|Degraded|Degraded|Optimal</div><div class="line">Physical Drive |Online|Failed –&gt; Unconfigured|Rebuild|Online</div></pre></td></tr></table></figure></p>
<h2 id="实用案例"><a href="#实用案例" class="headerlink" title="实用案例"></a>实用案例</h2><h3 id="查看RAID级别"><a href="#查看RAID级别" class="headerlink" title="查看RAID级别"></a>查看RAID级别</h3><p><img src="/assets/blogImg/megacli-1.png" alt="查看RAID级别"></p>
<h3 id="查看RAID卡信息"><a href="#查看RAID卡信息" class="headerlink" title="查看RAID卡信息"></a>查看RAID卡信息</h3><p>主要输出RAID卡的一些配置信息<br><img src="/assets/blogImg/megacli-2.png" alt="查看RAID卡配置信息"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">RAID Level : Primary-1, Secondary-0, RAID Level Qualifier-0</div><div class="line">Size : 1.698 TB</div><div class="line">State : Optimal</div><div class="line">Strip Size : 128 KB</div><div class="line">Number Of Drives per span:2 //表示每2个物理盘做成一个RAID1盘组</div><div class="line">Span Depth : 3 //表示共3个RAID1盘组做成了RAID10</div></pre></td></tr></table></figure></p>
<h3 id="查看所有硬盘的信息"><a href="#查看所有硬盘的信息" class="headerlink" title="查看所有硬盘的信息"></a>查看所有硬盘的信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -pdlist –aALL</div></pre></td></tr></table></figure>
<p><img src="/assets/blogImg/megacli-3.png" alt="查看所有硬盘信息"></p>
<h3 id="查看当前RAID缓存状态"><a href="#查看当前RAID缓存状态" class="headerlink" title="查看当前RAID缓存状态"></a>查看当前RAID缓存状态</h3><p><code>RAID缓存状态设置为wb的话要注意电池放电事宜，设置电池放电模式为自动学习模式</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/opt/MegaRAID/MegaCli/MegaCli64 -ldgetprop -dskcache -lall -aall</div></pre></td></tr></table></figure></p>
<p><img src="/assets/blogImg/megacli-4.png" alt="查看RAID缓存状态"></p>
<h3 id="RAID电池设置相关"><a href="#RAID电池设置相关" class="headerlink" title="RAID电池设置相关"></a>RAID电池设置相关</h3><ul>
<li><p>查看电池状态信息(Display BBU Status Information)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>N|<span class="_">-a</span>0,1,2|<span class="_">-a</span>ALL</div><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看电池容量（Display BBU Capacity Information）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuCapacityInfo <span class="_">-a</span>N|<span class="_">-a</span>0,1,2|<span class="_">-a</span>ALL</div><div class="line">MegaCli -AdpBbuCmd -GetBbuCapacityInfo –aALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看电池设计参数(Display BBU Design Parameters)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuDesignInfo <span class="_">-a</span>N|<span class="_">-a</span>0,1,2|<span class="_">-a</span>ALL</div><div class="line">MegaCli -AdpBbuCmd -GetBbuDesignInfo –aALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看电池属性（Display Current BBU Properties）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuProperties <span class="_">-a</span>N|<span class="_">-a</span>0,1,2|<span class="_">-a</span>ALL</div><div class="line">MegaCli -AdpBbuCmd -GetBbuProperties –aALL</div></pre></td></tr></table></figure>
</li>
<li><p>设置电池为学习模式为循环模式（Start BBU Learning Cycle）<br>Description Starts the learning cycle on the BBU.<br>No parameter is needed for this option.<br>MegaCli -AdpBbuCmd -BbuLearn -aN|-a0,1,2|-aALL</p>
</li>
</ul>
<h3 id="RAID磁盘设置相关"><a href="#RAID磁盘设置相关" class="headerlink" title="RAID磁盘设置相关"></a>RAID磁盘设置相关</h3><ul>
<li><p>设置磁盘的缓存模式和访问方式 （Change Virtual Disk Cache and Access Parameters）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Description Allows you to change the following virtual disk parameters:</div><div class="line">-WT (Write through), WB (Write back): Selects write policy.</div><div class="line">-NORA (No read ahead), RA (Read ahead), ADRA (Adaptive read ahead): Selects read policy.</div><div class="line">-Cached, -Direct: Selects cache policy.</div><div class="line">-RW, -RO, Blocked: Selects access policy.</div><div class="line">-EnDskCache: Enables disk cache.</div><div class="line">-DisDskCache: Disables disk cache.</div><div class="line">MegaCli -LDSetProp &#123; WT | WB|NORA |RA | ADRA|-Cached|Direct&#125; |</div><div class="line">&#123;-RW|RO|Blocked&#125; |</div><div class="line">&#123;-Name[string]&#125; |</div><div class="line">&#123;-EnDskCache|DisDskCache&#125; –Lx |</div><div class="line">-L0,1,2|-Lall -aN|-a0,1,2|-aALL</div><div class="line">MegaCli -LDSetProp WT -L0 -a0</div></pre></td></tr></table></figure>
</li>
<li><p>显示磁盘缓存和访问方式（Display Virtual Disk Cache and Access Parameters）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDGetProp -Cache | -Access | -Name | -DskCache -Lx|-L0,1,2|-Lall <span class="_">-a</span>N|<span class="_">-a</span>0,1,2|<span class="_">-a</span>ALL</div><div class="line">Displays the cache and access policies of the virtual disk(s):</div><div class="line">-WT (Write through), WB (Write back): Selects write policy.</div><div class="line">-NORA (No <span class="built_in">read</span> ahead), RA (Read ahead), ADRA (Adaptive <span class="built_in">read</span> ahead): Selects <span class="built_in">read</span> policy.</div><div class="line">-Cache, -Cached, Direct: Displays cache policy.</div><div class="line">-Access, -RW, -RO, Blocked: Displays access policy.</div><div class="line">-DskCache: Displays physical disk cache policy.</div></pre></td></tr></table></figure>
</li>
</ul>
<p><code>Megaraid必知必会</code><br>使用LSI的megaraid可以对raid进行有效监控。别的厂商比如HP,IBM也有自己的raid API<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -ldinfo -lall -aall</div></pre></td></tr></table></figure></p>
<ul>
<li><p>查询raid级别，磁盘数量，容量，条带大小。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -cfgdsply <span class="_">-a</span>ALL |grep Policy</div></pre></td></tr></table></figure>
</li>
<li><p>查询控制器cache策略</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDSetProp WB -L0 <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
<li><p>设置write back功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDSetProp CachedBadBBU -L0 <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
<li><p>设置即使电池坏了还是保持WB功能</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -BbuLearn a0</div></pre></td></tr></table></figure>
</li>
<li><p>手动充电</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -FwTermLog -Dsply <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示适配器个数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -adpCount</div></pre></td></tr></table></figure>
</li>
<li><p>显示所有适配器信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpAllInfo <span class="_">-a</span>All</div><div class="line">Critical Disks : 0 </div><div class="line">Failed Disks : 0</div></pre></td></tr></table></figure>
</li>
<li><p>显示所有逻辑磁盘组信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDInfo -LALL <span class="_">-a</span>All</div></pre></td></tr></table></figure>
</li>
<li><p>显示所有的物理信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDList <span class="_">-a</span>All</div><div class="line">Media Error Count: 0</div><div class="line">Other Error Count: 0</div></pre></td></tr></table></figure>
</li>
<li><p>查看充电状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL</div><div class="line">Learn Cycle Requested : No</div><div class="line">Fully Charged : Yes</div></pre></td></tr></table></figure>
</li>
<li><p>显示BBU(后备电池)状态信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示BBU容量信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuCapacityInfo <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示BBU设计参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuDesignInfo <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示当前BBU属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuProperties <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示Raid卡型号，Raid设置，Disk相关信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -cfgdsply <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看Cache策略设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MegaCli -cfgdsply <span class="_">-a</span>ALL |grep -i Policy</div><div class="line">Current Cache Policy: WriteBack, ReadAheadNone, Direct, Write Cache OK <span class="keyword">if</span> Bad BBU</div></pre></td></tr></table></figure>
</li>
<li><p>查看充电进度百分比</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>各种设备和磁盘的不同状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Device |Normal|Damage|Rebuild|Normal</div><div class="line">Virtual Drive |Optimal|Degraded|Degraded|Optimal</div><div class="line">Physical Drive |Online|Failed –&gt; Unconfigured|Rebuild|Online</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="通过脚本检测RAID磁盘状态"><a href="#通过脚本检测RAID磁盘状态" class="headerlink" title="通过脚本检测RAID磁盘状态"></a>通过脚本检测RAID磁盘状态</h3><p><code>Linux下脚本</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#check raid disk status</span></div><div class="line">MEGACLI=<span class="string">"/opt/MegaRAID/MegaCli/MegaCli64 "</span></div><div class="line"><span class="variable">$MEGACLI</span> -pdlist <span class="_">-a</span>ALL  | grep <span class="string">"Firmware state"</span> | awk -F : <span class="string">'&#123;print $2&#125;'</span> | awk -F , <span class="string">'&#123;print $1&#125;'</span> &gt;/tmp/fireware.log</div><div class="line"><span class="variable">$MEGACLI</span> -pdlist <span class="_">-a</span>ALL  | grep -E <span class="string">"Media Error|Other Error"</span> | awk -F : <span class="string">'&#123;print $2&#125;'</span> &gt;/tmp/disk.log</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `cat &lt; /tmp/disk.log`</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-ne</span> 0 ] <span class="keyword">then</span></div><div class="line">        curl <span class="string">"http://xxxxxxB&amp;state=ALARM&amp;description=raid_disk_error"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `cat &lt; /tmp/fireware.log`</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$i</span> !=  Online ] <span class="keyword">then</span></div><div class="line">        curl <span class="string">"http://xxxxxxstate=ALARM&amp;description=raid_disk_offline"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure></p>
<p><code>Windows下脚本</code><br>Windows下脚本用的工具是gnu for windows平台的一些软件，如 bash grep awk cat<br>通过bash直接调用脚本<br>如：G:\raid_check\unixtools&gt;bash.exe  G:\disk.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#check raid disk status</span></div><div class="line">MEGACLI=<span class="string">"//G/raid_check/MegaCli.exe"</span></div><div class="line">GREP=<span class="string">"//G/raid_check/unixtools/grep.exe"</span></div><div class="line">AWK=<span class="string">"//G/raid_check/unixtools/awk.exe"</span></div><div class="line">CAT=<span class="string">"//G/raid_check/unixtools/cat.exe"</span></div><div class="line">CURL=<span class="string">"//G/raid_check/unixtools/curl.exe"</span></div><div class="line"><span class="variable">$MEGACLI</span> -pdlist <span class="_">-a</span>ALL  | <span class="variable">$GREP</span> <span class="string">"Firmware state"</span> |<span class="variable">$AWK</span> -F: <span class="string">'&#123;print $2&#125;'</span> |<span class="variable">$AWK</span> -F , <span class="string">'&#123;print $1&#125;'</span> &gt;//c/fireware.log</div><div class="line"><span class="variable">$MEGACLI</span> -pdlist <span class="_">-a</span>ALL  | <span class="variable">$GREP</span> -E <span class="string">"Media Error|Other Error"</span> | <span class="variable">$AWK</span> -F : <span class="string">'&#123;print $2&#125;'</span> &gt; //c/disk.log</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="variable">$CAT</span> c:/disk.log`</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-ne</span> 0 ] <span class="keyword">then</span></div><div class="line">        <span class="variable">$CURL</span> <span class="string">"http://xxxxxx&amp;description=raid_disk_error"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `<span class="variable">$CAT</span> c:/fireware.log`</div><div class="line"><span class="keyword">do</span></div><div class="line">    <span class="keyword">if</span> [ <span class="variable">$i</span> != Online ] <span class="keyword">then</span></div><div class="line">        <span class="variable">$CURL</span> <span class="string">"http://xxxxx&amp;state=ALARM&amp;description=raid_disk_offline"</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure></p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><ul>
<li><p>查看raid级别：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDInfo -Lall <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看raid卡信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpAllInfo <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看硬盘信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDList <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看电池信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd <span class="_">-a</span>All</div></pre></td></tr></table></figure>
</li>
<li><p>查看raid卡日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -FwTermLog -Dsply <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示适配器个数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -adpCount</div></pre></td></tr></table></figure>
</li>
<li><p>显示适配器时间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpGetTime –aALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示所有适配器信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpAllInfo <span class="_">-a</span>All</div></pre></td></tr></table></figure>
</li>
<li><p>显示所有逻辑磁盘组信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDInfo -LALL <span class="_">-a</span>All</div></pre></td></tr></table></figure>
</li>
<li><p>显示所有的物理信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDList <span class="_">-a</span>All</div></pre></td></tr></table></figure>
</li>
<li><p>查看充电状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL |grep <span class="string">'Charger Status'</span></div></pre></td></tr></table></figure>
</li>
<li><p>显示BBU状态信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuStatus <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示BBU容量信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuCapacityInfo <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>显示BBU设计参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuDesignInfo <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示当前BBU属性：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -AdpBbuCmd -GetBbuProperties <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>显示Raid卡型号，Raid设置，Disk相关信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -cfgdsply <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
<li><p>查看磁盘缓存策略：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDGetProp -Cache -L0 <span class="_">-a</span>0</div><div class="line">MegaCli -LDGetProp -Cache -L1 <span class="_">-a</span>0</div><div class="line">MegaCli -LDGetProp -Cache -LALL <span class="_">-a</span>0</div><div class="line">MegaCli -LDGetProp -Cache -LALL <span class="_">-a</span>ALL</div><div class="line">MegaCli -LDGetProp -DskCache -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>设置磁盘缓存策略：<br>缓存策略：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">WT    (Write through)</div><div class="line">WB    (Write back)</div><div class="line">NORA  (No read ahead)</div><div class="line">RA    (Read ahead)</div><div class="line">ADRA  (Adaptive read ahead)</div><div class="line">Cached</div><div class="line">Direct</div></pre></td></tr></table></figure>
</li>
</ul>
<p>如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDSetProp WT|WB|NORA|RA|ADRA -L0 <span class="_">-a</span>0</div><div class="line">MegaCli -LDSetProp -Cached|-Direct -L0 <span class="_">-a</span>0</div><div class="line"><span class="built_in">enable</span> / <span class="built_in">disable</span> disk cache</div><div class="line">MegaCli -LDSetProp -EnDskCache|-DisDskCache -L0 <span class="_">-a</span>0</div><div class="line">``` </div><div class="line"> </div><div class="line">- 创建/删除阵列：</div><div class="line">如：</div><div class="line">创建一个 raid5 阵列，由物理盘 2,3,4 构成，该阵列的热备盘是物理盘 5</div><div class="line">```bash</div><div class="line">MegaCli -C<span class="built_in">fg</span>LdAdd -r5 [1:2,1:3,1:4] WB Direct -Hsp[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<p>创建阵列，不指定热备：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -C<span class="built_in">fg</span>LdAdd -r5 [1:2,1:3,1:4] WB Direct <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<p>删除阵列：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -C<span class="built_in">fg</span>LdDel -L1 <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<p>在线添加磁盘：重建逻辑磁盘组1，raid级别是5，添加物理磁盘号：1:4<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDRecon -Start -r5 -Add -PhysDrv[1:4] -L1 <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<p>查看阵列初始化信息：<br>阵列创建完后，会有一个初始化同步块的过程，可以看看其进度<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDInit -ShowProg -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<p>以动态可视化文字界面显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDInit -ProgDsply -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<p>查看阵列后台初始化进度<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDBI -ShowProg -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<p>以动态可视化文字界面显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -LDBI -ProgDsply -LALL <span class="_">-a</span>ALL</div></pre></td></tr></table></figure></p>
<ul>
<li>创建全局热备：</li>
</ul>
<p>指定第5块盘作为全局热备<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<p>也可以指定为某个阵列的专用热备<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDHSP -Set [-Dedicated [-Array1]] [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<p>删除全局热备：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDHSP -Rmv -PhysDrv[1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<ul>
<li><p>将某块物理盘下线/上线：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDOffline -PhysDrv [1:4] <span class="_">-a</span>0</div><div class="line">MegaCli -PDOnline -PhysDrv [1:4] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
<li><p>查看物理磁盘重建进度：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDRbld -ShowProg -PhysDrv [1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure>
</li>
</ul>
<p>以动态可视化文字界面显示<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MegaCli -PDRbld -ProgDsply -PhysDrv [1:5] <span class="_">-a</span>0</div></pre></td></tr></table></figure></p>
<hr>
<p>参考来源：<a href="http://blog.csdn.net/w57w57w57/article/details/7214128" target="_blank" rel="external">http://blog.csdn.net/w57w57w57/article/details/7214128</a></p>
]]></content>
    
    <summary type="html">
    
      MegaCli是一款管理维护硬件RAID软件，可以通过它来了解当前raid卡的所有信息，包括raid卡的型号，raid的阵列类型，raid上各磁盘状态，等等。
    
    </summary>
    
      <category term="CentOS" scheme="https://opstrip.com/categories/CentOS/"/>
    
      <category term="Linux" scheme="https://opstrip.com/categories/CentOS/Linux/"/>
    
      <category term="RAID阵列" scheme="https://opstrip.com/categories/CentOS/Linux/RAID%E9%98%B5%E5%88%97/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/categories/CentOS/Linux/RAID%E9%98%B5%E5%88%97/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
    
      <category term="MegaCli" scheme="https://opstrip.com/tags/MegaCli/"/>
    
      <category term="RAID" scheme="https://opstrip.com/tags/RAID/"/>
    
      <category term="磁盘阵列" scheme="https://opstrip.com/tags/%E7%A3%81%E7%9B%98%E9%98%B5%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>在CentOS7中部署php7.1及开启MySQL扩展</title>
    <link href="https://opstrip.com/2017/05/31/Deploying-php71-and-opening-MySQL-extension-on-CentOS7/"/>
    <id>https://opstrip.com/2017/05/31/Deploying-php71-and-opening-MySQL-extension-on-CentOS7/</id>
    <published>2017-05-31T09:24:24.000Z</published>
    <updated>2017-10-12T09:39:03.050Z</updated>
    
    <content type="html"><![CDATA[<p>之前在<code>CentOS7</code>安装<code>php7.1</code>的时候有遇到<code>PHP源</code>及<code>PHP7.1</code>不支持<code>MySQL扩展</code>问题，上午抽空安装了下终于解决了这两个问题，特此记录备忘。</p>
<h2 id="简单安装-yum方式"><a href="#简单安装-yum方式" class="headerlink" title="简单安装(yum方式)"></a>简单安装(yum方式)</h2><h3 id="安装软件源"><a href="#安装软件源" class="headerlink" title="安装软件源"></a>安装软件源</h3><h4 id="添加epel源"><a href="#添加epel源" class="headerlink" title="添加epel源"></a>添加epel源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY*</div><div class="line">[root@opstrip.com opt]# rpm -Uvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-10.noarch.rpm</div></pre></td></tr></table></figure>
<p>备用源：<a href="http://mirrors.rit.edu/fedora/epel/7/x86_64/e/epel-release-7-10.noarch.rpm" target="_blank" rel="external">http://mirrors.rit.edu/fedora/epel/7/x86_64/e/epel-release-7-10.noarch.rpm</a></p>
<h4 id="添加remi源"><a href="#添加remi源" class="headerlink" title="添加remi源"></a>添加remi源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# rpm -Uvh http://rpms.remirepo.net/enterprise/remi-release-7.rpm</div></pre></td></tr></table></figure>
<h3 id="安装并更新软件"><a href="#安装并更新软件" class="headerlink" title="安装并更新软件"></a>安装并更新软件</h3><h4 id="安装yum-config-manager实用程序"><a href="#安装yum-config-manager实用程序" class="headerlink" title="安装yum-config-manager实用程序"></a>安装yum-config-manager实用程序</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum -y install yum-utils</div></pre></td></tr></table></figure>
<h4 id="更新系统当前软件版本"><a href="#更新系统当前软件版本" class="headerlink" title="更新系统当前软件版本"></a>更新系统当前软件版本</h4><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum -y update</div></pre></td></tr></table></figure>
<p>更新完成后，就可以安装所需要的<code>PHP版本</code>了。</p>
<h3 id="安装PHP"><a href="#安装PHP" class="headerlink" title="安装PHP"></a>安装PHP</h3><p>以上准备工作完成后，就可以安装所需的<code>PHP版本</code>了。</p>
<h4 id="对于PHP5-4"><a href="#对于PHP5-4" class="headerlink" title="对于PHP5.4"></a>对于PHP5.4</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum -y install php</div></pre></td></tr></table></figure>
<p>安装前可尝试<code>yum search php54</code>搜索可安装的软件包。</p>
<h4 id="对于PHP7-0"><a href="#对于PHP7-0" class="headerlink" title="对于PHP7.0"></a>对于PHP7.0</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum-config-manager --enable remi-php70</div><div class="line">[root@opstrip.com opt]# yum -y install php php-opcache</div></pre></td></tr></table></figure>
<p>安装前可尝试<code>yum search php70</code>搜索可安装的软件包。</p>
<h4 id="对于PHP7-1"><a href="#对于PHP7-1" class="headerlink" title="对于PHP7.1"></a>对于PHP7.1</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum-config-manager --enable remi-php71</div><div class="line">[root@opstrip.com opt]# yum -y install php php-opcache</div></pre></td></tr></table></figure>
<p>安装前可尝试<code>yum search php71</code>搜索可安装的软件包。</p>
<p>完成后还需要添加<code>PHP常用扩展</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum -y install php-mysql php-gd php-ldap php-odbc php-pear php-xml php-xmlrpc php-mbstring php-soap curl curl-devel</div></pre></td></tr></table></figure></p>
<h4 id="对于Nginx"><a href="#对于Nginx" class="headerlink" title="对于Nginx"></a>对于Nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# yum -y install nginx nginx-mod-http-perl nginx-mod-stream nginx-filesystem nginx-mod-mail nginx-mod-http-image-filter nginx-all-modules nginx-mod-http-geoip nginx-mod-http-xslt-filter</div></pre></td></tr></table></figure>
<p>安装前仍建议尝试<code>yum search nginx</code>搜索可安装的软件包。</p>
<p>安装完成后配置<code>PHP</code>及<code>Nginx</code>并启动用以测试<code>phpinfo</code>页面，这时候应该能正常显示。</p>
<h2 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h2><h3 id="安装前的准备"><a href="#安装前的准备" class="headerlink" title="安装前的准备"></a>安装前的准备</h3><h4 id="下载PHP安装包"><a href="#下载PHP安装包" class="headerlink" title="下载PHP安装包"></a>下载PHP安装包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# wget -O php-7.1.5.tar.gz http://cn2.php.net/distributions/php-7.1.5.tar.gz</div></pre></td></tr></table></figure>
<h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# tar xf php-7.1.5.tar.gz</div></pre></td></tr></table></figure>
<h4 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]# yum install -y libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel</div></pre></td></tr></table></figure>
<h3 id="配置安装"><a href="#配置安装" class="headerlink" title="配置安装"></a>配置安装</h3><h4 id="编译配置"><a href="#编译配置" class="headerlink" title="编译配置"></a>编译配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com opt]# cd php-7.1.5</div><div class="line">[root@opstrip.com php-7.1.5]# ./configure \</div><div class="line">--prefix=/usr/local/php \</div><div class="line">--with-config-file-path=/etc \</div><div class="line">--enable-fpm \</div><div class="line">--with-fpm-user=www  \</div><div class="line">--with-fpm-group=www \</div><div class="line">--enable-inline-optimization \</div><div class="line">--disable-debug \</div><div class="line">--disable-rpath \</div><div class="line">--enable-shared  \</div><div class="line">--enable-soap \</div><div class="line">--with-libxml-dir \</div><div class="line">--with-xmlrpc \</div><div class="line">--with-openssl \</div><div class="line">--with-mcrypt \</div><div class="line">--with-mhash \</div><div class="line">--with-pcre-regex \</div><div class="line">--with-sqlite3 \</div><div class="line">--with-zlib \</div><div class="line">--enable-bcmath \</div><div class="line">--with-iconv \</div><div class="line">--with-bz2 \</div><div class="line">--enable-calendar \</div><div class="line">--with-curl \</div><div class="line">--with-cdb \</div><div class="line">--enable-dom \</div><div class="line">--enable-exif \</div><div class="line">--enable-fileinfo \</div><div class="line">--enable-filter \</div><div class="line">--with-pcre-dir \</div><div class="line">--enable-ftp \</div><div class="line">--with-gd \</div><div class="line">--with-openssl-dir \</div><div class="line">--with-jpeg-dir \</div><div class="line">--with-png-dir \</div><div class="line">--with-zlib-dir  \</div><div class="line">--with-freetype-dir \</div><div class="line">--enable-gd-native-ttf \</div><div class="line">--with-ldap \</div><div class="line">--with-gettext \</div><div class="line">--with-gmp \</div><div class="line">--with-mhash \</div><div class="line">--enable-json \</div><div class="line">--enable-mbstring \</div><div class="line">--enable-mbregex \</div><div class="line">--enable-mbregex-backtrack \</div><div class="line">--with-libmbfl \</div><div class="line">--with-onig \</div><div class="line">--enable-pdo \</div><div class="line">--with-mysqli=mysqlnd \</div><div class="line">--with-pdo-mysql=mysqlnd \</div><div class="line">--with-zlib-dir \</div><div class="line">--with-pdo-sqlite \</div><div class="line">--with-readline \</div><div class="line">--enable-session \</div><div class="line">--enable-shmop \</div><div class="line">--enable-simplexml \</div><div class="line">--enable-sockets  \</div><div class="line">--enable-sysvmsg \</div><div class="line">--enable-sysvsem \</div><div class="line">--enable-sysvshm \</div><div class="line">--enable-wddx \</div><div class="line">--with-libxml-dir \</div><div class="line">--with-xsl \</div><div class="line">--enable-zip \</div><div class="line">--enable-mysqlnd-compression-support \</div><div class="line">--with-pear \</div><div class="line">--enable-opcache</div></pre></td></tr></table></figure>
<p>具体可以参考PHP官方安装说明文档：<a href="http://php.net/manual/zh/install.unix.nginx.php" target="_blank" rel="external">http://php.net/manual/zh/install.unix.nginx.php</a></p>
<h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]# make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>配置环境变量：<br>在<code>/etc/profile</code>末尾追加<code>export PATH=$PATH:/usr/local/php/bin</code>，然后执行<code>source /etc/profile</code>生效后查看php版本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]# php -v</div><div class="line">PHP 7.1.5 (cli) (built: May 31 2017 16:12:38) ( NTS )</div><div class="line">Copyright (c) 1997-2017 The PHP Group</div><div class="line">Zend Engine v3.1.0, Copyright (c) 1998-2017 Zend Technologies</div></pre></td></tr></table></figure></p>
<h3 id="安装后的配置"><a href="#安装后的配置" class="headerlink" title="安装后的配置"></a>安装后的配置</h3><h4 id="配置php-fpm"><a href="#配置php-fpm" class="headerlink" title="配置php-fpm"></a>配置<code>php-fpm</code></h4><p>安装完成后可以通过<code>sapi/fpm/php-fpm.server</code>来启动<code>php-fpm</code>了。不过为了以后管理方便，通常需要将配置文件统一放到<code>/etc</code>目录下，并将<code>php-fpm.server</code>添加至<code>systemctl服务</code>。如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]# mkdir -p /etc/php-fpm.d</div><div class="line">[root@opstrip.com php-7.1.5]# cp php.ini-production /etc/php.ini</div><div class="line">[root@opstrip.com php-7.1.5]# cp sapi/fpm/php-fpm.service /usr/lib/systemd/system/</div><div class="line">[root@opstrip.com php-7.1.5]# cp sapi/fpm/php-fpm.conf /etc/</div><div class="line">[root@opstrip.com php-7.1.5]# cp sapi/fpm/www.conf /etc/php-fpm.d/</div></pre></td></tr></table></figure></p>
<p>然后更改<code>/usr/lib/systemd/system/php-fpm.service</code>文件使其执行正确的路径，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]# vi /usr/lib/systemd/system/php-fpm.service</div><div class="line"># It&apos;s not recommended to modify this file in-place, because it</div><div class="line"># will be overwritten during upgrades.  If you want to customize,</div><div class="line"># the best way is to use the &quot;systemctl edit&quot; command.</div><div class="line">    </div><div class="line">[Unit]</div><div class="line">Description=The PHP FastCGI Process Manager</div><div class="line">After=network.target</div><div class="line">    </div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">PIDFile=/var/run/php-fpm.pid</div><div class="line">ExecStart=/usr/local/php/sbin/php-fpm --nodaemonize --fpm-config /etc/php-fpm.conf</div><div class="line">ExecReload=/bin/kill -USR2 $MAINPID</div><div class="line">PrivateTmp=true</div><div class="line">    </div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<h4 id="启动php-fpm"><a href="#启动php-fpm" class="headerlink" title="启动php-fpm"></a>启动<code>php-fpm</code></h4><p>第一次通过<code>systemctl</code>启动PHP服务时需要先将<code>php-fpm</code>服务<code>enable</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]# systemctl enable php-fpm.service</div><div class="line">[root@opstrip.com php-7.1.5]# systemctl start php-fpm.service</div></pre></td></tr></table></figure></p>
<h3 id="编译安装Nginx"><a href="#编译安装Nginx" class="headerlink" title="编译安装Nginx"></a>编译安装Nginx</h3><p>详见<a href="https://opstrip.com/2017/04/05/LNMP-on-CentOS7-01/#安装Nginx">前文</a>，并根据需要配置并启动Nginx。这里就不在写了。</p>
<h2 id="开启MySQL扩展-仅编译安装"><a href="#开启MySQL扩展-仅编译安装" class="headerlink" title="开启MySQL扩展(仅编译安装)"></a>开启MySQL扩展(仅编译安装)</h2><p>由于PHP7已经完全移除了MySQL的扩展支持（由mysqli与mysqlnd取代），因此一些老的软件在升级PHP版本后会报类似<code>mysql_connect()</code>函数未定义的错误，一般建议使用新的PHP<code>mysqli</code>或者<code>pdo扩展</code>进行替换。当然也可以检出遗留版本的支持<code>MySQL扩展</code>的<code>PHP7</code>代码自行编译安装了，不过需要注意的就是<code>MySQL扩展</code>可是完全没有后续更新的了。</p>
<h3 id="安装前准备"><a href="#安装前准备" class="headerlink" title="安装前准备"></a>安装前准备</h3><h4 id="查看当前扩展"><a href="#查看当前扩展" class="headerlink" title="查看当前扩展"></a>查看当前扩展</h4><p>查看当前PHP7.1自带扩展：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com php-7.1.5]<span class="comment"># ls ext</span></div><div class="line">bcmath        dom                 gd           json        oci8         pdo_firebird    posix         skeleton    sysvsem      xmlwriter</div><div class="line">bz2           enchant             gettext      ldap        odbc         pdo_mysql       pspell        snmp        sysvshm      xsl</div><div class="line">calendar      exif                gmp          libxml      opcache      pdo_oci         readline      soap        tidy         zip</div><div class="line">com_dotnet    ext_skel            <span class="built_in">hash</span>         mbstring    openssl      pdo_odbc        recode        sockets     tokenizer    zlib</div><div class="line">ctype         ext_skel_win32.php  iconv        mcrypt      pcntl        pdo_pgsql       reflection    spl         wddx</div><div class="line">curl          fileinfo            imap         mysql       pcre         pdo_sqlite      session       sqlite3     xml</div><div class="line">date          filter              interbase    mysqli      pdo          pgsql           shmop         standard    xmlreader</div><div class="line">dba           ftp                 intl         mysqlnd     pdo_dblib    phar            simplexml     sysvmsg     xmlrpc</div></pre></td></tr></table></figure></p>
<p>可以看到MySQL扩展确实已经被移除了，我们可以直接在<code>ext目录</code>下检出老的<code>PHP MySQL扩展</code>代码。</p>
<h4 id="获取PHP-MySQL扩展源码"><a href="#获取PHP-MySQL扩展源码" class="headerlink" title="获取PHP MySQL扩展源码"></a>获取PHP MySQL扩展源码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com ext]# git clone https://github.com/php/pecl-database-mysql mysql --recursive</div><div class="line">Cloning into &apos;mysql&apos;...</div><div class="line">remote: Counting objects: 145, done.</div><div class="line">remote: Total 145 (delta 0), reused 0 (delta 0), pack-reused 145</div><div class="line">Receiving objects: 100% (145/145), 88.41 KiB | 0 bytes/s, done.</div><div class="line">Resolving deltas: 100% (65/65), done.</div><div class="line">Checking connectivity... done.</div></pre></td></tr></table></figure>
<h3 id="编译安装MySQL扩展"><a href="#编译安装MySQL扩展" class="headerlink" title="编译安装MySQL扩展"></a>编译安装MySQL扩展</h3><h4 id="使用phpize编译"><a href="#使用phpize编译" class="headerlink" title="使用phpize编译"></a>使用<code>phpize</code>编译</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com ext]# cd mysql</div><div class="line">[root@opstrip.com mysql]# ls</div><div class="line">config.m4  config.w32  CREDITS  LICENSE  mysql.mak  mysql_mysqlnd.h  package.xml  php_mysql.c  php_mysql.h  php_mysql_structs.h  README.md  tests</div><div class="line">[root@opstrip.com mysql]# /usr/local/php/bin/phpize</div><div class="line">Configuring for:</div><div class="line">PHP Api Version:         20151012</div><div class="line">Zend Module Api No:      20151012</div><div class="line">Zend Extension Api No:   320151012</div><div class="line">[root@opstrip.com mysql]# ./configure --with-php-config=/usr/local/php/bin/php-config</div></pre></td></tr></table></figure>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com mysql]# make &amp;&amp; make install</div><div class="line">[root@opstrip.com mysql]# ls /usr/local/php/lib/php/extensions/no-debug-non-zts-20160303/</div><div class="line">mysql.so  opcache.a  opcache.so</div></pre></td></tr></table></figure>
<p>安装完成后需确认<code>MySQL扩展</code>安装是否正确。<br>最后修改<code>php.ini</code>配置文件，增加一行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extension = &quot;mysql.so&quot;</div></pre></td></tr></table></figure></p>
<p>重新启动<code>php-fpm服务</code>就能在<code>phpinfo</code>里看到<code>MySQL扩展</code>了：<br><img src="/assets/blogImg/mysql.png" alt="查看MySQL扩展"></p>
<h2 id="开启Memcache扩展-仅编译安装"><a href="#开启Memcache扩展-仅编译安装" class="headerlink" title="开启Memcache扩展(仅编译安装)"></a>开启Memcache扩展(仅编译安装)</h2><p>php7.0之前版本正常编译安装memcache扩展就可以了，但是php7.0及以后的版本安装<a href="http://pecl.php.net/package/memcache" target="_blank" rel="external">http://pecl.php.net/package/memcache</a>下的任一款memcache都会报错。<br>这是因为一些文件及目录变动导致的，可移步Github的pecl-memcache分支版本下载。<br><a href="https://github.com/websupport-sk/pecl-memcache/archive/php7.zip" target="_blank" rel="external">https://github.com/websupport-sk/pecl-memcache/archive/php7.zip</a></p>
<h3 id="下载并编译安装Memcache"><a href="#下载并编译安装Memcache" class="headerlink" title="下载并编译安装Memcache"></a>下载并编译安装Memcache</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@opstrip.com ext]# wget https://github.com/websupport-sk/pecl-memcache/archive/php7.zip</div><div class="line">[root@opstrip.com ext]# unzip php7.zip</div><div class="line">[root@opstrip.com ext]# cd pecl-memcache-php7</div><div class="line">[root@opstrip.com pecl-memcache-php7]# /usr/local/php/bin/phpize</div><div class="line">[root@opstrip.com pecl-memcache-php7]# ./configure --with-php-config=/usr/local/php/bin/php-config</div><div class="line">[root@opstrip.com pecl-memcache-php7]# make &amp;&amp; make install</div><div class="line">[root@opstrip.com mysql]# ls /usr/local/php/lib/php/extensions/no-debug-non-zts-20160303/</div><div class="line">mysql.so  opcache.a  opcache.so memcache.so</div></pre></td></tr></table></figure>
<h3 id="添加配置文件"><a href="#添加配置文件" class="headerlink" title="添加配置文件"></a>添加配置文件</h3><p>修改<code>php.ini</code>配置文件，增加一行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">extension = &quot;memcache.so&quot;</div></pre></td></tr></table></figure></p>
<p>重新启动<code>php-fpm</code>，如果无报错，则打开phpinfo探针页面应该能在网页中找到Memcache项。如下图：<br><img src="/assets/blogImg/memcache.png" alt="Memcache扩展"></p>
<p>--本配置完。</p>
<hr>
<p>参考来源：</p>
<ul>
<li><a href="https://www.howtoforge.com/tutorial/centos-lamp-server-apache-mysql-php/" target="_blank" rel="external">https://www.howtoforge.com/tutorial/centos-lamp-server-apache-mysql-php/</a></li>
<li><a href="http://www.jianshu.com/p/871fd9518e29" target="_blank" rel="external">http://www.jianshu.com/p/871fd9518e29</a></li>
<li><a href="https://zohead.com/archives/php7-mysql/" target="_blank" rel="external">https://zohead.com/archives/php7-mysql/</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      介绍两种在CentOS7上安装PHP7.1的方式：yum安装和源码编译安装，并在编译安装PHP7.1后打开MySQL扩展、Memcache扩展。
    
    </summary>
    
      <category term="yum" scheme="https://opstrip.com/categories/yum/"/>
    
      <category term="CentOS7" scheme="https://opstrip.com/categories/yum/CentOS7/"/>
    
      <category term="Linux" scheme="https://opstrip.com/categories/yum/CentOS7/Linux/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/categories/yum/CentOS7/Linux/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
    
      <category term="CentOS7" scheme="https://opstrip.com/tags/CentOS7/"/>
    
      <category term="Linux" scheme="https://opstrip.com/tags/Linux/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/tags/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
  </entry>
  
  <entry>
    <title>阿里云：在ECS上挂载ossfs</title>
    <link href="https://opstrip.com/2017/05/26/Mounting-ossfs-on-ECS/"/>
    <id>https://opstrip.com/2017/05/26/Mounting-ossfs-on-ECS/</id>
    <published>2017-05-26T03:05:37.000Z</published>
    <updated>2017-09-19T05:44:15.678Z</updated>
    
    <content type="html"><![CDATA[<h3 id="OSS与CDN"><a href="#OSS与CDN" class="headerlink" title="OSS与CDN"></a>OSS与CDN</h3><h4 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h4><p><code>阿里云OSS</code>（Object Storage Service，对象存储服务）是阿里云提供的对象存储服务，具有以下特点：</p>
<ul>
<li>可以提供海量的文件存储，具有无限可伸缩能力；</li>
<li>有遍布全国及海外的数据中心，满足不同区域用户的使用；</li>
<li>服务稳定，达到7个9；</li>
<li>价格便宜；</li>
<li>与阿里云其他云产品组成生态体系，无缝衔接，自带图片处理服务，可以满足多种多样的业务场景；</li>
<li>技术团队可以提供7×24小时的技术支持。除此之外，OSS还支持更加强大的权限体系，可以满足更加复杂的场景，并且具有极好的数据安全性。</li>
</ul>
<h4 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h4><p><code>CDN</code>（Content Delivery Network，即内容分发网络），其基本思路是尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环节，使内容传输的更快、更稳定。通过在网络各处放置节点服务器所构成的在现有的互联网基础之上的一层智能虚拟网络，CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。</p>
<p>综上，OSS就是云存储（也有些计算能力，如图片处理等），CDN就是网络优化。</p>
<h3 id="权限配置"><a href="#权限配置" class="headerlink" title="权限配置"></a>权限配置</h3><a id="more"></a>
<p>在OSS中新建Bucket。假设BucketName为<code>example</code>，所属区域为<code>华东2</code>，读写权限<code>私有</code>，因此这个Bucket的外网链接地址为：<a href="http://example.oss-cn-shanghai.aliyuncs.com" target="_blank" rel="external">http://example.oss-cn-shanghai.aliyuncs.com</a>，内网地址为：<a href="http://example.oss-cn-shanghai-internal.aliyuncs.com" target="_blank" rel="external">http://example.oss-cn-shanghai-internal.aliyuncs.com</a>。<br>创建完Bucket后就已经将ossfs挂载到ECS主机了。ossfs挂载需要用到<code>AccessKey</code>，即<code>AccessKeyID</code>和<code>AccessKeySecret</code>。<code>AccessKey</code>是与用户权限一一对应的（可以在AccessKey管理中创建），所以在挂载ossfs的时候需要做<code>访问控制</code>来严格限制权限。<br>在<code>访问控制RAM</code>的<code>用户管理</code>中创建用户<code>user</code>，在<code>策略管理</code>中创建自定义策略<code>example</code>，策略内容如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="attr">  "Statement":</span> <span class="string">[</span></div><div class="line">    <span class="string">&#123;</span></div><div class="line"><span class="attr">      "Action":</span> <span class="string">"oss:*"</span><span class="string">,</span></div><div class="line"><span class="attr">      "Effect":</span> <span class="string">"Allow"</span><span class="string">,</span></div><div class="line"><span class="attr">      "Resource":</span> <span class="string">[</span></div><div class="line">        <span class="string">"acs:oss:*:*:example"</span><span class="string">,</span></div><div class="line">        <span class="string">"acs:oss:*:*:example/*"</span></div><div class="line">      <span class="string">]</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line">  <span class="string">],</span></div><div class="line"><span class="attr">  "Version":</span> <span class="string">"1"</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure></p>
<p>完成在<code>用户管理</code>中将策略<code>example</code>授权给<code>user</code>用户。进入<code>user</code>用户的<code>用户详情</code>，在<code>用户AccessKey</code>中<code>创建AccessKey</code>并保存下<code>AccessKeyID</code>和<code>AccessKeySecret</code>备用。</p>
<h3 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h3><p>下载安装<code>ossfs</code>安装包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ wget https://github.com/aliyun/ossfs/releases/download/v1.80.0/ossfs_1.80.0_centos7.0_x86_64.rpm</div><div class="line">$ sudo yum localinstall -y ossfs_1.80.0_centos7.0_x86_64.rpm</div></pre></td></tr></table></figure></p>
<p>创建<code>/etc/passwd-ossfs</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo <span class="built_in">echo</span> example:aAaAAAaaaAAaa:BbBBBBBbbbbbbbbbbB &gt; /etc/passwd-ossfs</div><div class="line">$ sudo chmod 640 /etc/passwd-ossfs</div><div class="line">$ sudo mkdir -p /data/example</div></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>说明</strong>：<strong>/etc/passwd-ossfs</strong>文件格式是<strong>BucketName:AccessKeyID:AccessKeySecret</strong>，权限建议<strong>640</strong>。</p>
</blockquote>
<h3 id="挂载ossfs"><a href="#挂载ossfs" class="headerlink" title="挂载ossfs"></a>挂载<code>ossfs</code></h3><p>均以上面的<code>example</code>为例。</p>
<h4 id="经典网络"><a href="#经典网络" class="headerlink" title="经典网络"></a>经典网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo ossfs example /data/example -ourl=http://oss-cn-shanghai-internal.aliyuncs.com -oallow_other</div></pre></td></tr></table></figure>
<h4 id="私有网络"><a href="#私有网络" class="headerlink" title="私有网络"></a>私有网络</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo ossfs example /data/example -ourl=http://vpc100-oss-cn-shanghai.aliyuncs.com -oallow_other</div></pre></td></tr></table></figure>
<p>详细参考：<a href="https://help.aliyun.com/document_detail/31837.html?spm=5176.7739584.2.2.M93hk9" target="_blank" rel="external">https://help.aliyun.com/document_detail/31837.html?spm=5176.7739584.2.2.M93hk9</a></p>
<h3 id="配置开机自启"><a href="#配置开机自启" class="headerlink" title="配置开机自启"></a>配置开机自启</h3><p>最后可以将这条命令写入到开机启动脚本里实现开机自动挂载。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ sudo vi /etc/rc.d/rc.local</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment"># THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># It is highly advisable to create own systemd services or udev rules</span></div><div class="line"><span class="comment"># to run scripts during boot instead of using this file.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># In contrast to previous versions due to parallel execution during boot</span></div><div class="line"><span class="comment"># this script will NOT be run after all other services.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure</span></div><div class="line"><span class="comment"># that this script will be executed during boot.</span></div><div class="line"></div><div class="line">touch /var/lock/subsys/<span class="built_in">local</span></div><div class="line">/usr/<span class="built_in">local</span>/bin/ossfs ossfs example /data/example -ourl=http://vpc100-oss-cn-shanghai.aliyuncs.com -oallow_other</div><div class="line">$ sudo chmod +x /etc/rc.d/rc.local</div></pre></td></tr></table></figure>
<p>参考来源：<a href="https://github.com/aliyun/ossfs/blob/master/README.md" target="_blank" rel="external">https://github.com/aliyun/ossfs/blob/master/README.md</a></p>
]]></content>
    
    <summary type="html">
    
      ossfs 能让您在Linux/Mac OS X 系统中把Aliyun OSS bucket 挂载到本地文件 系统中，您能够便捷的通过本地文件系统操作OSS 上的对象，实现数据的共享。
    
    </summary>
    
      <category term="阿里云" scheme="https://opstrip.com/categories/%E9%98%BF%E9%87%8C%E4%BA%91/"/>
    
      <category term="学习笔记" scheme="https://opstrip.com/categories/%E9%98%BF%E9%87%8C%E4%BA%91/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="CentOS" scheme="https://opstrip.com/categories/%E9%98%BF%E9%87%8C%E4%BA%91/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/CentOS/"/>
    
    
      <category term="阿里云" scheme="https://opstrip.com/tags/%E9%98%BF%E9%87%8C%E4%BA%91/"/>
    
      <category term="ECS" scheme="https://opstrip.com/tags/ECS/"/>
    
      <category term="oss" scheme="https://opstrip.com/tags/oss/"/>
    
      <category term="挂载" scheme="https://opstrip.com/tags/%E6%8C%82%E8%BD%BD/"/>
    
      <category term="ossfs" scheme="https://opstrip.com/tags/ossfs/"/>
    
  </entry>
  
  <entry>
    <title>9个常用iptables配置实例</title>
    <link href="https://opstrip.com/2017/05/19/nine-kinds-of-usage-for-iptables/"/>
    <id>https://opstrip.com/2017/05/19/nine-kinds-of-usage-for-iptables/</id>
    <published>2017-05-19T02:49:56.000Z</published>
    <updated>2017-05-19T03:22:56.411Z</updated>
    
    <content type="html"><![CDATA[<p>iptables命令可用于配置Linux的包过滤规则，常用于实现防火墙、NAT。咋一看iptables的配置很复杂，掌握规律后，其实用iptables完成指定任务并不难，下面我们通过具体实例，学习iptables的详细用法。</p>
<h3 id="删除已有规则"><a href="#删除已有规则" class="headerlink" title="删除已有规则"></a>删除已有规则</h3><p>在新设定<code>iptables</code>规则时，我们一般先确保旧规则被清除，用以下命令清除旧规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -F</div><div class="line">(or iptables --flush)</div></pre></td></tr></table></figure></p>
<h3 id="设置chain策略"><a href="#设置chain策略" class="headerlink" title="设置chain策略"></a>设置<code>chain策略</code></h3><p>对于filter table，默认的chain策略为ACCEPT，我们可以通过以下命令修改chain的策略：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -P INPUT DROP</div><div class="line">iptables -P FORWARD DROP</div><div class="line">iptables -P OUTPUT DROP</div></pre></td></tr></table></figure></p>
<p>以上命令配置将接收、转发和发出包均丢弃，施行比较严格的包管理。由于接收和发包均被设置为丢弃，当进一步配置其他规则的时候，需要注意针对<code>INPUT</code>和<code>OUTPUT</code>分别配置。当然，如果信任本机器往外发包，以上第三条规则可不必配置。</p>
<h3 id="配置屏蔽指定ip"><a href="#配置屏蔽指定ip" class="headerlink" title="配置屏蔽指定ip"></a>配置<code>屏蔽指定ip</code></h3><p>有时候我们发现某个<code>ip</code>不停的往服务器发包，这时我们可以使用以下命令，将<code>指定ip</code>发来的包丢弃：</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BLOCK_THIS_IP=<span class="string">"x.x.x.x"</span></div><div class="line">iptables -A INPUT -i eth0 -p tcp <span class="_">-s</span> <span class="string">"<span class="variable">$BLOCK_THIS_IP</span>"</span> -j DROP</div></pre></td></tr></table></figure>
<p>以上命令设置将由<code>x.x.x.x</code> <code>ip</code>发往<code>eth0</code>网口的<code>tcp</code>包丢弃。</p>
<h3 id="配置服务项"><a href="#配置服务项" class="headerlink" title="配置服务项"></a>配置<code>服务项</code></h3><p>利用<code>iptables</code>，我们可以对日常用到的服务项进行安全管理，比如设定只能通过指定网段、由指定网口通过<code>SSH</code>连接本机：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -i eth0 -p tcp <span class="_">-s</span> 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT</div><div class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>若要支持由本机通过<code>SSH</code>连接其他机器，由于在本机端口建立连接，因而还需要设置以下规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -i eth0 -p tcp <span class="_">-s</span> 192.168.100.0/24 --dport 22 -m state --state ESTABLESHED -j ACCEPT</div><div class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state NEW,ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>类似的，对于<code>HTTP/HTTPS(80/443)</code>、<code>pop3(110)</code>、<code>rsync(873)</code>、<code>MySQL(3306)</code>等<code>基于tcp连接</code>的服务，也可以参照上述命令配置。</p>
<p>对于基于<code>udp</code>的<code>dns服务</code>，使用以下命令开启<code>端口服务</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPT</div><div class="line">iptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT</div></pre></td></tr></table></figure></p>
<h3 id="配置网口转发"><a href="#配置网口转发" class="headerlink" title="配置网口转发"></a>配置<code>网口转发</code></h3><p>对于用作防火墙或网关的服务器，一个网口连接到公网，其他网口的包转发到该网口实现内网向公网通信，假设<code>eth0</code>连接内网，<code>eth1</code>连接公网，配置规则如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT</div></pre></td></tr></table></figure></p>
<h3 id="配置端口转发"><a href="#配置端口转发" class="headerlink" title="配置端口转发"></a>配置<code>端口转发</code></h3><p>对于端口，我们也可以运用<code>iptables</code>完成转发配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp <span class="_">-d</span> 172.16.12.37 --dport 40022 -j DNAT --to 172.16.12.37:22</div></pre></td></tr></table></figure></p>
<p>以上命令将<code>40022</code>端口的包转发到<code>22</code>端口，因而通过<code>40022</code>端口也可进行<code>SSH</code>连接，当然对于<code>40022</code>端口，我们也需要像以上<code>“4.配置服务项”</code>一节一样，配置其支持连接建立的规则。</p>
<h3 id="配置DoS攻击防范"><a href="#配置DoS攻击防范" class="headerlink" title="配置DoS攻击防范"></a>配置<code>DoS攻击防范</code></h3><p>利用<code>扩展模块limit</code>，我们还可以配置<code>iptables</code>规则，实现<code>DoS攻击防范</code>：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p tcp --dport 80 -m <span class="built_in">limit</span> --limit 25/minute --limit-burst 100 -j ACCEPT</div></pre></td></tr></table></figure></p>
<p><code>--litmit 25/minute</code> 指示每分钟限制最大连接数为<code>25</code><br><code>--litmit-burst 100</code> 指示当总连接数超过<code>100</code>时，启动<code>litmit/minute</code>限制</p>
<h3 id="配置web流量均衡"><a href="#配置web流量均衡" class="headerlink" title="配置web流量均衡"></a>配置<code>web流量均衡</code></h3><p>我们可以将一台服务器作为前端服务器，利用<code>iptables</code>进行<code>流量分发</code>，配置方法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.101:80</div><div class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.102:80</div><div class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.103:80</div></pre></td></tr></table></figure></p>
<p>以上配置规则用到<code>nth扩展模块</code>，将<code>80端口</code>的<code>流量均衡</code>到三台服务器。</p>
<h3 id="配置日志记录"><a href="#配置日志记录" class="headerlink" title="配置日志记录"></a>配置<code>日志记录</code></h3><p>使用<code>LOG目标</code>和<code>syslog服务</code>，我们可以记录某协议某端口下的收发包情况。拿记录丢包情况举例，可以通过以下方式实现。</p>
<h4 id="首先自定义一个chain："><a href="#首先自定义一个chain：" class="headerlink" title="首先自定义一个chain："></a>首先自定义一个chain：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -N LOGGING</div></pre></td></tr></table></figure>
<h4 id="其次将所有接收包导入LOGGING-chain中："><a href="#其次将所有接收包导入LOGGING-chain中：" class="headerlink" title="其次将所有接收包导入LOGGING chain中："></a>其次将所有接收包导入<code>LOGGING chain</code>中：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -j LOGGING</div></pre></td></tr></table></figure>
<h4 id="然后设置日志前缀、日志级别："><a href="#然后设置日志前缀、日志级别：" class="headerlink" title="然后设置日志前缀、日志级别："></a>然后设置日志前缀、日志级别：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A LOGGING -m <span class="built_in">limit</span> --limit 2/min -j LOG --log-prefix <span class="string">"IPTables Packet Dropped: "</span> --log-level 7</div></pre></td></tr></table></figure>
<h4 id="最后将包导向DROP，将包丢弃："><a href="#最后将包导向DROP，将包丢弃：" class="headerlink" title="最后将包导向DROP，将包丢弃："></a>最后将包导向<code>DROP</code>，将包丢弃：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A LOGGING -j DROP</div></pre></td></tr></table></figure>
<h4 id="另可以配置syslog-conf文件，指定iptables的日志输出。"><a href="#另可以配置syslog-conf文件，指定iptables的日志输出。" class="headerlink" title="另可以配置syslog.conf文件，指定iptables的日志输出。"></a>另可以配置<code>syslog.conf</code>文件，指定<code>iptables</code>的<code>日志输出</code>。</h4>]]></content>
    
    <summary type="html">
    
      介绍Linux中最迷人最神秘用途最大配置灵活的防火墙iptables的9大基本用法。包括清除已有规则、chain策略、屏蔽指定IP、服务项及指定端口、网络及端口的转发、DOS攻击防范、WEB流量均衡和丢弃包的情况写入日志等的配置。
    
    </summary>
    
      <category term="技术分享" scheme="https://opstrip.com/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
      <category term="备忘录" scheme="https://opstrip.com/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/%E5%A4%87%E5%BF%98%E5%BD%95/"/>
    
      <category term="iptables" scheme="https://opstrip.com/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/%E5%A4%87%E5%BF%98%E5%BD%95/iptables/"/>
    
    
      <category term="iptables" scheme="https://opstrip.com/tags/iptables/"/>
    
      <category term="chain策略" scheme="https://opstrip.com/tags/chain%E7%AD%96%E7%95%A5/"/>
    
      <category term="屏蔽指定IP" scheme="https://opstrip.com/tags/%E5%B1%8F%E8%94%BD%E6%8C%87%E5%AE%9AIP/"/>
    
      <category term="WEB流量均衡" scheme="https://opstrip.com/tags/WEB%E6%B5%81%E9%87%8F%E5%9D%87%E8%A1%A1/"/>
    
      <category term="DOS攻击防范" scheme="https://opstrip.com/tags/DOS%E6%94%BB%E5%87%BB%E9%98%B2%E8%8C%83/"/>
    
      <category term="网络转发" scheme="https://opstrip.com/tags/%E7%BD%91%E7%BB%9C%E8%BD%AC%E5%8F%91/"/>
    
      <category term="端口转发" scheme="https://opstrip.com/tags/%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>在CentOS7上配置LNMP环境：PHP篇</title>
    <link href="https://opstrip.com/2017/04/07/LNMP-on-CentOS7-02/"/>
    <id>https://opstrip.com/2017/04/07/LNMP-on-CentOS7-02/</id>
    <published>2017-04-07T03:15:14.000Z</published>
    <updated>2017-07-10T06:24:01.686Z</updated>
    
    <content type="html"><![CDATA[<p>上篇介绍了<code>Nginx</code>的安装配置及<code>Let&#39;s Encrypt</code>证书的自动签发与自动续期。这里主要介绍<code>PHP</code>的安装及在<code>Nginx</code>中的转发配置。</p>
<h3 id="安装PHP"><a href="#安装PHP" class="headerlink" title="安装PHP"></a>安装PHP</h3><h4 id="1、安装依赖"><a href="#1、安装依赖" class="headerlink" title="1、安装依赖"></a>1、安装依赖</h4><p>编译安装PHP之前需要安装PHP依赖包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# yum -y install gd-devel libjpeg-devel libpng-devel libiconv-devel freetype-devel libxml2 libxml2-devel curl-devel libxslt-devel libmcrypt-devel mhash mcrypt php-mysql</div></pre></td></tr></table></figure></p>
<p>完成后需在 <a href="https://downloads.mysql.com/archives/community/" target="_blank" rel="external">https://downloads.mysql.com/archives/community/</a> 下载安装<code>mysql-devel</code>、<code>mysql-shared</code>、<code>mysql-client</code>三个rpm包。<br>对于64位系统的主机，还需如下操作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# ln -s /usr/lib64/libmysqlclient.so.16.0.0 /usr/lib/libmysqlclient.so</div><div class="line">[root@opstrip opt]# ln -s /usr/lib64/libmysqlclient_r.so.16.0.0 /usr/lib/libmysqlclient_r.so</div></pre></td></tr></table></figure></p>
<p>在 <a href="http://php.net/get/php-5.6.30.tar.gz/from/a/mirror" target="_blank" rel="external">http://php.net/get/php-5.6.30.tar.gz/from/a/mirror</a> 下载<code>php-5.6.30.tar.gz</code>并上传至虚拟主机，此处为<code>/opt</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# tar xf php-5.6.30.tar.gz</div><div class="line">[root@opstrip opt]# cd php-5.6.30</div></pre></td></tr></table></figure></p>
<h4 id="2、编译安装PHP"><a href="#2、编译安装PHP" class="headerlink" title="2、编译安装PHP"></a>2、编译安装PHP</h4><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"># 编译PHP</div><div class="line">[root@opstrip php-5.6.30]# ./configure --prefix=/usr \</div><div class="line">--with-config-file-path=/etc/php-fpm \</div><div class="line">--with-openssl \</div><div class="line">--with-pcre-regex \</div><div class="line">--with-kerberos \</div><div class="line">--with-libdir=lib \</div><div class="line">--with-libxml-dir \</div><div class="line">--with-mysql \</div><div class="line">--with-mysqli \</div><div class="line">--with-pdo-mysql \</div><div class="line">--with-pdo-sqlite \</div><div class="line">--with-gd \</div><div class="line">--with-iconv \</div><div class="line">--with-zlib \</div><div class="line">--with-zlib-dir=/usr/lib/php/extensions/no-debug-zts-20131226/ \</div><div class="line">--with-xmlrpc \</div><div class="line">--with-xsl \</div><div class="line">--with-pear \</div><div class="line">--with-gettext \</div><div class="line">--with-curl \</div><div class="line">--with-png-dir \</div><div class="line">--with-jpeg-dir \</div><div class="line">--with-freetype-dir \</div><div class="line">--with-fpm-user=www \</div><div class="line">--with-fpm-group=www \</div><div class="line">--enable-mysqlnd \</div><div class="line">--enable-zip \</div><div class="line">--enable-inline-optimization \</div><div class="line">--enable-shared \</div><div class="line">--enable-libxml \</div><div class="line">--enable-xml \</div><div class="line">--enable-bcmath \</div><div class="line">--enable-shmop \</div><div class="line">--enable-sysvsem \</div><div class="line">--enable-mbregex \</div><div class="line">--enable-mbstring \</div><div class="line">--enable-ftp \</div><div class="line">--enable-gd-native-ttf \</div><div class="line">--enable-pcntl \</div><div class="line">--enable-soap \</div><div class="line">--enable-session \</div><div class="line">--enable-opcache \</div><div class="line">--enable-fpm \</div><div class="line">--enable-maintainer-zts \</div><div class="line">--enable-fileinfo</div><div class="line">[root@opstrip php-5.6.30]# make &amp;&amp; make install             # 编译并安装PHP</div><div class="line">[root@opstrip php-5.6.30]# php -v                           # 查看Nginx版本以确认安装成功</div><div class="line">PHP 5.6.30 (cli) (built: Apr  6 2017 15:50:41) </div><div class="line">Copyright (c) 1997-2016 The PHP Group</div><div class="line">Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies</div></pre></td></tr></table></figure>
<h3 id="配置PHP"><a href="#配置PHP" class="headerlink" title="配置PHP"></a>配置PHP</h3><h4 id="3、安装后的配置"><a href="#3、安装后的配置" class="headerlink" title="3、安装后的配置"></a>3、安装后的配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# cp /opt/php-5.6.30/php.ini-development /etc/php.ini</div></pre></td></tr></table></figure>
<p>编辑<code>php.ini</code>文件，搜索并添加如下内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">extension_dir = &quot;/usr/lib/php/extensions/no-debug-zts-20131226/&quot;</div><div class="line">session.save_path = &quot;/usr/tmp&quot;</div><div class="line">date.timezone = PRC</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# mkdir -p /etc/php-fpm.d</div><div class="line">[root@opstrip opt]# cp /usr/etc/php-fpm.conf.default /etc/sysconfig/php-fpm.conf</div><div class="line">[root@opstrip opt]# cp /usr/etc/php-fpm.d/www.conf.default /etc/php-fpm.d/www.conf</div><div class="line">[root@opstrip opt]# cp /opt/php-5.6.30/sapi/fpm/php-fpm.service.in /usr/lib/systemd/system/php-fpm.service</div><div class="line">[root@opstrip opt]# vi /usr/lib/systemd/system/php-fpm.service </div><div class="line"># It&apos;s not recommended to modify this file in-place, because it</div><div class="line"># will be overwritten during upgrades.  If you want to customize,</div><div class="line"># the best way is to use the &quot;systemctl edit&quot; command.</div><div class="line">    </div><div class="line">[Unit]</div><div class="line">Description=The PHP FastCGI Process Manager</div><div class="line">After=network.target</div><div class="line">    </div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">PIDFile=/usr/var/run/php-fpm.pid</div><div class="line">ExecStart=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/sysconfig/php-fpm.conf</div><div class="line">ExecReload=/bin/kill -USR2 $MAINPID</div><div class="line">PrivateTmp=true</div><div class="line">    </div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">[root@opstrip opt]# systemctl enable php-fpm                # 使php-fpm开机启动</div><div class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/php-fpm.service to /usr/lib/systemd/system/php-fpm.service.</div><div class="line">[root@opstrip opt]# systemctl start php-fpm                 # 启动php-fpm服务</div><div class="line">[root@opstrip opt]# ps -ef|grep php-fpm                     # 查看php-fpm进程</div><div class="line">root     14563     1  0 11:23 ?        00:00:00 php-fpm: master process (/etc/sysconfig/php-fpm.conf)</div><div class="line">www      14564 14563  0 11:23 ?        00:00:00 php-fpm: pool www</div><div class="line">www      14565 14563  0 11:23 ?        00:00:00 php-fpm: pool www</div><div class="line">root     14567 14426  0 11:23 pts/2    00:00:00 grep --color=auto php-fpm</div></pre></td></tr></table></figure>
<h3 id="配置基于PHP的虚拟主机"><a href="#配置基于PHP的虚拟主机" class="headerlink" title="配置基于PHP的虚拟主机"></a>配置基于PHP的虚拟主机</h3><h4 id="4、PHP虚拟主机配置"><a href="#4、PHP虚拟主机配置" class="headerlink" title="4、PHP虚拟主机配置"></a>4、PHP<code>虚拟主机</code>配置</h4><p>安装好<code>php-fpm</code>后，就可以放PHP网站了。先整个<code>wordpress</code>玩玩。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"># 获取网站的Html代码</div><div class="line">[root@opstrip opt]# wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz</div><div class="line">[root@opstrip opt]# tar xf wordpress-4.7.3-zh_CN.tar.gz</div><div class="line">[root@opstrip opt]# mv wordpress wwwroot</div><div class="line">[root@opstrip opt]# vi /etc/nginx/conf.d/wordpress.conf</div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    #listen [::]:80 ssl ipv6only=on; </div><div class="line">    server_name wp.opstrip.com;</div><div class="line">    root /opt/wwwroot/;</div><div class="line">    index index.php;</div><div class="line">    location ~ \.php$ &#123;</div><div class="line">        fastcgi_pass 127.0.0.1:9000;</div><div class="line">        fastcgi_index index.php;</div><div class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</div><div class="line">        include fastcgi_params;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"># HTTPS server</div><div class="line">    </div><div class="line">server &#123;</div><div class="line">    listen       443 ssl;</div><div class="line">    #listen [::]:443 ssl ipv6only=on;</div><div class="line">    server_name  wp.opstrip.com;</div><div class="line">    </div><div class="line">    ssl on;</div><div class="line">    ssl_certificate      /etc/letsencrypt/live/opstrip.com/fullchain.pem;</div><div class="line">    ssl_certificate_key  /etc/letsencrypt/live/opstrip.com/privkey.pem;</div><div class="line">    </div><div class="line">    ssl_session_cache    shared:SSL:1m;</div><div class="line">    ssl_session_timeout  5m;</div><div class="line">    </div><div class="line">    #ssl_ciphers  HIGH:!aNULL:!MD5;</div><div class="line">    #ssl_prefer_server_ciphers  on;</div><div class="line">    </div><div class="line">    root /opt/wwwroot/;</div><div class="line">    index index.php;</div><div class="line">    location ~ \.php$ &#123;</div><div class="line">        fastcgi_pass 127.0.0.1:9000;</div><div class="line">        fastcgi_index index.php;</div><div class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</div><div class="line">        include fastcgi_params;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">[root@opstrip opt]# systemctl reload nginx</div></pre></td></tr></table></figure></p>
<p>本地ping下<code>wp.opstrip.com</code>，如果<code>DNS</code>已经生效用浏览器打开 <a href="http://wp.opstrip.com" target="_blank" rel="external">http://wp.opstrip.com</a> 就开始安装<code>wordpress</code>了。具体可参考<a href="https://codex.wordpress.org/zh-cn:%E5%AE%89%E8%A3%85_WordPress" target="_blank" rel="external">官方文档：zh-cn:安装 WordPress</a>，根据需要配置数据库参数。因为使用的是<code>RDS</code>，所以需要在安装前从<code>EC2</code>登录到<code>RDS</code>创建数据库并授权给相应数据库账户。</p>
<p>--LNMP配置介绍完毕。</p>
]]></content>
    
    <summary type="html">
    
      介绍使用CentOS7搭建LNMP环境，本篇主要介绍PHP安装配置与Nginx的转发配置。
    
    </summary>
    
      <category term="linux" scheme="https://opstrip.com/categories/linux/"/>
    
      <category term="CentOS7" scheme="https://opstrip.com/categories/linux/CentOS7/"/>
    
      <category term="LNMP" scheme="https://opstrip.com/categories/linux/CentOS7/LNMP/"/>
    
      <category term="PHP" scheme="https://opstrip.com/categories/linux/CentOS7/LNMP/PHP/"/>
    
      <category term="RDS" scheme="https://opstrip.com/categories/linux/CentOS7/LNMP/PHP/RDS/"/>
    
      <category term="AWS" scheme="https://opstrip.com/categories/linux/CentOS7/LNMP/PHP/RDS/AWS/"/>
    
    
      <category term="CentOS7" scheme="https://opstrip.com/tags/CentOS7/"/>
    
      <category term="LNMP" scheme="https://opstrip.com/tags/LNMP/"/>
    
      <category term="搭建配置" scheme="https://opstrip.com/tags/%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>在CentOS7上配置LNMP环境：Nginx篇</title>
    <link href="https://opstrip.com/2017/04/05/LNMP-on-CentOS7-01/"/>
    <id>https://opstrip.com/2017/04/05/LNMP-on-CentOS7-01/</id>
    <published>2017-04-05T08:15:14.000Z</published>
    <updated>2017-07-10T06:26:25.672Z</updated>
    
    <content type="html"><![CDATA[<p>早就听说AWS的大名了，信用卡办下来后第一件事就是申请了个AWS的账号，买了美东的EC2（CentOS7）及RDS（MySQL5.6）资源各一。当然都是免费套餐中的，不管怎样总算是终于有了自己的主机了。<br>老规矩，初始化CentOS7，放上自己的key，配置好安全组打通EC2与RDS之间的网络，测试了下发现通了。</p>
<p>因为之前使用的GitHub Pages博客一直都是静态的Html，所以这次打算直接丢到EC2上先用nginx跑起来，然后将国外线路解析到这台EC2上，国内线路用 <a href="https://portal.qiniu.com/signup?code=3liil4gl9pkr6" target="_blank" rel="external">七牛的CDN</a> 的，相册中的照片也是存贮在七牛的。<br>一步步来吧，先整个Nginx。</p>
<h3 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h3><h4 id="1、安装Nginx依赖及常用软件包"><a href="#1、安装Nginx依赖及常用软件包" class="headerlink" title="1、安装Nginx依赖及常用软件包"></a>1、安装Nginx依赖及常用软件包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# yum -y install net-tools git gcc rsync  lrzsz telnet wget ntp dstat mlocate bind-utils nscd psmisc python-devel python-pip mtr chrony gcc gcc-c++ autoconf automake zlib zlib-devel openssl openssl-devel pcre-devel</div></pre></td></tr></table></figure>
<h4 id="2、安装前的准备"><a href="#2、安装前的准备" class="headerlink" title="2、安装前的准备"></a>2、安装前的准备</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 创建Nginx运行用户</div><div class="line">[root@opstrip opt]# groupadd -r www</div><div class="line">[root@opstrip opt]# useradd -s /sbin/nologin -g www -r www</div><div class="line"># 获取Nginx源码并解压</div><div class="line">[root@opstrip opt]# wget http://nginx.org/download/nginx-1.11.12.tar.gz</div><div class="line">[root@opstrip opt]# tar xf nginx-1.11.12.tar.gz</div><div class="line">[root@opstrip opt]# cd nginx-1.11.12</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="3、编译安装Nginx"><a href="#3、编译安装Nginx" class="headerlink" title="3、编译安装Nginx"></a>3、编译安装Nginx</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"># 编译Nginx</div><div class="line">[root@opstrip nginx-1.11.12]# ./configure \</div><div class="line">--prefix=/etc/nginx \</div><div class="line">--sbin-path=/usr/sbin/nginx \</div><div class="line">--conf-path=/etc/nginx/nginx.conf \</div><div class="line">--error-log-path=/var/log/nginx/error.log \</div><div class="line">--http-log-path=/var/log/nginx/access.log \</div><div class="line">--pid-path=/var/run/nginx.pid \</div><div class="line">--lock-path=/var/run/nginx.lock \</div><div class="line">--http-client-body-temp-path=/var/cache/nginx/client_temp \</div><div class="line">--http-proxy-temp-path=/var/cache/nginx/proxy_temp \</div><div class="line">--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \</div><div class="line">--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \</div><div class="line">--http-scgi-temp-path=/var/cache/nginx/scgi_temp \</div><div class="line">--user=www \</div><div class="line">--group=www \</div><div class="line">--with-http_ssl_module \</div><div class="line">--with-http_realip_module \</div><div class="line">--with-http_addition_module \</div><div class="line">--with-http_sub_module \</div><div class="line">--with-http_dav_module \</div><div class="line">--with-http_flv_module \</div><div class="line">--with-http_mp4_module \</div><div class="line">--with-http_gunzip_module \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--with-http_random_index_module \</div><div class="line">--with-http_secure_link_module \</div><div class="line">--with-http_stub_status_module \</div><div class="line">--with-http_auth_request_module \</div><div class="line">--with-mail_ssl_module \</div><div class="line">--with-file-aio \</div><div class="line">--with-cc-opt=&apos;-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic&apos;</div><div class="line"># 安装Nginx</div><div class="line">[root@opstrip nginx-1.11.12]# make &amp;&amp; make install</div><div class="line"># 查看Nginx版本以确认Nginx安装成功</div><div class="line">[root@opstrip nginx-1.11.12]# nginx -V</div></pre></td></tr></table></figure>
<h4 id="4、配置Nginx服务并启动"><a href="#4、配置Nginx服务并启动" class="headerlink" title="4、配置Nginx服务并启动"></a>4、配置Nginx服务并启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"># 创建Nginx缓存目录并赋予相应权限</div><div class="line">[root@opstrip nginx-1.11.12]# mkdir -p /var/cache/nginx/&#123;client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp&#125;</div><div class="line">[root@opstrip nginx-1.11.12]# chown -R www.www /var/cache/nginx/</div><div class="line"># 将Nginx添加到systemd中</div><div class="line">[root@opstrip nginx-1.11.12]# vi /usr/lib/systemd/system/nginx.service </div><div class="line">[Unit]</div><div class="line">Description=nginx - high performance web server</div><div class="line">Documentation=http://nginx.org/en/docs/</div><div class="line">After=network.target remote-fs.target nss-lookup.target</div><div class="line">  </div><div class="line">[Service]</div><div class="line">Type=forking</div><div class="line">PIDFile=/var/run/nginx.pid</div><div class="line">ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf</div><div class="line">ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf</div><div class="line">ExecReload=/bin/kill -s HUP $MAINPID</div><div class="line">ExecStop=/bin/kill -s QUIT $MAINPID</div><div class="line">PrivateTmp=true</div><div class="line">  </div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line"># 设置nginx开机启动并启动</div><div class="line">[root@opstrip opt]# systemctl enable nginx.service</div><div class="line">[root@opstrip opt]# systemctl start nginx.service</div><div class="line"># 确认nginx进程已启动</div><div class="line">[root@opstrip opt]# ps -ef|grep nginx</div><div class="line">root     12245     1  0 4月05 ?       00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</div><div class="line">www      19228 12245  0 15:02 ?        00:00:00 nginx: worker process</div><div class="line">root     29996 29890  0 16:58 pts/3    00:00:00 grep --color=auto nginx</div></pre></td></tr></table></figure>
<p>这时候浏览器访问<code>http://&lt;EC2的公网ip&gt;</code>，如果<code>安全组</code>与<code>firewalld</code>、<code>selinux</code>配置正确的话访问的应该是<code>nginx</code>的默认页。</p>
<h3 id="配置Nginx虚拟主机"><a href="#配置Nginx虚拟主机" class="headerlink" title="配置Nginx虚拟主机"></a>配置Nginx虚拟主机</h3><h4 id="5、Nginx虚拟主机配置"><a href="#5、Nginx虚拟主机配置" class="headerlink" title="5、Nginx虚拟主机配置"></a>5、Nginx<code>虚拟主机</code>配置</h4><p>是时候放网站了。网站放置前需要把相应的<code>域名解析</code>到这台EC2上，或者就需要<code>绑定本地hosts</code>。这里是将国外线路<code>A记录</code>到这台<code>EC2</code>上，同时添加了个<code>a.opstrip.com</code>域名指向这台<code>EC2</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# git clone https://github.com/opstrip/opstrip.github.io.git      # 克隆GitHub Pages博客中的Html源码</div><div class="line">[root@opstrip opt]# ln -s /opt/opstrip.github.io /usr/share/html</div><div class="line">[root@opstrip opt]# mkdir -p /etc/nginx/conf.d                                      # 将Nginx虚拟机配置文件放入到此目录</div><div class="line">[root@opstrip opt]# vi /etc/nginx/nginx.conf                                        # Nginx主配置文件</div><div class="line">    </div><div class="line">user  www;</div><div class="line">worker_processes  1;</div><div class="line">    </div><div class="line">error_log  /var/log/nginx/error.log;</div><div class="line">error_log  /var/log/nginx/error.log  notice;</div><div class="line">error_log  /var/log/nginx/error.log  info;</div><div class="line">    </div><div class="line">pid        /var/run/nginx.pid;</div><div class="line">    </div><div class="line">events &#123;</div><div class="line">    use epoll;</div><div class="line">    worker_connections 51200;</div><div class="line">    multi_accept on;</div><div class="line">&#125;</div><div class="line">    </div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line">    </div><div class="line">    #log format</div><div class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">                      &apos;&quot;$http_user_agent&quot; $http_x_forwarded_for&apos;;</div><div class="line">                      </div><div class="line">    access_log  /var/log/nginx/access.log  main;</div><div class="line">    </div><div class="line">    server_names_hash_bucket_size 128;</div><div class="line">    client_header_buffer_size 32k;</div><div class="line">    large_client_header_buffers 4 32k;</div><div class="line">    client_max_body_size 50m;</div><div class="line">    </div><div class="line">    sendfile on;</div><div class="line">    tcp_nopush     on;</div><div class="line">    keepalive_timeout 60;</div><div class="line">    tcp_nodelay on;</div><div class="line">    </div><div class="line">    # fastcgi_connect_timeout 300;</div><div class="line">    # fastcgi_send_timeout 300;</div><div class="line">    # fastcgi_read_timeout 300;</div><div class="line">    # fastcgi_buffer_size 64k;</div><div class="line">    # fastcgi_buffers 4 64k;</div><div class="line">    # fastcgi_busy_buffers_size 128k;</div><div class="line">    # fastcgi_temp_file_write_size 256k;</div><div class="line">    </div><div class="line">    gzip on;</div><div class="line">    gzip_min_length  1k;</div><div class="line">    gzip_buffers     4 16k;</div><div class="line">    gzip_http_version 1.0;</div><div class="line">    gzip_comp_level 2;</div><div class="line">    gzip_types       text/plain application/x-javascript text/css application/xml;</div><div class="line">    gzip_vary on;</div><div class="line">    gzip_proxied        expired no-cache no-store private auth;</div><div class="line">    gzip_disable        &quot;MSIE [1-6]\.&quot;;</div><div class="line">    </div><div class="line">    #limit_conn_zone $binary_remote_addr zone=perip:10m;</div><div class="line">    ##If enable limit_conn_zone,add &quot;limit_conn perip 10;&quot; to server section.</div><div class="line">    server_tokens off;</div><div class="line">    </div><div class="line">    #server &#123;</div><div class="line">        #listen       80;</div><div class="line">        #server_name  localhost;</div><div class="line">    </div><div class="line">        #charset koi8-r;</div><div class="line">    </div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line">    </div><div class="line">        #location / &#123;</div><div class="line">            #root   html;</div><div class="line">            #index  index.html index.htm;</div><div class="line">        #&#125;</div><div class="line">    </div><div class="line">        #error_page  404              /404.html;</div><div class="line">    </div><div class="line">        # redirect server error pages to the static page /50x.html</div><div class="line">        #</div><div class="line">        #error_page   500 502 503 504  /50x.html;</div><div class="line">        #location = /50x.html &#123;</div><div class="line">            #root   html;</div><div class="line">        #&#125;</div><div class="line">    </div><div class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</div><div class="line">        #</div><div class="line">        #location ~ \.php$ &#123;</div><div class="line">        #    proxy_pass   http://127.0.0.1;</div><div class="line">        #&#125;</div><div class="line">    </div><div class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</div><div class="line">        #</div><div class="line">        #location ~ \.php$ &#123;</div><div class="line">        #    root           html;</div><div class="line">        #    fastcgi_pass   127.0.0.1:9000;</div><div class="line">        #    fastcgi_index  index.php;</div><div class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</div><div class="line">        #    include        fastcgi_params;</div><div class="line">        #&#125;</div><div class="line">    </div><div class="line">        # deny access to .htaccess files, if Apache&apos;s document root</div><div class="line">        # concurs with nginx&apos;s one</div><div class="line">        #</div><div class="line">        #location ~ /\.ht &#123;</div><div class="line">        #    deny  all;</div><div class="line">        #&#125;</div><div class="line">    #&#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</div><div class="line">    #server &#123;</div><div class="line">    #    listen       8000;</div><div class="line">    #    listen       somename:8080;</div><div class="line">    #    server_name  somename  alias  another.alias;</div><div class="line">    </div><div class="line">    #    location / &#123;</div><div class="line">    #        root   html;</div><div class="line">    #        index  index.html index.htm;</div><div class="line">    #    &#125;</div><div class="line">    #&#125;</div><div class="line">    </div><div class="line">    # HTTPS server</div><div class="line">    </div><div class="line">    #server &#123;</div><div class="line">    #    listen       443 ssl;</div><div class="line">    #    server_name  localhost;</div><div class="line">    </div><div class="line">    #    ssl_certificate      cert.pem;</div><div class="line">    #    ssl_certificate_key  cert.key;</div><div class="line">    </div><div class="line">    #    ssl_session_cache    shared:SSL:1m;</div><div class="line">    #    ssl_session_timeout  5m;</div><div class="line">    </div><div class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</div><div class="line">    #    ssl_prefer_server_ciphers  on;</div><div class="line">    </div><div class="line">    #    location / &#123;</div><div class="line">    #        root   html;</div><div class="line">    #        index  index.html index.htm;</div><div class="line">    #    &#125;</div><div class="line">    #&#125;</div><div class="line">    include conf.d/*.conf;</div><div class="line">&#125;</div><div class="line">[root@opstrip opt]# vi /etc/nginx/conf.d/opstrip.conf</div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    listen [::]:80 ssl ipv6only=on; </div><div class="line">    server_name  opstrip.com www.opstrip.com a.opstrip.com;</div><div class="line">    </div><div class="line">    #charset koi8-r;</div><div class="line">    </div><div class="line">    #access_log  logs/host.access.log  main;</div><div class="line">    root /usr/share/html;</div><div class="line">    index index.html index.htm README README.txt;</div><div class="line">    location / &#123;</div><div class="line">        root   /usr/share/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    error_page  404              /404.html;</div><div class="line">    </div><div class="line">    # redirect server error pages to the static page /50x.html</div><div class="line">    error_page   500 502 503 504  /50x.html;</div><div class="line">    location = /50x.html &#123;</div><div class="line">        root   html;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">[root@opstrip opt]# systemctl reload nginx</div></pre></td></tr></table></figure></p>
<p>本地ping下<code>a.opstrip.com</code>，如果DNS已经生效用浏览器打开 <a href="http://a.opstrip.com" target="_blank" rel="external">http://a.opstrip.com</a> 博客就可以展现出来了。</p>
<h3 id="获取并配置SSL证书"><a href="#获取并配置SSL证书" class="headerlink" title="获取并配置SSL证书"></a>获取并配置SSL证书</h3><h4 id="6、使用Let‘s-encrypt免费证书"><a href="#6、使用Let‘s-encrypt免费证书" class="headerlink" title="6、使用Let‘s encrypt免费证书"></a>6、使用Let‘s encrypt免费证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/letsencrypt/letsencrypt</div><div class="line">cd letsencrypt/</div><div class="line">./certbot-auto certonly --webroot --agree-tos -v -t --email shiyao.zh@gmail.com -w /usr/share/html -d opstrip.com,www.opstrip.com,a.opstrip.com</div></pre></td></tr></table></figure>
<p>以上命令使用<code>certbot</code>的<code>webroot</code>方式获取，<code>-w</code>表示网站路径，<code>-d</code>表示域名，可以多个。遗憾的是还不支持泛域名。<br>由于机器是在墙外，只要DNS解析没问题，很容易就能通过验证。验证成功会返回类似如下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">IMPORTANT NOTES:</div><div class="line"> - Congratulations! Your certificate and chain have been saved at</div><div class="line">   /etc/letsencrypt/live/opstrip.com/fullchain.pem. Your cert will</div><div class="line">   expire on 2017-07-04. To obtain a new or tweaked version of this</div><div class="line">   certificate in the future, simply run certbot-auto again. To</div><div class="line">   non-interactively renew *all* of your certificates, run</div><div class="line">   &quot;certbot-auto renew&quot;</div><div class="line"> - If you like Certbot, please consider supporting our work by:</div><div class="line">           </div><div class="line">   Donating to ISRG / Let&apos;s Encrypt:   https://letsencrypt.org/donate</div><div class="line">   Donating to EFF:                    https://eff.org/donate-le</div></pre></td></tr></table></figure></p>
<p>每次获取的证书有效期都是90天，不过到期后可以续签的。证书文件在<code>/etc/letsencrypt/live</code>下，<code>fullchain.pem</code>与<code>privkey.pem</code>是<code>nginx</code>的<code>公钥</code>与<code>私钥</code>。所以Nginx SSL配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">[root@opstrip opt]# vi /etc/nginx/conf.d/opstrip.conf</div><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line">    listen [::]:80 ssl ipv6only=on; </div><div class="line">    server_name  opstrip.com www.opstrip.com a.opstrip.com;</div><div class="line">    </div><div class="line">    #charset koi8-r;</div><div class="line">    </div><div class="line">    #access_log  logs/host.access.log  main;</div><div class="line">    root /usr/share/html;</div><div class="line">    index index.html index.htm README README.txt;</div><div class="line">    location / &#123;</div><div class="line">        root   /usr/share/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    error_page  404              /404.html;</div><div class="line">    </div><div class="line">    # redirect server error pages to the static page /50x.html</div><div class="line">    #</div><div class="line">    error_page   500 502 503 504  /50x.html;</div><div class="line">    location = /50x.html &#123;</div><div class="line">        root   html;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"># HTTPS server</div><div class="line">    </div><div class="line">server &#123;</div><div class="line">    listen 443 ssl;</div><div class="line">    listen [::]:443 ssl ipv6only=on;</div><div class="line">    server_name  opstrip.com www.opstrip.com a.opstrip.com;</div><div class="line">    </div><div class="line">    ssl on;</div><div class="line">    #ssl_certificate      /etc/nginx/certs/www.opstrip.com.pem;</div><div class="line">    #ssl_certificate_key  /etc/nginx/certs/www.opstrip.com.key;</div><div class="line">    ssl_certificate      /etc/letsencrypt/live/opstrip.com/fullchain.pem;</div><div class="line">    ssl_certificate_key  /etc/letsencrypt/live/opstrip.com/privkey.pem;</div><div class="line">    </div><div class="line">    ssl_session_cache    shared:SSL:1m;</div><div class="line">    ssl_session_timeout  5m;</div><div class="line">    </div><div class="line">    #ssl_ciphers  HIGH:!aNULL:!MD5;</div><div class="line">    #ssl_prefer_server_ciphers  on;</div><div class="line">    </div><div class="line">    root /usr/share/html;</div><div class="line">    index index.html index.htm README README.txt;</div><div class="line">    location / &#123;</div><div class="line">        root   /usr/share/html;</div><div class="line">        index  index.html index.htm;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">[root@opstrip opt]# systemctl reload nginx</div></pre></td></tr></table></figure></p>
<p>现在可以访问 <a href="https://a.opstrip.com" target="_blank" rel="external">https://a.opstrip.com</a> 了，如下图：</p>
<p><center><img src="/assets/blogImg/letsencrypt.png" alt="Let&#39;s Encrypt"></center><br>可以看到证书的颁发机构为<code>Let&#39;s Encrypt</code>，有效期<code>三个月</code>。<br>因此我们可以写脚本<code>自动续签</code>的，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">[root@opstrip ~]# vi /opt/letsencrypt/renewletsencrypt.sh </div><div class="line">#!/bin/bash</div><div class="line">    </div><div class="line">. /etc/profile</div><div class="line">    </div><div class="line"># /usr/bin/systemctl stop nginx</div><div class="line">cd /opt/letsencrypt</div><div class="line">./letsencrypt-auto renew --email shiyao.zh@gmail.com --agree-tos</div><div class="line">sleep 3</div><div class="line">/usr/bin/systemctl reload nginx</div><div class="line">exit 0</div><div class="line"># 将脚本添加到crontab任务每3月执行一次即可</div><div class="line">[root@opstrip ~]# vi /etc/crontab</div><div class="line">SHELL=/bin/bash</div><div class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</div><div class="line">MAILTO=root</div><div class="line">    </div><div class="line"># For details see man 4 crontabs</div><div class="line"></div><div class="line"># Example of job definition:</div><div class="line"># .---------------- minute (0 - 59)</div><div class="line"># |  .------------- hour (0 - 23)</div><div class="line"># |  |  .---------- day of month (1 - 31)</div><div class="line"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</div><div class="line"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</div><div class="line"># |  |  |  |  |</div><div class="line"># *  *  *  *  * user-name  command to be executed</div><div class="line">59 23 30 */3 * /bin/bash /opt/letsencrypt/renewletsencrypt.sh  &gt;&gt; /opt/letsencrypt/renewletsencrypt.out 2&gt;&amp;1</div></pre></td></tr></table></figure></p>
<p>以上，Nginx及SSL证书自动获取讲解完成。下次将介绍PHP。</p>
]]></content>
    
    <summary type="html">
    
      介绍使用CentOS7搭建LNMP环境，本文介绍Nginx安装与Letsencrypt免费证书的申请及自动续签。
    
    </summary>
    
      <category term="linux" scheme="https://opstrip.com/categories/linux/"/>
    
      <category term="CentOS7" scheme="https://opstrip.com/categories/linux/CentOS7/"/>
    
      <category term="LNMP" scheme="https://opstrip.com/categories/linux/CentOS7/LNMP/"/>
    
    
      <category term="CentOS7" scheme="https://opstrip.com/tags/CentOS7/"/>
    
      <category term="LNMP" scheme="https://opstrip.com/tags/LNMP/"/>
    
      <category term="搭建配置" scheme="https://opstrip.com/tags/%E6%90%AD%E5%BB%BA%E9%85%8D%E7%BD%AE/"/>
    
  </entry>
  
  <entry>
    <title>hexo配置sitemap以及设置keywords</title>
    <link href="https://opstrip.com/2017/03/12/hexo-sitemap-keywords/"/>
    <id>https://opstrip.com/2017/03/12/hexo-sitemap-keywords/</id>
    <published>2017-03-12T05:55:53.000Z</published>
    <updated>2017-04-12T06:31:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文主要是对hexo搭建的博客进行简单的<code>SEO</code>，比如给每篇文章加上<code>keywords</code>，以及生成<code>sitemap.xml</code>文件，方便我们提交到各大搜索引擎。</p>
<h3 id="hexo安装sitemap"><a href="#hexo安装sitemap" class="headerlink" title="hexo安装sitemap"></a>hexo安装<code>sitemap</code></h3><p><code>windows用户</code>可以在博客根目录下按<code>shift</code>键不放再鼠标右击，即可在此目录下运行<code>CMD</code>窗口，运行如下代码:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-generator-sitemap --save</div></pre></td></tr></table></figure></p>
<p>在博客根目录下找到<code>_config.yml</code>文件，添加如下代码:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attr">sitemap:</span></div><div class="line"><span class="attr">  path:</span> <span class="string">sitemap.xml</span></div></pre></td></tr></table></figure></p>
<p>执行<code>hexo g</code>生成静态页面，再然后执行<code>hexo s</code>启动服务。<br>打开<code>http://localhost:4000/sitemap.xml</code>即可看到效果，弄好之后你就可以到各大搜索引擎提交sitemap<code>站点地图</code>了。</p>
<h3 id="keywords"><a href="#keywords" class="headerlink" title="keywords"></a><code>keywords</code></h3><a id="more"></a>
<p>默认情况下<code>hexo博客</code>及博客里的文章是没有<code>keywords</code>关键字的，需要我们手动添加。</p>
<h4 id="设置hexo博客的关键字"><a href="#设置hexo博客的关键字" class="headerlink" title="设置hexo博客的关键字:"></a><strong>设置<code>hexo博客</code>的<code>关键字</code></strong>:</h4><p>在博客根目录下找到<code>_config.yml</code>文件，在所示地方添加<code>keywords: 关键字1,关键字2,关键字3…</code>，采用<code>英文逗号</code>隔开，注意<code>keywords</code>与<code>关键词</code>之间的<code>空格</code>。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Site</span></div><div class="line"><span class="attr">title:</span> <span class="string">站点标题</span></div><div class="line"><span class="attr">subtitle:</span> <span class="string">站点副标题</span></div><div class="line"><span class="attr">description:</span> <span class="string">站点描述</span></div><div class="line"><span class="attr">author:</span> <span class="string">站点作者</span></div><div class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></div><div class="line"><span class="attr">timezone:</span></div><div class="line"><span class="attr">keywords:</span> <span class="string">前端博客,JavaScript,html5,css3,Jquery,NodeJs,Ubuntu（#博客关键字）</span></div></pre></td></tr></table></figure></p>
<h4 id="设置文章的关键字"><a href="#设置文章的关键字" class="headerlink" title="设置文章的关键字"></a><strong>设置文章的关键字</strong></h4><p>1、打开<code>theme/icarus/layout/common/head.ejs</code>，这是我的<code>head.ejs</code>所在路径，不同主题可能不同，但一般来说都是<code>head.ejs</code>文件，添加如下代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;% <span class="keyword">if</span> (page.keywords)&#123; %&gt;</div><div class="line">&lt;meta name="keywords" content="&lt;%= page.keywords %&gt;,&lt;%= config.keywords %&gt;"&gt;</div><div class="line">&lt;% &#125; else if (config.keywords)&#123; %&gt;</div><div class="line">&lt;meta name="keywords" content="&lt;%= config.keywords %&gt;"&gt;</div><div class="line">&lt;%&#125; %&gt;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>这段话的意思是如果页面有关键字，则用页面的关键字，否则使用配置文件的关键字</p>
</blockquote>
<p>2、在文章里面加入<code>keywords</code>，如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">title: ###</div><div class="line">date: ###</div><div class="line">categories: ###</div><div class="line">tags: ###</div><div class="line">keywords: ###</div><div class="line">---</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      介绍HEXO框架的sitemap站点地图生成及keywords页面关键字配置，做SEO优化。
    
    </summary>
    
      <category term="hexo" scheme="https://opstrip.com/categories/hexo/"/>
    
      <category term="sitemap" scheme="https://opstrip.com/categories/hexo/sitemap/"/>
    
      <category term="keywords" scheme="https://opstrip.com/categories/hexo/sitemap/keywords/"/>
    
      <category term="SEO" scheme="https://opstrip.com/categories/hexo/sitemap/keywords/SEO/"/>
    
    
      <category term="hexo" scheme="https://opstrip.com/tags/hexo/"/>
    
      <category term="sitemap" scheme="https://opstrip.com/tags/sitemap/"/>
    
      <category term="keywords" scheme="https://opstrip.com/tags/keywords/"/>
    
      <category term="SEO" scheme="https://opstrip.com/tags/SEO/"/>
    
      <category term="关键字" scheme="https://opstrip.com/tags/%E5%85%B3%E9%94%AE%E5%AD%97/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL命令行使用手册</title>
    <link href="https://opstrip.com/2017/02/22/using-notes-for-postgresql-commandline/"/>
    <id>https://opstrip.com/2017/02/22/using-notes-for-postgresql-commandline/</id>
    <published>2017-02-22T03:44:40.000Z</published>
    <updated>2017-05-04T07:11:23.463Z</updated>
    
    <content type="html"><![CDATA[<h3 id="启动pgsl数据库"><a href="#启动pgsl数据库" class="headerlink" title="启动pgsl数据库"></a>启动<code>pgsl</code>数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pg_ctl -D /xx/pgdata  <span class="keyword">start</span></div></pre></td></tr></table></figure>
<h3 id="查看pgsl版本"><a href="#查看pgsl版本" class="headerlink" title="查看pgsl版本"></a>查看<code>pgsl</code>版本</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pg_ctl <span class="comment">--version</span></div></pre></td></tr></table></figure>
<h3 id="命令行登录数据库"><a href="#命令行登录数据库" class="headerlink" title="命令行登录数据库"></a>命令行登录数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psql -U username -d dbname -h hostip -p port</div></pre></td></tr></table></figure>
<h3 id="列出所有数据库"><a href="#列出所有数据库" class="headerlink" title="列出所有数据库"></a>列出所有数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\l</div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\c dbname</div></pre></td></tr></table></figure>
<h3 id="列出当前数据库的所有表"><a href="#列出当前数据库的所有表" class="headerlink" title="列出当前数据库的所有表"></a>列出当前数据库的所有表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d</div></pre></td></tr></table></figure>
<h3 id="查看指定表的所有字段"><a href="#查看指定表的所有字段" class="headerlink" title="查看指定表的所有字段"></a>查看指定表的所有字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d  tablename</div></pre></td></tr></table></figure>
<p><img src="/assets/blogImg/pgdg-1.png" alt="查看指定表的所有字段"></p>
<h3 id="查看指定表的基本情况"><a href="#查看指定表的基本情况" class="headerlink" title="查看指定表的基本情况"></a>查看指定表的基本情况</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\d+  tablename</div></pre></td></tr></table></figure>
<p><img src="/assets/blogImg/pgdg-2.png" alt="查看指定表的基本情况"></p>
<h3 id="退出操作"><a href="#退出操作" class="headerlink" title="退出操作"></a>退出操作</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">q</div></pre></td></tr></table></figure>
<h3 id="新建表"><a href="#新建表" class="headerlink" title="新建表"></a>新建表</h3><h4 id="例1（主键）"><a href="#例1（主键）" class="headerlink" title="例1（主键）"></a>例1（主键）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> TESTCASE(</div><div class="line"><span class="keyword">id</span> <span class="built_in">INTEGER</span>, </div><div class="line">task_class <span class="built_in">INTEGER</span>,</div><div class="line">age <span class="built_in">TEXT</span>,</div><div class="line">PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>, task_class)</div><div class="line">);</div></pre></td></tr></table></figure>
<h4 id="例2（自增SERIAL）"><a href="#例2（自增SERIAL）" class="headerlink" title="例2（自增SERIAL）"></a>例2（自增<code>SERIAL</code>）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> CREATETASK_CHKID_N( </div><div class="line"><span class="keyword">id</span> <span class="built_in">SERIAL</span> PRIMARY <span class="keyword">KEY</span>, </div><div class="line">chk_id <span class="built_in">TEXT</span>, </div><div class="line">n <span class="built_in">INTEGER</span></div><div class="line">);</div></pre></td></tr></table></figure>
<p>其中<code>SERIAL</code>代表自增，默认从<code>1</code>开始增加，每次自增<code>1</code>。</p>
<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> REL_CROSS_NODE;</div></pre></td></tr></table></figure>
<h3 id="清空表"><a href="#清空表" class="headerlink" title="清空表"></a>清空表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">delete</span> <span class="keyword">from</span> [表名]</div></pre></td></tr></table></figure>
<h3 id="添加字段"><a href="#添加字段" class="headerlink" title="添加字段"></a>添加字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> [表名] <span class="keyword">add</span> <span class="keyword">column</span> [字段名] [类型];</div></pre></td></tr></table></figure>
<h3 id="更改字段"><a href="#更改字段" class="headerlink" title="更改字段"></a>更改字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> [表名] <span class="keyword">rename</span> <span class="keyword">column</span> [旧字段名] <span class="keyword">to</span> [新字段名];</div></pre></td></tr></table></figure>
<p>例：把表<code>table_ex</code>字段<code>col_1</code>限制非空去掉：<code>ALTER TABLE table_eg ALTER col_1 drop not NULL</code></p>
<ul>
<li>更改字段属性，含空格</li>
</ul>
<p>如果把字段<code>colname</code>把属性<code>Text</code>转化为<code>int</code>，原来<code>text</code>里面存在空啥的，可以<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> colname <span class="keyword">TYPE</span> <span class="built_in">int</span> <span class="keyword">USING</span> (<span class="keyword">trim</span>(keyword)::<span class="built_in">integer</span>);</div></pre></td></tr></table></figure></p>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">alter</span> <span class="keyword">table</span> [表名] <span class="keyword">drop</span> <span class="keyword">column</span> [字段名];</div></pre></td></tr></table></figure>
<h3 id="表中插入一行数据"><a href="#表中插入一行数据" class="headerlink" title="表中插入一行数据"></a>表中插入一行数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> [表名] (字段<span class="number">1</span>,字段<span class="number">2</span>) <span class="keyword">values</span> (值<span class="number">1</span>,值<span class="number">2</span>);</div></pre></td></tr></table></figure>
<p>例如：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> assist_info (<span class="keyword">id</span>, maat_id, block_type) <span class="keyword">values</span> (<span class="string">'F006'</span>, <span class="string">'F7775'</span>, <span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>注：如果表中字段有大写的字段，则需要对应的加上双引号。例：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> (<span class="keyword">no</span>, <span class="string">"Name"</span>) <span class="keyword">values</span> (<span class="string">'123'</span>, <span class="string">'jihite'</span>);</div></pre></td></tr></table></figure></p>
<p>值用单引号引起来(‘’)，不能用双引号（””）</p>
<h3 id="表中删除一行数据"><a href="#表中删除一行数据" class="headerlink" title="表中删除一行数据"></a>表中删除一行数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">delete</span> <span class="keyword">from</span> [表名] <span class="keyword">where</span> [该行特征];</div></pre></td></tr></table></figure>
<h3 id="修改表中数据"><a href="#修改表中数据" class="headerlink" title="修改表中数据"></a>修改表中数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span> [表名] <span class="keyword">set</span> [目标字段名]=[目标值] <span class="keyword">where</span> [该行特征]</div></pre></td></tr></table></figure>
<h3 id="删除表-1"><a href="#删除表-1" class="headerlink" title="删除表"></a>删除表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> [表名];</div></pre></td></tr></table></figure>
<h3 id="退出postgreSql"><a href="#退出postgreSql" class="headerlink" title="退出postgreSql"></a>退出<code>postgreSql</code></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\q</div></pre></td></tr></table></figure>
<h3 id="两个查询结果做差except"><a href="#两个查询结果做差except" class="headerlink" title="两个查询结果做差except"></a>两个查询结果做差<code>except</code></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(<span class="keyword">select</span> node_id <span class="keyword">from</span> node <span class="keyword">where</span> node_id=<span class="number">1</span> <span class="keyword">or</span> node_id=<span class="number">2</span>) <span class="keyword">except</span> (<span class="keyword">select</span> node_id <span class="keyword">from</span> node <span class="keyword">where</span> node_id=<span class="number">1</span>);</div><div class="line"> node_id</div><div class="line"><span class="comment">---------</span></div><div class="line">       2</div><div class="line">(1 row)</div></pre></td></tr></table></figure>
<h3 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_a_copy <span class="keyword">AS</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> test_a;</div></pre></td></tr></table></figure>
<h3 id="命令导入sql数据文件"><a href="#命令导入sql数据文件" class="headerlink" title="命令导入sql数据文件"></a>命令导入sql数据文件</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psql -h localhost  -d databaseName  -U username -f  filename</div></pre></td></tr></table></figure>
<h3 id="查询结果存储到输出文件"><a href="#查询结果存储到输出文件" class="headerlink" title="查询结果存储到输出文件"></a>查询结果存储到输出文件</h3><p>格式：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">\o file_path</div></pre></td></tr></table></figure></p>
<p>这样就会把查询结果存储到输出文件中。例<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">postgres=&gt; \o /home/jihite/data/iu_data;</div><div class="line">postgres=&gt; select test_id from cdb_all_iu_data limit 10;</div><div class="line">postgres=&gt; select test_id from cdb_all_iu_data limit 5;</div></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">test_id</div><div class="line">--------------</div><div class="line">         2143</div><div class="line">         2153</div><div class="line">         2144</div><div class="line">         2156</div><div class="line">         2145</div><div class="line">         2154</div><div class="line">         2146</div><div class="line">         2157</div><div class="line">         2147</div><div class="line">         2155</div><div class="line">(10 rows)</div><div class="line">    </div><div class="line">test_id</div><div class="line">--------------</div><div class="line">         2143</div><div class="line">         2153</div><div class="line">         2144</div><div class="line">         2156</div><div class="line">         2145</div><div class="line">(5 rows)</div></pre></td></tr></table></figure></p>
<h3 id="数据库的备份-amp-恢复"><a href="#数据库的备份-amp-恢复" class="headerlink" title="数据库的备份&amp;恢复"></a>数据库的备份&amp;恢复</h3><p>导出到线下文件<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pg_dump <span class="comment">--host hostname --port port --username username -t tablename -d dbname &gt;/home/jihite/table.sql</span></div></pre></td></tr></table></figure></p>
<p>把线下文件导入到数据库<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">psql -h 10.125.7.68 -p 5432 -d postgres -U postgres -W postgres -f 2.sql</div></pre></td></tr></table></figure></p>
<h3 id="x-打开扩展显示功能"><a href="#x-打开扩展显示功能" class="headerlink" title="\x 打开扩展显示功能"></a>\x 打开扩展显示功能</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">postgres=&gt; \x</div><div class="line">Expanded display is on.</div><div class="line">postgres=&gt; select *  from cdb_chk_items where chk_id = 'R000000335';</div><div class="line">-[ RECORD 1 ]+------------------------------------------------------------------------------------------------</div><div class="line">chk_id       | R000000335</div><div class="line">chk_desc     | 道路属性与道路属性相关检查</div><div class="line">chk_info     | &#123;"FIELDS": &#123;"TRAFFIC_SIGN": ["TYPE", "GEOM"], "ROAD_LINK": ["ROAD_CLASS", "FORM_WAY", "GEOM"]&#125;&#125;</div><div class="line">err_desc     | &#123;"ERR2": "roadclass取值错误", "ERR1": "formway取值错误"&#125;</div><div class="line">chk_level    | 1</div><div class="line">is_opened    | 1</div><div class="line">module_name  | TRAFFIC_SIGN</div><div class="line">invalid_flag | 1</div><div class="line">rel_mode     | MAIN_LAYER:TRAFFIC_SIGN</div><div class="line">             :         TRAFFIC_SIGN|A,M|DIRECT</div><div class="line">             :         ROAD_LINK|A,M,D|ATTR_REL</div></pre></td></tr></table></figure>
<h3 id="从表A中把符合条件的记录拷贝到表B"><a href="#从表A中把符合条件的记录拷贝到表B" class="headerlink" title="从表A中把符合条件的记录拷贝到表B"></a>从表A中把符合条件的记录拷贝到表B</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> A <span class="keyword">select</span> * <span class="keyword">from</span> B <span class="keyword">where</span> <span class="keyword">id</span>  <span class="keyword">in</span> (<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>);</div></pre></td></tr></table></figure>
<p><hr><br>转载自<code>jihite</code>博客：<a href="http://www.cnblogs.com/kaituorensheng/p/4667160.html" target="_blank" rel="external">http://www.cnblogs.com/kaituorensheng/p/4667160.html</a></p>
]]></content>
    
    <summary type="html">
    
      分类描述PostgreSQL常用SQL命令，附带相应演示。
    
    </summary>
    
      <category term="postgresql" scheme="https://opstrip.com/categories/postgresql/"/>
    
    
      <category term="常用命令" scheme="https://opstrip.com/tags/%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    
      <category term="PostgreSQL" scheme="https://opstrip.com/tags/PostgreSQL/"/>
    
      <category term="SQL大全" scheme="https://opstrip.com/tags/SQL%E5%A4%A7%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7下根分区扩容</title>
    <link href="https://opstrip.com/2017/02/21/root-partition-expansion-for-centos7/"/>
    <id>https://opstrip.com/2017/02/21/root-partition-expansion-for-centos7/</id>
    <published>2017-02-21T02:46:15.000Z</published>
    <updated>2017-05-04T07:02:54.694Z</updated>
    
    <content type="html"><![CDATA[<p>为更好熟悉CentOS7，日前在PC上安装了VirtualBox软件来跑CentOS7练练手。虚机CentOS7暂采用1Core CPU，2G Mem，10G Disk配置，最小化安装并升级下系统后快照备份存档以备后用，后期可根据需要随时调整配置。<br>今天准备整个PostgreSQL玩玩的，首先需要对10G的磁盘进行扩展。安装系统时选择的是默认分区方案，root分区是用lvm管理的，分区格式是xfs。如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# df -Th</div><div class="line">Filesystem                         Type      Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/centos_myprecious-root xfs       8.5G  855M  7.7G  10% /</div><div class="line">devtmpfs                           devtmpfs  487M     0  487M   0% /dev</div><div class="line">tmpfs                              tmpfs     497M     0  497M   0% /dev/shm</div><div class="line">tmpfs                              tmpfs     497M  6.5M  491M   2% /run</div><div class="line">tmpfs                              tmpfs     497M     0  497M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1                          xfs       497M  124M  374M  25% /boot</div><div class="line">tmpfs                              tmpfs     100M     0  100M   0% /run/user/0</div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure></p>
<p>所以扩展root分区就很容易了。首先再添加一块虚拟磁盘到虚机，重启后<code>fdisk -l</code>查看虚拟磁盘是否被识别。如下，可以看到新增磁盘被标记为<code>/dev/sdb</code>，有53.7G的空间。</p>
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# fdisk -l</div><div class="line">    </div><div class="line">Disk /dev/sda: 10.7 GB, 10737418240 bytes, 20971520 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk label type: dos</div><div class="line">Disk identifier: 0x0008ee5f</div><div class="line">    </div><div class="line">   Device Boot      Start         End      Blocks   Id  System</div><div class="line">/dev/sda1   *        2048     1026047      512000   83  Linux</div><div class="line">/dev/sda2         1026048    20971519     9972736   8e  Linux LVM</div><div class="line">    </div><div class="line">Disk /dev/sdb: 53.7 GB, 53687091200 bytes, 104857600 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">    </div><div class="line">Disk /dev/mapper/centos_myprecious-root: 8.3 GB, 53724839936 bytes, 104931328 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">    </div><div class="line">    </div><div class="line">Disk /dev/mapper/centos_myprecious-swap: 1073 MB, 1073741824 bytes, 2097152 sectors</div><div class="line">Units = sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">    </div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure>
<h3 id="创建磁盘分区"><a href="#创建磁盘分区" class="headerlink" title="创建磁盘分区"></a>创建磁盘分区</h3><p>惯例，为<code>/dev/sdb</code>磁盘创建分区，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# fdisk /dev/sdb</div><div class="line">Device contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabel</div><div class="line">Building a new DOS disklabel with disk identifier 0x4cb24dcf.</div><div class="line">Changes will remain in memory only, until you decide to write them.</div><div class="line">After that, of course, the previous content won&apos;t be recoverable.</div><div class="line">Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)</div><div class="line">WARNING: DOS-compatible mode is deprecated. It&apos;s strongly recommended to</div><div class="line">         switch off the mode (command &apos;c&apos;) and change display units to</div><div class="line">         sectors (command &apos;u&apos;).</div><div class="line">Command (m for help): m</div><div class="line">Command action</div><div class="line">   a   toggle a bootable flag</div><div class="line">   b   edit bsd disklabel</div><div class="line">   c   toggle the dos compatibility flag</div><div class="line">   d   delete a partition</div><div class="line">   l   list known partition types</div><div class="line">   m   print this menu</div><div class="line">   n   add a new partition</div><div class="line">   o   create a new empty DOS partition table</div><div class="line">   p   print the partition table</div><div class="line">   q   quit without saving changes</div><div class="line">   s   create a new empty Sun disklabel</div><div class="line">   t   change a partition&apos;s system id</div><div class="line">   u   change display/entry units</div><div class="line">   v   verify the partition table</div><div class="line">   w   write table to disk and exit</div><div class="line">   x   extra functionality (experts only)</div><div class="line">Command (m for help): n</div><div class="line">Command action</div><div class="line">   e   extended</div><div class="line">   p   primary partition (1-4)</div><div class="line">p</div><div class="line">Partition number (1-4): 1</div><div class="line">First cylinder (1-624152, default 1): </div><div class="line">Using default value 1</div><div class="line">Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-624152, default 624152): </div><div class="line">Using default value 624152</div><div class="line">Command (m for help): t</div><div class="line">Selected partition 1</div><div class="line">Hex code (type L to list codes): L</div><div class="line"> 0  Empty           24  NEC DOS         81  Minix / old Lin bf  Solaris        </div><div class="line"> 1  FAT12           39  Plan 9          82  Linux swap / So c1  DRDOS/sec (FAT-</div><div class="line"> 2  XENIX root      3c  PartitionMagic  83  Linux           c4  DRDOS/sec (FAT-</div><div class="line"> 3  XENIX usr       40  Venix 80286     84  OS/2 hidden C:  c6  DRDOS/sec (FAT-</div><div class="line"> 4  FAT16 &lt;32M      41  PPC PReP Boot   85  Linux extended  c7  Syrinx         </div><div class="line"> 5  Extended        42  SFS             86  NTFS volume set da  Non-FS data    </div><div class="line"> 6  FAT16           4d  QNX4.x          87  NTFS volume set db  CP/M / CTOS / .</div><div class="line"> 7  HPFS/NTFS       4e  QNX4.x 2nd part 88  Linux plaintext de  Dell Utility   </div><div class="line"> 8  AIX             4f  QNX4.x 3rd part 8e  Linux LVM       df  BootIt         </div><div class="line"> 9  AIX bootable    50  OnTrack DM      93  Amoeba          e1  DOS access     </div><div class="line"> a  OS/2 Boot Manag 51  OnTrack DM6 Aux 94  Amoeba BBT      e3  DOS R/O        </div><div class="line"> b  W95 FAT32       52  CP/M            9f  BSD/OS          e4  SpeedStor      </div><div class="line"> c  W95 FAT32 (LBA) 53  OnTrack DM6 Aux a0  IBM Thinkpad hi eb  BeOS fs        </div><div class="line"> e  W95 FAT16 (LBA) 54  OnTrackDM6      a5  FreeBSD         ee  GPT            </div><div class="line"> f  W95 Ext&apos;d (LBA) 55  EZ-Drive        a6  OpenBSD         ef  EFI (FAT-12/16/</div><div class="line">10  OPUS            56  Golden Bow      a7  NeXTSTEP        f0  Linux/PA-RISC b</div><div class="line">11  Hidden FAT12    5c  Priam Edisk     a8  Darwin UFS      f1  SpeedStor      </div><div class="line">12  Compaq diagnost 61  SpeedStor       a9  NetBSD          f4  SpeedStor      </div><div class="line">14  Hidden FAT16 &lt;3 63  GNU HURD or Sys ab  Darwin boot     f2  DOS secondary  </div><div class="line">16  Hidden FAT16    64  Novell Netware  af  HFS / HFS+      fb  VMware VMFS    </div><div class="line">17  Hidden HPFS/NTF 65  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE </div><div class="line">18  AST SmartSleep  70  DiskSecure Mult b8  BSDI swap       fd  Linux raid auto</div><div class="line">1b  Hidden W95 FAT3 75  PC/IX           bb  Boot Wizard hid fe  LANstep        </div><div class="line">1c  Hidden W95 FAT3 80  Old Minix       be  Solaris boot    ff  BBT            </div><div class="line">1e  Hidden W95 FAT1</div><div class="line">Hex code (type L to list codes): 8e</div><div class="line">Changed system type of partition 1 to 8e (Linux LVM)</div><div class="line">Command (m for help): p</div><div class="line">Disk /dev/sdb: 53.7 GB, 53687091200 bytes</div><div class="line">16 heads, 63 sectors/track, 624152 cylinders</div><div class="line">Units = cylinders of 1008 * 512 = 516096 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 512 bytes</div><div class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</div><div class="line">Disk identifier: 0x4cb24dcf</div><div class="line">   Device Boot      Start         End      Blocks   Id  System</div><div class="line">/dev/sdb1               1      624152   314572576+  8e  Linux LVM</div><div class="line">Command (m for help): w</div><div class="line">The partition table has been altered!</div><div class="line">Calling ioctl() to re-read partition table.</div><div class="line">Syncing disks.</div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure></p>
<p>整块磁盘<code>/dev/sdb</code>被分区为<code>/dev/sdb1</code>，将该分区格式化为<code>xfs</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# mkfs.xfs -f /dev/sdb1</div></pre></td></tr></table></figure></p>
<h3 id="创建物理卷PV"><a href="#创建物理卷PV" class="headerlink" title="创建物理卷PV"></a>创建物理卷PV</h3><p>查看并创建物理卷PV：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# pvdisplay</div><div class="line">  --- Physical volume ---</div><div class="line">  PV Name               /dev/sda2</div><div class="line">  VG Name               centos_myprecious</div><div class="line">  PV Size               9.51 GiB / not usable 3.00 MiB</div><div class="line">  Allocatable           yes (but full)</div><div class="line">  PE Size               4.00 MiB</div><div class="line">  Total PE              2434</div><div class="line">  Free PE               0</div><div class="line">  Allocated PE          2434</div><div class="line">  PV UUID               0bE8O8-syyl-TSyE-p9Bv-sZEJ-3GkE-vNC4XB</div><div class="line">  </div><div class="line">[root@myprecious ~]# pvcreate /dev/sdb1</div><div class="line">  Physical volume &quot;/dev/sdb1&quot; successfully created</div><div class="line">[root@myprecious ~]# pvdisplay</div><div class="line">  --- Physical volume ---</div><div class="line">  PV Name               /dev/sda2</div><div class="line">  VG Name               centos_myprecious</div><div class="line">  PV Size               9.51 GiB / not usable 3.00 MiB</div><div class="line">  Allocatable           yes (but full)</div><div class="line">  PE Size               4.00 MiB</div><div class="line">  Total PE              2434</div><div class="line">  Free PE               0</div><div class="line">  Allocated PE          2434</div><div class="line">  PV UUID               0bE8O8-syyl-TSyE-p9Bv-sZEJ-3GkE-vNC4XB</div><div class="line">  </div><div class="line">  &quot;/dev/sdb1&quot; is a new physical volume of &quot;53.7 GiB&quot;</div><div class="line">  --- NEW Physical volume ---</div><div class="line">  PV Name               /dev/sdb1</div><div class="line">  VG Name               </div><div class="line">  PV Size               53.7 GiB</div><div class="line">  Allocatable           NO</div><div class="line">  PE Size               0   </div><div class="line">  Total PE              0</div><div class="line">  Free PE               0</div><div class="line">  Allocated PE          0</div><div class="line">  PV UUID               8Z7hoj-Ub4d-xLr3-z7ti-Z5zM-oVTv-TuLtv7</div><div class="line">   </div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure></p>
<h3 id="创建卷组VG"><a href="#创建卷组VG" class="headerlink" title="创建卷组VG"></a>创建卷组VG</h3><p>以上，PV <code>/dev/sdb1</code>已创建完成，但未被分配。将PV <code>/dev/sdb1</code>分配到系统的卷组VG上，这里为<code>centos_myprecious</code>，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# vgdisplay</div><div class="line">  --- Volume group ---</div><div class="line">  VG Name               centos_myprecious</div><div class="line">  System ID             </div><div class="line">  Format                lvm2</div><div class="line">  Metadata Areas        2</div><div class="line">  Metadata Sequence No  5</div><div class="line">  VG Access             read/write</div><div class="line">  VG Status             resizable</div><div class="line">  MAX LV                0</div><div class="line">  Cur LV                2</div><div class="line">  Open LV               2</div><div class="line">  Max PV                0</div><div class="line">  Cur PV                2</div><div class="line">  Act PV                2</div><div class="line">  VG Size               59.50 GiB</div><div class="line">  PE Size               4.00 MiB</div><div class="line">  Total PE              15233</div><div class="line">  Alloc PE / Size       13065 / 51.04 GiB</div><div class="line">  Free  PE / Size       2168 / 8.47 GiB</div><div class="line">  VG UUID               jvcc7L-quO1-MQOz-KDX3-v4QN-ES9G-q4h7H7</div><div class="line">   </div><div class="line">[root@myprecious ~]# vgextend centos_myprecious /dev/sdb1</div><div class="line">  Physical volume &quot;/dev/sdb1&quot; successfully created</div><div class="line">  Volume group &quot;centos_myprecious&quot; successfully extended</div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure></p>
<h3 id="查看逻辑卷LV"><a href="#查看逻辑卷LV" class="headerlink" title="查看逻辑卷LV"></a>查看逻辑卷LV</h3><p>在分配完卷组后，就可以见卷组中未分配的空间分配给root分区了，这里为<code>/dev/sdb1</code>分区。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# lvdisplay</div><div class="line">  --- Logical volume ---</div><div class="line">  LV Path                /dev/centos_myprecious/root</div><div class="line">  LV Name                root</div><div class="line">  VG Name                centos_myprecious</div><div class="line">  LV UUID                KqVmPb-MNpe-VPmH-ato8-aeVU-JbOz-HNgG0M</div><div class="line">  LV Write Access        read/write</div><div class="line">  LV Creation host, time myprecious, 2017-02-20 14:35:34 +0800</div><div class="line">  LV Status              available</div><div class="line">  # open                 1</div><div class="line">  LV Size                8.47 GiB</div><div class="line">  Current LE             2168</div><div class="line">  Segments               1</div><div class="line">  Allocation             inherit</div><div class="line">  Read ahead sectors     auto</div><div class="line">  - currently set to     8192</div><div class="line">  Block device           253:0</div><div class="line">  </div><div class="line">  --- Logical volume ---</div><div class="line">  LV Path                /dev/centos_myprecious/swap</div><div class="line">  LV Name                swap</div><div class="line">  VG Name                centos_myprecious</div><div class="line">  LV UUID                4HGA1K-1bYu-Vvmx-j70O-l0U7-NwvG-etzOF6</div><div class="line">  LV Write Access        read/write</div><div class="line">  LV Creation host, time myprecious, 2017-02-20 14:35:33 +0800</div><div class="line">  LV Status              available</div><div class="line">  # open                 2</div><div class="line">  LV Size                1.00 GiB</div><div class="line">  Current LE             256</div><div class="line">  Segments               1</div><div class="line">  Allocation             inherit</div><div class="line">  Read ahead sectors     auto</div><div class="line">  - currently set to     8192</div><div class="line">  Block device           253:1</div></pre></td></tr></table></figure></p>
<h3 id="扩展逻辑卷LV时的小插曲"><a href="#扩展逻辑卷LV时的小插曲" class="headerlink" title="扩展逻辑卷LV时的小插曲"></a>扩展逻辑卷LV时的小插曲</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# lvextend -l 100%FREE /dev/centos_myprecious/root </div><div class="line">  Size of logical volume centos_myprecious/root changed from 8.47 GiB (2168 extents) to 50.04 GiB (12809 extents).</div><div class="line">  Logical volume root successfully resized.</div><div class="line">[root@myprecious ~]# e2fsck -f /dev/centos_myprecious/root </div><div class="line">e2fsck 1.42.9 (28-Dec-2013)</div><div class="line">/dev/centos_myprecious/root is mounted.</div><div class="line">e2fsck: Cannot continue, aborting.</div><div class="line">    </div><div class="line">[root@myprecious ~]# resize2fs /dev/centos_myprecious/root </div><div class="line">resize2fs 1.42.9 (28-Dec-2013)</div><div class="line">resize2fs: Bad magic number in super-block while trying to open /dev/centos_myprecious/root</div><div class="line">Couldn&apos;t find valid filesystem superblock.</div><div class="line">[root@myprecious ~]# df -h</div><div class="line">Filesystem                          Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/centos_myprecious-root  8.5G  854M  7.7G  10% /</div><div class="line">devtmpfs                            487M     0  487M   0% /dev</div><div class="line">tmpfs                               497M     0  497M   0% /dev/shm</div><div class="line">tmpfs                               497M  6.5M  491M   2% /run</div><div class="line">tmpfs                               497M     0  497M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1                           497M  124M  374M  25% /boot</div><div class="line">tmpfs                               100M     0  100M   0% /run/user/0</div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure>
<p>在使用<code>resize2fs</code>操作后报错，查看分区信息发现根分区并没有变多，甚至重启后执行<code>resize2fs</code>操作依旧报错。之前的<code>centos6</code>扩展<code>ext2</code>/<code>ext3</code>/<code>ext4</code>明明都是好好的，问题出在哪儿呢？查找资料，发现是<code>resize2fs</code>不能扩展<code>xfs</code>分区所致。扩展<code>xfs</code>分区需要使用<code>xfs_growfs</code>。如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]# xfs_growfs /dev/centos_myprecious/root </div><div class="line">meta-data=/dev/mapper/centos_myprecious-root isize=256    agcount=4, agsize=555008 blks</div><div class="line">         =                       sectsz=512   attr=2, projid32bit=1</div><div class="line">         =                       crc=0        finobt=0</div><div class="line">data     =                       bsize=4096   blocks=2220032, imaxpct=25</div><div class="line">         =                       sunit=0      swidth=0 blks</div><div class="line">naming   =version 2              bsize=4096   ascii-ci=0 ftype=0</div><div class="line">log      =internal               bsize=4096   blocks=2560, version=2</div><div class="line">         =                       sectsz=512   sunit=0 blks, lazy-count=1</div><div class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</div><div class="line">data blocks changed from 2220032 to 13116416</div><div class="line">[root@myprecious ~]# df -h</div><div class="line">Filesystem                          Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/centos_myprecious-root   51G  904M   50G   2% /</div><div class="line">devtmpfs                            487M     0  487M   0% /dev</div><div class="line">tmpfs                               497M     0  497M   0% /dev/shm</div><div class="line">tmpfs                               497M  6.5M  491M   2% /run</div><div class="line">tmpfs                               497M     0  497M   0% /sys/fs/cgroup</div><div class="line">/dev/sda1                           497M  124M  374M  25% /boot</div><div class="line">tmpfs                               100M     0  100M   0% /run/user/0</div><div class="line">[root@myprecious ~]#</div></pre></td></tr></table></figure></p>
<p>使用<code>xfs_growfs</code>后，根分区被正常扩展。没注意到<code>centos7</code>中根分区已经有<code>centos6</code>中的<code>ext4</code>变更为<code>xfs</code>，相应的扩展分区的命令变更为<code>xfs_growfs</code>。<br>有时候真的是不能想当然，一个小细节的差异也会导致达不到预期的效果。</p>
]]></content>
    
    <summary type="html">
    
      介绍centos7中lvm管理下xfs分区格式的根分区的在线扩展，附详尽的操作过程。
    
    </summary>
    
      <category term="linux" scheme="https://opstrip.com/categories/linux/"/>
    
    
      <category term="lvm" scheme="https://opstrip.com/tags/lvm/"/>
    
      <category term="xfs" scheme="https://opstrip.com/tags/xfs/"/>
    
      <category term="pv" scheme="https://opstrip.com/tags/pv/"/>
    
      <category term="vg" scheme="https://opstrip.com/tags/vg/"/>
    
      <category term="lv" scheme="https://opstrip.com/tags/lv/"/>
    
      <category term="xfs_growfs" scheme="https://opstrip.com/tags/xfs-growfs/"/>
    
      <category term="分区扩展" scheme="https://opstrip.com/tags/%E5%88%86%E5%8C%BA%E6%89%A9%E5%B1%95/"/>
    
  </entry>
  
  <entry>
    <title>Firewalld学习手记</title>
    <link href="https://opstrip.com/2017/02/20/the-notes-for-learning-firewalld/"/>
    <id>https://opstrip.com/2017/02/20/the-notes-for-learning-firewalld/</id>
    <published>2017-02-20T08:11:45.000Z</published>
    <updated>2017-02-22T03:40:42.000Z</updated>
    
    <content type="html"><![CDATA[<p>在<code>CentOS 7</code>中，引入了一个新的服务，<code>Firewalld</code>，下面一张图，让大家明确的了解<code>Firewall</code>与<code>iptables</code>之间的关系与区别。</p>
<p><center><img src="/assets/blogImg/firewall_stack.png" alt="firewall stack"></center><br>安装它，只需<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum install firewalld</span></div></pre></td></tr></table></figure></p>
<p>如果需要图形界面的话，则再安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yum install firewall-config</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="一、介绍"><a href="#一、介绍" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>防火墙守护<code>firewalld</code>服务引入了一个信任级别的概念来管理与之相关联的连接与接口。它支持<code>ipv4</code>与<code>ipv6</code>，并支持网桥，采用<code>firewall-cmd (command)</code>或<code>firewall-config (gui)</code>来动态的管理<code>kernel netfilter</code> 的临时或永久的接口规则，并实时生效而无需重启服务。</p>
<h3 id="zone"><a href="#zone" class="headerlink" title="zone"></a>zone</h3><p>Firewall 能将不同的网络连接归类到不同的信任级别，Zone 提供了以下几个级别：</p>
<blockquote>
<p>drop: 丢弃所有进入的包，而不给出任何响应<br>block: 拒绝所有外部发起的连接，允许内部发起的连接<br>public: 允许指定的进入连接<br>external: 同上，对伪装的进入连接，一般用于路由转发<br>dmz: 允许受限制的进入连接<br>work: 允许受信任的计算机被限制的进入连接，类似 workgroup<br>home: 同上，类似 homegroup<br>internal: 同上，范围针对所有互联网用户<br>trusted: 信任所有连接</p>
</blockquote>
<h3 id="过滤规则"><a href="#过滤规则" class="headerlink" title="过滤规则"></a>过滤规则</h3><blockquote>
<p>source: 根据源地址过滤<br>interface: 根据网卡过滤<br>service: 根据服务名过滤<br>port: 根据端口过滤<br>icmp-block: icmp 报文过滤，按照 icmp 类型配置<br>masquerade: ip 地址伪装<br>forward-port: 端口转发<br>rule: 自定义规则</p>
</blockquote>
<p>其中，过滤规则的优先级遵循如下顺序： </p>
<blockquote>
<p>source<br>interface<br>firewalld.conf</p>
</blockquote>
<h2 id="二、使用方法"><a href="#二、使用方法" class="headerlink" title="二、使用方法"></a>二、使用方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># systemctl start firewalld         # 启动,</span></div><div class="line"><span class="comment"># systemctl enable firewalld        # 开机启动</span></div><div class="line"><span class="comment"># systemctl stop firewalld          # 关闭</span></div><div class="line"><span class="comment"># systemctl disable firewalld       # 取消开机启动</span></div><div class="line"><span class="comment"># systemctl status firewalld        # 查看状态，或使用命令firewall-cmd --state</span></div></pre></td></tr></table></figure>
<h3 id="0-配置firewalld"><a href="#0-配置firewalld" class="headerlink" title="0. 配置firewalld"></a>0. 配置firewalld</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd –version             <span class="comment"># 查看版本</span></div><div class="line">$ firewall-cmd –<span class="built_in">help</span>                <span class="comment"># 查看帮助</span></div></pre></td></tr></table></figure>
<p>查看设置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd –state               <span class="comment"># 显示状态</span></div><div class="line">$ firewall-cmd –get-active-zones    <span class="comment"># 查看区域信息</span></div><div class="line">$ firewall-cmd –get-zone-of-interface=eth0      <span class="comment"># 查看指定接口所属区域</span></div><div class="line"><span class="comment"># firewall-cmd –panic-on            # 拒绝所有包</span></div><div class="line"><span class="comment"># firewall-cmd –panic-off           # 取消拒绝状态</span></div><div class="line">$ firewall-cmd –query-panic         <span class="comment"># 查看是否拒绝</span></div></pre></td></tr></table></figure></p>
<p>具体的规则管理，可以使用<code>firewall-cmd</code>，具体的使用方法可以<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --help</div><div class="line"></div><div class="line">--zone=NAME                         <span class="comment"># 指定 zone</span></div><div class="line">--permanent                         <span class="comment"># 永久修改，--reload 后生效</span></div><div class="line">--timeout=seconds                   <span class="comment"># 持续效果，到期后自动移除，用于调试，不能与 --permanent 同时使用</span></div></pre></td></tr></table></figure></p>
<h3 id="1-查看规则"><a href="#1-查看规则" class="headerlink" title="1. 查看规则"></a>1. 查看规则</h3><p>查看运行状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --state</div></pre></td></tr></table></figure></p>
<p>查看已被激活的<code>Zone</code>信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --get-active-zones</div><div class="line">public</div><div class="line">  interfaces: eth0 eth1</div></pre></td></tr></table></figure></p>
<p>查看指定接口的<code>Zone</code>信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --get-zone-of-interface=eth0</div><div class="line">public</div></pre></td></tr></table></figure></p>
<p>查看指定级别的接口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --zone=public --list-interfaces</div><div class="line">eth0</div></pre></td></tr></table></figure></p>
<p>查看指定级别的所有信息，譬如<code>public</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --zone=public --list-all</div><div class="line">public (default, active)</div><div class="line">  interfaces: eth0</div><div class="line">  sources:</div><div class="line">  services: dhcpv6-client http ssh</div><div class="line">  ports:</div><div class="line">  masquerade: no</div><div class="line">  forward-ports:</div><div class="line">  icmp-blocks:</div><div class="line">  rich rules:</div></pre></td></tr></table></figure></p>
<p>查看所有级别被允许的信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --get-service</div></pre></td></tr></table></figure></p>
<p>查看重启后所有<code>Zones</code>级别中被允许的服务，即永久放行的服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ firewall-cmd --get-service --permanent</div></pre></td></tr></table></figure></p>
<h3 id="2-管理规则"><a href="#2-管理规则" class="headerlink" title="2. 管理规则"></a>2. 管理规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --panic-on           # 丢弃</span></div><div class="line"><span class="comment"># firewall-cmd --panic-off          # 取消丢弃</span></div><div class="line"><span class="comment"># firewall-cmd --query-panic        # 查看丢弃状态</span></div><div class="line"><span class="comment"># firewall-cmd --reload             # 更新规则，不重启服务</span></div><div class="line"><span class="comment"># firewall-cmd --complete-reload    # 更新规则，重启服务</span></div></pre></td></tr></table></figure>
<p>添加某接口至某信任等级，譬如添加<code>eth0</code>至<code>public</code>，永久修改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-interface=eth0 --permanent</span></div></pre></td></tr></table></figure></p>
<p>设置<code>public</code>为默认的信任级别<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --set-default-zone=public</span></div></pre></td></tr></table></figure></p>
<h4 id="a-管理端口"><a href="#a-管理端口" class="headerlink" title="a. 管理端口"></a>a. 管理端口</h4><p>列出<code>dmz</code>级别的被允许的进入端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=dmz --list-ports</span></div></pre></td></tr></table></figure></p>
<p>允许<code>tcp</code>端口<code>8080</code>至<code>dmz</code>级别<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=dmz --add-port=8080/tcp</span></div></pre></td></tr></table></figure></p>
<p>允许某范围的<code>udp</code>端口至<code>public</code>级别，并永久生效<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-port=5060-5059/udp --permanent</span></div></pre></td></tr></table></figure></p>
<h4 id="b-网卡接口"><a href="#b-网卡接口" class="headerlink" title="b. 网卡接口"></a>b. 网卡接口</h4><p>列出<code>public zone</code>所有网卡<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --list-interfaces</span></div></pre></td></tr></table></figure></p>
<p>将<code>eth0</code>添加至<code>public zone</code>，<code>永久</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --permanent --add-interface=eth0</span></div></pre></td></tr></table></figure></p>
<p><code>eth0</code>存在与<code>public zone</code>，将该网卡添加至<code>work zone</code>，并将之从<code>public zone</code>中删除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=work --permanent --change-interface=eth0</span></div></pre></td></tr></table></figure></p>
<p>删除<code>public zone</code>中的<code>eth0</code>，<code>永久</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --permanent --remove-interface=eth0</span></div></pre></td></tr></table></figure></p>
<h4 id="c-管理服务"><a href="#c-管理服务" class="headerlink" title="c. 管理服务"></a>c. 管理服务</h4><p>添加<code>smtp</code>服务至<code>work zone</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=work --add-service=smtp</span></div></pre></td></tr></table></figure></p>
<p>移除<code>work zone</code>中的<code>smtp</code>服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=work --remove-service=smtp</span></div></pre></td></tr></table></figure></p>
<h4 id="d-配置external-zone中的ip地址伪装"><a href="#d-配置external-zone中的ip地址伪装" class="headerlink" title="d. 配置external zone中的ip地址伪装"></a>d. 配置<code>external zone</code>中的<code>ip</code>地址伪装</h4><p>查看<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=external --query-masquerade</span></div></pre></td></tr></table></figure></p>
<p>打开伪装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=external --add-masquerade</span></div></pre></td></tr></table></figure></p>
<p>关闭伪装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=external --remove-masquerade</span></div></pre></td></tr></table></figure></p>
<h4 id="e-配置public-zone的端口转发"><a href="#e-配置public-zone的端口转发" class="headerlink" title="e. 配置public zone的端口转发"></a>e. 配置<code>public zone</code>的端口转发</h4><p>要打开端口转发，则需要先<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-masquerade</span></div></pre></td></tr></table></figure></p>
<p>然后转发<code>tcp 22</code>端口至<code>3753</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toport=3753</span></div></pre></td></tr></table></figure></p>
<p>转发<code>22</code>端口数据至另一个<code>ip192.168.1.100</code>的相同端口上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toaddr=192.168.1.100</span></div></pre></td></tr></table></figure></p>
<p>转发<code>22</code>端口数据至<code>ip192.168.1.100</code>的<code>2055</code>端口上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toport=2055:toaddr=192.168.1.100</span></div></pre></td></tr></table></figure></p>
<h4 id="f-配置public-zone的icmp"><a href="#f-配置public-zone的icmp" class="headerlink" title="f. 配置public zone的icmp"></a>f. 配置<code>public zone</code>的<code>icmp</code></h4><p>查看所有支持的<code>icmp</code>类型<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --get-icmptypes</span></div><div class="line">destination-unreachable <span class="built_in">echo</span>-reply <span class="built_in">echo</span>-request parameter-problem redirect router-advertisement router-solicitation <span class="built_in">source</span>-quench time-exceeded</div></pre></td></tr></table></figure></p>
<p>列出<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --list-icmp-blocks</span></div></pre></td></tr></table></figure></p>
<p>添加<code>echo-request</code>屏蔽<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --add-icmp-block=echo-request [--timeout=seconds]</span></div></pre></td></tr></table></figure></p>
<p>移除<code>echo-reply</code>屏蔽<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --zone=public --remove-icmp-block=echo-reply</span></div></pre></td></tr></table></figure></p>
<h4 id="g-IP封禁"><a href="#g-IP封禁" class="headerlink" title="g.IP封禁"></a>g.<code>IP</code>封禁</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># firewall-cmd --permanent --add-rich-rule="rule family='ipv4' source address='222.222.222.222' reject"</span></div></pre></td></tr></table></figure>
<p>以上都是一些常用方法，更多高级方法，请参考：</p>
<ul>
<li>红帽官网：<a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html" target="_blank" rel="external">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html</a></li>
<li>Fedora社区：<a href="https://fedoraproject.org/wiki/FirewallD" target="_blank" rel="external">https://fedoraproject.org/wiki/FirewallD</a></li>
</ul>
<hr>
<p>转载自：<a href="https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html" target="_blank" rel="external">https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html</a></p>
]]></content>
    
    <summary type="html">
    
      介绍centos7中firewalld防火墙的特点、使用方法。包括端口与服务、区域Zone、IP地址伪装及IP禁封等。
    
    </summary>
    
      <category term="firewall" scheme="https://opstrip.com/categories/firewall/"/>
    
    
      <category term="学习笔记" scheme="https://opstrip.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
      <category term="centos7" scheme="https://opstrip.com/tags/centos7/"/>
    
      <category term="firewalld" scheme="https://opstrip.com/tags/firewalld/"/>
    
  </entry>
  
  <entry>
    <title>KVM学习手记：02 存储池、虚拟机及快照</title>
    <link href="https://opstrip.com/2017/01/17/Using-Notes-For-KVM-02/"/>
    <id>https://opstrip.com/2017/01/17/Using-Notes-For-KVM-02/</id>
    <published>2017-01-17T04:38:47.000Z</published>
    <updated>2017-05-08T05:46:35.316Z</updated>
    
    <content type="html"><![CDATA[<p>接<a href="http://opstrip.com/2017/01/16/Using-Notes-For-KVM-01/">上篇</a>，在确认主机（Host OS）支持虚拟化、安装KVM系列支持组件、配置桥接网络后，就可以创建基础镜像了。</p>
<h2 id="创建存储池"><a href="#创建存储池" class="headerlink" title="创建存储池"></a>创建存储池</h2><p>在创建虚拟机之前，需要先创建一个存储池。存储池<code>Storage pools</code>是在宿主机上放置虚拟机的存储位置，可以是本地的，也可以是网络存储，具体的虚拟机实例放置在卷<code>Volume</code>上。</p>
<h3 id="1-存储池"><a href="#1-存储池" class="headerlink" title="1.存储池"></a>1.存储池</h3><p>存储池<code>Storage pools</code>是在宿主机上放置虚拟机虚拟磁盘的存储位置,默认的存储是在<code>/var/lib/libvirt/images</code>目录下,由于对硬盘和虚拟磁盘大小的空间规划,一般在<code>/opt/kvm/images</code>目录或规划的目录下集中存放虚拟机的虚拟磁盘方便管理,操作存储卷的命令行是<code>virsh</code>。</p>
<h3 id="2-建立存储池目录"><a href="#2-建立存储池目录" class="headerlink" title="2.建立存储池目录"></a>2.建立存储池目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建目录</span></div><div class="line">[root@myprecious ~]<span class="comment"># mkdir -p /opt/kvm/images</span></div><div class="line"><span class="comment">#更改目录的所有者,并设置权限</span></div><div class="line">[root@myprecious ~]<span class="comment"># chown -R qemu:qemu /opt/kvm/images</span></div><div class="line">[root@myprecious ~]<span class="comment"># chmod -R 700 /opt/kvm/images</span></div><div class="line"><span class="comment">#完成验证</span></div><div class="line">[root@myprecious ~]<span class="comment"># ls -al /opt/kvm</span></div></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="3-创建存储池"><a href="#3-创建存储池" class="headerlink" title="3.创建存储池"></a>3.创建存储池</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#定义一个存储池绑定目录</span></div><div class="line">[root@myprecious ~]<span class="comment"># virsh pool-define-as StoragePool --type dir --target /opt/kvm/images</span></div><div class="line">Pool StoragePool defined</div><div class="line">    </div><div class="line"><span class="comment">#建立基于文件夹的存储池</span></div><div class="line">[root@myprecious ~]<span class="comment"># virsh pool-build StoragePool</span></div><div class="line">Pool StoragePool built</div><div class="line">    </div><div class="line"><span class="comment">#激活StoragePool</span></div><div class="line">[root@myprecious ~]<span class="comment"># virsh pool-start StoragePool</span></div><div class="line">Pool StoragePool started</div><div class="line">    </div><div class="line"><span class="comment">#存储池开机自动运行,使用virsh pool-autostart</span></div><div class="line">[root@myprecious ~]<span class="comment"># virsh pool-autostart StoragePool</span></div><div class="line">Pool StoragePool marked as autostarted</div></pre></td></tr></table></figure>
<p><code>virsh pool-create-as –name vmware_pool –type dir –target /virhost/vmware</code><br>创建存储池vmware_pool，类型为文件目录，/virhost/vmware，与pool-define-as结果一样</p>
<h3 id="4-验证查看存储池信息"><a href="#4-验证查看存储池信息" class="headerlink" title="4.验证查看存储池信息"></a>4.验证查看存储池信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virsh pool-info StoragePool</span></div><div class="line">Name:           StoragePool</div><div class="line">UUID:           29481667-27<span class="built_in">fc</span>-4b73-8530-cdc081208c95</div><div class="line">State:          running    <span class="comment">#激活状态</span></div><div class="line">Persistent:     yes</div><div class="line">Autostart:      yes</div><div class="line">Capacity:       37.69 GiB  <span class="comment">#容量</span></div><div class="line">Allocation:     8.13 GiB   <span class="comment">#分配</span></div><div class="line">Available:      29.56 GiB  <span class="comment">#可用</span></div></pre></td></tr></table></figure>
<h3 id="5-查看创建的所有存储池"><a href="#5-查看创建的所有存储池" class="headerlink" title="5.查看创建的所有存储池"></a>5.查看创建的所有存储池</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virsh pool-list</span></div><div class="line">Name                 State      Autostart</div><div class="line">-----------------------------------------</div><div class="line">boot-scratch         active     yes</div><div class="line">default              active     yes</div><div class="line">StoragePool          active     yes</div></pre></td></tr></table></figure>
<h3 id="6-StoragePool存储池中创建一个卷，这个卷是用来做虚拟机的硬盘"><a href="#6-StoragePool存储池中创建一个卷，这个卷是用来做虚拟机的硬盘" class="headerlink" title="6.StoragePool存储池中创建一个卷，这个卷是用来做虚拟机的硬盘"></a>6.<code>StoragePool</code>存储池中创建一个卷，这个卷是用来做虚拟机的硬盘</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#创建卷baseCentos.qcow2，所在存储池为StoragePool，容量10G，初始分配1G，文件格式类型qcow2</span></div><div class="line">[root@myprecious ~]<span class="comment"># virsh vol-create-as --pool StoragePool --name baseCentos.qcow2 --capacity 10G --allocation 1G --format qcow2</span></div><div class="line">Vol baseCentos.qcow2 created</div><div class="line">    </div><div class="line"><span class="comment">#查看卷信息名称：baseCentos.qcow2，类型：文件，容量：10.00 GiB，分配：196.00 KiB</span></div><div class="line">[root@myprecious ~]<span class="comment"># virsh vol-info /opt/kvm/images/baseCentos.qcow2 </span></div><div class="line">Name:           baseCentos.qcow2</div><div class="line">Type:           file</div><div class="line">Capacity:       10.00 GiB</div><div class="line">Allocation:     196.00 KiB</div></pre></td></tr></table></figure>
<h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><p>在配置好网络环境和存储池后,就可以创建虚拟机了!<br>KVM有三种方式来创建虚拟机，分别是：<code>图形安装方式</code>(virt-manager)、<code>命令行安装方式</code>(virt-install)及<code>模板安装方式</code>(module)。这里只介绍命令行安装方式，这也是平时用的最多的安装方式。</p>
<h3 id="1-virt-install命令安装"><a href="#1-virt-install命令安装" class="headerlink" title="1.virt-install命令安装"></a>1.<code>virt-install</code>命令安装</h3><p><code>virt-install</code>参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virt-install -h</span></div><div class="line">Options:</div><div class="line">--version             show program<span class="string">'s version number and exit</span></div><div class="line">-h, --help            show this help message and exit</div><div class="line">--connect=URI         Connect to hypervisor with libvirt URI</div><div class="line">General Options:</div><div class="line">  -n NAME, --name=NAME    #虚拟机名(英文开头,数字开头报错)</div><div class="line">  -r MEMORY, --ram=MEMORY #以MB单位为虚拟机分配内存</div><div class="line">  --vcpus=VCPUS       vcpu 数目 举例:</div><div class="line">                      --vcpus 5</div><div class="line">                      --vcpus 5,maxcpus=10</div><div class="line">                      --vcpus sockets=2,cores=4,threads=2</div><div class="line">  --cpuset=CPUSET     Set which physical CPUs domain can use.</div><div class="line">  --cpu=CPU           #CPU的模式及特点 例: --cpu coreduo,+x2apic</div><div class="line">  --description=DESCRIPTION #虚拟机描述</div><div class="line">  --security=SECURITY #安全配置设置</div><div class="line">  --numatune=NUMATUNE #NUMA政策调整</div><div class="line">Installation Method Options:</div><div class="line">  -c CDROM, --cdrom=CDROM #光驱安装介质</div><div class="line">  -l LOCATION, --location=LOCATION #安装源 (eg, nfs:host:/path,http://host/path, ftp://host/path)</div><div class="line">  --pxe               #使用 PXE 协议从网络引导</div><div class="line">  --import            #导入已存在的虚拟磁盘</div><div class="line">  --init=INIT         Path to init binary for container guest. Ex:</div><div class="line">                      --init /path/to/app (to contain an application)</div><div class="line">                      --init /sbin/init (for a full OS container)</div><div class="line">  --livecd            #把光盘媒体作为一个Live CD</div><div class="line">  -x EXTRA, --extra-args=EXTRA #额外的参数传递给安装内核启动</div><div class="line">  --initrd-inject=INITRD_INJECTIONS #设置启动initrd文件</div><div class="line">  --os-type=DISTRO_TYPE #虚拟机系统类型. 'linux<span class="string">', '</span>unix<span class="string">','</span>windows<span class="string">'</span></div><div class="line">  --os-variant=DISTRO_VARIANT #系统版本, e.g.'rhel5<span class="string">', '</span>win2k<span class="string">'</span></div><div class="line">  --boot=BOOTOPTS   #配置安装后启动命令，菜单，永久的内核启动</div><div class="line">Storage Configuration:</div><div class="line">  --disk=DISKOPTS     指定各种选项的存储虚拟磁盘. Ex.</div><div class="line">                      --disk path=/my/existing/disk</div><div class="line">                      --disk path=/my/new/disk,size=5 (in gigabytes)</div><div class="line">                      --disk vol=poolname:volname,device=cdrom,bus=scsi,...</div><div class="line">  --nodisks           #设置无虚拟磁盘</div><div class="line">  --filesystem=FILESYSTEMS</div><div class="line">                      Pass host directory to the guest. Ex:</div><div class="line">                      --filesystem /my/source/dir,/dir/in/guest</div><div class="line">                      --filesystem template_name,/,type=template</div><div class="line">Networking Configuration:</div><div class="line">  -w NETWORK, --network=NETWORK #设置网络接口. Ex:</div><div class="line">                      --network bridge=mybr0</div><div class="line">                      --network network=my_libvirt_virtual_net</div><div class="line">                      --network network=mynet,model=virtio,mac=00:11...</div><div class="line">  --nonetworks        #设置无网络</div><div class="line">Graphics Configuration:</div><div class="line">  --graphics=GRAPHICS #图形支持. 举例:</div><div class="line">                      --graphics vnc</div><div class="line">                      --graphics spice,port=5901,tlsport=5902</div><div class="line">                      --graphics none</div><div class="line">                      --graphics vnc,password=foobar,port=5910,keymap=ja</div><div class="line">  --noautoconsole     #不要自动尝试连接客户机控制台</div><div class="line">Device Options:</div><div class="line">  --serial=SERIALS    #配置客户机串行驱动</div><div class="line">  --parallel=PARALLELS #配置客户机并连驱动</div><div class="line">  --channel=CHANNELS  #配置客户机沟通渠道</div><div class="line">  --console=CONSOLES  #配置客户机和主机之间的文本控制台连接</div><div class="line">  --host-device=HOSTDEVS #配置物理主机设备连接到客户机</div><div class="line">  --soundhw=SOUNDHW   #配置客户机声音驱动</div><div class="line">  --watchdog=WATCHDOG #配置客户机监视驱动</div><div class="line">  --video=VIDEO       #配置客户机视频硬件</div><div class="line">  --smartcard=SMARTCARD #配置智能卡驱动 Ex:</div><div class="line">                      --smartcard mode=passthrough</div><div class="line">Virtualization Platform Options:</div><div class="line">  -v, --hvm           #设置虚拟机为全虚拟化</div><div class="line">  -p, --paravirt      #设置虚拟机为半虚拟化</div><div class="line">  --container         This guest should be a container guest</div><div class="line">  --virt-type=HV_TYPE #Hypervisor类型(kvm, qemu, xen, ...)</div><div class="line">  --arch=ARCH         #CPU架构模拟</div><div class="line">  --machine=MACHINE   #模拟机械类型</div><div class="line">  --noapic            #全虚拟话客户机禁用APIC</div><div class="line">  --noacpi            #全虚拟话客户机禁用ACPI</div><div class="line">  -u UUID, --uuid=UUID #客户端 UUID</div><div class="line">Miscellaneous Options:</div><div class="line">  --autostart         #跟随主机开机自动启动</div><div class="line">  --print-xml</div><div class="line">  --print-step=XMLSTEP #显示指定安装步骤的xml</div><div class="line">  --noreboot           #安装完成是禁用自启动</div><div class="line">  --wait=WAIT          #超时等待时间</div><div class="line">  --dry-run</div><div class="line">  --force</div><div class="line">  -q, --quiet          #抑制非错误输出</div><div class="line">  --prompt</div><div class="line">    -d, --debug          #打印错误信息</div></pre></td></tr></table></figure></p>
<h3 id="2-远程连接虚拟机安装界面"><a href="#2-远程连接虚拟机安装界面" class="headerlink" title="2.远程连接虚拟机安装界面"></a>2.远程连接虚拟机安装界面</h3><p>由于centos必须经过文本的安装界面才能安装，在宿主机没有桌面系统的前提下，通过VNC实现远程连接。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># vim sed -i 's/#vnc_listen = "0.0.0.0"/vnc_listen = "0.0.0.0"/g' /etc/libvirt/qemu.conf</span></div><div class="line"><span class="comment">#必须重启宿主机</span></div><div class="line">[root@myprecious ~]<span class="comment"># reboot</span></div></pre></td></tr></table></figure></p>
<p>使监听所有端口，否则只监听本地，监听本地是指只能从宿主机本地登录指定虚拟机如 vncviewer 127.0.0.1：端口号(如127.0.0.1:5902)，如果监听所有端口则可以从远程通过宿主机IP：端口号 登录虚拟机(如192.168.122.24:5902)</p>
<h3 id="3-Virt-install新建虚拟机centos"><a href="#3-Virt-install新建虚拟机centos" class="headerlink" title="3.Virt-install新建虚拟机centos"></a>3.Virt-install新建虚拟机centos</h3><h4 id="1-raw格式磁盘"><a href="#1-raw格式磁盘" class="headerlink" title="(1)raw格式磁盘"></a>(1)raw格式磁盘</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#--disk 默认为`raw`格式磁盘</span></div><div class="line">[root@myprecious ~]<span class="comment"># virt-install --name=vm1 --ram=1024 --vcpus=2 --disk path=/opt/kvm/images/vm1.img,size=10 --cdrom /opt/kvm/data/centos7.iso --graphics vnc,port=5910, --network bridge=virbr0,model=virtio --force --autostart</span></div><div class="line">Starting install...</div><div class="line">Allocating <span class="string">'vm1.img'</span>  |  10 GB     00:00</div><div class="line">Creating domain...       |    0 B     00:00</div><div class="line">Cannot open display:</div><div class="line">Run <span class="string">'virt-viewer --help'</span> to see a full list of available <span class="built_in">command</span> line options</div><div class="line">Domain installation still <span class="keyword">in</span> progress. You can reconnect to the console to complete the installation process.</div></pre></td></tr></table></figure>
<h4 id="2-qcow2格式磁盘-kvm推荐使用qcow2，具有多种特性，建议生成此格式磁盘"><a href="#2-qcow2格式磁盘-kvm推荐使用qcow2，具有多种特性，建议生成此格式磁盘" class="headerlink" title="(2)qcow2格式磁盘(kvm推荐使用qcow2，具有多种特性，建议生成此格式磁盘)"></a>(2)<code>qcow2</code>格式磁盘(<code>kvm</code>推荐使用<code>qcow2</code>，具有多种特性，建议生成此格式磁盘)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#--disk format=qcow2 指定磁盘格式</span></div><div class="line">[root@myprecious ~]<span class="comment"># virt-install --name=vm2 --ram=1024 --vcpus=1 --disk path=/opt/kvm/images/vm2.qcow2,format=qcow2,size=7,bus=virtio --cdrom /opt/kvm/data/centos7.iso --graphics vnc,port=5911, --network bridge=virbr0,model=virtio --force --autostart</span></div></pre></td></tr></table></figure>
<p>以上就是显示创建成功然后确认下<code>端口</code>和<code>iptables</code>没有问题的话就可以使用<code>vnc</code>连接<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># netstat -antup  |grep kvm</span></div><div class="line">tcp    0  0 0.0.0.0:5910    0.0.0.0:*   LISTEN  1787/qemu-kvm</div><div class="line">tcp    0  0 192.168.122.24:5910   192.168.122.1:58697  ESTABLISHED 1787/qemu-kvm</div></pre></td></tr></table></figure></p>
<h3 id="4-远程连接安装界面"><a href="#4-远程连接安装界面" class="headerlink" title="4.远程连接安装界面"></a>4.远程连接安装界面</h3><p>关闭宿主机(这里为myprecious)中的防火墙<code>firewalld</code>，<code>telnet</code>下到宿主机的响应端口(这里为<code>telnet 192.168.104.240 5911</code>)，如果端口是通的说明可以连通。<br>在物理机Windows上安装<a href="http://www.tightvnc.com/download/2.8.5/tightvnc-2.8.5-gpl-setup-64bit.msi" target="_blank" rel="external">TightVNC</a>，完成后输入IP:Port(此处为192.168.104.240:5911)以完成虚机安装。<br>在vnc安装完成虚拟机自动重启,启动之后就再也连不上了，这时使用virsh手动启动。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virsh start vm1 #vm1为虚拟机名</span></div></pre></td></tr></table></figure></p>
<p>再次远程连接，然后配置虚拟机ip，配置console登录后重启。</p>
<h3 id="5-查看虚拟机的基本信息"><a href="#5-查看虚拟机的基本信息" class="headerlink" title="5.查看虚拟机的基本信息"></a>5.查看虚拟机的基本信息</h3><p>使用<code>virt-install</code>工具，工具自动创建磁盘，默认是raw格式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># qemu-img info /opt/kvm/images/vm1.img</span></div><div class="line">image: /opt/kvm/images/vm1.img</div><div class="line">file format: raw</div><div class="line">virtual size: 10G (10737418240 bytes)</div><div class="line">disk size: 1.4G</div></pre></td></tr></table></figure></p>
<h3 id="6-查看虚拟机的配置文件"><a href="#6-查看虚拟机的配置文件" class="headerlink" title="6.查看虚拟机的配置文件"></a>6.查看虚拟机的配置文件</h3><p>使用<code>virt-install</code>工具安装虚拟机后，在目录<code>/etc/libvirt/qemu/</code>下生成xml配置文件<br>配置文件命名:虚拟机名.xml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># cat /etc/libvirt/qemu/vm1.xml</span></div></pre></td></tr></table></figure></p>
<h3 id="7-窗口检测与ACPID"><a href="#7-窗口检测与ACPID" class="headerlink" title="7.窗口检测与ACPID"></a>7.窗口检测与ACPID</h3><p>启动一个窗口监测安装进程如<code>virt-viewer vm1</code>来查看安装进程。</p>
<p>有时候会碰到虚拟机无法正常安装，如果没有启动acpid进程的话，使用<code>virsh shutdown vm1</code>就会无法关闭虚拟机，这时候就需要使用命令<code>virsh destroy vm1</code>来强制关闭了。</p>
<h4 id="安装acpid"><a href="#安装acpid" class="headerlink" title="安装acpid"></a>安装acpid</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># yum install acpid -y</span></div><div class="line">[root@myprecious ~]<span class="comment"># systemctl list-unit-files | grep acpid</span></div><div class="line">acpid.service                                 enabled </div><div class="line">[root@myprecious ~]<span class="comment"># systemctl enable acpid.service</span></div><div class="line">[root@myprecious ~]<span class="comment"># systemctl start acpid.service</span></div></pre></td></tr></table></figure>
<p>完成以上操作后，就可以使用<code>virsh shutdown &lt;guestname&gt;</code>来很方便的关闭远程虚机了。</p>
<h4 id="8-快照"><a href="#8-快照" class="headerlink" title="8.快照"></a>8.快照</h4><p>等做完虚拟机的配置后，就需要对虚拟机做一个快照了。<br>快照的制作有两种方法，一种是直接在virsh 里面使用<code>snapshot</code>来制作。另外一种是使用<code>qemu-img</code>来创建快照</p>
<h5 id="1-使用snapshot创建快照："><a href="#1-使用snapshot创建快照：" class="headerlink" title="1.使用snapshot创建快照："></a>1.使用snapshot创建快照：</h5><ul>
<li>创建快照<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virsh snapshot-create-as vm1</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>快照创建的很快，其实，就是生成了一个XML的配置文件，记录下当前的信息。</p>
<ul>
<li><p>查看快照</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virsh snapshot-list vm1</span></div><div class="line">名称                  CreationTime            状态</div><div class="line">------------------------------------------------------------</div><div class="line"> 1330938135          2017-01-17 10:44:29 +0800 shutoff</div></pre></td></tr></table></figure>
</li>
<li><p>查看快照的配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># virsh snapshot-current vm1</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>那么，快照文件存在什么地方呢，在<code>/var/lib/libvirt/qemu/snapshot</code>目录下，有以虚拟机的域名为名称的文件夹，就在里面哪。</p>
<h5 id="2-使用qemu-img创建快照："><a href="#2-使用qemu-img创建快照：" class="headerlink" title="2.使用qemu-img创建快照："></a>2.使用qemu-img创建快照：</h5><p>使用qemu-img创建快照也很方便，这个镜像是直接对硬盘文件进行操作，硬盘文件的格式必须为<code>qcow2</code>格式的。</p>
<ul>
<li><p>创建快照</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># qemu-img snapshot -c 2017-1-17 /opt/kvm/images/baseCentos.qcow2</span></div></pre></td></tr></table></figure>
</li>
<li><p>查看快照<br>创建完毕后，查看一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># qemu-img snapshot -l /opt/kvm/images/baseCentos.qcow2</span></div><div class="line">Snapshot list:</div><div class="line">ID       TAG                VMSIZE               DATE      VM CLOCK</div><div class="line">1        1330938135               0 2017-01-1710:44:29  00:00:00.000</div><div class="line">2        2017-1-17                0 2017-01-1711:51:39  00:00:00.000</div></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到有两个快照，<code>ID＝1</code>为<code>virsh</code>创建的，<code>ID＝2</code>为<code>qemu-img</code>创建的。</p>
<p>–(待续)–</p>
<hr>
<p>参考信息：</p>
<ul>
<li><a href="http://wangying.sinaapp.com/archives/1893" target="_blank" rel="external">尘埃-kvm虚拟机之创建存储池三</a>（存储池创建）</li>
<li><a href="http://wangying.sinaapp.com/archives/1914" target="_blank" rel="external">尘埃-kvm虚拟机之虚拟机安装四</a>（虚拟机安装）</li>
</ul>
]]></content>
    
    <summary type="html">
    
      本篇介绍如何创建存储池、创建并安装虚拟机及生成快照。
    
    </summary>
    
      <category term="虚拟化" scheme="https://opstrip.com/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
      <category term="Linux" scheme="https://opstrip.com/tags/Linux/"/>
    
      <category term="KVM" scheme="https://opstrip.com/tags/KVM/"/>
    
      <category term="虚拟化" scheme="https://opstrip.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
      <category term="虚拟机" scheme="https://opstrip.com/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>KVM学习手记：01 安装</title>
    <link href="https://opstrip.com/2017/01/16/Using-Notes-For-KVM-01/"/>
    <id>https://opstrip.com/2017/01/16/Using-Notes-For-KVM-01/</id>
    <published>2017-01-16T02:52:54.000Z</published>
    <updated>2017-05-04T07:08:13.326Z</updated>
    
    <content type="html"><![CDATA[<h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p><strong>认识<code>虚拟化</code></strong><br>在计算机中，<code>虚拟化</code>（英语：Virtualization）是一种资源管理技术，是将计算机的各种实体资源，如服务器、网络、内存及存储等，予以抽象、转换后呈现出来，打破实体结构间的不可切割的障碍，使用户可以比原本的组态更好的方式来应用这些资源。这些资源的新虚拟部份是不受现有资源的架设方式，地域或物理组态所限制。一般所指的<code>虚拟化资源</code>包括计算能力和资料存储。在实际的生产环境中，<code>虚拟化技术</code>主要用来解决高性能的物理硬件产能过剩和老的旧的硬件产能过低的重组重用，透明化底层物理硬件，从而最大化的利用物理硬件。</p>
<p><strong>虚拟化技术的分类</strong><br><code>虚拟化</code>技术主要分为以下几个大类 [1]：</p>
<h4 id="平台虚拟化（Platform-Virtualization），针对计算机和操作系统的虚拟化。"><a href="#平台虚拟化（Platform-Virtualization），针对计算机和操作系统的虚拟化。" class="headerlink" title="平台虚拟化（Platform Virtualization），针对计算机和操作系统的虚拟化。"></a><strong>平台虚拟化</strong>（Platform Virtualization），针对计算机和操作系统的<code>虚拟化</code>。</h4><h4 id="资源虚拟化（Resource-Virtualization），针对特定的系统资源的虚拟化，比如内存、存储、网络资源等。"><a href="#资源虚拟化（Resource-Virtualization），针对特定的系统资源的虚拟化，比如内存、存储、网络资源等。" class="headerlink" title="资源虚拟化（Resource Virtualization），针对特定的系统资源的虚拟化，比如内存、存储、网络资源等。"></a><strong>资源虚拟化</strong>（Resource Virtualization），针对特定的系统资源的<code>虚拟化</code>，比如内存、存储、网络资源等。</h4><h4 id="应用程序虚拟化（Application-Virtualization），包括仿真、模拟、解释技术等。"><a href="#应用程序虚拟化（Application-Virtualization），包括仿真、模拟、解释技术等。" class="headerlink" title="应用程序虚拟化（Application Virtualization），包括仿真、模拟、解释技术等。"></a><strong>应用程序虚拟化</strong>（Application Virtualization），包括仿真、模拟、解释技术等。</h4><p>我们通常所说的<code>虚拟化</code>主要是指<code>平台虚拟化技术</code>，通过使用控制程序（Control Program，也被称为 Virtual Machine Monitor 或 Hypervisor），隐藏特定计算平台的实际物理特性，为用户提供抽象的、统一的、模拟的计算环境（称为虚拟机）。虚拟机中运行的操作系统被称为客户机操作系统（Guest OS），运行虚拟机监控器的操作系统被称为主机操作系统（Host OS），当然某些虚拟机监控器可以脱离操作系统直接运行在硬件之上（如 VMWARE 的 ESX 产品）。运行虚拟机的真实系统我们称之为主机系统。<br><code>平台虚拟化技术</code>又可以细分为如下几个子类：</p>
<a id="more"></a>
<h5 id="全虚拟化（Full-Virtualization）"><a href="#全虚拟化（Full-Virtualization）" class="headerlink" title="全虚拟化（Full Virtualization）"></a><strong>全虚拟化</strong>（Full Virtualization）</h5><p><code>全虚拟化</code>是指虚拟机模拟了完整的底层硬件，包括处理器、物理内存、时钟、外设等，使得为原始硬件设计的操作系统或其它系统软件完全不做任何修改就可以在虚拟机中运行。操作系统与真实硬件之间的交互可以看成是通过一个预先规定的硬件接口进行的。<code>全虚拟化</code> VMM 以完整模拟硬件的方式提供全部接口（同时还必须模拟特权指令的执行过程）。举例而言，x86 体系结构中，对于操作系统切换进程页表的操作，真实硬件通过提供一个特权 CR3 寄存器来实现该接口，操作系统只需执行 “mov pgtable,%%cr3” 汇编指令即可。<code>全虚拟化</code> VMM 必须完整地模拟该接口执行的全过程。如果硬件不提供<code>虚拟化</code>的特殊支持，那么这个模拟过程将会十分复杂：一般而言，VMM 必须运行在最高优先级来完全控制主机系统，而 Guest OS 需要降级运行，从而不能执行特权操作。当 Guest OS 执行前面的特权汇编指令时，主机系统产生异常（General Protection Exception），执行控制权重新从 Guest OS 转到 VMM 手中。VMM 事先分配一个变量作为影子 CR3 寄存器给 Guest OS，将 pgtable 代表的客户机物理地址（Guest Physical Address）填入影子 CR3 寄存器，然后 VMM 还需要 pgtable 翻译成主机物理地址（Host Physical Address）并填入物理 CR3 寄存器，最后返回到 Guest OS中。随后 VMM 还将处理复杂的 Guest OS 缺页异常（Page Fault）。比较著名的<code>全虚拟化</code> VMM 有 Microsoft Virtual PC、VMware Workstation、Sun Virtual Box、Parallels Desktop for Mac 和 QEMU。</p>
<h5 id="超虚拟化（Paravirtualization）"><a href="#超虚拟化（Paravirtualization）" class="headerlink" title="超虚拟化（Paravirtualization）"></a><code>超虚拟化</code>（Paravirtualization）</h5><p>这是一种修改 Guest OS 部分访问特权状态的代码以便直接与 VMM 交互的技术。在<code>超虚拟化</code>虚拟机中，部分硬件接口以软件的形式提供给客户机操作系统，这可以通过 Hypercall（VMM 提供给 Guest OS 的直接调用，与系统调用类似）的方式来提供。例如，Guest OS 把切换页表的代码修改为调用 Hypercall 来直接完成修改影子 CR3 寄存器和翻译地址的工作。由于不需要产生额外的异常和模拟部分硬件执行流程，<code>超虚拟化</code>可以大幅度提高性能，比较著名的 VMM 有 Denali、Xen。</p>
<h5 id="硬件辅助虚拟化（Hardware-Assisted-Virtualization）"><a href="#硬件辅助虚拟化（Hardware-Assisted-Virtualization）" class="headerlink" title="硬件辅助虚拟化（Hardware-Assisted Virtualization）"></a><code>硬件辅助虚拟化</code>（Hardware-Assisted Virtualization）</h5><p><code>硬件辅助虚拟化</code>是指借助硬件（主要是主机处理器）的支持来实现高效的<code>全虚拟化</code>。例如有了 Intel-VT 技术的支持，Guest OS 和 VMM 的执行环境自动地完全隔离开来，Guest OS 有自己的“全套寄存器”，可以直接运行在最高级别。因此在上面的例子中，Guest OS 能够执行修改页表的汇编指令。Intel-VT 和 AMD-V 是目前 x86 体系结构上可用的两种<code>硬件辅助虚拟化</code>技术。</p>
<h5 id="部分虚拟化（Partial-Virtualization）"><a href="#部分虚拟化（Partial-Virtualization）" class="headerlink" title="部分虚拟化（Partial Virtualization）"></a><code>部分虚拟化</code>（Partial Virtualization）</h5><p>VMM 只模拟部分底层硬件，因此客户机操作系统不做修改是无法在虚拟机中运行的，其它程序可能也需要进行修改。在历史上，<code>部分虚拟化</code>是通往<code>全虚拟化</code>道路上的重要里程碑，最早出现在第一代的分时系统 CTSS 和 IBM M44/44X 实验性的分页系统中。</p>
<h5 id="操作系统级虚拟化（Operating-System-Level-Virtualization）"><a href="#操作系统级虚拟化（Operating-System-Level-Virtualization）" class="headerlink" title="操作系统级虚拟化（Operating System Level Virtualization）"></a><code>操作系统级虚拟化</code>（Operating System Level Virtualization）</h5><p>在传统操作系统中，所有用户的进程本质上是在同一个操作系统的实例中运行，因此内核或应用程序的缺陷可能影响到其它进程。<code>操作系统级虚拟化</code>是一种在服务器操作系统中使用的轻量级的<code>虚拟化</code>技术，内核通过创建多个虚拟的操作系统实例（内核和库）来隔离不同的进程，不同实例中的进程完全不了解对方的存在。比较著名的有 Solaris Container [2]，FreeBSD Jail 和 OpenVZ 等。<br>这种分类并不是绝对的，一个优秀的<code>虚拟化</code>软件往往融合了多项技术。例如 VMware Workstation 是一个著名的<code>全虚拟化</code>的 VMM，但是它使用了一种被称为动态二进制翻译的技术把对特权状态的访问转换成对影子状态的操作，从而避免了低效的 Trap-And-Emulate 的处理方式，这与<code>超虚拟化</code>相似，只不过<code>超虚拟化</code>是静态地修改程序代码。对于<code>超虚拟化</code>而言，如果能利用硬件特性，那么虚拟机的管理将会大大简化，同时还能保持较高的性能。</p>
<hr>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h4 id="认识KVM"><a href="#认识KVM" class="headerlink" title="认识KVM"></a><strong>认识<code>KVM</code></strong></h4><p>好了，虚拟化的概念就简单的说这么多了。是时候介绍一下今天的主角————<code>KVM</code>了。<br><code>KVM</code>全称<code>***Kernel-based  Virtual Machine***</code>, 其实kvm只是一个内核模块，提供虚拟cpu和内存管理的模块，至于其它的设备是由qemu模拟的，如网卡，显卡，磁盘等。后来redhat联合IBM以及Linux社区创造了libvirt，模拟的设备性能要比qemu的好很多，并提供了一系列的管理工具和api，整个集成了kvm虚拟化的解决方案。Linux(redhat系)装载kvm模块后，摇身一变成为了VM Monitor，也称为Hypervisor，部署使用简单，需要硬件支持虚拟化。</p>
<h4 id="安装KVM"><a href="#安装KVM" class="headerlink" title="安装KVM"></a><strong>安装KVM</strong></h4><h5 id="0-实验-作业环境"><a href="#0-实验-作业环境" class="headerlink" title="0.实验/作业环境"></a>0.实验/作业环境</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#物理主机端：</div><div class="line">#操作系统：Win7旗舰版64位</div><div class="line">#CPU：Intel Core i5-6200U</div><div class="line">#软件环境：VMWareStation12.0</div><div class="line">#其他：在BIOS中开启了VT功能</div><div class="line">#宿主机端：</div><div class="line">#操作系统：CentOS7.3</div><div class="line">#软件支持：libvirt/qemu/bridge</div></pre></td></tr></table></figure>
<h5 id="1-检测硬件是否支持虚拟化"><a href="#1-检测硬件是否支持虚拟化" class="headerlink" title="1.检测硬件是否支持虚拟化"></a>1.检测硬件是否支持虚拟化</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># egrep '(vmx|svm)' --color=always /proc/cpuinfo </span></div><div class="line">[root@myprecious ~]<span class="comment"># modprobe kvm </span></div><div class="line">[root@myprecious ~]<span class="comment"># modprobe kvm_intel || modprobe kvm_amd</span></div></pre></td></tr></table></figure>
<p>如果输出结果含有vmx或者svm字样，则表示支持CPU虚拟化，Intel是vmx，AMD是svm，也需要检测是否有kvm_xxx模块，如果装载不成功，可能是没有开启硬件虚拟化,需要bios中开启，具体开启方式请联系厂家。</p>
<h5 id="2-升级安装常用软件及虚拟化服务并启动"><a href="#2-升级安装常用软件及虚拟化服务并启动" class="headerlink" title="2.升级安装常用软件及虚拟化服务并启动"></a>2.升级安装常用软件及虚拟化服务并启动</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># yum clean all</span></div><div class="line">[root@myprecious ~]<span class="comment"># yum makecache</span></div><div class="line">[root@myprecious ~]<span class="comment"># yum upgrade -y # 升级宿主机系统软件</span></div><div class="line">[root@myprecious ~]<span class="comment"># yum -y install qemu-kvm libvirt virt-install bridge-utils</span></div><div class="line">[root@myprecious ~]<span class="comment"># yum -y install vim wget gcc make crontabs mlocate ntp lrzsz telnet* gcc-c++ autoconf setuptool ntsysv system-config-securitylevel-tui system-config-network-tui sysstat dstat screen # 安装常用软件</span></div><div class="line">[root@myprecious ~]<span class="comment"># yum -y groupinstall Virtualization 'Virtualization Client' 'Virtualization Platform' 'Virtualization Tools'    # 安装虚拟化软件包</span></div><div class="line">[root@myprecious ~]<span class="comment"># lsmod | grep kvm  # 确保模块已加载</span></div><div class="line">       441119  0</div><div class="line">[root@myprecious ~]<span class="comment"># systemctl start libvirtd</span></div><div class="line">[root@myprecious ~]<span class="comment"># systemctl enable libvirtd</span></div></pre></td></tr></table></figure>
<p><code>注：centos7上服务的管理方式换成了systemctl</code></p>
<h5 id="3-检查是否有kvm模块，如果有则继续"><a href="#3-检查是否有kvm模块，如果有则继续" class="headerlink" title="3.检查是否有kvm模块，如果有则继续"></a>3.检查是否有kvm模块，如果有则继续</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># lsmod | grep kvm </span></div><div class="line">kvm_intel              52570  30  </div><div class="line">kvm                   314739  1 kvm_intel</div></pre></td></tr></table></figure>
<h5 id="4-配置桥接网络br0"><a href="#4-配置桥接网络br0" class="headerlink" title="4.配置桥接网络br0"></a>4.配置桥接网络br0</h5><p>centos7上默认已不再是eth0、eth1，比如，在我的机器上安装好的第一块网卡成为了eno16777736，修改步骤和centos6上没有区别。拿我这台测试电脑来说，常见配置网桥方法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># cd /etc/sysconfig/network-scripts/</span></div><div class="line">[root@myprecious ~]<span class="comment"># cat ifcfg-br0</span></div><div class="line">TYPE=Bridge</div><div class="line">BOOTPROTO=none</div><div class="line">DEVICE=br0</div><div class="line">ONBOOT=yes</div><div class="line">IPADDR0=192.168.107.240</div><div class="line">PREFIX0=22</div><div class="line">GATEWAY0=192.168.104.254</div><div class="line"><span class="comment">#NM_CONTROLLED=no</span></div><div class="line">[root@myprecious ~]<span class="comment"># cat ifcfg-eno16777736</span></div><div class="line">DEVICE=eno16777736</div><div class="line">TYPE=Ethernet</div><div class="line">ONBOOT=yes</div><div class="line">BRIDGE=br0</div><div class="line"><span class="comment">#NM_CONTROLLED=no</span></div><div class="line">[root@myprecious ~]<span class="comment"># reboot</span></div><div class="line">[root@myprecious ~]<span class="comment"># ifconfig</span></div><div class="line">br0: flags=4163  mtu 1500</div><div class="line">        inet 192.168.107.240  netmask 255.255.252.0  broadcast 192.168.107.255</div><div class="line">        inet6 fe80::7a24:afff:fe46:ca60  prefixlen 64  scopeid 0x20</div><div class="line">        ether 78:24:af:46:ca:60  txqueuelen 0  (Ethernet)</div><div class="line">        RX packets 129  bytes 14676 (14.3 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 148  bytes 21994 (21.4 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line">eno16777736: flags=4163  mtu 1500</div><div class="line">        ether 00:0c:29:24:02:98  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 129  bytes 16482 (16.0 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 148  bytes 21994 (21.4 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line">lo: flags=73  mtu 65536</div><div class="line">        inet 127.0.0.1  netmask 255.0.0.0</div><div class="line">        inet6 ::1  prefixlen 128  scopeid 0x10</div><div class="line">        loop  txqueuelen 0  (Local Loopback)</div><div class="line">        RX packets 9  bytes 728 (728.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 9  bytes 728 (728.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line">virbr0: flags=4099  mtu 1500</div><div class="line">        inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255</div><div class="line">        ether a6:88:9f:14:b2:66  txqueuelen 0  (Ethernet)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 1  bytes 90 (90.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div><div class="line">[root@myprecious ~]<span class="comment"># ip add show</span></div><div class="line">1: lo:  mtu 65536 qdisc noqueue state UNKNOWN</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eno16777736:  mtu 1500 qdisc pfifo_fast master br0 state UP qlen 1000</div><div class="line">    link/ether 78:24:af:46:ca:60 brd ff:ff:ff:ff:ff:ff</div><div class="line">3: br0:  mtu 1500 qdisc noqueue state UP</div><div class="line">    link/ether 78:24:af:46:ca:60 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.0.102/24 brd 192.168.0.255 scope global br0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 fe80::7a24:afff:fe46:ca60/64 scope link</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">4: virbr0:  mtu 1500 qdisc noqueue state DOWN</div><div class="line">    link/ether a6:88:9f:14:b2:66 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</div><div class="line">       valid_lft forever preferred_lft forever</div></pre></td></tr></table></figure></p>
<p><del><code>***说明***</code>：以上网卡配置文件中，<code>NM_CONTROLLED</code>这个属性值，根据redhat公司的文档是必须设置为“no”的（这个值为“yes”表示可以由服务<code>NetworkManager</code>来管理。<code>NetworkManager</code>服务不支持桥接，所以要设置为“no”。）</del></p>
<p>由于该宿主机使用的是虚拟化环境非原生的物理网络，由VMWare与Windows桥接（通常在Windows中被识别为VMnet0的虚拟网卡）使用，VMWare已经为我们创建了虚拟网桥<code>virbr0</code>，所以这里我们就不用配置了。如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># ip add show</span></div><div class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</div><div class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</div><div class="line">    inet 127.0.0.1/8 scope host lo</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 ::1/128 scope host </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">2: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">    link/ether 00:0c:29:24:02:98 brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.104.240/22 brd 192.168.107.255 scope global eno16777736</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">    inet6 fe80::20c:29ff:fe24:298/64 scope link </div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN qlen 1000</div><div class="line">    link/ether 52:54:00:fe:f9:2b brd ff:ff:ff:ff:ff:ff</div><div class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</div><div class="line">       valid_lft forever preferred_lft forever</div><div class="line">4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN qlen 1000</div><div class="line">    link/ether 52:54:00:fe:f9:2b brd ff:ff:ff:ff:ff:ff</div><div class="line">[root@myprecious ~]<span class="comment"># brctl show</span></div><div class="line">bridge name     bridge id               STP enabled     interfaces</div><div class="line">virbr0          8000.525400fef92b       yes             virbr0-nic</div></pre></td></tr></table></figure></p>
<p><code>注：由于</code>ip<code>命令属于</code>iproute2<code>软件包中的工具，由于代替旧的</code>ifconfig<code>命令，尽可能的习惯使用新的命令和工具包来淘汰老的软件和工具。</code></p>
<h5 id="5-关闭selinux"><a href="#5-关闭selinux" class="headerlink" title="5.关闭selinux"></a>5.关闭selinux</h5><p>同centos6<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@myprecious ~]<span class="comment"># setenforce  0</span></div><div class="line">[root@myprecious ~]<span class="comment"># sed -i 's/=enforcing/=disabled/g' /etc/selinux/config</span></div></pre></td></tr></table></figure></p>
<p>–(待续)–</p>
<hr>
<p>参考信息：<a href="http://www.ibm.com/developerworks/cn/linux/l-cn-vt/index.html" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/linux/l-cn-vt/index.html</a>（虚拟化介绍）</p>
]]></content>
    
    <summary type="html">
    
      简单介绍虚拟化及KVM，安装、配置并开启KVM服务，配置桥接网络。
    
    </summary>
    
      <category term="虚拟化" scheme="https://opstrip.com/categories/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
    
      <category term="Linux" scheme="https://opstrip.com/tags/Linux/"/>
    
      <category term="KVM" scheme="https://opstrip.com/tags/KVM/"/>
    
      <category term="虚拟化" scheme="https://opstrip.com/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/"/>
    
      <category term="虚拟机" scheme="https://opstrip.com/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>iptables配置详解</title>
    <link href="https://opstrip.com/2017/01/13/Iptables-Configuration-Examples/"/>
    <id>https://opstrip.com/2017/01/13/Iptables-Configuration-Examples/</id>
    <published>2017-01-13T07:43:40.000Z</published>
    <updated>2017-05-04T07:10:13.409Z</updated>
    
    <content type="html"><![CDATA[<p>iptables命令可用于配置Linux的包过滤规则，常用于实现防火墙、NAT。咋一看iptables的配置很复杂，掌握规律后，其实用iptables完成指定任务并不难，下面我们通过具体实例，学习iptables的详细用法。</p>
<h3 id="删除已有规则"><a href="#删除已有规则" class="headerlink" title="删除已有规则"></a>删除已有规则</h3><p>在新设定iptables规则时，我们一般先确保旧规则被清除，用以下命令清除旧规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -F</div><div class="line">(or iptables --flush)</div></pre></td></tr></table></figure></p>
<h3 id="设置chain策略"><a href="#设置chain策略" class="headerlink" title="设置chain策略"></a>设置chain策略</h3><p>对于filter table，默认的chain策略为ACCEPT，我们可以通过以下命令修改chain的策略：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -P INPUT DROP</div><div class="line">iptables -P FORWARD DROP</div><div class="line">iptables -P OUTPUT DROP</div></pre></td></tr></table></figure></p>
<p>以上命令配置将接收、转发和发出包均丢弃，施行比较严格的包管理。由于接收和发包均被设置为丢弃，当进一步配置其他规则的时候，需要注意针对INPUT和OUTPUT分别配置。当然，如果信任本机器往外发包，以上第三条规则可不必配置。</p>
<a id="more"></a>
<h3 id="IP黑名单"><a href="#IP黑名单" class="headerlink" title="IP黑名单"></a>IP黑名单</h3><p>有时候我们发现某个ip不停的往服务器发包，这时我们可以使用以下命令，将指定ip发来的包丢弃：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BLOCK_THIS_IP=<span class="string">"x.x.x.x"</span></div><div class="line">iptables -A INPUT -i eth0 -p tcp <span class="_">-s</span> <span class="string">"<span class="variable">$BLOCK_THIS_IP</span>"</span> -j DROP</div></pre></td></tr></table></figure></p>
<p>以上命令设置将由<code>x.x.x.x</code> ip发往<code>eth0</code>网口的<code>tcp</code>包<code>丢弃</code>。</p>
<h3 id="配置服务项"><a href="#配置服务项" class="headerlink" title="配置服务项"></a>配置服务项</h3><p>利用iptables，我们可以对日常用到的服务项进行安全管理，比如设定只能通过指定网段、由指定网口通过SSH连接本机：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -i eth0 -p tcp <span class="_">-s</span> 10.221.18.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPT</div><div class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>若要支持由本机通过SSH连接其他机器，由于在本机端口建立连接，因而还需要设置以下规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -i eth0 -p tcp <span class="_">-s</span> 10.221.18.0/24 --dport 22 -m state --state ESTABLESHED -j ACCEPT</div><div class="line">iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state NEW,ESTABLISHED -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>类似的，对于HTTP/HTTPS(80/443)、pop3(110)、rsync(873)、MySQL(3306)等基于tcp连接的服务，也可以参照上述命令配置。</p>
<p>对于基于udp的dns服务，使用以下命令开启端口服务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPT</div><div class="line">iptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT</div></pre></td></tr></table></figure></p>
<h3 id="网口转发配置"><a href="#网口转发配置" class="headerlink" title="网口转发配置"></a>网口转发配置</h3><p>对于用作防火墙或网关的服务器，一个网口连接到公网，其他网口的包转发到该网口实现内网向公网通信，假设eth0连接内网，eth1连接公网，配置规则如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT</div></pre></td></tr></table></figure></p>
<h3 id="端口转发配置"><a href="#端口转发配置" class="headerlink" title="端口转发配置"></a>端口转发配置</h3><p>对于端口，我们也可以运用iptables完成转发配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp <span class="_">-d</span> 10.221.18.15 --dport 422 -j DNAT --to 10.221.18.37:22</div></pre></td></tr></table></figure></p>
<p>以上命令将<code>422</code>端口的包转发到<code>22</code>端口，因而通过<code>422</code>端口也可进行<code>SSH</code>连接，当然对于<code>422</code>端口，我们也需要像以上“<code>4.配置服务项</code>”一节一样，配置其支持连接建立的规则。</p>
<h3 id="DoS攻击防范"><a href="#DoS攻击防范" class="headerlink" title="DoS攻击防范"></a>DoS攻击防范</h3><p>利用扩展模块limit，我们还可以配置iptables规则，实现DoS攻击防范：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -p tcp --dport 80 -m <span class="built_in">limit</span> --limit 25/minute --limit-burst 100 -j ACCEPT</div></pre></td></tr></table></figure></p>
<p><code>--litmit 25/minute</code> 指示每分钟限制最大连接数为<code>25</code><br><code>--litmit-burst 100</code> 指示当总连接数超过<code>100</code>时，启动 <code>litmit/minute</code> 限制</p>
<h3 id="配置web流量均衡"><a href="#配置web流量均衡" class="headerlink" title="配置web流量均衡"></a>配置web流量均衡</h3><p>我们可以将一台服务器作为前端服务器，利用iptables进行流量分发，配置方法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 10.221.18.101:80</div><div class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 10.221.18.102:80</div><div class="line">iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 10.221.18.103:80</div></pre></td></tr></table></figure></p>
<p>以上配置规则用到<code>nth</code>扩展模块，将<code>80</code>端口的流量均衡到三台服务器。</p>
<h3 id="将丢弃包情况记入日志"><a href="#将丢弃包情况记入日志" class="headerlink" title="将丢弃包情况记入日志"></a>将丢弃包情况记入日志</h3><p>使用LOG目标和syslog服务，我们可以记录某协议某端口下的收发包情况。拿记录丢包情况举例，可以通过以下方式实现。</p>
<p>首先自定义一个chain：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -N LOGGING</div></pre></td></tr></table></figure></p>
<p>其次将所有接收包导入<code>LOGGING chain</code>中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A INPUT -j LOGGING</div></pre></td></tr></table></figure></p>
<p>然后设置日志前缀、日志级别：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A LOGGING -m <span class="built_in">limit</span> --limit 2/min -j LOG --log-prefix <span class="string">"IPTables Packet Dropped: "</span> --log-level 7</div></pre></td></tr></table></figure></p>
<p>最后将包倒向DROP，将包丢弃：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -A LOGGING -j DROP</div></pre></td></tr></table></figure></p>
<p>另可以配置syslog.conf文件，指定iptables的日志输出。</p>
]]></content>
    
    <summary type="html">
    
      介绍CentOS6下iptables的常见用法。如：端口过滤、端口转发、DOS攻击防范、Web流量均衡等。
    
    </summary>
    
      <category term="Linux" scheme="https://opstrip.com/categories/Linux/"/>
    
    
      <category term="iptables" scheme="https://opstrip.com/tags/iptables/"/>
    
      <category term="CentOS6" scheme="https://opstrip.com/tags/CentOS6/"/>
    
      <category term="学习笔记" scheme="https://opstrip.com/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>git常用用法小结</title>
    <link href="https://opstrip.com/2017/01/12/common-usage-summary-for-git/"/>
    <id>https://opstrip.com/2017/01/12/common-usage-summary-for-git/</id>
    <published>2017-01-12T05:41:10.000Z</published>
    <updated>2017-04-24T05:46:24.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="配置全局用户："><a href="#配置全局用户：" class="headerlink" title="配置全局用户："></a>配置全局用户：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ git config --global user.name <span class="string">"Your Name"</span></div><div class="line">$ git config --global user.email <span class="string">"email@example.com"</span></div><div class="line">$ git config --global color.ui <span class="literal">true</span>   <span class="comment"># 开启彩色高亮</span></div><div class="line">$ git config --global core.editor vim <span class="comment"># 设置编辑器为vim</span></div><div class="line">$ git config <span class="_">-l</span>                       <span class="comment"># 列举所有配置</span></div></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>git 配置文件路径 ~/.gitconfig</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">项目的 git 配置文件路径 project/.git/config</div><div class="line">项目配置会覆盖全局配置</div></pre></td></tr></table></figure>
<h4 id="配置本地（当前repository）用户："><a href="#配置本地（当前repository）用户：" class="headerlink" title="配置本地（当前repository）用户："></a>配置本地（当前repository）用户：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --local user.name <span class="string">"Your Name"</span></div><div class="line">$ git config --local user.email <span class="string">"email@example.com"</span></div></pre></td></tr></table></figure>
<h4 id="删除全局用户配置："><a href="#删除全局用户配置：" class="headerlink" title="删除全局用户配置："></a>删除全局用户配置：</h4><a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --global --unset user.name</div><div class="line">$ git config --global --unset user.email</div></pre></td></tr></table></figure>
<h4 id="删除本地用户配置："><a href="#删除本地用户配置：" class="headerlink" title="删除本地用户配置："></a>删除本地用户配置：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git config --local --unset user.name</div><div class="line">$ git config --local --unset user.email</div></pre></td></tr></table></figure>
<h3 id="创建版本库"><a href="#创建版本库" class="headerlink" title="创建版本库"></a>创建版本库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir learngit <span class="comment">#新建文件夹</span></div><div class="line">$ <span class="built_in">cd</span> learngit    <span class="comment">#进入文件夹</span></div><div class="line">$ <span class="built_in">pwd</span>  <span class="comment">#显示路径</span></div><div class="line">/Users/admin/learngit</div></pre></td></tr></table></figure>
<h3 id="初始化版本库与提交"><a href="#初始化版本库与提交" class="headerlink" title="初始化版本库与提交"></a>初始化版本库与提交</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ git init    <span class="comment">#初始化空版本库</span></div><div class="line">Initialized empty Git repository <span class="keyword">in</span> /Users/admin/learngit/.git/</div><div class="line">$ git add &lt;file&gt;          <span class="comment"># 将工作文件修改提交到本地暂存区</span></div><div class="line">$ git add .               <span class="comment"># 将所有修改过的工作文件提交暂存区</span></div><div class="line">$ git commit -m <span class="string">"wrote a readme file"</span>  <span class="comment">#将暂存区文件提交到当前分支</span></div><div class="line">[master (root-commit) cb926e7] wrote a readme file</div><div class="line"> 1 file changed, 2 insertions(+)</div><div class="line"> create mode 100644 readme.txt</div></pre></td></tr></table></figure>
<h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><p>查看、添加、提交、删除、找回，重置修改文件</p>
<h4 id="查看文件"><a href="#查看文件" class="headerlink" title="查看文件"></a>查看文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ git show                <span class="comment"># 显示某次提交的内容</span></div><div class="line">$ git show <span class="variable">$id</span>            <span class="comment"># 显示指定id的内容</span></div><div class="line">    </div><div class="line">$ git diff &lt;file&gt;                  <span class="comment"># 比较当前文件和暂存区文件差异</span></div><div class="line">$ git diff</div><div class="line">$ git diff &lt;<span class="variable">$id1</span>&gt; &lt;<span class="variable">$id2</span>&gt;           <span class="comment"># 比较两次提交之间的差异</span></div><div class="line">$ git diff &lt;branch1&gt;..&lt;branch2&gt;    <span class="comment"># 在两个分支之间比较</span></div><div class="line">$ git diff --staged                <span class="comment"># 比较暂存区和版本库差异</span></div><div class="line">$ git diff --cached                <span class="comment"># 比较暂存区和版本库差异</span></div><div class="line">$ git diff --stat                  <span class="comment"># 仅仅比较统计信息</span></div></pre></td></tr></table></figure>
<h4 id="查看提交记录"><a href="#查看提交记录" class="headerlink" title="查看提交记录"></a>查看提交记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">log</span></div><div class="line">$ git <span class="built_in">log</span> &lt;file&gt;          <span class="comment"># 查看该文件每次提交记录</span></div><div class="line">$ git <span class="built_in">log</span> -p &lt;file&gt;       <span class="comment"># 查看每次详细修改内容的 diff</span></div><div class="line">$ git <span class="built_in">log</span> -p -2           <span class="comment"># 查看最近两次详细修改内容的 diff</span></div><div class="line">$ git 本地分支管理</div></pre></td></tr></table></figure>
<h4 id="查看、切换、创建和删除分支"><a href="#查看、切换、创建和删除分支" class="headerlink" title="查看、切换、创建和删除分支"></a>查看、切换、创建和删除分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ git branch              <span class="comment"># 查看分支</span></div><div class="line">$ git branch -r           <span class="comment"># 查看远程分支</span></div><div class="line">$ git branch &lt;new_branch&gt; <span class="comment"># 创建新的分支</span></div><div class="line">$ git branch -v           <span class="comment"># 查看各个分支最后提交信息</span></div><div class="line">$ git branch --merged     <span class="comment"># 查看已经被合并到当前分支的分支</span></div><div class="line">$ git branch --no-merged  <span class="comment"># 查看尚未被合并到当前分支的分支</span></div><div class="line">$ git branch <span class="_">-d</span> &lt;branch&gt;  <span class="comment"># 删除某个分支</span></div><div class="line">$ git branch -D &lt;branch&gt;  <span class="comment"># 强制删除某个分支 (未被合并的分支被删除的时候需要强制)</span></div><div class="line">    </div><div class="line">$ git checkout &lt;branch&gt;   <span class="comment"># 切换到某个分支</span></div><div class="line">$ git checkout -b &lt;new_branch&gt;          <span class="comment"># 创建新的分支，并且切换过去</span></div><div class="line">$ git checkout -b &lt;new_branch&gt; &lt;branch&gt; <span class="comment"># 基于 branch 创建新的new_branch</span></div><div class="line">$ git checkout <span class="variable">$id</span>        <span class="comment"># 把某次历史提交记录 checkout 出来，但无分支信息，切换到其他分支会自动删除</span></div><div class="line">$ git checkout <span class="variable">$id</span> -b &lt;new_branch&gt;      <span class="comment"># 把某次历史提交记录 checkout 出来，创建成一个分支</span></div><div class="line">$ git checkout  -- &lt;file&gt; <span class="comment"># 抛弃工作区修改</span></div><div class="line">$ git checkout  .         <span class="comment"># 抛弃工作区修改</span></div></pre></td></tr></table></figure>
<h4 id="分支合并和rebase"><a href="#分支合并和rebase" class="headerlink" title="分支合并和rebase"></a>分支合并和rebase</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git merge &lt;branch&gt;               <span class="comment"># 将 branch 分支合并到当前分支</span></div><div class="line">$ git merge origin/master --no-ff  <span class="comment"># 不要 Fast-Foward 合并，这样可以生成 merge 提交</span></div><div class="line">$ git rebase master &lt;branch&gt;       <span class="comment"># 将 master rebase 到 branch，相当于：git checkout &lt;branch&gt; &amp;&amp; git rebase master &amp;&amp; git checkout master &amp;&amp; git merge &lt;branch&gt;</span></div></pre></td></tr></table></figure>
<h4 id="git暂存管理"><a href="#git暂存管理" class="headerlink" title="git暂存管理"></a>git暂存管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git stash               <span class="comment"># 暂存</span></div><div class="line">$ git stash list          <span class="comment"># 列所有stash</span></div><div class="line">$ git stash apply         <span class="comment"># 恢复暂存的内容</span></div><div class="line">$ git stash drop          <span class="comment"># 删除暂存区</span></div></pre></td></tr></table></figure>
<h4 id="git远程分支管理"><a href="#git远程分支管理" class="headerlink" title="git远程分支管理"></a>git远程分支管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ git pull                         <span class="comment"># 抓取远程仓库所有分支更新并合并到本地</span></div><div class="line">$ git pull --no-ff                 <span class="comment"># 抓取远程仓库所有分支更新并合并到本地，不要快进合并</span></div><div class="line">$ git fetch origin                 <span class="comment"># 抓取远程仓库更新</span></div><div class="line">$ git merge origin/master          <span class="comment"># 将远程主分支合并到本地当前分支</span></div><div class="line">$ git checkout --track origin/branch     <span class="comment"># 跟踪某个远程分支创建相应的本地分支</span></div><div class="line">$ git checkout -b &lt;local_branch&gt; origin/&lt;remote_branch&gt;  <span class="comment"># 基于远程分支创建本地分支，功能同上</span></div><div class="line">    </div><div class="line">$ git push                         <span class="comment"># push所有分支</span></div><div class="line">$ git push origin master           <span class="comment"># 将本地主分支推到远程主分支</span></div><div class="line">$ git push -u origin master        <span class="comment"># 将本地主分支推到远程(如无远程主分支则创建，用于初始化远程仓库)</span></div><div class="line">$ git push origin &lt;local_branch&gt;   <span class="comment"># 创建远程分支， origin是远程仓库名</span></div><div class="line">$ git push origin &lt;local_branch&gt;:&lt;remote_branch&gt;  <span class="comment"># 创建远程分支</span></div><div class="line">$ git push origin :&lt;remote_branch&gt; <span class="comment"># 先删除本地分支(git branch -d &lt;branch&gt;)，然后再push删除远程分支</span></div><div class="line">    </div><div class="line">$ git rm &lt;file&gt;                    <span class="comment"># 从版本库中删除文件</span></div><div class="line">$ git rm -rf &lt;file&gt;                <span class="comment"># 强制删除远程仓库中的文件目录</span></div><div class="line">$ git rm &lt;file&gt; --cached           <span class="comment"># 从版本库中删除文件，但不删除文件</span></div><div class="line">    </div><div class="line">$ git reset &lt;file&gt;                 <span class="comment"># 从暂存区恢复到工作文件</span></div><div class="line">$ git reset -- .                   <span class="comment"># 从暂存区恢复到工作文件</span></div><div class="line">$ git reset --hard                 <span class="comment"># 恢复最近一次提交过的状态，即放弃上次提交后的所有本次修改</span></div><div class="line">$ git reset --hard HEAD^           <span class="comment">#回退到上个版本（上一个版本就是HEAD^，上上一个版本就是HEAD^^，当然往上100个版本写100个^比较容易数不过来，所以写成HEAD~100。）</span></div></pre></td></tr></table></figure>
<h4 id="git远程仓库管理"><a href="#git远程仓库管理" class="headerlink" title="git远程仓库管理"></a>git远程仓库管理</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$ git remote -v                    <span class="comment"># 查看远程服务器地址和仓库名称</span></div><div class="line">$ git remote show origin           <span class="comment"># 查看远程服务器仓库状态</span></div><div class="line">$ git remote add origin git@github.com:whuhacker/Unblock-Youku-Firefox.git     <span class="comment"># 添加远程仓库地址</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin git@github.com:whuhacker/Unblock-Youku-Firefox.git <span class="comment"># 设置远程仓库地址(用于修改远程仓库地址)</span></div><div class="line">$ git remote rm &lt;repository&gt;       <span class="comment"># 删除远程仓库</span></div><div class="line">    </div><div class="line">$ git commit &lt;file&gt;</div><div class="line">$ git commit .</div><div class="line">$ git commit <span class="_">-a</span>           <span class="comment"># 将 git add, git rm 和 git ci 等操作都合并在一起做</span></div><div class="line">$ git commit -am <span class="string">"some comments"</span></div><div class="line">$ git commit --amend      <span class="comment"># 修改最后一次提交记录</span></div><div class="line">    </div><div class="line">$ git revert &lt;<span class="variable">$id</span>&gt;        <span class="comment"># 恢复某次提交的状态，恢复动作本身也创建了一次提交对象</span></div><div class="line">$ git revert HEAD         <span class="comment"># 恢复最后一次提交的状态</span></div><div class="line">    </div><div class="line">$ git status              <span class="comment"># 查看还问提交但是已经被修改的文件</span></div><div class="line">    </div><div class="line">$ git <span class="built_in">log</span>                 <span class="comment"># 查看历史版本提交记录</span></div><div class="line">$ git <span class="built_in">log</span> --pretty=oneline  <span class="comment"># 查看历史版本提交记录（显示在一行）</span></div><div class="line">$ git reflog              <span class="comment"># 用来记录每一次执行的命令</span></div><div class="line">    </div><div class="line">$ git merge dev           <span class="comment"># 合并dev到当前分支</span></div><div class="line">$ git merge --no-ff -m <span class="string">"merge with no-ff"</span> dev                         <span class="comment"># 加上--no-ff参数就可以用普通模式合并，合并后的历史有分支，能看出来曾经做过合并远程仓库</span></div><div class="line">$ ssh-keygen -t rsa -C <span class="string">"youremail@example.com"</span>                        <span class="comment"># 获取管理github仓库的密钥私钥</span></div><div class="line">$ git remote add origin git@github.com:opstrip/opstrip.github.io.git  <span class="comment"># 关联远程仓库</span></div><div class="line">$ git remote <span class="built_in">set</span>-url origin git@github.com:opstrip/opstrip.github.io.git  <span class="comment"># 修改远程仓库</span></div><div class="line">$ git push -u origin master    <span class="comment"># 推送到远程仓库的master分支</span></div><div class="line">$ git <span class="built_in">clone</span> git@github.com:opstrip/opstrip.github.io.git  <span class="comment"># 从远程克隆仓库到本地</span></div><div class="line">$ git push origin branch-name  <span class="comment"># 把本地提交推送到远程仓库的&lt;branch-name&gt;分支</span></div><div class="line">$ git pull                <span class="comment"># 获取最新的远程仓库</span></div></pre></td></tr></table></figure>
<h4 id="设置跟踪远程库和本地库"><a href="#设置跟踪远程库和本地库" class="headerlink" title="设置跟踪远程库和本地库"></a>设置跟踪远程库和本地库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git branch --set-upstream master origin/master</div><div class="line">$ git branch --set-upstream develop origin/develop</div></pre></td></tr></table></figure>
<hr>
<ul>
<li>如果git pull提示“no tracking information”，则说明本地分支和远程分支的链接关系没有创建，用命令git branch –set-upstream branch-name origin/branch-name。</li>
</ul>
]]></content>
    
    <summary type="html">
    
      git使用详解：全局/本地配置、版本库管理、分支管理、远程库管理等。
    
    </summary>
    
      <category term="学习笔记" scheme="https://opstrip.com/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="git用法" scheme="https://opstrip.com/tags/git%E7%94%A8%E6%B3%95/"/>
    
      <category term="版本控制" scheme="https://opstrip.com/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
      <category term="使用详解" scheme="https://opstrip.com/tags/%E4%BD%BF%E7%94%A8%E8%AF%A6%E8%A7%A3/"/>
    
  </entry>
  
  <entry>
    <title>nginx配置文件nginx.conf配置模版</title>
    <link href="https://opstrip.com/2017/01/10/nginx-configuration-template/"/>
    <id>https://opstrip.com/2017/01/10/nginx-configuration-template/</id>
    <published>2017-01-10T05:46:44.000Z</published>
    <updated>2017-05-04T07:13:50.389Z</updated>
    
    <content type="html"><![CDATA[<p>Nginx(“engine x”)是一款轻量级高性能的Web服务器/反向代理服务器及电子邮件（IMAP/POP3/SMTP）代理服务器，并在一个BSD-like 协议下发行。由俄罗斯的程序设计师Igor Sysoev所开发，供俄国大型的入口网站及搜索引擎Rambler.ru（俄文：Рамблер）使用。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，因而获得了众多粉丝的青睐。目前中国大陆使用nginx网站的大型网站主要有：百度、京东、新浪、网易、腾讯、淘宝等。<br>今天花了点时间整理了下Nginx配置参数中文说明，以做备忘。更详细的模块参数可参考：<a href="http://wiki.nginx.org/Main" title="nginx官网" target="_blank" rel="external">nginx官网</a></p>
<a id="more"></a>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line">    </div><div class="line"><span class="comment">#定义Nginx运行的用户和用户组</span></div><div class="line"><span class="string">user</span> <span class="string">www</span> <span class="string">www;</span></div><div class="line">    </div><div class="line"><span class="comment">#nginx进程数，建议设置为等于CPU总核心数。</span></div><div class="line"><span class="string">worker_processes</span> <span class="number">8</span><span class="string">;</span></div><div class="line">    </div><div class="line"><span class="comment">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span></div><div class="line"><span class="string">error_log</span> <span class="string">/var/log/nginx/error.log</span> <span class="string">info;</span></div><div class="line">    </div><div class="line"><span class="comment">#进程文件</span></div><div class="line"><span class="string">pid</span> <span class="string">/var/run/nginx.pid;</span></div><div class="line">    </div><div class="line"><span class="comment">#一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</span></div><div class="line"><span class="string">worker_rlimit_nofile</span> <span class="number">65535</span><span class="string">;</span></div><div class="line">    </div><div class="line"><span class="comment">#工作模式与连接数上限</span></div><div class="line"><span class="string">events</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">    <span class="comment">#参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span></div><div class="line">    <span class="string">use</span> <span class="string">epoll;</span></div><div class="line">    <span class="comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span></div><div class="line">    <span class="string">worker_connections</span> <span class="number">65535</span><span class="string">;</span></div><div class="line"><span class="string">&#125;</span></div><div class="line">    </div><div class="line"><span class="comment">#设定http服务器</span></div><div class="line"><span class="string">http</span></div><div class="line"><span class="string">&#123;</span></div><div class="line">    <span class="string">include</span> <span class="string">mime.types;</span> <span class="comment">#文件扩展名与文件类型映射表</span></div><div class="line">    <span class="string">default_type</span> <span class="string">application/octet-stream;</span> <span class="comment">#默认文件类型</span></div><div class="line">    <span class="comment">#charset utf-8; #默认编码</span></div><div class="line">    <span class="string">server_names_hash_bucket_size</span> <span class="number">128</span><span class="string">;</span> <span class="comment">#服务器名字的hash表大小</span></div><div class="line">    <span class="string">client_header_buffer_size</span> <span class="number">32</span><span class="string">k;</span> <span class="comment">#上传文件大小限制</span></div><div class="line">    <span class="string">large_client_header_buffers</span> <span class="number">4</span> <span class="number">64</span><span class="string">k;</span> <span class="comment">#设定请求缓</span></div><div class="line">    <span class="string">client_max_body_size</span> <span class="number">8</span><span class="string">m;</span> <span class="comment">#设定请求缓</span></div><div class="line">    <span class="string">sendfile</span> <span class="string">on;</span> <span class="comment">#开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。</span></div><div class="line">    <span class="string">autoindex</span> <span class="string">on;</span> <span class="comment">#开启目录列表访问，合适下载服务器，默认关闭。</span></div><div class="line">    <span class="string">tcp_nopush</span> <span class="string">on;</span> <span class="comment">#防止网络阻塞</span></div><div class="line">    <span class="string">tcp_nodelay</span> <span class="string">on;</span> <span class="comment">#防止网络阻塞</span></div><div class="line">    <span class="string">keepalive_timeout</span> <span class="number">120</span><span class="string">;</span> <span class="comment">#长连接超时时间，单位是秒</span></div><div class="line">    </div><div class="line">    <span class="comment">#FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。</span></div><div class="line">    <span class="string">fastcgi_connect_timeout</span> <span class="number">300</span><span class="string">;</span></div><div class="line">    <span class="string">fastcgi_send_timeout</span> <span class="number">300</span><span class="string">;</span></div><div class="line">    <span class="string">fastcgi_read_timeout</span> <span class="number">300</span><span class="string">;</span></div><div class="line">    <span class="string">fastcgi_buffer_size</span> <span class="number">64</span><span class="string">k;</span></div><div class="line">    <span class="string">fastcgi_buffers</span> <span class="number">4</span> <span class="number">64</span><span class="string">k;</span></div><div class="line">    <span class="string">fastcgi_busy_buffers_size</span> <span class="number">128</span><span class="string">k;</span></div><div class="line">    <span class="string">fastcgi_temp_file_write_size</span> <span class="number">128</span><span class="string">k;</span></div><div class="line">    </div><div class="line">    <span class="comment">#gzip模块设置</span></div><div class="line">    <span class="string">gzip</span> <span class="string">on;</span> <span class="comment">#开启gzip压缩输出</span></div><div class="line">    <span class="string">gzip_min_length</span> <span class="number">1</span><span class="string">k;</span> <span class="comment">#最小压缩文件大小</span></div><div class="line">    <span class="string">gzip_buffers</span> <span class="number">4</span> <span class="number">16</span><span class="string">k;</span> <span class="comment">#压缩缓冲区</span></div><div class="line">    <span class="string">gzip_http_version</span> <span class="number">1.0</span><span class="string">;</span> <span class="comment">#压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span></div><div class="line">    <span class="string">gzip_comp_level</span> <span class="number">2</span><span class="string">;</span> <span class="comment">#压缩等级</span></div><div class="line">    <span class="string">gzip_types</span> <span class="string">text/plain</span> <span class="string">application/x-javascript</span> <span class="string">text/css</span> <span class="string">application/xml;</span></div><div class="line">    <span class="comment">#压缩类型，默认就已经包含text/html，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。</span></div><div class="line">    <span class="string">gzip_vary</span> <span class="string">on;</span></div><div class="line">    <span class="comment">#limit_zone crawler $binary_remote_addr 10m; #开启限制IP连接数的时候需要使用</span></div><div class="line">    </div><div class="line">    <span class="string">upstream</span> <span class="string">opstrip.com</span> <span class="string">&#123;</span></div><div class="line">        <span class="comment">#upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span></div><div class="line">        <span class="string">server</span> <span class="number">10.12</span><span class="number">.80</span><span class="number">.121</span><span class="string">:80</span> <span class="string">weight=3;</span></div><div class="line">        <span class="string">server</span> <span class="number">10.12</span><span class="number">.80</span><span class="number">.122</span><span class="string">:80</span> <span class="string">weight=2;</span></div><div class="line">        <span class="string">server</span> <span class="number">10.12</span><span class="number">.80</span><span class="number">.123</span><span class="string">:80</span> <span class="string">weight=3;</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line">    </div><div class="line">    <span class="comment">#虚拟主机的配置</span></div><div class="line">    <span class="string">server</span></div><div class="line">    <span class="string">&#123;</span></div><div class="line">        <span class="comment">#监听端口</span></div><div class="line">        <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></div><div class="line">        <span class="comment">#域名可以有多个，用空格隔开</span></div><div class="line">        <span class="string">server_name</span> <span class="string">opstrip.com</span> <span class="string">www.opstrip.com;</span></div><div class="line">        <span class="string">index</span> <span class="string">index.html</span> <span class="string">index.htm</span> <span class="string">index.php;</span></div><div class="line">        <span class="string">root</span> <span class="string">/var/www/opstrip.com;</span></div><div class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.*.(php|php5)?$</span></div><div class="line">        <span class="string">&#123;</span></div><div class="line">            <span class="string">fastcgi_pass</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:9000;</span></div><div class="line">            <span class="string">fastcgi_index</span> <span class="string">index.php;</span></div><div class="line">            <span class="string">include</span> <span class="string">fastcgi.conf;</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">        <span class="comment">#图片缓存时间设置</span></div><div class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.*.(gif|jpg|jpeg|png|bmp|swf)$</span></div><div class="line">        <span class="string">&#123;</span></div><div class="line">            <span class="string">expires</span> <span class="number">10</span><span class="string">d;</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">        <span class="comment">#JS和CSS缓存时间设置</span></div><div class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.*.(js|css)?$</span></div><div class="line">        <span class="string">&#123;</span></div><div class="line">            <span class="string">expires</span> <span class="number">1</span><span class="string">h;</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">        <span class="comment">#日志格式设定</span></div><div class="line">        <span class="string">log_format</span> <span class="string">access</span> <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></div><div class="line">        <span class="string">'$status $body_bytes_sent "$http_referer" '</span></div><div class="line">        <span class="string">'"$http_user_agent" $http_x_forwarded_for'</span><span class="string">;</span></div><div class="line">        <span class="comment">#定义本虚拟主机的访问日志</span></div><div class="line">        <span class="string">access_log</span> <span class="string">/var/log/nginx/ha97access.log</span> <span class="string">access;</span></div><div class="line">    </div><div class="line">        <span class="comment">#对 "/" 启用反向代理</span></div><div class="line">        <span class="string">location</span> <span class="string">/</span> <span class="string">&#123;</span></div><div class="line">            <span class="string">proxy_pass</span> <span class="attr">http://127.0.0.1:88;</span></div><div class="line">            <span class="string">proxy_redirect</span> <span class="string">off;</span></div><div class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Real-IP</span> <span class="string">$remote_addr;</span></div><div class="line">            <span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></div><div class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Forwarded-For</span> <span class="string">$proxy_add_x_forwarded_for;</span></div><div class="line">            <span class="comment">#以下是一些反向代理的配置，可选。</span></div><div class="line">            <span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$host;</span></div><div class="line">            <span class="string">client_max_body_size</span> <span class="number">10</span><span class="string">m;</span> <span class="comment">#允许客户端请求的最大单文件字节数</span></div><div class="line">            <span class="string">client_body_buffer_size</span> <span class="number">128</span><span class="string">k;</span> <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数，</span></div><div class="line">            <span class="string">proxy_connect_timeout</span> <span class="number">90</span><span class="string">;</span> <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></div><div class="line">            <span class="string">proxy_send_timeout</span> <span class="number">90</span><span class="string">;</span> <span class="comment">#后端服务器数据回传时间(代理发送超时)</span></div><div class="line">            <span class="string">proxy_read_timeout</span> <span class="number">90</span><span class="string">;</span> <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></div><div class="line">            <span class="string">proxy_buffer_size</span> <span class="number">4</span><span class="string">k;</span> <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></div><div class="line">            <span class="string">proxy_buffers</span> <span class="number">4</span> <span class="number">32</span><span class="string">k;</span> <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的设置</span></div><div class="line">            <span class="string">proxy_busy_buffers_size</span> <span class="number">64</span><span class="string">k;</span> <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></div><div class="line">            <span class="string">proxy_temp_file_write_size</span> <span class="number">64</span><span class="string">k;</span></div><div class="line">            <span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">    </div><div class="line">        <span class="comment">#设定查看Nginx状态的地址</span></div><div class="line">        <span class="string">location</span> <span class="string">/NginxStatus</span> <span class="string">&#123;</span></div><div class="line">            <span class="string">stub_status</span> <span class="string">on;</span></div><div class="line">            <span class="string">access_log</span> <span class="string">on;</span></div><div class="line">            <span class="string">auth_basic</span> <span class="string">"NginxStatus"</span><span class="string">;</span></div><div class="line">            <span class="string">auth_basic_user_file</span> <span class="string">conf/htpasswd;</span></div><div class="line">            <span class="comment">#htpasswd文件的内容可以用apache提供的htpasswd工具来产生。</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">    </div><div class="line">        <span class="comment">#本地动静分离反向代理配置</span></div><div class="line">        <span class="comment">#所有jsp的页面均交由tomcat或resin处理</span></div><div class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.(jsp|jspx|do)?$</span> <span class="string">&#123;</span></div><div class="line">            <span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$host;</span></div><div class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Real-IP</span> <span class="string">$remote_addr;</span></div><div class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Forwarded-For</span> <span class="string">$proxy_add_x_forwarded_for;</span></div><div class="line">            <span class="string">proxy_pass</span> <span class="attr">http://127.0.0.1:8080;</span></div><div class="line">        <span class="string">&#125;</span></div><div class="line">        <span class="comment">#所有静态文件由nginx直接读取不经过tomcat或resin</span></div><div class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$</span></div><div class="line">        <span class="string">&#123;</span> <span class="string">expires</span> <span class="number">15</span><span class="string">d;</span> <span class="string">&#125;</span></div><div class="line">        <span class="string">location</span> <span class="string">~</span> <span class="string">.*.(js|css)?$</span></div><div class="line">        <span class="string">&#123;</span> <span class="string">expires</span> <span class="number">1</span><span class="string">h;</span> <span class="string">&#125;</span></div><div class="line">    <span class="string">&#125;</span></div><div class="line"><span class="string">&#125;</span></div></pre></td></tr></table></figure>
<p>更详细的模块参数可以参考：<a href="http://wiki.nginx.org/Main" title="Nginx官方文档" target="_blank" rel="external">http://wiki.nginx.org/Main</a></p>
]]></content>
    
    <summary type="html">
    
      很全的nginx配置模板，一篇文章让你掌握几乎所有的nginx配置参数。
    
    </summary>
    
      <category term="WEB中间件" scheme="https://opstrip.com/categories/WEB%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="nginx" scheme="https://opstrip.com/tags/nginx/"/>
    
      <category term="配置模板" scheme="https://opstrip.com/tags/%E9%85%8D%E7%BD%AE%E6%A8%A1%E6%9D%BF/"/>
    
      <category term="参考样例" scheme="https://opstrip.com/tags/%E5%8F%82%E8%80%83%E6%A0%B7%E4%BE%8B/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 配置 console登录</title>
    <link href="https://opstrip.com/2017/01/09/open-console-on-centos6-centos7/"/>
    <id>https://opstrip.com/2017/01/09/open-console-on-centos6-centos7/</id>
    <published>2017-01-09T06:46:44.000Z</published>
    <updated>2017-05-04T07:21:26.928Z</updated>
    
    <content type="html"><![CDATA[<p>创建KVM镜像时，为管理方便，需要镜像支持console登录。以下说说分别在centos6/centos7中配置console登录的方法。</p>
<h2 id="CentOS6-配置-console-登录"><a href="#CentOS6-配置-console-登录" class="headerlink" title="CentOS6 配置 console 登录"></a>CentOS6 配置 console 登录</h2><p><strong>1. 添加<code>ttyS0</code>的许可，允许<code>root</code>登录</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># echo "ttyS0" &gt;&gt; /etc/securetty</span></div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p><strong>2. 修改 <code>/etc/grub.conf</code> 文件</strong></p>
<p>在/etc/grub.conf文件中kernel行末尾追加<code>console=ttyS0</code></p>
<p><strong>3. 修改<code>/etc/inittab</code>文件（可省略）</strong><br>  在<code>/etc/inittab</code>中加入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">S0:12345:respawn:/sbin/agetty ttyS0 115200</div></pre></td></tr></table></figure></p>
<p><strong>4. 重启</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># reboot</span></div></pre></td></tr></table></figure></p>
<h2 id="CentOS7-配置-console-登录"><a href="#CentOS7-配置-console-登录" class="headerlink" title="CentOS7 配置 console 登录"></a>CentOS7 配置 console 登录</h2><p><strong>1. 编辑文件<code>/etc/sysconfig/grub</code></strong></p>
<p>  在<code>GRUB_CMD_LINELINUX</code>行末尾添加<code>console=ttyS0</code>，类似以下这样：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">GRUB_TIMEOUT=5</div><div class="line">GRUB_DEFAULT=saved</div><div class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></div><div class="line">GRUB_TERMINAL_OUTPUT=<span class="string">"console"</span></div><div class="line">GRUB_CMDLINE_LINUX=<span class="string">"rd.lvm.lv=centos/root rd.lvm.lv=centos/swap crashkernel=auto rhgb quiet console=ttyS0"</span></div><div class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></div></pre></td></tr></table></figure></p>
<p><strong>2. 并以root权限运行以下命令：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">stty -F /dev/ttyS0 speed 9600</div><div class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</div><div class="line">systemctl start getty@ttyS0</div></pre></td></tr></table></figure>
<p>  完成后验证。</p>
]]></content>
    
    <summary type="html">
    
      console登录配置，涵盖centos6/centos7。
    
    </summary>
    
      <category term="Linux" scheme="https://opstrip.com/categories/Linux/"/>
    
    
      <category term="console" scheme="https://opstrip.com/tags/console/"/>
    
      <category term="centos6" scheme="https://opstrip.com/tags/centos6/"/>
    
      <category term="centos7" scheme="https://opstrip.com/tags/centos7/"/>
    
  </entry>
  
</feed>
