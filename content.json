[{"title":"Linux Bash使用小技巧","date":"2017-11-27T09:43:30.000Z","path":"2017/11/27/Linux-Shell-Bash-Tips/","text":"在bash中检查远程端口是否打开:1echo &gt;/dev/tcp/8.8.8.8/53 &amp;&amp; echo \"open\" 将进程挂起:1Ctrl + z 将进程移到前台:1fg （译注，挂起的进程是不执行的，如果希望在后台执行，可以使用bg命令，并且指定通过jobs命令获得的任务号。） 生成随机16进制数字,n是字符的数量:1openssl rand -hex n 在当前shell中执行一个文件中的命令（译注：这个文件不是一个bash脚本，比如.bashrc、bash_profile等）: 1source /home/user/file.name 提取字符串的前5个字符:1$&#123;variable:0:5&#125; 打开SSH调试模式（译注：当你遇到SSH连接问题时很有用）:1ssh -vvv user@ip_address 使用pem key的进行SSH连接：1ssh user@ip_address -i key.pem 用wget获取完整目录列表到本地目录:1wget -r --no-parent --reject \"index.html*\" http://hostname/ -P /home/user/dirs 同时创建多个目录:1mkdir -p /home/user/&#123;test,test1,test2&#125; 以树状列出进程及子进程:1ps axwef 创建war文件:1jar -cvf name.war file 测试磁盘写速度:1dd if=/dev/zero of=/tmp/output.img bs=8k count=256k conv=fdatasync; rm -rf /tmp/output.img 测试磁盘读速度:1hdparm -Tt /dev/sda 获取文本的md5值:1echo -n \"text\" | md5sum 检测xml语法:1xmllint --noout file.xml 将tar.gz文件解压到指定目录:1tar zxvf package.tar.gz -C new_dir 用curl获取HTTP头:1curl -I http://www.example.com 修改一些文件或目录的时间戳 (格式为：YYMMDDhhmm):1touch -t 0712250000 file 使用wget从ftp下载:1wget -m ftp://username:password@hostname 生成随机密码 (本例中16位字符长):1LANG=c &lt; /dev/urandom tr -dc _A-Z-a-z-0-9 | head -c$&#123;1:-16&#125;;echo; 快速创建一个文件的备份（扩展名是.bkp）:1cp some_file_name&#123;,.bkp&#125; 访问Windows共享:1smbclient -U \"DOMAINuser\" //dc.domain.com/share/test/dir 运行history中的命令 (这里在history中的第100个):1!100 unzip到目录中:1unzip package_name.zip -d dir_name 输入多行文字 (按 CTRL + d 退出):1cat &gt; test.txt 创建空白的文件或者清空已存在的文件:1&gt; test.txt 从Ubuntu NTP服务器上更新日期:1ntpdate ntp.ubuntu.com netstat 显示所有IPv4的TCP监听的端口:1netstat -lnt4 | awk '&#123;print $4&#125;' | cut -f2 -d: | grep -o '[0-9]*' 将qcow2的镜像转化成raw格式:12qemu-img convert -f qcow2 -O raw precise-server-cloudimg-amd64-disk1.img \\ precise-server-cloudimg-amd64-disk1.raw 重复运行命令并显示它的输出 (默认2秒重复一次):1watch ps -ef 显示所有用户:1getent passwd 以读写模式挂载根文件系统:1mount -o remount,rw / 挂载目录 (适合于符号链接不能工作的情况下):1mount --bind /source /destination 发送DNS动态更新给DNS:1nsupdate &lt; 递归grep所有目录1grep -r \"some_text\" /path/to/dir 列出10个最大的系统中已打开的文件:1lsof / | awk '&#123; if($7 &gt; 1048576) print $7/1048576 \"MB \"$9 &#125;' | sort -n -u | tail 以MB显示空余内存:1free -m | grep cache | awk '/[0-9]/&#123; print $4\" MB\" &#125;' 打开vim并跳转到文件最后:1vim + some_file_name git clone特定branch (本例是master分支):1git clone git@github.com:name/app.git -b master git切换到另外一个branch (本例是develop分支):1git checkout develop git删除一个branch(本例是myfeature):1git branch -d myfeature Git删除一个远程branch:1git push origin :branchName Git push 新的branch到远程:1git push -u origin mynewfeature 打印history中最后的cat命令1!cat:p 运行history中的最后的cat命令:1!cat 找出在/home/user中的所有空子目录:1find /home/user -maxdepth 1 -type d -empty 得到test.txt中50到60行的文本:1&lt; test.txt sed -n '50,60p' 以sudo权限重新运行上一个执行的命令 (如果是: mkdir /root/test, 下面会运行: sudo mkdir /root/test)（译注：当你执行一个命令忘记sudo时，可以这样重新执行，而不必再把完整命令敲一遍）:1sudo !! 创建临时RAM文件系统 – ramdisk (请先创建 /tmpram 目录):1mount -t tmpfs tmpfs /tmpram -o size=512m Grep完整的单词（译注：而不是其它单词的一部分）:1grep -w \"name\" test.txt 提升权限后在一个文件后追加文本:1echo \"some text\" | sudo tee -a /path/file 列出所有支持的kill信号:1kill -l 生成随机密码 (本例中16个字符长):1openssl rand -base64 16 在bash历史中不记录最后的会话:1kill -9 $$ 扫描网络来找出开放的端口:1nmap -p 8081 172.20.0.0/16 设置git email:1git config --global user.email \"me@example.com\" 如果你有未提交的commit，与master同步:1git pull --rebase origin master 将文件名中含有txt的所有文件移动到/home/user:1find -iname \"*txt*\" -exec mv -v &#123;&#125; /home/user \\; 按行将两个文件中的对应行合并显示:1paste test.txt test1.txt shell中的进度条:1pv data.log 用netcat发送数据给服务器:1echo \"hosts.sampleHost 10 `date +%s`\" | nc 192.168.200.2 3000 转换tab为空格:1expand test.txt &gt; test1.txt 跳过bash历史:1&lt;&lt;空格&gt;&gt;cmd 回到之前的工作目录:1cd - 切割大的tar.gz文件为几个文件 (每个100MB)，并还原:12split –b 100m /path/to/large/archive /path/to/output/filescat files* &gt; archive 用curl获取HTTP状态值:1curl -sL -w \"%&#123;http_code&#125;\\n\" www.example.com -o /dev/null 当 Ctrl + c 没用时:1Ctrl + \\ 获取文件所有者:1stat -c %U file.txt 列出块设备:1lsblk -f 找出文件中带有末尾空格的文件:1find . -type f -exec egrep -l \" +$\" \"&#123;&#125;\" \\; 找出用tab缩进的文件:1find . -type f -exec egrep -l $'t' \"&#123;&#125;\" \\; 用”=”打印水平行1printf '%100sn' | tr ' ' =","tags":[{"name":"Linux","slug":"Linux","permalink":"https://opstrip.com/tags/Linux/"},{"name":"Shell","slug":"Shell","permalink":"https://opstrip.com/tags/Shell/"},{"name":"Bash","slug":"Bash","permalink":"https://opstrip.com/tags/Bash/"},{"name":"小技巧","slug":"小技巧","permalink":"https://opstrip.com/tags/小技巧/"}]},{"title":"Zabbix：企业微信告警配置","date":"2017-11-02T09:02:16.000Z","path":"2017/11/02/Zabbix-Warning-for-qiyeWeChat/","text":"Zabbix可以通过多种方式把告警信息发送到指定人，常用的有邮件，短信报警方式，但是越来越多的企业开始使用zabbix结合微信作为主要的告警方式，这样可以及时有效的把告警信息推送到接收人，方便告警的及时处理。 先决条件准备事项 微信企业号 企业号已经被部门成员关注 企业号有一个可以发送消息的应用，一个授权管理员，可以使用应用给成员发送消息 需要得到的信息 CorpID和Secret、AgentId 记录用户的账号 说明 解释下上面的几个条件。添加一个可以发送消息的应用，就可以给组织中的所有成员发送消息；如果没有权限可以联系企业微信管理员帮忙添加。这里使用的是警报通知。添加应用过程如下： 点击企业应用，新增应用 设置应用 同样也可以在微信插件里面二维码邀请关注加入通讯录 创建完成后记录下AgentID及Secret 获取CorpID在我的企业→企业信息里 获取用户账号像某位用户发送告警需要知道该用户的账号，可在通讯录中查找。若没有权限，请向您的企业微信管理员查询。打开通讯录，查看成员列表单击成员以查看成员详情 注：以上图片来自网络。 配置前的准备获取Zabbix脚本路径12[root@opstrip.com ~]# grep -i alertscripts /etc/zabbix/zabbix_server.conf AlertScriptsPath=/usr/lib/zabbix/alertscripts 我们设置zabbix默认脚本路径，这样在web端就可以获取到脚本 获取告警脚本12345[root@opstrip.com alertscripts]# cd /usr/lib/zabbix/alertscripts[root@opstrip.com alertscripts]# wget http://download.zhsir.org/Zabbix/weixin_linux_amd64[root@opstrip.com alertscripts]# mv weixin_linux_amd64 wechat[root@opstrip.com alertscripts]# chmod 755 wechat [root@opstrip.com alertscripts]# chown zabbix:zabbix wechat 运行脚本进行测试12[root@opstrip.com alertscripts]# ./wechat --corpid=wwcxxxxxxxxxxxxxxxx --corpsecret=Q-HMnIo9HKX8kZwbT4m1SUcS-kmYhmiuRgr4DCLreQA --msg=&quot;您好,告警测试&quot; --user=testUser --agentid=1000002 &#123;&quot;errcode&quot;:0,&quot;errmsg&quot;:&quot;ok&quot;,&quot;invaliduser&quot;:&quot;&quot;&#125; 提示： --corpid= 我们企业里面的id --corpsecret=这里就是我们Secret里面的id --msg=内容 --user=用来接收告警的企业微信账号 因为脚本是编译过的，无法进行编辑，我们可以使用./wechat -h or –help 查看 测试效果如下图： 在Zabbix中启用企业微信告警创建报警媒介依次在Zabbix打开管理→报警媒介类型→创建媒体类型以创建企业微信告警：添加企业微信告警： 说明： --corpid=我们企业里面的id，这里是wwcxxxxxxxxxxxxxxxx --corpsecret=我们Secret里面的id，这里是Q-HMnIo9HKX8kZwbT4m1SUcS-kmYhmiuRgr4DCLreQA --agentid=Agentld ID，这里是1000002 --user={ALERT.SENDTO}，发送给谁，创建动作时提供 --msg={ALERT.MESSAGE}，发送的信息，由触发器提供 添加动作假定您已完成好Zabbix其他的前期工作，如用户的创建、告警添加、触发器创建等。正常添加动作规则及触发器条件，在操作选项卡里添加以下规则：12345678910111213141516【告警】 &#123;TRIGGER.NAME&#125; 告警主机：&#123;HOST.NAME&#125;主机IP： &#123;HOST.IP&#125;告警时间：&#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;告警等级：&#123;TRIGGER.SEVERITY&#125;告警信息：&#123;TRIGGER.NAME&#125;问题详情：&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125;事件ID： &#123;EVENT.ID&#125;触发器URL： &#123;TRIGGER.URL&#125; Item values: 1. &#123;ITEM.NAME1&#125; (&#123;HOST.NAME1&#125;:&#123;ITEM.KEY1&#125;): &#123;ITEM.VALUE1&#125;2. &#123;ITEM.NAME2&#125; (&#123;HOST.NAME2&#125;:&#123;ITEM.KEY2&#125;): &#123;ITEM.VALUE2&#125;3. &#123;ITEM.NAME3&#125; (&#123;HOST.NAME3&#125;:&#123;ITEM.KEY3&#125;): &#123;ITEM.VALUE3&#125; 在操作项中作如下配置：恢复操作及确认操作类似。 测试验证停掉zabbix-agent进程1[root@opstrip.com ~]# systemctl stop zabbix-agent 大概5分钟后，报警如下打开微信，看到警报通知已经有收到告警了 至此，企业微信告警配置完成。","tags":[{"name":"zabbix","slug":"zabbix","permalink":"https://opstrip.com/tags/zabbix/"},{"name":"WeChat","slug":"WeChat","permalink":"https://opstrip.com/tags/WeChat/"},{"name":"告警配置","slug":"告警配置","permalink":"https://opstrip.com/tags/告警配置/"}]},{"title":"一些nginx配置小技巧","date":"2017-08-10T08:50:29.000Z","path":"2017/08/10/some-nginx-configuration-tips/","text":"nginx文件处理有些时候需要在网站中创建一些文本文件已实现某些功能，如当前获取免费SSL证书的文件验证，又不想在网站新建文件，这时候可以配置nginx返回text/plain格式文本以达到直接访问文件的效果。如下： 123456789101112131415161718server &#123; listen 80; server_name www.example.com; access_log /var/log/nginx/www-example-com.log access; root /etc/nginx/html; ...... #Aliyun ssl by txt location = /.well-known/pki-validation/fileauth.txt &#123; default_type text/plain; return 200 '201708090000005cpmpl49g1psxj1r86w70mmpi27g61r4f7u2bthwedki0trwtx'; &#125; ...... &#125; 访问效果如下： nginx图片处理ngxin有很多有一堆的module，当业务量不大服务器的负载较低时，可以简单的用ngxin的Image Filter作为图片缩放、剪裁、旋转等处理的工具。 安装依赖image filter依赖libgd2，所以需要先安装。 1yum install gd gd-devel 安装nginxnginx的module是静态加载的，必须编译到nginx的主文件里面。图片处理需要安装nginx-mod-http-image-filter模块。 1yum install nginx nginx-mod-http-image-filter nginx-all-modules 配置image filter网上有很多利用image filter做图片缩放的配置，下面是我写的一个配置（部分代码），比较简陋，另外，目前的问题是jpeg的图片质量参数无法生效，还在找原因。 12345678910111213141516171819202122232425262728293031323334353637set $width \"-\";set $height \"-\"; if ( $arg_w != \"\" )&#123; set $width $arg_w;&#125; if ( $arg_h != \"\" )&#123; set $height $arg_h;&#125; set $rotate \"-\"; if ( $arg_r != \"\" )&#123; set $rotate $arg_r;&#125; set $quality \"-\"; if ( $arg_q != \"\" )&#123; set $quality $arg_q;&#125; location /images/ &#123; image_filter resize $width $height; # 缩放图片 image_filter rotate $rotate; # 旋转图片 image_filter_jpeg_quality $quality; # jpeg图片质量，没有效果 image_filter_interlace on; # 将jpeg图片转换为可以渐进式加载的格式，这样用户可以尽快看到图片效果 image_filter_transparency on; # 是否保留图片的透明像素，因为我们还有png图，所以这里要打开 image_filter_buffer 8M; # 这里需要手动设置下图片缓存大小，默认为1M，超出1M的图片服务器会报错。 error_page 415 = /empty; # 如果处理图片文件不存在或者处理图片失败，会返回一张空白图&#125; location = /empty &#123;# 使用`empty_gif`模块，返回一张1x1像素的gif图。建议不要再前端页面中将'/empty'作为占位图，没有必要，前端页面可以使用 'data:image/gif;base64,R0lGODlhCgAKAIAAAMzMzP///yH5BAAAAAAALAAAAAAKAAoAAAIRhI8Qy6zdHlxyVnjjdJv2UAAAOw==' empty_gif; &#125; 这样就可以通过*.jpg?r=90&amp;w=100&amp;h=100这样的参数配置做图片的缩放和旋转了。 其他选择nginx 还有一些其他的第三方module可以用于图片缩放。例如： ngx_small_light 可以使用ImageMagick的功能，比image filter强大很多。 ngx_image_thumb是国产的，这个module会自动处理图盘的后缀参数，进行图片剪裁、缩放，配置起来比较容易，同时支持图片水印。","tags":[{"name":"小技巧","slug":"小技巧","permalink":"https://opstrip.com/tags/小技巧/"},{"name":"nginx","slug":"nginx","permalink":"https://opstrip.com/tags/nginx/"}]},{"title":"Nginx日志统计分析常用命令","date":"2017-07-04T06:18:31.000Z","path":"2017/07/04/Common-Commands-for-Nginx-Log-Statistics/","text":"IP相关统计 统计IP访问量 1awk '&#123;print $1&#125;' access.log | sort -n | uniq | wc -l 查看某一时间段的IP访问量(4-5点) 1grep \"07/Apr/2017:0[4-5]\" access.log | awk '&#123;print $1&#125;' | sort | uniq -c| sort -nr | wc -l 查看访问最频繁的前100个IP 1awk '&#123;print $1&#125;' access.log | sort -n |uniq -c | sort -rn | head -n 100 查看访问100次以上的IP 1awk '&#123;print $1&#125;' access.log | sort -n |uniq -c |awk '&#123;if($1 &gt;100) print $0&#125;'|sort -rn 查询某个IP的详细访问情况,按访问频率排序 1grep '104.217.108.66' access.log |awk '&#123;print $7&#125;'|sort |uniq -c |sort -rn |head -n 100 页面访问统计 查看访问最频的页面(TOP100) 1awk '&#123;print $7&#125;' access.log | sort |uniq -c | sort -rn | head -n 100 查看访问最频的页面([排除php页面】(TOP100) 1grep -v \".php\" access.log | awk '&#123;print $7&#125;' | sort |uniq -c | sort -rn | head -n 100 查看页面访问次数超过100次的页面 1cat access.log | cut -d ' ' -f 7 | sort |uniq -c | awk '&#123;if ($1 &gt; 100) print $0&#125;' | less 查看最近1000条记录，访问量最高的页面 1tail -1000 access.log |awk '&#123;print $7&#125;'|sort|uniq -c|sort -nr|less 每秒请求量统计 统计每秒的请求数,top100的时间点(精确到秒)1awk '&#123;print $4&#125;' access.log |cut -c 14-21|sort|uniq -c|sort -nr|head -n 100 每分钟请求量统计 统计每分钟的请求数,top100的时间点(精确到分钟)1awk '&#123;print $4&#125;' access.log |cut -c 14-18|sort|uniq -c|sort -nr|head -n 100 每小时请求量统计 统计每小时的请求数,top100的时间点(精确到小时)1awk '&#123;print $4&#125;' access.log |cut -c 14-15|sort|uniq -c|sort -nr|head -n 100 性能分析在nginx log中最后一个字段加入$request_time 列出传输时间超过3秒的页面，显示前20条 1cat access.log|awk '($NF &gt; 3)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -20 列出php页面请求时间超过3秒的页面，并统计其出现的次数，显示前100条 1cat access.log|awk '($NF &gt; 1 &amp;&amp; $7~/\\.php/)&#123;print $7&#125;'|sort -n|uniq -c|sort -nr|head -100 蜘蛛抓取统计 统计蜘蛛抓取次数 1grep 'Baiduspider' access.log |wc -l 统计蜘蛛抓取404的次数 1grep 'Baiduspider' access.log |grep '404' | wc -l TCP连接统计 查看当前TCP连接数 1netstat -tan | grep \"ESTABLISHED\" | grep \":80\" | wc -l 用tcpdump嗅探80端口的访问看看谁最高 1tcpdump -i eth0 -tnn dst port 80 -c 1000 | awk -F\".\" '&#123;print $1\".\"$2\".\"$3\".\"$4&#125;' | sort | uniq -c | sort -nr 实例脚本 获取前一分钟nginx访问日志条数 1234567#!/bin/bash export LANG=Cexport PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/binTIME=$(date -d \"1 minute ago\" +\"%d/%h/%Y:%H:%M\") grep \"$TIME\" /var/log/nginx/access.log | wc -l 获取前一分钟nginx错误日志条数 1234567#!/bin/bash export LANG=Cexport PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/binTIME=$(date -d \"1 minute ago\" +\"%Y-%m-%d %H:%M\") grep \"$TIME\" /var/log/nginx/error.log | wc -l","tags":[{"name":"Nginx","slug":"Nginx","permalink":"https://opstrip.com/tags/Nginx/"},{"name":"日志分析","slug":"日志分析","permalink":"https://opstrip.com/tags/日志分析/"},{"name":"常用命令","slug":"常用命令","permalink":"https://opstrip.com/tags/常用命令/"}]},{"title":"MegaCli:如何使用命令行监控RAID卡状态","date":"2017-06-14T06:30:47.000Z","path":"2017/06/14/howto-monitor-raidCard-status-with-commandline-MegaCli/","text":"简介MegaCli是一款管理维护硬件RAID软件，可以通过它来了解当前raid卡的所有信息，包括 raid卡的型号，raid的阵列类型，raid 上各磁盘状态，等等。通常，我们对硬盘当前的状态不太好确定，一般通过机房人员巡检来完成，有没有通过软件的方式来检查确定这个问题呢。MegaCli就可以做到，一般通过 MegaCli 的Media Error Count: 0 Other Error Count: 0 这两个数值来确定阵列中磁盘是否有问题；Medai Error Count 表示磁盘可能错误，可能是磁盘有坏道，这个值不为0值得注意，数值越大，危险系数越高，Other Error Count 表示磁盘可能存在松动，可能需要重新再插入。MegaCli 可以对阵列中所有的磁盘进行检测，我们可以通过脚本的方式来检测相关参数，从而通知管理人员。 下载MegCli猛击以下链接下载：安装包下载 安装 12[root@localhost opt]# tar xf MegaCli8.07.10.tar.gz[root@localhost opt]# rpm -ivh MegaCli8.07.10/Linux/&#123;Lib_Utils-1.00-09,MegaCli-8.02.21-1&#125;.noarch.rpm 使用命令及参数命令使用 常用命令12345678910111213141516/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -Lall -aALL 【查raid级别】/opt/MegaRAID/MegaCli/MegaCli64 -AdpAllInfo -aALL 【查raid卡信息】/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aALL 【查看硬盘信息】/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -aAll 【查看电池信息】/opt/MegaRAID/MegaCli/MegaCli64 -FwTermLog -Dsply -aALL 【查看raid卡日志】/opt/MegaRAID/MegaCli/MegaCli64 -adpCount 【显示适配器个数】/opt/MegaRAID/MegaCli/MegaCli64 -AdpGetTime –aALL 【显示适配器时间】/opt/MegaRAID/MegaCli/MegaCli64 -AdpAllInfo -aAll 【显示所有适配器信息】/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -LALL -aAll 【显示所有逻辑磁盘组信息】/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aAll 【显示所有的物理信息】/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuStatus -aALL | grep 'Charger Status' 【查看充电状态】/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuStatus -aALL 【显示BBU状态信息】/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuCapacityInfo -aALL 【显示BBU容量信息】/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuDesignInfo -aALL 【显示BBU设计参数】/opt/MegaRAID/MegaCli/MegaCli64 -AdpBbuCmd -GetBbuProperties -aALL 【显示当前BBU属性】/opt/MegaRAID/MegaCli/MegaCli64 -cfgdsply -aALL 【显示Raid卡型号，Raid设置，Disk相关信息】 磁带状态的变化从拔盘，到插盘的过程中：123Device |Normal|Damage|Rebuild|NormalVirtual Drive |Optimal|Degraded|Degraded|OptimalPhysical Drive |Online|Failed –&gt; Unconfigured|Rebuild|Online 查看磁盘缓存策略12345/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -L0 -a0/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -L1 -a0/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -LALL -a0/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -Cache -LALL -aALL/opt/MegaRAID/MegaCli/MegaCli64 -LDGetProp -DskCache -LALL -aALL 设置磁盘缓存策略缓存策略解释：1234567WT (Write throughWB (Write back)NORA (No read ahead)RA (Read ahead)ADRA (Adaptive read ahead)CachedDirect 例子：1234/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp WT|WB|NORA|RA|ADRA -L0 -a0/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -Cached|-Direct -L0 -a0enable / disable disk cache/opt/MegaRAID/MegaCli/MegaCli64 -LDSetProp -EnDskCache|-DisDskCache -L0 -a0 创建一个 raid5 阵列由物理盘 2,3,4 构成，该阵列的热备盘是物理盘 51/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r5 [1:2,1:3,1:4] WB Direct -Hsp[1:5] -a0 创建阵列，不指定热备1/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r5 [1:2,1:3,1:4] WB Direct -a0 删除阵列1/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdDel -L1 -a0 在线添加磁盘1/opt/MegaRAID/MegaCli/MegaCli64 -LDRecon -Start -r5 -Add -PhysDrv[1:4] -L1 -a0 查看进度阵列创建完后，会有一个初始化同步块的过程，可以看看其进度。1/opt/MegaRAID/MegaCli/MegaCli64 -LDInit -ShowProg -LALL -aALL 或者以动态可视化文字界面显示1/opt/MegaRAID/MegaCli/MegaCli64 -LDInit -ProgDsply -LALL -aALL 查看阵列后台初始化进度1/opt/MegaRAID/MegaCli/MegaCli64 -LDBI -ShowProg -LALL -aALL 或者以动态可视化文字界面显示1/opt/MegaRAID/MegaCli/MegaCli64 -LDBI -ProgDsply -LALL -aALL 热备管理 指定第5块盘作为全局热备 1/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] -a0 指定为某个阵列的专用热备 1/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Set [-Dedicated [-Array1]] [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] -a0 删除全局热备 1/opt/MegaRAID/MegaCli/MegaCli64 -PDHSP -Rmv -PhysDrv[1:5] -a0 将某块物理盘下线/上线12/opt/MegaRAID/MegaCli/MegaCli64 -PDOffline -PhysDrv [1:4] -a0/opt/MegaRAID/MegaCli/MegaCli64 -PDOnline -PhysDrv [1:4] -a0 查看物理磁盘重建进度1/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ShowProg -PhysDrv [1:5] -a0 或者以动态可视化文字界面显示1/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ProgDsply -PhysDrv [1:5] -a0 磁带状态的变化从拔盘，到插盘的过程中：123Device |Normal|Damage|Rebuild|NormalVirtual Drive |Optimal|Degraded|Degraded|OptimalPhysical Drive |Online|Failed –&gt; Unconfigured|Rebuild|Online 实用案例查看RAID级别 查看RAID卡信息主要输出RAID卡的一些配置信息123456RAID Level : Primary-1, Secondary-0, RAID Level Qualifier-0Size : 1.698 TBState : OptimalStrip Size : 128 KBNumber Of Drives per span:2 //表示每2个物理盘做成一个RAID1盘组Span Depth : 3 //表示共3个RAID1盘组做成了RAID10 查看所有硬盘的信息1/opt/MegaRAID/MegaCli/MegaCli64 -pdlist –aALL 查看当前RAID缓存状态RAID缓存状态设置为wb的话要注意电池放电事宜，设置电池放电模式为自动学习模式1/opt/MegaRAID/MegaCli/MegaCli64 -ldgetprop -dskcache -lall -aall RAID电池设置相关 查看电池状态信息(Display BBU Status Information) 12MegaCli -AdpBbuCmd -GetBbuStatus -aN|-a0,1,2|-aALLMegaCli -AdpBbuCmd -GetBbuStatus -aALL 查看电池容量（Display BBU Capacity Information） 12MegaCli -AdpBbuCmd -GetBbuCapacityInfo -aN|-a0,1,2|-aALLMegaCli -AdpBbuCmd -GetBbuCapacityInfo –aALL 查看电池设计参数(Display BBU Design Parameters) 12MegaCli -AdpBbuCmd -GetBbuDesignInfo -aN|-a0,1,2|-aALLMegaCli -AdpBbuCmd -GetBbuDesignInfo –aALL 查看电池属性（Display Current BBU Properties） 12MegaCli -AdpBbuCmd -GetBbuProperties -aN|-a0,1,2|-aALLMegaCli -AdpBbuCmd -GetBbuProperties –aALL 设置电池为学习模式为循环模式（Start BBU Learning Cycle）Description Starts the learning cycle on the BBU.No parameter is needed for this option.MegaCli -AdpBbuCmd -BbuLearn -aN|-a0,1,2|-aALL RAID磁盘设置相关 设置磁盘的缓存模式和访问方式 （Change Virtual Disk Cache and Access Parameters） 12345678910111213Description Allows you to change the following virtual disk parameters:-WT (Write through), WB (Write back): Selects write policy.-NORA (No read ahead), RA (Read ahead), ADRA (Adaptive read ahead): Selects read policy.-Cached, -Direct: Selects cache policy.-RW, -RO, Blocked: Selects access policy.-EnDskCache: Enables disk cache.-DisDskCache: Disables disk cache.MegaCli -LDSetProp &#123; WT | WB|NORA |RA | ADRA|-Cached|Direct&#125; |&#123;-RW|RO|Blocked&#125; |&#123;-Name[string]&#125; |&#123;-EnDskCache|DisDskCache&#125; –Lx |-L0,1,2|-Lall -aN|-a0,1,2|-aALLMegaCli -LDSetProp WT -L0 -a0 显示磁盘缓存和访问方式（Display Virtual Disk Cache and Access Parameters） 1234567MegaCli -LDGetProp -Cache | -Access | -Name | -DskCache -Lx|-L0,1,2|-Lall -aN|-a0,1,2|-aALLDisplays the cache and access policies of the virtual disk(s):-WT (Write through), WB (Write back): Selects write policy.-NORA (No read ahead), RA (Read ahead), ADRA (Adaptive read ahead): Selects read policy.-Cache, -Cached, Direct: Displays cache policy.-Access, -RW, -RO, Blocked: Displays access policy.-DskCache: Displays physical disk cache policy. Megaraid必知必会使用LSI的megaraid可以对raid进行有效监控。别的厂商比如HP,IBM也有自己的raid API1MegaCli -ldinfo -lall -aall 查询raid级别，磁盘数量，容量，条带大小。 1MegaCli -cfgdsply -aALL |grep Policy 查询控制器cache策略 1MegaCli -LDSetProp WB -L0 -a0 设置write back功能 1MegaCli -LDSetProp CachedBadBBU -L0 -a0 设置即使电池坏了还是保持WB功能 1MegaCli -AdpBbuCmd -BbuLearn a0 手动充电 1MegaCli -FwTermLog -Dsply -aALL 显示适配器个数 1MegaCli -adpCount 显示所有适配器信息 123MegaCli -AdpAllInfo -aAllCritical Disks : 0 Failed Disks : 0 显示所有逻辑磁盘组信息 1MegaCli -LDInfo -LALL -aAll 显示所有的物理信息 123MegaCli -PDList -aAllMedia Error Count: 0Other Error Count: 0 查看充电状态 123MegaCli -AdpBbuCmd -GetBbuStatus -aALLLearn Cycle Requested : NoFully Charged : Yes 显示BBU(后备电池)状态信息 1MegaCli -AdpBbuCmd -GetBbuStatus -aALL 显示BBU容量信息 1MegaCli -AdpBbuCmd -GetBbuCapacityInfo -aALL 显示BBU设计参数 1MegaCli -AdpBbuCmd -GetBbuDesignInfo -aALL 显示当前BBU属性 1MegaCli -AdpBbuCmd -GetBbuProperties -aALL 显示Raid卡型号，Raid设置，Disk相关信息 1MegaCli -cfgdsply -aALL 查看Cache策略设置 12MegaCli -cfgdsply -aALL |grep -i PolicyCurrent Cache Policy: WriteBack, ReadAheadNone, Direct, Write Cache OK if Bad BBU 查看充电进度百分比 1MegaCli -AdpBbuCmd -GetBbuStatus -aALL 各种设备和磁盘的不同状态： 123Device |Normal|Damage|Rebuild|NormalVirtual Drive |Optimal|Degraded|Degraded|OptimalPhysical Drive |Online|Failed –&gt; Unconfigured|Rebuild|Online 通过脚本检测RAID磁盘状态Linux下脚本1234567891011121314151617#!/bin/bash#check raid disk statusMEGACLI=\"/opt/MegaRAID/MegaCli/MegaCli64 \"$MEGACLI -pdlist -aALL | grep \"Firmware state\" | awk -F : '&#123;print $2&#125;' | awk -F , '&#123;print $1&#125;' &gt;/tmp/fireware.log$MEGACLI -pdlist -aALL | grep -E \"Media Error|Other Error\" | awk -F : '&#123;print $2&#125;' &gt;/tmp/disk.logfor i in `cat &lt; /tmp/disk.log`do if [ $i -ne 0 ] then curl \"http://xxxxxxB&amp;state=ALARM&amp;description=raid_disk_error\" fidonefor i in `cat &lt; /tmp/fireware.log`do if [ $i != Online ] then curl \"http://xxxxxxstate=ALARM&amp;description=raid_disk_offline\" fidone Windows下脚本Windows下脚本用的工具是gnu for windows平台的一些软件，如 bash grep awk cat通过bash直接调用脚本如：G:\\raid_check\\unixtools&gt;bash.exe G:\\disk.sh1234567891011121314151617181920#check raid disk statusMEGACLI=\"//G/raid_check/MegaCli.exe\"GREP=\"//G/raid_check/unixtools/grep.exe\"AWK=\"//G/raid_check/unixtools/awk.exe\"CAT=\"//G/raid_check/unixtools/cat.exe\"CURL=\"//G/raid_check/unixtools/curl.exe\"$MEGACLI -pdlist -aALL | $GREP \"Firmware state\" |$AWK -F: '&#123;print $2&#125;' |$AWK -F , '&#123;print $1&#125;' &gt;//c/fireware.log$MEGACLI -pdlist -aALL | $GREP -E \"Media Error|Other Error\" | $AWK -F : '&#123;print $2&#125;' &gt; //c/disk.logfor i in `$CAT c:/disk.log`do if [ $i -ne 0 ] then $CURL \"http://xxxxxx&amp;description=raid_disk_error\" fidonefor i in `$CAT c:/fireware.log`do if [ $i != Online ] then $CURL \"http://xxxxx&amp;state=ALARM&amp;description=raid_disk_offline\" fidone 附录 查看raid级别： 1MegaCli -LDInfo -Lall -aALL 查看raid卡信息： 1MegaCli -AdpAllInfo -aALL 查看硬盘信息： 1MegaCli -PDList -aALL 查看电池信息： 1MegaCli -AdpBbuCmd -aAll 查看raid卡日志： 1MegaCli -FwTermLog -Dsply -aALL 显示适配器个数： 1MegaCli -adpCount 显示适配器时间： 1MegaCli -AdpGetTime –aALL 显示所有适配器信息： 1MegaCli -AdpAllInfo -aAll 显示所有逻辑磁盘组信息： 1MegaCli -LDInfo -LALL -aAll 显示所有的物理信息： 1MegaCli -PDList -aAll 查看充电状态： 1MegaCli -AdpBbuCmd -GetBbuStatus -aALL |grep 'Charger Status' 显示BBU状态信息： 1MegaCli -AdpBbuCmd -GetBbuStatus -aALL 显示BBU容量信息： 1MegaCli -AdpBbuCmd -GetBbuCapacityInfo -aALL 显示BBU设计参数： 1MegaCli -AdpBbuCmd -GetBbuDesignInfo -aALL 显示当前BBU属性： 1MegaCli -AdpBbuCmd -GetBbuProperties -aALL 显示Raid卡型号，Raid设置，Disk相关信息： 1MegaCli -cfgdsply -aALL 查看磁盘缓存策略： 12345MegaCli -LDGetProp -Cache -L0 -a0MegaCli -LDGetProp -Cache -L1 -a0MegaCli -LDGetProp -Cache -LALL -a0MegaCli -LDGetProp -Cache -LALL -aALLMegaCli -LDGetProp -DskCache -LALL -aALL 设置磁盘缓存策略：缓存策略：1234567WT (Write through)WB (Write back)NORA (No read ahead)RA (Read ahead)ADRA (Adaptive read ahead)CachedDirect 如：1234567891011MegaCli -LDSetProp WT|WB|NORA|RA|ADRA -L0 -a0MegaCli -LDSetProp -Cached|-Direct -L0 -a0enable / disable disk cacheMegaCli -LDSetProp -EnDskCache|-DisDskCache -L0 -a0``` - 创建/删除阵列：如：创建一个 raid5 阵列，由物理盘 2,3,4 构成，该阵列的热备盘是物理盘 5```bashMegaCli -CfgLdAdd -r5 [1:2,1:3,1:4] WB Direct -Hsp[1:5] -a0 创建阵列，不指定热备：1MegaCli -CfgLdAdd -r5 [1:2,1:3,1:4] WB Direct -a0 删除阵列：1MegaCli -CfgLdDel -L1 -a0 在线添加磁盘：重建逻辑磁盘组1，raid级别是5，添加物理磁盘号：1:41MegaCli -LDRecon -Start -r5 -Add -PhysDrv[1:4] -L1 -a0 查看阵列初始化信息：阵列创建完后，会有一个初始化同步块的过程，可以看看其进度1MegaCli -LDInit -ShowProg -LALL -aALL 以动态可视化文字界面显示1MegaCli -LDInit -ProgDsply -LALL -aALL 查看阵列后台初始化进度1MegaCli -LDBI -ShowProg -LALL -aALL 以动态可视化文字界面显示1MegaCli -LDBI -ProgDsply -LALL -aALL 创建全局热备： 指定第5块盘作为全局热备1MegaCli -PDHSP -Set [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] -a0 也可以指定为某个阵列的专用热备1MegaCli -PDHSP -Set [-Dedicated [-Array1]] [-EnclAffinity] [-nonRevertible] -PhysDrv[1:5] -a0 删除全局热备：1MegaCli -PDHSP -Rmv -PhysDrv[1:5] -a0 将某块物理盘下线/上线： 12MegaCli -PDOffline -PhysDrv [1:4] -a0MegaCli -PDOnline -PhysDrv [1:4] -a0 查看物理磁盘重建进度： 1MegaCli -PDRbld -ShowProg -PhysDrv [1:5] -a0 以动态可视化文字界面显示1MegaCli -PDRbld -ProgDsply -PhysDrv [1:5] -a0 参考来源：http://blog.csdn.net/w57w57w57/article/details/7214128","tags":[{"name":"MegaCli","slug":"MegaCli","permalink":"https://opstrip.com/tags/MegaCli/"},{"name":"RAID","slug":"RAID","permalink":"https://opstrip.com/tags/RAID/"},{"name":"磁盘阵列","slug":"磁盘阵列","permalink":"https://opstrip.com/tags/磁盘阵列/"}]},{"title":"在CentOS7中部署php7.1及开启MySQL扩展","date":"2017-05-31T09:24:24.000Z","path":"2017/05/31/Deploying-php71-and-opening-MySQL-extension-on-CentOS7/","text":"之前在CentOS7安装php7.1的时候有遇到PHP源及PHP7.1不支持MySQL扩展问题，上午抽空安装了下终于解决了这两个问题，特此记录备忘。 简单安装(yum方式)安装软件源添加epel源12[root@opstrip.com opt]# rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY*[root@opstrip.com opt]# rpm -Uvh http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-10.noarch.rpm 备用源：http://mirrors.rit.edu/fedora/epel/7/x86_64/e/epel-release-7-10.noarch.rpm 添加remi源1[root@opstrip.com opt]# rpm -Uvh http://rpms.remirepo.net/enterprise/remi-release-7.rpm 安装并更新软件安装yum-config-manager实用程序1[root@opstrip.com opt]# yum -y install yum-utils 更新系统当前软件版本 1[root@opstrip.com opt]# yum -y update 更新完成后，就可以安装所需要的PHP版本了。 安装PHP以上准备工作完成后，就可以安装所需的PHP版本了。 对于PHP5.41[root@opstrip.com opt]# yum -y install php 安装前可尝试yum search php54搜索可安装的软件包。 对于PHP7.012[root@opstrip.com opt]# yum-config-manager --enable remi-php70[root@opstrip.com opt]# yum -y install php php-opcache 安装前可尝试yum search php70搜索可安装的软件包。 对于PHP7.112[root@opstrip.com opt]# yum-config-manager --enable remi-php71[root@opstrip.com opt]# yum -y install php php-opcache 安装前可尝试yum search php71搜索可安装的软件包。 完成后还需要添加PHP常用扩展：1[root@opstrip.com opt]# yum -y install php-mysql php-gd php-ldap php-odbc php-pear php-xml php-xmlrpc php-mbstring php-soap curl curl-devel 对于Nginx1[root@opstrip.com opt]# yum -y install nginx nginx-mod-http-perl nginx-mod-stream nginx-filesystem nginx-mod-mail nginx-mod-http-image-filter nginx-all-modules nginx-mod-http-geoip nginx-mod-http-xslt-filter 安装前仍建议尝试yum search nginx搜索可安装的软件包。 安装完成后配置PHP及Nginx并启动用以测试phpinfo页面，这时候应该能正常显示。 源码编译安装安装前的准备下载PHP安装包1[root@opstrip.com opt]# wget -O php-7.1.5.tar.gz http://cn2.php.net/distributions/php-7.1.5.tar.gz 解压1[root@opstrip.com opt]# tar xf php-7.1.5.tar.gz 安装依赖包1[root@opstrip.com php-7.1.5]# yum install -y libxml2 libxml2-devel openssl openssl-devel bzip2 bzip2-devel libcurl libcurl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel gmp gmp-devel libmcrypt libmcrypt-devel readline readline-devel libxslt libxslt-devel 配置安装编译配置123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869[root@opstrip.com opt]# cd php-7.1.5[root@opstrip.com php-7.1.5]# ./configure \\--prefix=/usr/local/php \\--with-config-file-path=/etc \\--enable-fpm \\--with-fpm-user=www \\--with-fpm-group=www \\--enable-inline-optimization \\--disable-debug \\--disable-rpath \\--enable-shared \\--enable-soap \\--with-libxml-dir \\--with-xmlrpc \\--with-openssl \\--with-mcrypt \\--with-mhash \\--with-pcre-regex \\--with-sqlite3 \\--with-zlib \\--enable-bcmath \\--with-iconv \\--with-bz2 \\--enable-calendar \\--with-curl \\--with-cdb \\--enable-dom \\--enable-exif \\--enable-fileinfo \\--enable-filter \\--with-pcre-dir \\--enable-ftp \\--with-gd \\--with-openssl-dir \\--with-jpeg-dir \\--with-png-dir \\--with-zlib-dir \\--with-freetype-dir \\--enable-gd-native-ttf \\--with-ldap \\--with-gettext \\--with-gmp \\--with-mhash \\--enable-json \\--enable-mbstring \\--enable-mbregex \\--enable-mbregex-backtrack \\--with-libmbfl \\--with-onig \\--enable-pdo \\--with-mysqli=mysqlnd \\--with-pdo-mysql=mysqlnd \\--with-zlib-dir \\--with-pdo-sqlite \\--with-readline \\--enable-session \\--enable-shmop \\--enable-simplexml \\--enable-sockets \\--enable-sysvmsg \\--enable-sysvsem \\--enable-sysvshm \\--enable-wddx \\--with-libxml-dir \\--with-xsl \\--enable-zip \\--enable-mysqlnd-compression-support \\--with-pear \\--enable-opcache 具体可以参考PHP官方安装说明文档：http://php.net/manual/zh/install.unix.nginx.php 编译安装1[root@opstrip.com php-7.1.5]# make &amp;&amp; make install 配置环境变量：在/etc/profile末尾追加export PATH=$PATH:/usr/local/php/bin，然后执行source /etc/profile生效后查看php版本：1234[root@opstrip.com php-7.1.5]# php -vPHP 7.1.5 (cli) (built: May 31 2017 16:12:38) ( NTS )Copyright (c) 1997-2017 The PHP GroupZend Engine v3.1.0, Copyright (c) 1998-2017 Zend Technologies 安装后的配置配置php-fpm安装完成后可以通过sapi/fpm/php-fpm.server来启动php-fpm了。不过为了以后管理方便，通常需要将配置文件统一放到/etc目录下，并将php-fpm.server添加至systemctl服务。如下：12345[root@opstrip.com php-7.1.5]# mkdir -p /etc/php-fpm.d[root@opstrip.com php-7.1.5]# cp php.ini-production /etc/php.ini[root@opstrip.com php-7.1.5]# cp sapi/fpm/php-fpm.service /usr/lib/systemd/system/[root@opstrip.com php-7.1.5]# cp sapi/fpm/php-fpm.conf /etc/[root@opstrip.com php-7.1.5]# cp sapi/fpm/www.conf /etc/php-fpm.d/ 然后更改/usr/lib/systemd/system/php-fpm.service文件使其执行正确的路径，如下：123456789101112131415161718[root@opstrip.com php-7.1.5]# vi /usr/lib/systemd/system/php-fpm.service# It&apos;s not recommended to modify this file in-place, because it# will be overwritten during upgrades. If you want to customize,# the best way is to use the &quot;systemctl edit&quot; command. [Unit]Description=The PHP FastCGI Process ManagerAfter=network.target [Service]Type=simplePIDFile=/var/run/php-fpm.pidExecStart=/usr/local/php/sbin/php-fpm --nodaemonize --fpm-config /etc/php-fpm.confExecReload=/bin/kill -USR2 $MAINPIDPrivateTmp=true [Install]WantedBy=multi-user.target 启动php-fpm第一次通过systemctl启动PHP服务时需要先将php-fpm服务enable：12[root@opstrip.com php-7.1.5]# systemctl enable php-fpm.service[root@opstrip.com php-7.1.5]# systemctl start php-fpm.service 编译安装Nginx详见前文，并根据需要配置并启动Nginx。这里就不在写了。 开启MySQL扩展(仅编译安装)由于PHP7已经完全移除了MySQL的扩展支持（由mysqli与mysqlnd取代），因此一些老的软件在升级PHP版本后会报类似mysql_connect()函数未定义的错误，一般建议使用新的PHPmysqli或者pdo扩展进行替换。当然也可以检出遗留版本的支持MySQL扩展的PHP7代码自行编译安装了，不过需要注意的就是MySQL扩展可是完全没有后续更新的了。 安装前准备查看当前扩展查看当前PHP7.1自带扩展：123456789[root@opstrip.com php-7.1.5]# ls extbcmath dom gd json oci8 pdo_firebird posix skeleton sysvsem xmlwriterbz2 enchant gettext ldap odbc pdo_mysql pspell snmp sysvshm xslcalendar exif gmp libxml opcache pdo_oci readline soap tidy zipcom_dotnet ext_skel hash mbstring openssl pdo_odbc recode sockets tokenizer zlibctype ext_skel_win32.php iconv mcrypt pcntl pdo_pgsql reflection spl wddxcurl fileinfo imap mysql pcre pdo_sqlite session sqlite3 xmldate filter interbase mysqli pdo pgsql shmop standard xmlreaderdba ftp intl mysqlnd pdo_dblib phar simplexml sysvmsg xmlrpc 可以看到MySQL扩展确实已经被移除了，我们可以直接在ext目录下检出老的PHP MySQL扩展代码。 获取PHP MySQL扩展源码1234567[root@opstrip.com ext]# git clone https://github.com/php/pecl-database-mysql mysql --recursiveCloning into &apos;mysql&apos;...remote: Counting objects: 145, done.remote: Total 145 (delta 0), reused 0 (delta 0), pack-reused 145Receiving objects: 100% (145/145), 88.41 KiB | 0 bytes/s, done.Resolving deltas: 100% (65/65), done.Checking connectivity... done. 编译安装MySQL扩展使用phpize编译123456789[root@opstrip.com ext]# cd mysql[root@opstrip.com mysql]# lsconfig.m4 config.w32 CREDITS LICENSE mysql.mak mysql_mysqlnd.h package.xml php_mysql.c php_mysql.h php_mysql_structs.h README.md tests[root@opstrip.com mysql]# /usr/local/php/bin/phpizeConfiguring for:PHP Api Version: 20151012Zend Module Api No: 20151012Zend Extension Api No: 320151012[root@opstrip.com mysql]# ./configure --with-php-config=/usr/local/php/bin/php-config 安装123[root@opstrip.com mysql]# make &amp;&amp; make install[root@opstrip.com mysql]# ls /usr/local/php/lib/php/extensions/no-debug-non-zts-20160303/mysql.so opcache.a opcache.so 安装完成后需确认MySQL扩展安装是否正确。最后修改php.ini配置文件，增加一行：1extension = &quot;mysql.so&quot; 重新启动php-fpm服务就能在phpinfo里看到MySQL扩展了： 开启Memcache扩展(仅编译安装)php7.0之前版本正常编译安装memcache扩展就可以了，但是php7.0及以后的版本安装http://pecl.php.net/package/memcache下的任一款memcache都会报错。这是因为一些文件及目录变动导致的，可移步Github的pecl-memcache分支版本下载。https://github.com/websupport-sk/pecl-memcache/archive/php7.zip 下载并编译安装Memcache12345678[root@opstrip.com ext]# wget https://github.com/websupport-sk/pecl-memcache/archive/php7.zip[root@opstrip.com ext]# unzip php7.zip[root@opstrip.com ext]# cd pecl-memcache-php7[root@opstrip.com pecl-memcache-php7]# /usr/local/php/bin/phpize[root@opstrip.com pecl-memcache-php7]# ./configure --with-php-config=/usr/local/php/bin/php-config[root@opstrip.com pecl-memcache-php7]# make &amp;&amp; make install[root@opstrip.com mysql]# ls /usr/local/php/lib/php/extensions/no-debug-non-zts-20160303/mysql.so opcache.a opcache.so memcache.so 添加配置文件修改php.ini配置文件，增加一行：1extension = &quot;memcache.so&quot; 重新启动php-fpm，如果无报错，则打开phpinfo探针页面应该能在网页中找到Memcache项。如下图： --本配置完。 参考来源： https://www.howtoforge.com/tutorial/centos-lamp-server-apache-mysql-php/ http://www.jianshu.com/p/871fd9518e29 https://zohead.com/archives/php7-mysql/","tags":[{"name":"CentOS7","slug":"CentOS7","permalink":"https://opstrip.com/tags/CentOS7/"},{"name":"Linux","slug":"Linux","permalink":"https://opstrip.com/tags/Linux/"},{"name":"备忘录","slug":"备忘录","permalink":"https://opstrip.com/tags/备忘录/"}]},{"title":"阿里云：在ECS上挂载ossfs","date":"2017-05-26T03:05:37.000Z","path":"2017/05/26/Mounting-ossfs-on-ECS/","text":"OSS与CDNOSS阿里云OSS（Object Storage Service，对象存储服务）是阿里云提供的对象存储服务，具有以下特点： 可以提供海量的文件存储，具有无限可伸缩能力； 有遍布全国及海外的数据中心，满足不同区域用户的使用； 服务稳定，达到7个9； 价格便宜； 与阿里云其他云产品组成生态体系，无缝衔接，自带图片处理服务，可以满足多种多样的业务场景； 技术团队可以提供7×24小时的技术支持。除此之外，OSS还支持更加强大的权限体系，可以满足更加复杂的场景，并且具有极好的数据安全性。 CDNCDN（Content Delivery Network，即内容分发网络），其基本思路是尽可能避开互联网上有可能影响数据传输速度和稳定性的瓶颈和环节，使内容传输的更快、更稳定。通过在网络各处放置节点服务器所构成的在现有的互联网基础之上的一层智能虚拟网络，CDN系统能够实时地根据网络流量和各节点的连接、负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上。其目的是使用户可就近取得所需内容，解决 Internet网络拥挤的状况，提高用户访问网站的响应速度。 综上，OSS就是云存储（也有些计算能力，如图片处理等），CDN就是网络优化。 权限配置 在OSS中新建Bucket。假设BucketName为example，所属区域为华东2，读写权限私有，因此这个Bucket的外网链接地址为：http://example.oss-cn-shanghai.aliyuncs.com，内网地址为：http://example.oss-cn-shanghai-internal.aliyuncs.com。创建完Bucket后就已经将ossfs挂载到ECS主机了。ossfs挂载需要用到AccessKey，即AccessKeyID和AccessKeySecret。AccessKey是与用户权限一一对应的（可以在AccessKey管理中创建），所以在挂载ossfs的时候需要做访问控制来严格限制权限。在访问控制RAM的用户管理中创建用户user，在策略管理中创建自定义策略example，策略内容如下：12345678910111213&#123; \"Statement\": [ &#123; \"Action\": \"oss:*\", \"Effect\": \"Allow\", \"Resource\": [ \"acs:oss:*:*:example\", \"acs:oss:*:*:example/*\" ] &#125; ], \"Version\": \"1\"&#125; 完成在用户管理中将策略example授权给user用户。进入user用户的用户详情，在用户AccessKey中创建AccessKey并保存下AccessKeyID和AccessKeySecret备用。 安装与配置下载安装ossfs安装包：12$ wget https://github.com/aliyun/ossfs/releases/download/v1.80.0/ossfs_1.80.0_centos7.0_x86_64.rpm$ sudo yum localinstall -y ossfs_1.80.0_centos7.0_x86_64.rpm 创建/etc/passwd-ossfs123$ sudo echo example:aAaAAAaaaAAaa:BbBBBBBbbbbbbbbbbB &gt; /etc/passwd-ossfs$ sudo chmod 640 /etc/passwd-ossfs$ sudo mkdir -p /data/example 说明：/etc/passwd-ossfs文件格式是BucketName:AccessKeyID:AccessKeySecret，权限建议640。 挂载ossfs均以上面的example为例。 经典网络1$ sudo ossfs example /data/example -ourl=http://oss-cn-shanghai-internal.aliyuncs.com -oallow_other 私有网络1$ sudo ossfs example /data/example -ourl=http://vpc100-oss-cn-shanghai.aliyuncs.com -oallow_other 详细参考：https://help.aliyun.com/document_detail/31837.html?spm=5176.7739584.2.2.M93hk9 配置开机自启最后可以将这条命令写入到开机启动脚本里实现开机自动挂载。 12345678910111213141516$ sudo vi /etc/rc.d/rc.local#!/bin/bash# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES## It is highly advisable to create own systemd services or udev rules# to run scripts during boot instead of using this file.## In contrast to previous versions due to parallel execution during boot# this script will NOT be run after all other services.## Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure# that this script will be executed during boot.touch /var/lock/subsys/local/usr/local/bin/ossfs ossfs example /data/example -ourl=http://vpc100-oss-cn-shanghai.aliyuncs.com -oallow_other$ sudo chmod +x /etc/rc.d/rc.local 参考来源：https://github.com/aliyun/ossfs/blob/master/README.md","tags":[{"name":"阿里云","slug":"阿里云","permalink":"https://opstrip.com/tags/阿里云/"},{"name":"ECS","slug":"ECS","permalink":"https://opstrip.com/tags/ECS/"},{"name":"oss","slug":"oss","permalink":"https://opstrip.com/tags/oss/"},{"name":"挂载","slug":"挂载","permalink":"https://opstrip.com/tags/挂载/"},{"name":"ossfs","slug":"ossfs","permalink":"https://opstrip.com/tags/ossfs/"}]},{"title":"9个常用iptables配置实例","date":"2017-05-19T02:49:56.000Z","path":"2017/05/19/nine-kinds-of-usage-for-iptables/","text":"iptables命令可用于配置Linux的包过滤规则，常用于实现防火墙、NAT。咋一看iptables的配置很复杂，掌握规律后，其实用iptables完成指定任务并不难，下面我们通过具体实例，学习iptables的详细用法。 删除已有规则在新设定iptables规则时，我们一般先确保旧规则被清除，用以下命令清除旧规则：12iptables -F(or iptables --flush) 设置chain策略对于filter table，默认的chain策略为ACCEPT，我们可以通过以下命令修改chain的策略：123iptables -P INPUT DROPiptables -P FORWARD DROPiptables -P OUTPUT DROP 以上命令配置将接收、转发和发出包均丢弃，施行比较严格的包管理。由于接收和发包均被设置为丢弃，当进一步配置其他规则的时候，需要注意针对INPUT和OUTPUT分别配置。当然，如果信任本机器往外发包，以上第三条规则可不必配置。 配置屏蔽指定ip有时候我们发现某个ip不停的往服务器发包，这时我们可以使用以下命令，将指定ip发来的包丢弃： 12BLOCK_THIS_IP=\"x.x.x.x\"iptables -A INPUT -i eth0 -p tcp -s \"$BLOCK_THIS_IP\" -j DROP 以上命令设置将由x.x.x.x ip发往eth0网口的tcp包丢弃。 配置服务项利用iptables，我们可以对日常用到的服务项进行安全管理，比如设定只能通过指定网段、由指定网口通过SSH连接本机：12iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPTiptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT 若要支持由本机通过SSH连接其他机器，由于在本机端口建立连接，因而还需要设置以下规则：12iptables -A INPUT -i eth0 -p tcp -s 192.168.100.0/24 --dport 22 -m state --state ESTABLESHED -j ACCEPTiptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state NEW,ESTABLISHED -j ACCEPT 类似的，对于HTTP/HTTPS(80/443)、pop3(110)、rsync(873)、MySQL(3306)等基于tcp连接的服务，也可以参照上述命令配置。 对于基于udp的dns服务，使用以下命令开启端口服务：12iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPTiptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT 配置网口转发对于用作防火墙或网关的服务器，一个网口连接到公网，其他网口的包转发到该网口实现内网向公网通信，假设eth0连接内网，eth1连接公网，配置规则如下：1iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT 配置端口转发对于端口，我们也可以运用iptables完成转发配置：1iptables -t nat -A PREROUTING -p tcp -d 172.16.12.37 --dport 40022 -j DNAT --to 172.16.12.37:22 以上命令将40022端口的包转发到22端口，因而通过40022端口也可进行SSH连接，当然对于40022端口，我们也需要像以上“4.配置服务项”一节一样，配置其支持连接建立的规则。 配置DoS攻击防范利用扩展模块limit，我们还可以配置iptables规则，实现DoS攻击防范：1iptables -A INPUT -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT --litmit 25/minute 指示每分钟限制最大连接数为25--litmit-burst 100 指示当总连接数超过100时，启动litmit/minute限制 配置web流量均衡我们可以将一台服务器作为前端服务器，利用iptables进行流量分发，配置方法如下：123iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.101:80iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.102:80iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.103:80 以上配置规则用到nth扩展模块，将80端口的流量均衡到三台服务器。 配置日志记录使用LOG目标和syslog服务，我们可以记录某协议某端口下的收发包情况。拿记录丢包情况举例，可以通过以下方式实现。 首先自定义一个chain：1iptables -N LOGGING 其次将所有接收包导入LOGGING chain中：1iptables -A INPUT -j LOGGING 然后设置日志前缀、日志级别：1iptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix \"IPTables Packet Dropped: \" --log-level 7 最后将包导向DROP，将包丢弃：1iptables -A LOGGING -j DROP 另可以配置syslog.conf文件，指定iptables的日志输出。","tags":[{"name":"iptables","slug":"iptables","permalink":"https://opstrip.com/tags/iptables/"},{"name":"chain策略","slug":"chain策略","permalink":"https://opstrip.com/tags/chain策略/"},{"name":"屏蔽指定IP","slug":"屏蔽指定IP","permalink":"https://opstrip.com/tags/屏蔽指定IP/"},{"name":"WEB流量均衡","slug":"WEB流量均衡","permalink":"https://opstrip.com/tags/WEB流量均衡/"},{"name":"DOS攻击防范","slug":"DOS攻击防范","permalink":"https://opstrip.com/tags/DOS攻击防范/"},{"name":"网络转发","slug":"网络转发","permalink":"https://opstrip.com/tags/网络转发/"},{"name":"端口转发","slug":"端口转发","permalink":"https://opstrip.com/tags/端口转发/"}]},{"title":"在CentOS7上配置LNMP环境：PHP篇","date":"2017-04-07T03:15:14.000Z","path":"2017/04/07/LNMP-on-CentOS7-02/","text":"上篇介绍了Nginx的安装配置及Let&#39;s Encrypt证书的自动签发与自动续期。这里主要介绍PHP的安装及在Nginx中的转发配置。 安装PHP1、安装依赖编译安装PHP之前需要安装PHP依赖包：1[root@opstrip opt]# yum -y install gd-devel libjpeg-devel libpng-devel libiconv-devel freetype-devel libxml2 libxml2-devel curl-devel libxslt-devel libmcrypt-devel mhash mcrypt php-mysql 完成后需在 https://downloads.mysql.com/archives/community/ 下载安装mysql-devel、mysql-shared、mysql-client三个rpm包。对于64位系统的主机，还需如下操作：12[root@opstrip opt]# ln -s /usr/lib64/libmysqlclient.so.16.0.0 /usr/lib/libmysqlclient.so[root@opstrip opt]# ln -s /usr/lib64/libmysqlclient_r.so.16.0.0 /usr/lib/libmysqlclient_r.so 在 http://php.net/get/php-5.6.30.tar.gz/from/a/mirror 下载php-5.6.30.tar.gz并上传至虚拟主机，此处为/opt。12[root@opstrip opt]# tar xf php-5.6.30.tar.gz[root@opstrip opt]# cd php-5.6.30 2、编译安装PHP 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051# 编译PHP[root@opstrip php-5.6.30]# ./configure --prefix=/usr \\--with-config-file-path=/etc/php-fpm \\--with-openssl \\--with-pcre-regex \\--with-kerberos \\--with-libdir=lib \\--with-libxml-dir \\--with-mysql \\--with-mysqli \\--with-pdo-mysql \\--with-pdo-sqlite \\--with-gd \\--with-iconv \\--with-zlib \\--with-zlib-dir=/usr/lib/php/extensions/no-debug-zts-20131226/ \\--with-xmlrpc \\--with-xsl \\--with-pear \\--with-gettext \\--with-curl \\--with-png-dir \\--with-jpeg-dir \\--with-freetype-dir \\--with-fpm-user=www \\--with-fpm-group=www \\--enable-mysqlnd \\--enable-zip \\--enable-inline-optimization \\--enable-shared \\--enable-libxml \\--enable-xml \\--enable-bcmath \\--enable-shmop \\--enable-sysvsem \\--enable-mbregex \\--enable-mbstring \\--enable-ftp \\--enable-gd-native-ttf \\--enable-pcntl \\--enable-soap \\--enable-session \\--enable-opcache \\--enable-fpm \\--enable-maintainer-zts \\--enable-fileinfo[root@opstrip php-5.6.30]# make &amp;&amp; make install # 编译并安装PHP[root@opstrip php-5.6.30]# php -v # 查看Nginx版本以确认安装成功PHP 5.6.30 (cli) (built: Apr 6 2017 15:50:41) Copyright (c) 1997-2016 The PHP GroupZend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies 配置PHP3、安装后的配置1[root@opstrip opt]# cp /opt/php-5.6.30/php.ini-development /etc/php.ini 编辑php.ini文件，搜索并添加如下内容：123extension_dir = &quot;/usr/lib/php/extensions/no-debug-zts-20131226/&quot;session.save_path = &quot;/usr/tmp&quot;date.timezone = PRC 123456789101112131415161718192021222324252627282930[root@opstrip opt]# mkdir -p /etc/php-fpm.d[root@opstrip opt]# cp /usr/etc/php-fpm.conf.default /etc/sysconfig/php-fpm.conf[root@opstrip opt]# cp /usr/etc/php-fpm.d/www.conf.default /etc/php-fpm.d/www.conf[root@opstrip opt]# cp /opt/php-5.6.30/sapi/fpm/php-fpm.service.in /usr/lib/systemd/system/php-fpm.service[root@opstrip opt]# vi /usr/lib/systemd/system/php-fpm.service # It&apos;s not recommended to modify this file in-place, because it# will be overwritten during upgrades. If you want to customize,# the best way is to use the &quot;systemctl edit&quot; command. [Unit]Description=The PHP FastCGI Process ManagerAfter=network.target [Service]Type=simplePIDFile=/usr/var/run/php-fpm.pidExecStart=/usr/sbin/php-fpm --nodaemonize --fpm-config /etc/sysconfig/php-fpm.confExecReload=/bin/kill -USR2 $MAINPIDPrivateTmp=true [Install]WantedBy=multi-user.target[root@opstrip opt]# systemctl enable php-fpm # 使php-fpm开机启动Created symlink from /etc/systemd/system/multi-user.target.wants/php-fpm.service to /usr/lib/systemd/system/php-fpm.service.[root@opstrip opt]# systemctl start php-fpm # 启动php-fpm服务[root@opstrip opt]# ps -ef|grep php-fpm # 查看php-fpm进程root 14563 1 0 11:23 ? 00:00:00 php-fpm: master process (/etc/sysconfig/php-fpm.conf)www 14564 14563 0 11:23 ? 00:00:00 php-fpm: pool wwwwww 14565 14563 0 11:23 ? 00:00:00 php-fpm: pool wwwroot 14567 14426 0 11:23 pts/2 00:00:00 grep --color=auto php-fpm 配置基于PHP的虚拟主机4、PHP虚拟主机配置安装好php-fpm后，就可以放PHP网站了。先整个wordpress玩玩。12345678910111213141516171819202122232425262728293031323334353637383940414243444546# 获取网站的Html代码[root@opstrip opt]# wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz[root@opstrip opt]# tar xf wordpress-4.7.3-zh_CN.tar.gz[root@opstrip opt]# mv wordpress wwwroot[root@opstrip opt]# vi /etc/nginx/conf.d/wordpress.confserver &#123; listen 80; #listen [::]:80 ssl ipv6only=on; server_name wp.opstrip.com; root /opt/wwwroot/; index index.php; location ~ \\.php$ &#123; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; &#125;&#125; # HTTPS server server &#123; listen 443 ssl; #listen [::]:443 ssl ipv6only=on; server_name wp.opstrip.com; ssl on; ssl_certificate /etc/letsencrypt/live/opstrip.com/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/opstrip.com/privkey.pem; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; #ssl_ciphers HIGH:!aNULL:!MD5; #ssl_prefer_server_ciphers on; root /opt/wwwroot/; index index.php; location ~ \\.php$ &#123; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; include fastcgi_params; &#125;&#125;[root@opstrip opt]# systemctl reload nginx 本地ping下wp.opstrip.com，如果DNS已经生效用浏览器打开 http://wp.opstrip.com 就开始安装wordpress了。具体可参考官方文档：zh-cn:安装 WordPress，根据需要配置数据库参数。因为使用的是RDS，所以需要在安装前从EC2登录到RDS创建数据库并授权给相应数据库账户。 --LNMP配置介绍完毕。","tags":[{"name":"CentOS7","slug":"CentOS7","permalink":"https://opstrip.com/tags/CentOS7/"},{"name":"LNMP","slug":"LNMP","permalink":"https://opstrip.com/tags/LNMP/"},{"name":"搭建配置","slug":"搭建配置","permalink":"https://opstrip.com/tags/搭建配置/"}]},{"title":"在CentOS7上配置LNMP环境：Nginx篇","date":"2017-04-05T08:15:14.000Z","path":"2017/04/05/LNMP-on-CentOS7-01/","text":"早就听说AWS的大名了，信用卡办下来后第一件事就是申请了个AWS的账号，买了美东的EC2（CentOS7）及RDS（MySQL5.6）资源各一。当然都是免费套餐中的，不管怎样总算是终于有了自己的主机了。老规矩，初始化CentOS7，放上自己的key，配置好安全组打通EC2与RDS之间的网络，测试了下发现通了。 因为之前使用的GitHub Pages博客一直都是静态的Html，所以这次打算直接丢到EC2上先用nginx跑起来，然后将国外线路解析到这台EC2上，国内线路用 七牛的CDN 的，相册中的照片也是存贮在七牛的。一步步来吧，先整个Nginx。 安装Nginx1、安装Nginx依赖及常用软件包1[root@opstrip opt]# yum -y install net-tools git gcc rsync lrzsz telnet wget ntp dstat mlocate bind-utils nscd psmisc python-devel python-pip mtr chrony gcc gcc-c++ autoconf automake zlib zlib-devel openssl openssl-devel pcre-devel 2、安装前的准备1234567# 创建Nginx运行用户[root@opstrip opt]# groupadd -r www[root@opstrip opt]# useradd -s /sbin/nologin -g www -r www# 获取Nginx源码并解压[root@opstrip opt]# wget http://nginx.org/download/nginx-1.11.12.tar.gz[root@opstrip opt]# tar xf nginx-1.11.12.tar.gz[root@opstrip opt]# cd nginx-1.11.12 3、编译安装Nginx123456789101112131415161718192021222324252627282930313233343536# 编译Nginx[root@opstrip nginx-1.11.12]# ./configure \\--prefix=/etc/nginx \\--sbin-path=/usr/sbin/nginx \\--conf-path=/etc/nginx/nginx.conf \\--error-log-path=/var/log/nginx/error.log \\--http-log-path=/var/log/nginx/access.log \\--pid-path=/var/run/nginx.pid \\--lock-path=/var/run/nginx.lock \\--http-client-body-temp-path=/var/cache/nginx/client_temp \\--http-proxy-temp-path=/var/cache/nginx/proxy_temp \\--http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp \\--http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp \\--http-scgi-temp-path=/var/cache/nginx/scgi_temp \\--user=www \\--group=www \\--with-http_ssl_module \\--with-http_realip_module \\--with-http_addition_module \\--with-http_sub_module \\--with-http_dav_module \\--with-http_flv_module \\--with-http_mp4_module \\--with-http_gunzip_module \\--with-http_gzip_static_module \\--with-http_random_index_module \\--with-http_secure_link_module \\--with-http_stub_status_module \\--with-http_auth_request_module \\--with-mail_ssl_module \\--with-file-aio \\--with-cc-opt=&apos;-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic&apos;# 安装Nginx[root@opstrip nginx-1.11.12]# make &amp;&amp; make install# 查看Nginx版本以确认Nginx安装成功[root@opstrip nginx-1.11.12]# nginx -V 4、配置Nginx服务并启动1234567891011121314151617181920212223242526272829# 创建Nginx缓存目录并赋予相应权限[root@opstrip nginx-1.11.12]# mkdir -p /var/cache/nginx/&#123;client_temp,proxy_temp,fastcgi_temp,uwsgi_temp,scgi_temp&#125;[root@opstrip nginx-1.11.12]# chown -R www.www /var/cache/nginx/# 将Nginx添加到systemd中[root@opstrip nginx-1.11.12]# vi /usr/lib/systemd/system/nginx.service [Unit]Description=nginx - high performance web serverDocumentation=http://nginx.org/en/docs/After=network.target remote-fs.target nss-lookup.target [Service]Type=forkingPIDFile=/var/run/nginx.pidExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.confExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.confExecReload=/bin/kill -s HUP $MAINPIDExecStop=/bin/kill -s QUIT $MAINPIDPrivateTmp=true [Install]WantedBy=multi-user.target# 设置nginx开机启动并启动[root@opstrip opt]# systemctl enable nginx.service[root@opstrip opt]# systemctl start nginx.service# 确认nginx进程已启动[root@opstrip opt]# ps -ef|grep nginxroot 12245 1 0 4月05 ? 00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.confwww 19228 12245 0 15:02 ? 00:00:00 nginx: worker processroot 29996 29890 0 16:58 pts/3 00:00:00 grep --color=auto nginx 这时候浏览器访问http://&lt;EC2的公网ip&gt;，如果安全组与firewalld、selinux配置正确的话访问的应该是nginx的默认页。 配置Nginx虚拟主机5、Nginx虚拟主机配置是时候放网站了。网站放置前需要把相应的域名解析到这台EC2上，或者就需要绑定本地hosts。这里是将国外线路A记录到这台EC2上，同时添加了个a.opstrip.com域名指向这台EC2。123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169[root@opstrip opt]# git clone https://github.com/opstrip/opstrip.github.io.git # 克隆GitHub Pages博客中的Html源码[root@opstrip opt]# ln -s /opt/opstrip.github.io /usr/share/html[root@opstrip opt]# mkdir -p /etc/nginx/conf.d # 将Nginx虚拟机配置文件放入到此目录[root@opstrip opt]# vi /etc/nginx/nginx.conf # Nginx主配置文件 user www;worker_processes 1; error_log /var/log/nginx/error.log;error_log /var/log/nginx/error.log notice;error_log /var/log/nginx/error.log info; pid /var/run/nginx.pid; events &#123; use epoll; worker_connections 51200; multi_accept on;&#125; http &#123; include mime.types; default_type application/octet-stream; #log format log_format main &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos; &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos; &apos;&quot;$http_user_agent&quot; $http_x_forwarded_for&apos;; access_log /var/log/nginx/access.log main; server_names_hash_bucket_size 128; client_header_buffer_size 32k; large_client_header_buffers 4 32k; client_max_body_size 50m; sendfile on; tcp_nopush on; keepalive_timeout 60; tcp_nodelay on; # fastcgi_connect_timeout 300; # fastcgi_send_timeout 300; # fastcgi_read_timeout 300; # fastcgi_buffer_size 64k; # fastcgi_buffers 4 64k; # fastcgi_busy_buffers_size 128k; # fastcgi_temp_file_write_size 256k; gzip on; gzip_min_length 1k; gzip_buffers 4 16k; gzip_http_version 1.0; gzip_comp_level 2; gzip_types text/plain application/x-javascript text/css application/xml; gzip_vary on; gzip_proxied expired no-cache no-store private auth; gzip_disable &quot;MSIE [1-6]\\.&quot;; #limit_conn_zone $binary_remote_addr zone=perip:10m; ##If enable limit_conn_zone,add &quot;limit_conn perip 10;&quot; to server section. server_tokens off; #server &#123; #listen 80; #server_name localhost; #charset koi8-r; #access_log logs/host.access.log main; #location / &#123; #root html; #index index.html index.htm; #&#125; #error_page 404 /404.html; # redirect server error pages to the static page /50x.html # #error_page 500 502 503 504 /50x.html; #location = /50x.html &#123; #root html; #&#125; # proxy the PHP scripts to Apache listening on 127.0.0.1:80 # #location ~ \\.php$ &#123; # proxy_pass http://127.0.0.1; #&#125; # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000 # #location ~ \\.php$ &#123; # root html; # fastcgi_pass 127.0.0.1:9000; # fastcgi_index index.php; # fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; # include fastcgi_params; #&#125; # deny access to .htaccess files, if Apache&apos;s document root # concurs with nginx&apos;s one # #location ~ /\\.ht &#123; # deny all; #&#125; #&#125; # another virtual host using mix of IP-, name-, and port-based configuration #server &#123; # listen 8000; # listen somename:8080; # server_name somename alias another.alias; # location / &#123; # root html; # index index.html index.htm; # &#125; #&#125; # HTTPS server #server &#123; # listen 443 ssl; # server_name localhost; # ssl_certificate cert.pem; # ssl_certificate_key cert.key; # ssl_session_cache shared:SSL:1m; # ssl_session_timeout 5m; # ssl_ciphers HIGH:!aNULL:!MD5; # ssl_prefer_server_ciphers on; # location / &#123; # root html; # index index.html index.htm; # &#125; #&#125; include conf.d/*.conf;&#125;[root@opstrip opt]# vi /etc/nginx/conf.d/opstrip.confserver &#123; listen 80; listen [::]:80 ssl ipv6only=on; server_name opstrip.com www.opstrip.com a.opstrip.com; #charset koi8-r; #access_log logs/host.access.log main; root /usr/share/html; index index.html index.htm README README.txt; location / &#123; root /usr/share/html; index index.html index.htm; &#125; error_page 404 /404.html; # redirect server error pages to the static page /50x.html error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125;&#125;[root@opstrip opt]# systemctl reload nginx 本地ping下a.opstrip.com，如果DNS已经生效用浏览器打开 http://a.opstrip.com 博客就可以展现出来了。 获取并配置SSL证书6、使用Let‘s encrypt免费证书123git clone https://github.com/letsencrypt/letsencryptcd letsencrypt/./certbot-auto certonly --webroot --agree-tos -v -t --email shiyao.zh@gmail.com -w /usr/share/html -d opstrip.com,www.opstrip.com,a.opstrip.com 以上命令使用certbot的webroot方式获取，-w表示网站路径，-d表示域名，可以多个。遗憾的是还不支持泛域名。由于机器是在墙外，只要DNS解析没问题，很容易就能通过验证。验证成功会返回类似如下信息：1234567891011IMPORTANT NOTES: - Congratulations! Your certificate and chain have been saved at /etc/letsencrypt/live/opstrip.com/fullchain.pem. Your cert will expire on 2017-07-04. To obtain a new or tweaked version of this certificate in the future, simply run certbot-auto again. To non-interactively renew *all* of your certificates, run &quot;certbot-auto renew&quot; - If you like Certbot, please consider supporting our work by: Donating to ISRG / Let&apos;s Encrypt: https://letsencrypt.org/donate Donating to EFF: https://eff.org/donate-le 每次获取的证书有效期都是90天，不过到期后可以续签的。证书文件在/etc/letsencrypt/live下，fullchain.pem与privkey.pem是nginx的公钥与私钥。所以Nginx SSL配置如下：1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253[root@opstrip opt]# vi /etc/nginx/conf.d/opstrip.confserver &#123; listen 80; listen [::]:80 ssl ipv6only=on; server_name opstrip.com www.opstrip.com a.opstrip.com; #charset koi8-r; #access_log logs/host.access.log main; root /usr/share/html; index index.html index.htm README README.txt; location / &#123; root /usr/share/html; index index.html index.htm; &#125; error_page 404 /404.html; # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125;&#125; # HTTPS server server &#123; listen 443 ssl; listen [::]:443 ssl ipv6only=on; server_name opstrip.com www.opstrip.com a.opstrip.com; ssl on; #ssl_certificate /etc/nginx/certs/www.opstrip.com.pem; #ssl_certificate_key /etc/nginx/certs/www.opstrip.com.key; ssl_certificate /etc/letsencrypt/live/opstrip.com/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/opstrip.com/privkey.pem; ssl_session_cache shared:SSL:1m; ssl_session_timeout 5m; #ssl_ciphers HIGH:!aNULL:!MD5; #ssl_prefer_server_ciphers on; root /usr/share/html; index index.html index.htm README README.txt; location / &#123; root /usr/share/html; index index.html index.htm; &#125;&#125;[root@opstrip opt]# systemctl reload nginx 现在可以访问 https://a.opstrip.com 了，如下图： 可以看到证书的颁发机构为Let&#39;s Encrypt，有效期三个月。因此我们可以写脚本自动续签的，如下：12345678910111213141516171819202122232425262728[root@opstrip ~]# vi /opt/letsencrypt/renewletsencrypt.sh #!/bin/bash . /etc/profile # /usr/bin/systemctl stop nginxcd /opt/letsencrypt./letsencrypt-auto renew --email shiyao.zh@gmail.com --agree-tossleep 3/usr/bin/systemctl reload nginxexit 0# 将脚本添加到crontab任务每3月执行一次即可[root@opstrip ~]# vi /etc/crontabSHELL=/bin/bashPATH=/sbin:/bin:/usr/sbin:/usr/binMAILTO=root # For details see man 4 crontabs# Example of job definition:# .---------------- minute (0 - 59)# | .------------- hour (0 - 23)# | | .---------- day of month (1 - 31)# | | | .------- month (1 - 12) OR jan,feb,mar,apr ...# | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat# | | | | |# * * * * * user-name command to be executed59 23 30 */3 * /bin/bash /opt/letsencrypt/renewletsencrypt.sh &gt;&gt; /opt/letsencrypt/renewletsencrypt.out 2&gt;&amp;1 以上，Nginx及SSL证书自动获取讲解完成。下次将介绍PHP。","tags":[{"name":"CentOS7","slug":"CentOS7","permalink":"https://opstrip.com/tags/CentOS7/"},{"name":"LNMP","slug":"LNMP","permalink":"https://opstrip.com/tags/LNMP/"},{"name":"搭建配置","slug":"搭建配置","permalink":"https://opstrip.com/tags/搭建配置/"}]},{"title":"hexo配置sitemap以及设置keywords","date":"2017-03-12T05:55:53.000Z","path":"2017/03/12/hexo-sitemap-keywords/","text":"本文主要是对hexo搭建的博客进行简单的SEO，比如给每篇文章加上keywords，以及生成sitemap.xml文件，方便我们提交到各大搜索引擎。 hexo安装sitemapwindows用户可以在博客根目录下按shift键不放再鼠标右击，即可在此目录下运行CMD窗口，运行如下代码:1npm install hexo-generator-sitemap --save 在博客根目录下找到_config.yml文件，添加如下代码:12sitemap: path: sitemap.xml 执行hexo g生成静态页面，再然后执行hexo s启动服务。打开http://localhost:4000/sitemap.xml即可看到效果，弄好之后你就可以到各大搜索引擎提交sitemap站点地图了。 keywords 默认情况下hexo博客及博客里的文章是没有keywords关键字的，需要我们手动添加。 设置hexo博客的关键字:在博客根目录下找到_config.yml文件，在所示地方添加keywords: 关键字1,关键字2,关键字3…，采用英文逗号隔开，注意keywords与关键词之间的空格。12345678# Sitetitle: 站点标题subtitle: 站点副标题description: 站点描述author: 站点作者language: zh-CNtimezone:keywords: 前端博客,JavaScript,html5,css3,Jquery,NodeJs,Ubuntu（#博客关键字） 设置文章的关键字1、打开theme/icarus/layout/common/head.ejs，这是我的head.ejs所在路径，不同主题可能不同，但一般来说都是head.ejs文件，添加如下代码:12345&lt;% if (page.keywords)&#123; %&gt;&lt;meta name=\"keywords\" content=\"&lt;%= page.keywords %&gt;,&lt;%= config.keywords %&gt;\"&gt;&lt;% &#125; else if (config.keywords)&#123; %&gt;&lt;meta name=\"keywords\" content=\"&lt;%= config.keywords %&gt;\"&gt;&lt;%&#125; %&gt; 这段话的意思是如果页面有关键字，则用页面的关键字，否则使用配置文件的关键字 2、在文章里面加入keywords，如下所示：1234567---title: ###date: ###categories: ###tags: ###keywords: ###---","tags":[{"name":"hexo","slug":"hexo","permalink":"https://opstrip.com/tags/hexo/"},{"name":"sitemap","slug":"sitemap","permalink":"https://opstrip.com/tags/sitemap/"},{"name":"keywords","slug":"keywords","permalink":"https://opstrip.com/tags/keywords/"},{"name":"SEO","slug":"SEO","permalink":"https://opstrip.com/tags/SEO/"},{"name":"关键字","slug":"关键字","permalink":"https://opstrip.com/tags/关键字/"}]},{"title":"PostgreSQL命令行使用手册","date":"2017-02-22T03:44:40.000Z","path":"2017/02/22/using-notes-for-postgresql-commandline/","text":"启动pgsl数据库1pg_ctl -D /xx/pgdata start 查看pgsl版本1pg_ctl --version 命令行登录数据库1psql -U username -d dbname -h hostip -p port 列出所有数据库1\\l 切换数据库1\\c dbname 列出当前数据库的所有表1\\d 查看指定表的所有字段1\\d tablename 查看指定表的基本情况1\\d+ tablename 退出操作1q 新建表例1（主键）123456create table TESTCASE(id INTEGER, task_class INTEGER,age TEXT,PRIMARY KEY(id, task_class)); 例2（自增SERIAL）12345create table CREATETASK_CHKID_N( id SERIAL PRIMARY KEY, chk_id TEXT, n INTEGER); 其中SERIAL代表自增，默认从1开始增加，每次自增1。 删除表1drop table REL_CROSS_NODE; 清空表1delete from [表名] 添加字段1alter table [表名] add column [字段名] [类型]; 更改字段1alter table [表名] rename column [旧字段名] to [新字段名]; 例：把表table_ex字段col_1限制非空去掉：ALTER TABLE table_eg ALTER col_1 drop not NULL 更改字段属性，含空格 如果把字段colname把属性Text转化为int，原来text里面存在空啥的，可以1ALTER TABLE tablename ALTER COLUMN colname TYPE int USING (trim(keyword)::integer); 删除字段1alter table [表名] drop column [字段名]; 表中插入一行数据1insert into [表名] (字段1,字段2) values (值1,值2); 例如：1insert into assist_info (id, maat_id, block_type) values ('F006', 'F7775', 1) 注：如果表中字段有大写的字段，则需要对应的加上双引号。例：1insert into test (no, \"Name\") values ('123', 'jihite'); 值用单引号引起来(‘’)，不能用双引号（””） 表中删除一行数据1delete from [表名] where [该行特征]; 修改表中数据1update [表名] set [目标字段名]=[目标值] where [该行特征] 删除表1drop table [表名]; 退出postgreSql1\\q 两个查询结果做差except12345(select node_id from node where node_id=1 or node_id=2) except (select node_id from node where node_id=1); node_id--------- 2(1 row) 复制表1CREATE TABLE test_a_copy AS SELECT * FROM test_a; 命令导入sql数据文件1psql -h localhost -d databaseName -U username -f filename 查询结果存储到输出文件格式：1\\o file_path 这样就会把查询结果存储到输出文件中。例123postgres=&gt; \\o /home/jihite/data/iu_data;postgres=&gt; select test_id from cdb_all_iu_data limit 10;postgres=&gt; select test_id from cdb_all_iu_data limit 5; 结果：12345678910111213141516171819202122test_id-------------- 2143 2153 2144 2156 2145 2154 2146 2157 2147 2155(10 rows) test_id-------------- 2143 2153 2144 2156 2145(5 rows) 数据库的备份&amp;恢复导出到线下文件1pg_dump --host hostname --port port --username username -t tablename -d dbname &gt;/home/jihite/table.sql 把线下文件导入到数据库1psql -h 10.125.7.68 -p 5432 -d postgres -U postgres -W postgres -f 2.sql \\x 打开扩展显示功能123456789101112131415postgres=&gt; \\xExpanded display is on.postgres=&gt; select * from cdb_chk_items where chk_id = 'R000000335';-[ RECORD 1 ]+------------------------------------------------------------------------------------------------chk_id | R000000335chk_desc | 道路属性与道路属性相关检查chk_info | &#123;\"FIELDS\": &#123;\"TRAFFIC_SIGN\": [\"TYPE\", \"GEOM\"], \"ROAD_LINK\": [\"ROAD_CLASS\", \"FORM_WAY\", \"GEOM\"]&#125;&#125;err_desc | &#123;\"ERR2\": \"roadclass取值错误\", \"ERR1\": \"formway取值错误\"&#125;chk_level | 1is_opened | 1module_name | TRAFFIC_SIGNinvalid_flag | 1rel_mode | MAIN_LAYER:TRAFFIC_SIGN : TRAFFIC_SIGN|A,M|DIRECT : ROAD_LINK|A,M,D|ATTR_REL 从表A中把符合条件的记录拷贝到表B1insert into A select * from B where id in ('a', 'b', 'c'); 转载自jihite博客：http://www.cnblogs.com/kaituorensheng/p/4667160.html","tags":[{"name":"常用命令","slug":"常用命令","permalink":"https://opstrip.com/tags/常用命令/"},{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://opstrip.com/tags/PostgreSQL/"},{"name":"SQL大全","slug":"SQL大全","permalink":"https://opstrip.com/tags/SQL大全/"}]},{"title":"CentOS7下根分区扩容","date":"2017-02-21T02:46:15.000Z","path":"2017/02/21/root-partition-expansion-for-centos7/","text":"为更好熟悉CentOS7，日前在PC上安装了VirtualBox软件来跑CentOS7练练手。虚机CentOS7暂采用1Core CPU，2G Mem，10G Disk配置，最小化安装并升级下系统后快照备份存档以备后用，后期可根据需要随时调整配置。今天准备整个PostgreSQL玩玩的，首先需要对10G的磁盘进行扩展。安装系统时选择的是默认分区方案，root分区是用lvm管理的，分区格式是xfs。如下所示：12345678910[root@myprecious ~]# df -ThFilesystem Type Size Used Avail Use% Mounted on/dev/mapper/centos_myprecious-root xfs 8.5G 855M 7.7G 10% /devtmpfs devtmpfs 487M 0 487M 0% /devtmpfs tmpfs 497M 0 497M 0% /dev/shmtmpfs tmpfs 497M 6.5M 491M 2% /runtmpfs tmpfs 497M 0 497M 0% /sys/fs/cgroup/dev/sda1 xfs 497M 124M 374M 25% /boottmpfs tmpfs 100M 0 100M 0% /run/user/0[root@myprecious ~]# 所以扩展root分区就很容易了。首先再添加一块虚拟磁盘到虚机，重启后fdisk -l查看虚拟磁盘是否被识别。如下，可以看到新增磁盘被标记为/dev/sdb，有53.7G的空间。 123456789101112131415161718192021222324252627282930[root@myprecious ~]# fdisk -l Disk /dev/sda: 10.7 GB, 10737418240 bytes, 20971520 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk label type: dosDisk identifier: 0x0008ee5f Device Boot Start End Blocks Id System/dev/sda1 * 2048 1026047 512000 83 Linux/dev/sda2 1026048 20971519 9972736 8e Linux LVM Disk /dev/sdb: 53.7 GB, 53687091200 bytes, 104857600 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytes Disk /dev/mapper/centos_myprecious-root: 8.3 GB, 53724839936 bytes, 104931328 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytes Disk /dev/mapper/centos_myprecious-swap: 1073 MB, 1073741824 bytes, 2097152 sectorsUnits = sectors of 1 * 512 = 512 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytes [root@myprecious ~]# 创建磁盘分区惯例，为/dev/sdb磁盘创建分区，如下：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081[root@myprecious ~]# fdisk /dev/sdbDevice contains neither a valid DOS partition table, nor Sun, SGI or OSF disklabelBuilding a new DOS disklabel with disk identifier 0x4cb24dcf.Changes will remain in memory only, until you decide to write them.After that, of course, the previous content won&apos;t be recoverable.Warning: invalid flag 0x0000 of partition table 4 will be corrected by w(rite)WARNING: DOS-compatible mode is deprecated. It&apos;s strongly recommended to switch off the mode (command &apos;c&apos;) and change display units to sectors (command &apos;u&apos;).Command (m for help): mCommand action a toggle a bootable flag b edit bsd disklabel c toggle the dos compatibility flag d delete a partition l list known partition types m print this menu n add a new partition o create a new empty DOS partition table p print the partition table q quit without saving changes s create a new empty Sun disklabel t change a partition&apos;s system id u change display/entry units v verify the partition table w write table to disk and exit x extra functionality (experts only)Command (m for help): nCommand action e extended p primary partition (1-4)pPartition number (1-4): 1First cylinder (1-624152, default 1): Using default value 1Last cylinder, +cylinders or +size&#123;K,M,G&#125; (1-624152, default 624152): Using default value 624152Command (m for help): tSelected partition 1Hex code (type L to list codes): L 0 Empty 24 NEC DOS 81 Minix / old Lin bf Solaris 1 FAT12 39 Plan 9 82 Linux swap / So c1 DRDOS/sec (FAT- 2 XENIX root 3c PartitionMagic 83 Linux c4 DRDOS/sec (FAT- 3 XENIX usr 40 Venix 80286 84 OS/2 hidden C: c6 DRDOS/sec (FAT- 4 FAT16 &lt;32M 41 PPC PReP Boot 85 Linux extended c7 Syrinx 5 Extended 42 SFS 86 NTFS volume set da Non-FS data 6 FAT16 4d QNX4.x 87 NTFS volume set db CP/M / CTOS / . 7 HPFS/NTFS 4e QNX4.x 2nd part 88 Linux plaintext de Dell Utility 8 AIX 4f QNX4.x 3rd part 8e Linux LVM df BootIt 9 AIX bootable 50 OnTrack DM 93 Amoeba e1 DOS access a OS/2 Boot Manag 51 OnTrack DM6 Aux 94 Amoeba BBT e3 DOS R/O b W95 FAT32 52 CP/M 9f BSD/OS e4 SpeedStor c W95 FAT32 (LBA) 53 OnTrack DM6 Aux a0 IBM Thinkpad hi eb BeOS fs e W95 FAT16 (LBA) 54 OnTrackDM6 a5 FreeBSD ee GPT f W95 Ext&apos;d (LBA) 55 EZ-Drive a6 OpenBSD ef EFI (FAT-12/16/10 OPUS 56 Golden Bow a7 NeXTSTEP f0 Linux/PA-RISC b11 Hidden FAT12 5c Priam Edisk a8 Darwin UFS f1 SpeedStor 12 Compaq diagnost 61 SpeedStor a9 NetBSD f4 SpeedStor 14 Hidden FAT16 &lt;3 63 GNU HURD or Sys ab Darwin boot f2 DOS secondary 16 Hidden FAT16 64 Novell Netware af HFS / HFS+ fb VMware VMFS 17 Hidden HPFS/NTF 65 Novell Netware b7 BSDI fs fc VMware VMKCORE 18 AST SmartSleep 70 DiskSecure Mult b8 BSDI swap fd Linux raid auto1b Hidden W95 FAT3 75 PC/IX bb Boot Wizard hid fe LANstep 1c Hidden W95 FAT3 80 Old Minix be Solaris boot ff BBT 1e Hidden W95 FAT1Hex code (type L to list codes): 8eChanged system type of partition 1 to 8e (Linux LVM)Command (m for help): pDisk /dev/sdb: 53.7 GB, 53687091200 bytes16 heads, 63 sectors/track, 624152 cylindersUnits = cylinders of 1008 * 512 = 516096 bytesSector size (logical/physical): 512 bytes / 512 bytesI/O size (minimum/optimal): 512 bytes / 512 bytesDisk identifier: 0x4cb24dcf Device Boot Start End Blocks Id System/dev/sdb1 1 624152 314572576+ 8e Linux LVMCommand (m for help): wThe partition table has been altered!Calling ioctl() to re-read partition table.Syncing disks.[root@myprecious ~]# 整块磁盘/dev/sdb被分区为/dev/sdb1，将该分区格式化为xfs。1[root@myprecious ~]# mkfs.xfs -f /dev/sdb1 创建物理卷PV查看并创建物理卷PV：123456789101112131415161718192021222324252627282930313233343536373839[root@myprecious ~]# pvdisplay --- Physical volume --- PV Name /dev/sda2 VG Name centos_myprecious PV Size 9.51 GiB / not usable 3.00 MiB Allocatable yes (but full) PE Size 4.00 MiB Total PE 2434 Free PE 0 Allocated PE 2434 PV UUID 0bE8O8-syyl-TSyE-p9Bv-sZEJ-3GkE-vNC4XB [root@myprecious ~]# pvcreate /dev/sdb1 Physical volume &quot;/dev/sdb1&quot; successfully created[root@myprecious ~]# pvdisplay --- Physical volume --- PV Name /dev/sda2 VG Name centos_myprecious PV Size 9.51 GiB / not usable 3.00 MiB Allocatable yes (but full) PE Size 4.00 MiB Total PE 2434 Free PE 0 Allocated PE 2434 PV UUID 0bE8O8-syyl-TSyE-p9Bv-sZEJ-3GkE-vNC4XB &quot;/dev/sdb1&quot; is a new physical volume of &quot;53.7 GiB&quot; --- NEW Physical volume --- PV Name /dev/sdb1 VG Name PV Size 53.7 GiB Allocatable NO PE Size 0 Total PE 0 Free PE 0 Allocated PE 0 PV UUID 8Z7hoj-Ub4d-xLr3-z7ti-Z5zM-oVTv-TuLtv7 [root@myprecious ~]# 创建卷组VG以上，PV /dev/sdb1已创建完成，但未被分配。将PV /dev/sdb1分配到系统的卷组VG上，这里为centos_myprecious，如下：1234567891011121314151617181920212223242526[root@myprecious ~]# vgdisplay --- Volume group --- VG Name centos_myprecious System ID Format lvm2 Metadata Areas 2 Metadata Sequence No 5 VG Access read/write VG Status resizable MAX LV 0 Cur LV 2 Open LV 2 Max PV 0 Cur PV 2 Act PV 2 VG Size 59.50 GiB PE Size 4.00 MiB Total PE 15233 Alloc PE / Size 13065 / 51.04 GiB Free PE / Size 2168 / 8.47 GiB VG UUID jvcc7L-quO1-MQOz-KDX3-v4QN-ES9G-q4h7H7 [root@myprecious ~]# vgextend centos_myprecious /dev/sdb1 Physical volume &quot;/dev/sdb1&quot; successfully created Volume group &quot;centos_myprecious&quot; successfully extended[root@myprecious ~]# 查看逻辑卷LV在分配完卷组后，就可以见卷组中未分配的空间分配给root分区了，这里为/dev/sdb1分区。12345678910111213141516171819202122232425262728293031323334[root@myprecious ~]# lvdisplay --- Logical volume --- LV Path /dev/centos_myprecious/root LV Name root VG Name centos_myprecious LV UUID KqVmPb-MNpe-VPmH-ato8-aeVU-JbOz-HNgG0M LV Write Access read/write LV Creation host, time myprecious, 2017-02-20 14:35:34 +0800 LV Status available # open 1 LV Size 8.47 GiB Current LE 2168 Segments 1 Allocation inherit Read ahead sectors auto - currently set to 8192 Block device 253:0 --- Logical volume --- LV Path /dev/centos_myprecious/swap LV Name swap VG Name centos_myprecious LV UUID 4HGA1K-1bYu-Vvmx-j70O-l0U7-NwvG-etzOF6 LV Write Access read/write LV Creation host, time myprecious, 2017-02-20 14:35:33 +0800 LV Status available # open 2 LV Size 1.00 GiB Current LE 256 Segments 1 Allocation inherit Read ahead sectors auto - currently set to 8192 Block device 253:1 扩展逻辑卷LV时的小插曲12345678910111213141516171819202122[root@myprecious ~]# lvextend -l 100%FREE /dev/centos_myprecious/root Size of logical volume centos_myprecious/root changed from 8.47 GiB (2168 extents) to 50.04 GiB (12809 extents). Logical volume root successfully resized.[root@myprecious ~]# e2fsck -f /dev/centos_myprecious/root e2fsck 1.42.9 (28-Dec-2013)/dev/centos_myprecious/root is mounted.e2fsck: Cannot continue, aborting. [root@myprecious ~]# resize2fs /dev/centos_myprecious/root resize2fs 1.42.9 (28-Dec-2013)resize2fs: Bad magic number in super-block while trying to open /dev/centos_myprecious/rootCouldn&apos;t find valid filesystem superblock.[root@myprecious ~]# df -hFilesystem Size Used Avail Use% Mounted on/dev/mapper/centos_myprecious-root 8.5G 854M 7.7G 10% /devtmpfs 487M 0 487M 0% /devtmpfs 497M 0 497M 0% /dev/shmtmpfs 497M 6.5M 491M 2% /runtmpfs 497M 0 497M 0% /sys/fs/cgroup/dev/sda1 497M 124M 374M 25% /boottmpfs 100M 0 100M 0% /run/user/0[root@myprecious ~]# 在使用resize2fs操作后报错，查看分区信息发现根分区并没有变多，甚至重启后执行resize2fs操作依旧报错。之前的centos6扩展ext2/ext3/ext4明明都是好好的，问题出在哪儿呢？查找资料，发现是resize2fs不能扩展xfs分区所致。扩展xfs分区需要使用xfs_growfs。如下：123456789101112131415161718192021[root@myprecious ~]# xfs_growfs /dev/centos_myprecious/root meta-data=/dev/mapper/centos_myprecious-root isize=256 agcount=4, agsize=555008 blks = sectsz=512 attr=2, projid32bit=1 = crc=0 finobt=0data = bsize=4096 blocks=2220032, imaxpct=25 = sunit=0 swidth=0 blksnaming =version 2 bsize=4096 ascii-ci=0 ftype=0log =internal bsize=4096 blocks=2560, version=2 = sectsz=512 sunit=0 blks, lazy-count=1realtime =none extsz=4096 blocks=0, rtextents=0data blocks changed from 2220032 to 13116416[root@myprecious ~]# df -hFilesystem Size Used Avail Use% Mounted on/dev/mapper/centos_myprecious-root 51G 904M 50G 2% /devtmpfs 487M 0 487M 0% /devtmpfs 497M 0 497M 0% /dev/shmtmpfs 497M 6.5M 491M 2% /runtmpfs 497M 0 497M 0% /sys/fs/cgroup/dev/sda1 497M 124M 374M 25% /boottmpfs 100M 0 100M 0% /run/user/0[root@myprecious ~]# 使用xfs_growfs后，根分区被正常扩展。没注意到centos7中根分区已经有centos6中的ext4变更为xfs，相应的扩展分区的命令变更为xfs_growfs。有时候真的是不能想当然，一个小细节的差异也会导致达不到预期的效果。","tags":[{"name":"lvm","slug":"lvm","permalink":"https://opstrip.com/tags/lvm/"},{"name":"xfs","slug":"xfs","permalink":"https://opstrip.com/tags/xfs/"},{"name":"pv","slug":"pv","permalink":"https://opstrip.com/tags/pv/"},{"name":"vg","slug":"vg","permalink":"https://opstrip.com/tags/vg/"},{"name":"lv","slug":"lv","permalink":"https://opstrip.com/tags/lv/"},{"name":"xfs_growfs","slug":"xfs-growfs","permalink":"https://opstrip.com/tags/xfs-growfs/"},{"name":"分区扩展","slug":"分区扩展","permalink":"https://opstrip.com/tags/分区扩展/"}]},{"title":"Firewalld学习手记","date":"2017-02-20T08:11:45.000Z","path":"2017/02/20/the-notes-for-learning-firewalld/","text":"在CentOS 7中，引入了一个新的服务，Firewalld，下面一张图，让大家明确的了解Firewall与iptables之间的关系与区别。 安装它，只需1# yum install firewalld 如果需要图形界面的话，则再安装1# yum install firewall-config 一、介绍防火墙守护firewalld服务引入了一个信任级别的概念来管理与之相关联的连接与接口。它支持ipv4与ipv6，并支持网桥，采用firewall-cmd (command)或firewall-config (gui)来动态的管理kernel netfilter 的临时或永久的接口规则，并实时生效而无需重启服务。 zoneFirewall 能将不同的网络连接归类到不同的信任级别，Zone 提供了以下几个级别： drop: 丢弃所有进入的包，而不给出任何响应block: 拒绝所有外部发起的连接，允许内部发起的连接public: 允许指定的进入连接external: 同上，对伪装的进入连接，一般用于路由转发dmz: 允许受限制的进入连接work: 允许受信任的计算机被限制的进入连接，类似 workgrouphome: 同上，类似 homegroupinternal: 同上，范围针对所有互联网用户trusted: 信任所有连接 过滤规则 source: 根据源地址过滤interface: 根据网卡过滤service: 根据服务名过滤port: 根据端口过滤icmp-block: icmp 报文过滤，按照 icmp 类型配置masquerade: ip 地址伪装forward-port: 端口转发rule: 自定义规则 其中，过滤规则的优先级遵循如下顺序： sourceinterfacefirewalld.conf 二、使用方法12345# systemctl start firewalld # 启动,# systemctl enable firewalld # 开机启动# systemctl stop firewalld # 关闭# systemctl disable firewalld # 取消开机启动# systemctl status firewalld # 查看状态，或使用命令firewall-cmd --state 0. 配置firewalld12$ firewall-cmd –version # 查看版本$ firewall-cmd –help # 查看帮助 查看设置123456$ firewall-cmd –state # 显示状态$ firewall-cmd –get-active-zones # 查看区域信息$ firewall-cmd –get-zone-of-interface=eth0 # 查看指定接口所属区域# firewall-cmd –panic-on # 拒绝所有包# firewall-cmd –panic-off # 取消拒绝状态$ firewall-cmd –query-panic # 查看是否拒绝 具体的规则管理，可以使用firewall-cmd，具体的使用方法可以12345$ firewall-cmd --help--zone=NAME # 指定 zone--permanent # 永久修改，--reload 后生效--timeout=seconds # 持续效果，到期后自动移除，用于调试，不能与 --permanent 同时使用 1. 查看规则查看运行状态1$ firewall-cmd --state 查看已被激活的Zone信息123$ firewall-cmd --get-active-zonespublic interfaces: eth0 eth1 查看指定接口的Zone信息12$ firewall-cmd --get-zone-of-interface=eth0public 查看指定级别的接口12$ firewall-cmd --zone=public --list-interfaceseth0 查看指定级别的所有信息，譬如public12345678910$ firewall-cmd --zone=public --list-allpublic (default, active) interfaces: eth0 sources: services: dhcpv6-client http ssh ports: masquerade: no forward-ports: icmp-blocks: rich rules: 查看所有级别被允许的信息1$ firewall-cmd --get-service 查看重启后所有Zones级别中被允许的服务，即永久放行的服务1$ firewall-cmd --get-service --permanent 2. 管理规则12345# firewall-cmd --panic-on # 丢弃# firewall-cmd --panic-off # 取消丢弃# firewall-cmd --query-panic # 查看丢弃状态# firewall-cmd --reload # 更新规则，不重启服务# firewall-cmd --complete-reload # 更新规则，重启服务 添加某接口至某信任等级，譬如添加eth0至public，永久修改1# firewall-cmd --zone=public --add-interface=eth0 --permanent 设置public为默认的信任级别1# firewall-cmd --set-default-zone=public a. 管理端口列出dmz级别的被允许的进入端口1# firewall-cmd --zone=dmz --list-ports 允许tcp端口8080至dmz级别1# firewall-cmd --zone=dmz --add-port=8080/tcp 允许某范围的udp端口至public级别，并永久生效1# firewall-cmd --zone=public --add-port=5060-5059/udp --permanent b. 网卡接口列出public zone所有网卡1# firewall-cmd --zone=public --list-interfaces 将eth0添加至public zone，永久1# firewall-cmd --zone=public --permanent --add-interface=eth0 eth0存在与public zone，将该网卡添加至work zone，并将之从public zone中删除1# firewall-cmd --zone=work --permanent --change-interface=eth0 删除public zone中的eth0，永久1# firewall-cmd --zone=public --permanent --remove-interface=eth0 c. 管理服务添加smtp服务至work zone1# firewall-cmd --zone=work --add-service=smtp 移除work zone中的smtp服务1# firewall-cmd --zone=work --remove-service=smtp d. 配置external zone中的ip地址伪装查看1# firewall-cmd --zone=external --query-masquerade 打开伪装1# firewall-cmd --zone=external --add-masquerade 关闭伪装1# firewall-cmd --zone=external --remove-masquerade e. 配置public zone的端口转发要打开端口转发，则需要先1# firewall-cmd --zone=public --add-masquerade 然后转发tcp 22端口至37531# firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toport=3753 转发22端口数据至另一个ip192.168.1.100的相同端口上1# firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toaddr=192.168.1.100 转发22端口数据至ip192.168.1.100的2055端口上1# firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toport=2055:toaddr=192.168.1.100 f. 配置public zone的icmp查看所有支持的icmp类型12# firewall-cmd --get-icmptypesdestination-unreachable echo-reply echo-request parameter-problem redirect router-advertisement router-solicitation source-quench time-exceeded 列出1# firewall-cmd --zone=public --list-icmp-blocks 添加echo-request屏蔽1# firewall-cmd --zone=public --add-icmp-block=echo-request [--timeout=seconds] 移除echo-reply屏蔽1# firewall-cmd --zone=public --remove-icmp-block=echo-reply g.IP封禁1# firewall-cmd --permanent --add-rich-rule=\"rule family='ipv4' source address='222.222.222.222' reject\" 以上都是一些常用方法，更多高级方法，请参考： 红帽官网：https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/sec-Using_Firewalls.html Fedora社区：https://fedoraproject.org/wiki/FirewallD 转载自：https://havee.me/linux/2015-01/using-firewalls-on-centos-7.html","tags":[{"name":"学习笔记","slug":"学习笔记","permalink":"https://opstrip.com/tags/学习笔记/"},{"name":"centos7","slug":"centos7","permalink":"https://opstrip.com/tags/centos7/"},{"name":"firewalld","slug":"firewalld","permalink":"https://opstrip.com/tags/firewalld/"}]},{"title":"KVM学习手记：02 存储池、虚拟机及快照","date":"2017-01-17T04:38:47.000Z","path":"2017/01/17/Using-Notes-For-KVM-02/","text":"接上篇，在确认主机（Host OS）支持虚拟化、安装KVM系列支持组件、配置桥接网络后，就可以创建基础镜像了。 创建存储池在创建虚拟机之前，需要先创建一个存储池。存储池Storage pools是在宿主机上放置虚拟机的存储位置，可以是本地的，也可以是网络存储，具体的虚拟机实例放置在卷Volume上。 1.存储池存储池Storage pools是在宿主机上放置虚拟机虚拟磁盘的存储位置,默认的存储是在/var/lib/libvirt/images目录下,由于对硬盘和虚拟磁盘大小的空间规划,一般在/opt/kvm/images目录或规划的目录下集中存放虚拟机的虚拟磁盘方便管理,操作存储卷的命令行是virsh。 2.建立存储池目录1234567#创建目录[root@myprecious ~]# mkdir -p /opt/kvm/images#更改目录的所有者,并设置权限[root@myprecious ~]# chown -R qemu:qemu /opt/kvm/images[root@myprecious ~]# chmod -R 700 /opt/kvm/images#完成验证[root@myprecious ~]# ls -al /opt/kvm 3.创建存储池123456789101112131415#定义一个存储池绑定目录[root@myprecious ~]# virsh pool-define-as StoragePool --type dir --target /opt/kvm/imagesPool StoragePool defined #建立基于文件夹的存储池[root@myprecious ~]# virsh pool-build StoragePoolPool StoragePool built #激活StoragePool[root@myprecious ~]# virsh pool-start StoragePoolPool StoragePool started #存储池开机自动运行,使用virsh pool-autostart[root@myprecious ~]# virsh pool-autostart StoragePoolPool StoragePool marked as autostarted virsh pool-create-as –name vmware_pool –type dir –target /virhost/vmware创建存储池vmware_pool，类型为文件目录，/virhost/vmware，与pool-define-as结果一样 4.验证查看存储池信息123456789[root@myprecious ~]# virsh pool-info StoragePoolName: StoragePoolUUID: 29481667-27fc-4b73-8530-cdc081208c95State: running #激活状态Persistent: yesAutostart: yesCapacity: 37.69 GiB #容量Allocation: 8.13 GiB #分配Available: 29.56 GiB #可用 5.查看创建的所有存储池123456[root@myprecious ~]# virsh pool-listName State Autostart-----------------------------------------boot-scratch active yesdefault active yesStoragePool active yes 6.StoragePool存储池中创建一个卷，这个卷是用来做虚拟机的硬盘12345678910#创建卷baseCentos.qcow2，所在存储池为StoragePool，容量10G，初始分配1G，文件格式类型qcow2[root@myprecious ~]# virsh vol-create-as --pool StoragePool --name baseCentos.qcow2 --capacity 10G --allocation 1G --format qcow2Vol baseCentos.qcow2 created #查看卷信息名称：baseCentos.qcow2，类型：文件，容量：10.00 GiB，分配：196.00 KiB[root@myprecious ~]# virsh vol-info /opt/kvm/images/baseCentos.qcow2 Name: baseCentos.qcow2Type: fileCapacity: 10.00 GiBAllocation: 196.00 KiB 创建虚拟机在配置好网络环境和存储池后,就可以创建虚拟机了!KVM有三种方式来创建虚拟机，分别是：图形安装方式(virt-manager)、命令行安装方式(virt-install)及模板安装方式(module)。这里只介绍命令行安装方式，这也是平时用的最多的安装方式。 1.virt-install命令安装virt-install参数1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586[root@myprecious ~]# virt-install -hOptions:--version show program's version number and exit-h, --help show this help message and exit--connect=URI Connect to hypervisor with libvirt URIGeneral Options: -n NAME, --name=NAME #虚拟机名(英文开头,数字开头报错) -r MEMORY, --ram=MEMORY #以MB单位为虚拟机分配内存 --vcpus=VCPUS vcpu 数目 举例: --vcpus 5 --vcpus 5,maxcpus=10 --vcpus sockets=2,cores=4,threads=2 --cpuset=CPUSET Set which physical CPUs domain can use. --cpu=CPU #CPU的模式及特点 例: --cpu coreduo,+x2apic --description=DESCRIPTION #虚拟机描述 --security=SECURITY #安全配置设置 --numatune=NUMATUNE #NUMA政策调整Installation Method Options: -c CDROM, --cdrom=CDROM #光驱安装介质 -l LOCATION, --location=LOCATION #安装源 (eg, nfs:host:/path,http://host/path, ftp://host/path) --pxe #使用 PXE 协议从网络引导 --import #导入已存在的虚拟磁盘 --init=INIT Path to init binary for container guest. Ex: --init /path/to/app (to contain an application) --init /sbin/init (for a full OS container) --livecd #把光盘媒体作为一个Live CD -x EXTRA, --extra-args=EXTRA #额外的参数传递给安装内核启动 --initrd-inject=INITRD_INJECTIONS #设置启动initrd文件 --os-type=DISTRO_TYPE #虚拟机系统类型. 'linux', 'unix','windows' --os-variant=DISTRO_VARIANT #系统版本, e.g.'rhel5', 'win2k' --boot=BOOTOPTS #配置安装后启动命令，菜单，永久的内核启动Storage Configuration: --disk=DISKOPTS 指定各种选项的存储虚拟磁盘. Ex. --disk path=/my/existing/disk --disk path=/my/new/disk,size=5 (in gigabytes) --disk vol=poolname:volname,device=cdrom,bus=scsi,... --nodisks #设置无虚拟磁盘 --filesystem=FILESYSTEMS Pass host directory to the guest. Ex: --filesystem /my/source/dir,/dir/in/guest --filesystem template_name,/,type=templateNetworking Configuration: -w NETWORK, --network=NETWORK #设置网络接口. Ex: --network bridge=mybr0 --network network=my_libvirt_virtual_net --network network=mynet,model=virtio,mac=00:11... --nonetworks #设置无网络Graphics Configuration: --graphics=GRAPHICS #图形支持. 举例: --graphics vnc --graphics spice,port=5901,tlsport=5902 --graphics none --graphics vnc,password=foobar,port=5910,keymap=ja --noautoconsole #不要自动尝试连接客户机控制台Device Options: --serial=SERIALS #配置客户机串行驱动 --parallel=PARALLELS #配置客户机并连驱动 --channel=CHANNELS #配置客户机沟通渠道 --console=CONSOLES #配置客户机和主机之间的文本控制台连接 --host-device=HOSTDEVS #配置物理主机设备连接到客户机 --soundhw=SOUNDHW #配置客户机声音驱动 --watchdog=WATCHDOG #配置客户机监视驱动 --video=VIDEO #配置客户机视频硬件 --smartcard=SMARTCARD #配置智能卡驱动 Ex: --smartcard mode=passthroughVirtualization Platform Options: -v, --hvm #设置虚拟机为全虚拟化 -p, --paravirt #设置虚拟机为半虚拟化 --container This guest should be a container guest --virt-type=HV_TYPE #Hypervisor类型(kvm, qemu, xen, ...) --arch=ARCH #CPU架构模拟 --machine=MACHINE #模拟机械类型 --noapic #全虚拟话客户机禁用APIC --noacpi #全虚拟话客户机禁用ACPI -u UUID, --uuid=UUID #客户端 UUIDMiscellaneous Options: --autostart #跟随主机开机自动启动 --print-xml --print-step=XMLSTEP #显示指定安装步骤的xml --noreboot #安装完成是禁用自启动 --wait=WAIT #超时等待时间 --dry-run --force -q, --quiet #抑制非错误输出 --prompt -d, --debug #打印错误信息 2.远程连接虚拟机安装界面由于centos必须经过文本的安装界面才能安装，在宿主机没有桌面系统的前提下，通过VNC实现远程连接。123[root@myprecious ~]# vim sed -i 's/#vnc_listen = \"0.0.0.0\"/vnc_listen = \"0.0.0.0\"/g' /etc/libvirt/qemu.conf#必须重启宿主机[root@myprecious ~]# reboot 使监听所有端口，否则只监听本地，监听本地是指只能从宿主机本地登录指定虚拟机如 vncviewer 127.0.0.1：端口号(如127.0.0.1:5902)，如果监听所有端口则可以从远程通过宿主机IP：端口号 登录虚拟机(如192.168.122.24:5902) 3.Virt-install新建虚拟机centos(1)raw格式磁盘12345678#--disk 默认为`raw`格式磁盘[root@myprecious ~]# virt-install --name=vm1 --ram=1024 --vcpus=2 --disk path=/opt/kvm/images/vm1.img,size=10 --cdrom /opt/kvm/data/centos7.iso --graphics vnc,port=5910, --network bridge=virbr0,model=virtio --force --autostartStarting install...Allocating 'vm1.img' | 10 GB 00:00Creating domain... | 0 B 00:00Cannot open display:Run 'virt-viewer --help' to see a full list of available command line optionsDomain installation still in progress. You can reconnect to the console to complete the installation process. (2)qcow2格式磁盘(kvm推荐使用qcow2，具有多种特性，建议生成此格式磁盘)12#--disk format=qcow2 指定磁盘格式[root@myprecious ~]# virt-install --name=vm2 --ram=1024 --vcpus=1 --disk path=/opt/kvm/images/vm2.qcow2,format=qcow2,size=7,bus=virtio --cdrom /opt/kvm/data/centos7.iso --graphics vnc,port=5911, --network bridge=virbr0,model=virtio --force --autostart 以上就是显示创建成功然后确认下端口和iptables没有问题的话就可以使用vnc连接123[root@myprecious ~]# netstat -antup |grep kvmtcp 0 0 0.0.0.0:5910 0.0.0.0:* LISTEN 1787/qemu-kvmtcp 0 0 192.168.122.24:5910 192.168.122.1:58697 ESTABLISHED 1787/qemu-kvm 4.远程连接安装界面关闭宿主机(这里为myprecious)中的防火墙firewalld，telnet下到宿主机的响应端口(这里为telnet 192.168.104.240 5911)，如果端口是通的说明可以连通。在物理机Windows上安装TightVNC，完成后输入IP:Port(此处为192.168.104.240:5911)以完成虚机安装。在vnc安装完成虚拟机自动重启,启动之后就再也连不上了，这时使用virsh手动启动。1[root@myprecious ~]# virsh start vm1 #vm1为虚拟机名 再次远程连接，然后配置虚拟机ip，配置console登录后重启。 5.查看虚拟机的基本信息使用virt-install工具，工具自动创建磁盘，默认是raw格式12345[root@myprecious ~]# qemu-img info /opt/kvm/images/vm1.imgimage: /opt/kvm/images/vm1.imgfile format: rawvirtual size: 10G (10737418240 bytes)disk size: 1.4G 6.查看虚拟机的配置文件使用virt-install工具安装虚拟机后，在目录/etc/libvirt/qemu/下生成xml配置文件配置文件命名:虚拟机名.xml1[root@myprecious ~]# cat /etc/libvirt/qemu/vm1.xml 7.窗口检测与ACPID启动一个窗口监测安装进程如virt-viewer vm1来查看安装进程。 有时候会碰到虚拟机无法正常安装，如果没有启动acpid进程的话，使用virsh shutdown vm1就会无法关闭虚拟机，这时候就需要使用命令virsh destroy vm1来强制关闭了。 安装acpid12345[root@myprecious ~]# yum install acpid -y[root@myprecious ~]# systemctl list-unit-files | grep acpidacpid.service enabled [root@myprecious ~]# systemctl enable acpid.service[root@myprecious ~]# systemctl start acpid.service 完成以上操作后，就可以使用virsh shutdown &lt;guestname&gt;来很方便的关闭远程虚机了。 8.快照等做完虚拟机的配置后，就需要对虚拟机做一个快照了。快照的制作有两种方法，一种是直接在virsh 里面使用snapshot来制作。另外一种是使用qemu-img来创建快照 1.使用snapshot创建快照： 创建快照1[root@myprecious ~]# virsh snapshot-create-as vm1 快照创建的很快，其实，就是生成了一个XML的配置文件，记录下当前的信息。 查看快照 1234[root@myprecious ~]# virsh snapshot-list vm1名称 CreationTime 状态------------------------------------------------------------ 1330938135 2017-01-17 10:44:29 +0800 shutoff 查看快照的配置文件 1[root@myprecious ~]# virsh snapshot-current vm1 那么，快照文件存在什么地方呢，在/var/lib/libvirt/qemu/snapshot目录下，有以虚拟机的域名为名称的文件夹，就在里面哪。 2.使用qemu-img创建快照：使用qemu-img创建快照也很方便，这个镜像是直接对硬盘文件进行操作，硬盘文件的格式必须为qcow2格式的。 创建快照 1[root@myprecious ~]# qemu-img snapshot -c 2017-1-17 /opt/kvm/images/baseCentos.qcow2 查看快照创建完毕后，查看一下 12345[root@myprecious ~]# qemu-img snapshot -l /opt/kvm/images/baseCentos.qcow2Snapshot list:ID TAG VMSIZE DATE VM CLOCK1 1330938135 0 2017-01-1710:44:29 00:00:00.0002 2017-1-17 0 2017-01-1711:51:39 00:00:00.000 可以看到有两个快照，ID＝1为virsh创建的，ID＝2为qemu-img创建的。 –(待续)– 参考信息： 尘埃-kvm虚拟机之创建存储池三（存储池创建） 尘埃-kvm虚拟机之虚拟机安装四（虚拟机安装）","tags":[{"name":"Linux","slug":"Linux","permalink":"https://opstrip.com/tags/Linux/"},{"name":"KVM","slug":"KVM","permalink":"https://opstrip.com/tags/KVM/"},{"name":"虚拟化","slug":"虚拟化","permalink":"https://opstrip.com/tags/虚拟化/"},{"name":"虚拟机","slug":"虚拟机","permalink":"https://opstrip.com/tags/虚拟机/"}]},{"title":"KVM学习手记：01 安装","date":"2017-01-16T02:52:54.000Z","path":"2017/01/16/Using-Notes-For-KVM-01/","text":"引言认识虚拟化在计算机中，虚拟化（英语：Virtualization）是一种资源管理技术，是将计算机的各种实体资源，如服务器、网络、内存及存储等，予以抽象、转换后呈现出来，打破实体结构间的不可切割的障碍，使用户可以比原本的组态更好的方式来应用这些资源。这些资源的新虚拟部份是不受现有资源的架设方式，地域或物理组态所限制。一般所指的虚拟化资源包括计算能力和资料存储。在实际的生产环境中，虚拟化技术主要用来解决高性能的物理硬件产能过剩和老的旧的硬件产能过低的重组重用，透明化底层物理硬件，从而最大化的利用物理硬件。 虚拟化技术的分类虚拟化技术主要分为以下几个大类 [1]： 平台虚拟化（Platform Virtualization），针对计算机和操作系统的虚拟化。资源虚拟化（Resource Virtualization），针对特定的系统资源的虚拟化，比如内存、存储、网络资源等。应用程序虚拟化（Application Virtualization），包括仿真、模拟、解释技术等。我们通常所说的虚拟化主要是指平台虚拟化技术，通过使用控制程序（Control Program，也被称为 Virtual Machine Monitor 或 Hypervisor），隐藏特定计算平台的实际物理特性，为用户提供抽象的、统一的、模拟的计算环境（称为虚拟机）。虚拟机中运行的操作系统被称为客户机操作系统（Guest OS），运行虚拟机监控器的操作系统被称为主机操作系统（Host OS），当然某些虚拟机监控器可以脱离操作系统直接运行在硬件之上（如 VMWARE 的 ESX 产品）。运行虚拟机的真实系统我们称之为主机系统。平台虚拟化技术又可以细分为如下几个子类： 全虚拟化（Full Virtualization）全虚拟化是指虚拟机模拟了完整的底层硬件，包括处理器、物理内存、时钟、外设等，使得为原始硬件设计的操作系统或其它系统软件完全不做任何修改就可以在虚拟机中运行。操作系统与真实硬件之间的交互可以看成是通过一个预先规定的硬件接口进行的。全虚拟化 VMM 以完整模拟硬件的方式提供全部接口（同时还必须模拟特权指令的执行过程）。举例而言，x86 体系结构中，对于操作系统切换进程页表的操作，真实硬件通过提供一个特权 CR3 寄存器来实现该接口，操作系统只需执行 “mov pgtable,%%cr3” 汇编指令即可。全虚拟化 VMM 必须完整地模拟该接口执行的全过程。如果硬件不提供虚拟化的特殊支持，那么这个模拟过程将会十分复杂：一般而言，VMM 必须运行在最高优先级来完全控制主机系统，而 Guest OS 需要降级运行，从而不能执行特权操作。当 Guest OS 执行前面的特权汇编指令时，主机系统产生异常（General Protection Exception），执行控制权重新从 Guest OS 转到 VMM 手中。VMM 事先分配一个变量作为影子 CR3 寄存器给 Guest OS，将 pgtable 代表的客户机物理地址（Guest Physical Address）填入影子 CR3 寄存器，然后 VMM 还需要 pgtable 翻译成主机物理地址（Host Physical Address）并填入物理 CR3 寄存器，最后返回到 Guest OS中。随后 VMM 还将处理复杂的 Guest OS 缺页异常（Page Fault）。比较著名的全虚拟化 VMM 有 Microsoft Virtual PC、VMware Workstation、Sun Virtual Box、Parallels Desktop for Mac 和 QEMU。 超虚拟化（Paravirtualization）这是一种修改 Guest OS 部分访问特权状态的代码以便直接与 VMM 交互的技术。在超虚拟化虚拟机中，部分硬件接口以软件的形式提供给客户机操作系统，这可以通过 Hypercall（VMM 提供给 Guest OS 的直接调用，与系统调用类似）的方式来提供。例如，Guest OS 把切换页表的代码修改为调用 Hypercall 来直接完成修改影子 CR3 寄存器和翻译地址的工作。由于不需要产生额外的异常和模拟部分硬件执行流程，超虚拟化可以大幅度提高性能，比较著名的 VMM 有 Denali、Xen。 硬件辅助虚拟化（Hardware-Assisted Virtualization）硬件辅助虚拟化是指借助硬件（主要是主机处理器）的支持来实现高效的全虚拟化。例如有了 Intel-VT 技术的支持，Guest OS 和 VMM 的执行环境自动地完全隔离开来，Guest OS 有自己的“全套寄存器”，可以直接运行在最高级别。因此在上面的例子中，Guest OS 能够执行修改页表的汇编指令。Intel-VT 和 AMD-V 是目前 x86 体系结构上可用的两种硬件辅助虚拟化技术。 部分虚拟化（Partial Virtualization）VMM 只模拟部分底层硬件，因此客户机操作系统不做修改是无法在虚拟机中运行的，其它程序可能也需要进行修改。在历史上，部分虚拟化是通往全虚拟化道路上的重要里程碑，最早出现在第一代的分时系统 CTSS 和 IBM M44/44X 实验性的分页系统中。 操作系统级虚拟化（Operating System Level Virtualization）在传统操作系统中，所有用户的进程本质上是在同一个操作系统的实例中运行，因此内核或应用程序的缺陷可能影响到其它进程。操作系统级虚拟化是一种在服务器操作系统中使用的轻量级的虚拟化技术，内核通过创建多个虚拟的操作系统实例（内核和库）来隔离不同的进程，不同实例中的进程完全不了解对方的存在。比较著名的有 Solaris Container [2]，FreeBSD Jail 和 OpenVZ 等。这种分类并不是绝对的，一个优秀的虚拟化软件往往融合了多项技术。例如 VMware Workstation 是一个著名的全虚拟化的 VMM，但是它使用了一种被称为动态二进制翻译的技术把对特权状态的访问转换成对影子状态的操作，从而避免了低效的 Trap-And-Emulate 的处理方式，这与超虚拟化相似，只不过超虚拟化是静态地修改程序代码。对于超虚拟化而言，如果能利用硬件特性，那么虚拟机的管理将会大大简化，同时还能保持较高的性能。 正文认识KVM好了，虚拟化的概念就简单的说这么多了。是时候介绍一下今天的主角————KVM了。KVM全称***Kernel-based Virtual Machine***, 其实kvm只是一个内核模块，提供虚拟cpu和内存管理的模块，至于其它的设备是由qemu模拟的，如网卡，显卡，磁盘等。后来redhat联合IBM以及Linux社区创造了libvirt，模拟的设备性能要比qemu的好很多，并提供了一系列的管理工具和api，整个集成了kvm虚拟化的解决方案。Linux(redhat系)装载kvm模块后，摇身一变成为了VM Monitor，也称为Hypervisor，部署使用简单，需要硬件支持虚拟化。 安装KVM0.实验/作业环境12345678#物理主机端：#操作系统：Win7旗舰版64位#CPU：Intel Core i5-6200U#软件环境：VMWareStation12.0#其他：在BIOS中开启了VT功能#宿主机端：#操作系统：CentOS7.3#软件支持：libvirt/qemu/bridge 1.检测硬件是否支持虚拟化123[root@myprecious ~]# egrep '(vmx|svm)' --color=always /proc/cpuinfo [root@myprecious ~]# modprobe kvm [root@myprecious ~]# modprobe kvm_intel || modprobe kvm_amd 如果输出结果含有vmx或者svm字样，则表示支持CPU虚拟化，Intel是vmx，AMD是svm，也需要检测是否有kvm_xxx模块，如果装载不成功，可能是没有开启硬件虚拟化,需要bios中开启，具体开启方式请联系厂家。 2.升级安装常用软件及虚拟化服务并启动12345678910[root@myprecious ~]# yum clean all[root@myprecious ~]# yum makecache[root@myprecious ~]# yum upgrade -y # 升级宿主机系统软件[root@myprecious ~]# yum -y install qemu-kvm libvirt virt-install bridge-utils[root@myprecious ~]# yum -y install vim wget gcc make crontabs mlocate ntp lrzsz telnet* gcc-c++ autoconf setuptool ntsysv system-config-securitylevel-tui system-config-network-tui sysstat dstat screen # 安装常用软件[root@myprecious ~]# yum -y groupinstall Virtualization 'Virtualization Client' 'Virtualization Platform' 'Virtualization Tools' # 安装虚拟化软件包[root@myprecious ~]# lsmod | grep kvm # 确保模块已加载 441119 0[root@myprecious ~]# systemctl start libvirtd[root@myprecious ~]# systemctl enable libvirtd 注：centos7上服务的管理方式换成了systemctl 3.检查是否有kvm模块，如果有则继续123[root@myprecious ~]# lsmod | grep kvm kvm_intel 52570 30 kvm 314739 1 kvm_intel 4.配置桥接网络br0centos7上默认已不再是eth0、eth1，比如，在我的机器上安装好的第一块网卡成为了eno16777736，修改步骤和centos6上没有区别。拿我这台测试电脑来说，常见配置网桥方法如下：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566[root@myprecious ~]# cd /etc/sysconfig/network-scripts/[root@myprecious ~]# cat ifcfg-br0TYPE=BridgeBOOTPROTO=noneDEVICE=br0ONBOOT=yesIPADDR0=192.168.107.240PREFIX0=22GATEWAY0=192.168.104.254#NM_CONTROLLED=no[root@myprecious ~]# cat ifcfg-eno16777736DEVICE=eno16777736TYPE=EthernetONBOOT=yesBRIDGE=br0#NM_CONTROLLED=no[root@myprecious ~]# reboot[root@myprecious ~]# ifconfigbr0: flags=4163 mtu 1500 inet 192.168.107.240 netmask 255.255.252.0 broadcast 192.168.107.255 inet6 fe80::7a24:afff:fe46:ca60 prefixlen 64 scopeid 0x20 ether 78:24:af:46:ca:60 txqueuelen 0 (Ethernet) RX packets 129 bytes 14676 (14.3 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 148 bytes 21994 (21.4 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0eno16777736: flags=4163 mtu 1500 ether 00:0c:29:24:02:98 txqueuelen 1000 (Ethernet) RX packets 129 bytes 16482 (16.0 KiB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 148 bytes 21994 (21.4 KiB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0lo: flags=73 mtu 65536 inet 127.0.0.1 netmask 255.0.0.0 inet6 ::1 prefixlen 128 scopeid 0x10 loop txqueuelen 0 (Local Loopback) RX packets 9 bytes 728 (728.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 9 bytes 728 (728.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0virbr0: flags=4099 mtu 1500 inet 192.168.122.1 netmask 255.255.255.0 broadcast 192.168.122.255 ether a6:88:9f:14:b2:66 txqueuelen 0 (Ethernet) RX packets 0 bytes 0 (0.0 B) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 1 bytes 90 (90.0 B) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0[root@myprecious ~]# ip add show1: lo: mtu 65536 qdisc noqueue state UNKNOWN link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eno16777736: mtu 1500 qdisc pfifo_fast master br0 state UP qlen 1000 link/ether 78:24:af:46:ca:60 brd ff:ff:ff:ff:ff:ff3: br0: mtu 1500 qdisc noqueue state UP link/ether 78:24:af:46:ca:60 brd ff:ff:ff:ff:ff:ff inet 192.168.0.102/24 brd 192.168.0.255 scope global br0 valid_lft forever preferred_lft forever inet6 fe80::7a24:afff:fe46:ca60/64 scope link valid_lft forever preferred_lft forever4: virbr0: mtu 1500 qdisc noqueue state DOWN link/ether a6:88:9f:14:b2:66 brd ff:ff:ff:ff:ff:ff inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0 valid_lft forever preferred_lft forever ***说明***：以上网卡配置文件中，NM_CONTROLLED这个属性值，根据redhat公司的文档是必须设置为“no”的（这个值为“yes”表示可以由服务NetworkManager来管理。NetworkManager服务不支持桥接，所以要设置为“no”。） 由于该宿主机使用的是虚拟化环境非原生的物理网络，由VMWare与Windows桥接（通常在Windows中被识别为VMnet0的虚拟网卡）使用，VMWare已经为我们创建了虚拟网桥virbr0，所以这里我们就不用配置了。如下：12345678910111213141516171819202122[root@myprecious ~]# ip add show1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever2: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000 link/ether 00:0c:29:24:02:98 brd ff:ff:ff:ff:ff:ff inet 192.168.104.240/22 brd 192.168.107.255 scope global eno16777736 valid_lft forever preferred_lft forever inet6 fe80::20c:29ff:fe24:298/64 scope link valid_lft forever preferred_lft forever3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN qlen 1000 link/ether 52:54:00:fe:f9:2b brd ff:ff:ff:ff:ff:ff inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0 valid_lft forever preferred_lft forever4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN qlen 1000 link/ether 52:54:00:fe:f9:2b brd ff:ff:ff:ff:ff:ff[root@myprecious ~]# brctl showbridge name bridge id STP enabled interfacesvirbr0 8000.525400fef92b yes virbr0-nic 注：由于ip命令属于iproute2软件包中的工具，由于代替旧的ifconfig命令，尽可能的习惯使用新的命令和工具包来淘汰老的软件和工具。 5.关闭selinux同centos612[root@myprecious ~]# setenforce 0[root@myprecious ~]# sed -i 's/=enforcing/=disabled/g' /etc/selinux/config –(待续)– 参考信息：http://www.ibm.com/developerworks/cn/linux/l-cn-vt/index.html（虚拟化介绍）","tags":[{"name":"Linux","slug":"Linux","permalink":"https://opstrip.com/tags/Linux/"},{"name":"KVM","slug":"KVM","permalink":"https://opstrip.com/tags/KVM/"},{"name":"虚拟化","slug":"虚拟化","permalink":"https://opstrip.com/tags/虚拟化/"},{"name":"虚拟机","slug":"虚拟机","permalink":"https://opstrip.com/tags/虚拟机/"}]},{"title":"iptables配置详解","date":"2017-01-13T07:43:40.000Z","path":"2017/01/13/Iptables-Configuration-Examples/","text":"iptables命令可用于配置Linux的包过滤规则，常用于实现防火墙、NAT。咋一看iptables的配置很复杂，掌握规律后，其实用iptables完成指定任务并不难，下面我们通过具体实例，学习iptables的详细用法。 删除已有规则在新设定iptables规则时，我们一般先确保旧规则被清除，用以下命令清除旧规则：12iptables -F(or iptables --flush) 设置chain策略对于filter table，默认的chain策略为ACCEPT，我们可以通过以下命令修改chain的策略：123iptables -P INPUT DROPiptables -P FORWARD DROPiptables -P OUTPUT DROP 以上命令配置将接收、转发和发出包均丢弃，施行比较严格的包管理。由于接收和发包均被设置为丢弃，当进一步配置其他规则的时候，需要注意针对INPUT和OUTPUT分别配置。当然，如果信任本机器往外发包，以上第三条规则可不必配置。 IP黑名单有时候我们发现某个ip不停的往服务器发包，这时我们可以使用以下命令，将指定ip发来的包丢弃：12BLOCK_THIS_IP=\"x.x.x.x\"iptables -A INPUT -i eth0 -p tcp -s \"$BLOCK_THIS_IP\" -j DROP 以上命令设置将由x.x.x.x ip发往eth0网口的tcp包丢弃。 配置服务项利用iptables，我们可以对日常用到的服务项进行安全管理，比如设定只能通过指定网段、由指定网口通过SSH连接本机：12iptables -A INPUT -i eth0 -p tcp -s 10.221.18.0/24 --dport 22 -m state --state NEW,ESTABLESHED -j ACCEPTiptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT 若要支持由本机通过SSH连接其他机器，由于在本机端口建立连接，因而还需要设置以下规则：12iptables -A INPUT -i eth0 -p tcp -s 10.221.18.0/24 --dport 22 -m state --state ESTABLESHED -j ACCEPTiptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state NEW,ESTABLISHED -j ACCEPT 类似的，对于HTTP/HTTPS(80/443)、pop3(110)、rsync(873)、MySQL(3306)等基于tcp连接的服务，也可以参照上述命令配置。 对于基于udp的dns服务，使用以下命令开启端口服务：12iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPTiptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT 网口转发配置对于用作防火墙或网关的服务器，一个网口连接到公网，其他网口的包转发到该网口实现内网向公网通信，假设eth0连接内网，eth1连接公网，配置规则如下：1iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT 端口转发配置对于端口，我们也可以运用iptables完成转发配置：1iptables -t nat -A PREROUTING -p tcp -d 10.221.18.15 --dport 422 -j DNAT --to 10.221.18.37:22 以上命令将422端口的包转发到22端口，因而通过422端口也可进行SSH连接，当然对于422端口，我们也需要像以上“4.配置服务项”一节一样，配置其支持连接建立的规则。 DoS攻击防范利用扩展模块limit，我们还可以配置iptables规则，实现DoS攻击防范：1iptables -A INPUT -p tcp --dport 80 -m limit --limit 25/minute --limit-burst 100 -j ACCEPT --litmit 25/minute 指示每分钟限制最大连接数为25--litmit-burst 100 指示当总连接数超过100时，启动 litmit/minute 限制 配置web流量均衡我们可以将一台服务器作为前端服务器，利用iptables进行流量分发，配置方法如下：123iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 10.221.18.101:80iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 10.221.18.102:80iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 10.221.18.103:80 以上配置规则用到nth扩展模块，将80端口的流量均衡到三台服务器。 将丢弃包情况记入日志使用LOG目标和syslog服务，我们可以记录某协议某端口下的收发包情况。拿记录丢包情况举例，可以通过以下方式实现。 首先自定义一个chain：1iptables -N LOGGING 其次将所有接收包导入LOGGING chain中：1iptables -A INPUT -j LOGGING 然后设置日志前缀、日志级别：1iptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix \"IPTables Packet Dropped: \" --log-level 7 最后将包倒向DROP，将包丢弃：1iptables -A LOGGING -j DROP 另可以配置syslog.conf文件，指定iptables的日志输出。","tags":[{"name":"iptables","slug":"iptables","permalink":"https://opstrip.com/tags/iptables/"},{"name":"CentOS6","slug":"CentOS6","permalink":"https://opstrip.com/tags/CentOS6/"},{"name":"学习笔记","slug":"学习笔记","permalink":"https://opstrip.com/tags/学习笔记/"}]},{"title":"git常用用法小结","date":"2017-01-12T05:41:10.000Z","path":"2017/01/12/common-usage-summary-for-git/","text":"配置配置全局用户：12345$ git config --global user.name \"Your Name\"$ git config --global user.email \"email@example.com\"$ git config --global color.ui true # 开启彩色高亮$ git config --global core.editor vim # 设置编辑器为vim$ git config -l # 列举所有配置 git 配置文件路径 ~/.gitconfig12项目的 git 配置文件路径 project/.git/config项目配置会覆盖全局配置 配置本地（当前repository）用户：12$ git config --local user.name \"Your Name\"$ git config --local user.email \"email@example.com\" 删除全局用户配置： 12$ git config --global --unset user.name$ git config --global --unset user.email 删除本地用户配置：12$ git config --local --unset user.name$ git config --local --unset user.email 创建版本库1234$ mkdir learngit #新建文件夹$ cd learngit #进入文件夹$ pwd #显示路径/Users/admin/learngit 初始化版本库与提交12345678$ git init #初始化空版本库Initialized empty Git repository in /Users/admin/learngit/.git/$ git add &lt;file&gt; # 将工作文件修改提交到本地暂存区$ git add . # 将所有修改过的工作文件提交暂存区$ git commit -m \"wrote a readme file\" #将暂存区文件提交到当前分支[master (root-commit) cb926e7] wrote a readme file 1 file changed, 2 insertions(+) create mode 100644 readme.txt 常用操作查看、添加、提交、删除、找回，重置修改文件 查看文件12345678910$ git show # 显示某次提交的内容$ git show $id # 显示指定id的内容 $ git diff &lt;file&gt; # 比较当前文件和暂存区文件差异$ git diff$ git diff &lt;$id1&gt; &lt;$id2&gt; # 比较两次提交之间的差异$ git diff &lt;branch1&gt;..&lt;branch2&gt; # 在两个分支之间比较$ git diff --staged # 比较暂存区和版本库差异$ git diff --cached # 比较暂存区和版本库差异$ git diff --stat # 仅仅比较统计信息 查看提交记录12345$ git log$ git log &lt;file&gt; # 查看该文件每次提交记录$ git log -p &lt;file&gt; # 查看每次详细修改内容的 diff$ git log -p -2 # 查看最近两次详细修改内容的 diff$ git 本地分支管理 查看、切换、创建和删除分支12345678910111213141516$ git branch # 查看分支$ git branch -r # 查看远程分支$ git branch &lt;new_branch&gt; # 创建新的分支$ git branch -v # 查看各个分支最后提交信息$ git branch --merged # 查看已经被合并到当前分支的分支$ git branch --no-merged # 查看尚未被合并到当前分支的分支$ git branch -d &lt;branch&gt; # 删除某个分支$ git branch -D &lt;branch&gt; # 强制删除某个分支 (未被合并的分支被删除的时候需要强制) $ git checkout &lt;branch&gt; # 切换到某个分支$ git checkout -b &lt;new_branch&gt; # 创建新的分支，并且切换过去$ git checkout -b &lt;new_branch&gt; &lt;branch&gt; # 基于 branch 创建新的new_branch$ git checkout $id # 把某次历史提交记录 checkout 出来，但无分支信息，切换到其他分支会自动删除$ git checkout $id -b &lt;new_branch&gt; # 把某次历史提交记录 checkout 出来，创建成一个分支$ git checkout -- &lt;file&gt; # 抛弃工作区修改$ git checkout . # 抛弃工作区修改 分支合并和rebase123$ git merge &lt;branch&gt; # 将 branch 分支合并到当前分支$ git merge origin/master --no-ff # 不要 Fast-Foward 合并，这样可以生成 merge 提交$ git rebase master &lt;branch&gt; # 将 master rebase 到 branch，相当于：git checkout &lt;branch&gt; &amp;&amp; git rebase master &amp;&amp; git checkout master &amp;&amp; git merge &lt;branch&gt; git暂存管理1234$ git stash # 暂存$ git stash list # 列所有stash$ git stash apply # 恢复暂存的内容$ git stash drop # 删除暂存区 git远程分支管理12345678910111213141516171819202122$ git pull # 抓取远程仓库所有分支更新并合并到本地$ git pull --no-ff # 抓取远程仓库所有分支更新并合并到本地，不要快进合并$ git fetch origin # 抓取远程仓库更新$ git merge origin/master # 将远程主分支合并到本地当前分支$ git checkout --track origin/branch # 跟踪某个远程分支创建相应的本地分支$ git checkout -b &lt;local_branch&gt; origin/&lt;remote_branch&gt; # 基于远程分支创建本地分支，功能同上 $ git push # push所有分支$ git push origin master # 将本地主分支推到远程主分支$ git push -u origin master # 将本地主分支推到远程(如无远程主分支则创建，用于初始化远程仓库)$ git push origin &lt;local_branch&gt; # 创建远程分支， origin是远程仓库名$ git push origin &lt;local_branch&gt;:&lt;remote_branch&gt; # 创建远程分支$ git push origin :&lt;remote_branch&gt; # 先删除本地分支(git branch -d &lt;branch&gt;)，然后再push删除远程分支 $ git rm &lt;file&gt; # 从版本库中删除文件$ git rm -rf &lt;file&gt; # 强制删除远程仓库中的文件目录$ git rm &lt;file&gt; --cached # 从版本库中删除文件，但不删除文件 $ git reset &lt;file&gt; # 从暂存区恢复到工作文件$ git reset -- . # 从暂存区恢复到工作文件$ git reset --hard # 恢复最近一次提交过的状态，即放弃上次提交后的所有本次修改$ git reset --hard HEAD^ #回退到上个版本（上一个版本就是HEAD^，上上一个版本就是HEAD^^，当然往上100个版本写100个^比较容易数不过来，所以写成HEAD~100。） git远程仓库管理123456789101112131415161718192021222324252627282930$ git remote -v # 查看远程服务器地址和仓库名称$ git remote show origin # 查看远程服务器仓库状态$ git remote add origin git@github.com:whuhacker/Unblock-Youku-Firefox.git # 添加远程仓库地址$ git remote set-url origin git@github.com:whuhacker/Unblock-Youku-Firefox.git # 设置远程仓库地址(用于修改远程仓库地址)$ git remote rm &lt;repository&gt; # 删除远程仓库 $ git commit &lt;file&gt;$ git commit .$ git commit -a # 将 git add, git rm 和 git ci 等操作都合并在一起做$ git commit -am \"some comments\"$ git commit --amend # 修改最后一次提交记录 $ git revert &lt;$id&gt; # 恢复某次提交的状态，恢复动作本身也创建了一次提交对象$ git revert HEAD # 恢复最后一次提交的状态 $ git status # 查看还问提交但是已经被修改的文件 $ git log # 查看历史版本提交记录$ git log --pretty=oneline # 查看历史版本提交记录（显示在一行）$ git reflog # 用来记录每一次执行的命令 $ git merge dev # 合并dev到当前分支$ git merge --no-ff -m \"merge with no-ff\" dev # 加上--no-ff参数就可以用普通模式合并，合并后的历史有分支，能看出来曾经做过合并远程仓库$ ssh-keygen -t rsa -C \"youremail@example.com\" # 获取管理github仓库的密钥私钥$ git remote add origin git@github.com:opstrip/opstrip.github.io.git # 关联远程仓库$ git remote set-url origin git@github.com:opstrip/opstrip.github.io.git # 修改远程仓库$ git push -u origin master # 推送到远程仓库的master分支$ git clone git@github.com:opstrip/opstrip.github.io.git # 从远程克隆仓库到本地$ git push origin branch-name # 把本地提交推送到远程仓库的&lt;branch-name&gt;分支$ git pull # 获取最新的远程仓库 设置跟踪远程库和本地库12$ git branch --set-upstream master origin/master$ git branch --set-upstream develop origin/develop 如果git pull提示“no tracking information”，则说明本地分支和远程分支的链接关系没有创建，用命令git branch –set-upstream branch-name origin/branch-name。","tags":[{"name":"git用法","slug":"git用法","permalink":"https://opstrip.com/tags/git用法/"},{"name":"版本控制","slug":"版本控制","permalink":"https://opstrip.com/tags/版本控制/"},{"name":"使用详解","slug":"使用详解","permalink":"https://opstrip.com/tags/使用详解/"}]},{"title":"nginx配置文件nginx.conf配置模版","date":"2017-01-10T05:46:44.000Z","path":"2017/01/10/nginx-configuration-template/","text":"Nginx(“engine x”)是一款轻量级高性能的Web服务器/反向代理服务器及电子邮件（IMAP/POP3/SMTP）代理服务器，并在一个BSD-like 协议下发行。由俄罗斯的程序设计师Igor Sysoev所开发，供俄国大型的入口网站及搜索引擎Rambler.ru（俄文：Рамблер）使用。其特点是占有内存少，并发能力强，事实上nginx的并发能力确实在同类型的网页服务器中表现较好，因而获得了众多粉丝的青睐。目前中国大陆使用nginx网站的大型网站主要有：百度、京东、新浪、网易、腾讯、淘宝等。今天花了点时间整理了下Nginx配置参数中文说明，以做备忘。更详细的模块参数可参考：nginx官网 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145 #定义Nginx运行的用户和用户组user www www; #nginx进程数，建议设置为等于CPU总核心数。worker_processes 8; #全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]error_log /var/log/nginx/error.log info; #进程文件pid /var/run/nginx.pid; #一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。worker_rlimit_nofile 65535; #工作模式与连接数上限events&#123; #参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。 use epoll; #单个进程最大连接数（最大连接数=连接数*进程数） worker_connections 65535;&#125; #设定http服务器http&#123; include mime.types; #文件扩展名与文件类型映射表 default_type application/octet-stream; #默认文件类型 #charset utf-8; #默认编码 server_names_hash_bucket_size 128; #服务器名字的hash表大小 client_header_buffer_size 32k; #上传文件大小限制 large_client_header_buffers 4 64k; #设定请求缓 client_max_body_size 8m; #设定请求缓 sendfile on; #开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。 autoindex on; #开启目录列表访问，合适下载服务器，默认关闭。 tcp_nopush on; #防止网络阻塞 tcp_nodelay on; #防止网络阻塞 keepalive_timeout 120; #长连接超时时间，单位是秒 #FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。 fastcgi_connect_timeout 300; fastcgi_send_timeout 300; fastcgi_read_timeout 300; fastcgi_buffer_size 64k; fastcgi_buffers 4 64k; fastcgi_busy_buffers_size 128k; fastcgi_temp_file_write_size 128k; #gzip模块设置 gzip on; #开启gzip压缩输出 gzip_min_length 1k; #最小压缩文件大小 gzip_buffers 4 16k; #压缩缓冲区 gzip_http_version 1.0; #压缩版本（默认1.1，前端如果是squid2.5请使用1.0） gzip_comp_level 2; #压缩等级 gzip_types text/plain application/x-javascript text/css application/xml; #压缩类型，默认就已经包含text/html，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。 gzip_vary on; #limit_zone crawler $binary_remote_addr 10m; #开启限制IP连接数的时候需要使用 upstream opstrip.com &#123; #upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。 server 10.12.80.121:80 weight=3; server 10.12.80.122:80 weight=2; server 10.12.80.123:80 weight=3; &#125; #虚拟主机的配置 server &#123; #监听端口 listen 80; #域名可以有多个，用空格隔开 server_name opstrip.com www.opstrip.com; index index.html index.htm index.php; root /var/www/opstrip.com; location ~ .*.(php|php5)?$ &#123; fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; include fastcgi.conf; &#125; #图片缓存时间设置 location ~ .*.(gif|jpg|jpeg|png|bmp|swf)$ &#123; expires 10d; &#125; #JS和CSS缓存时间设置 location ~ .*.(js|css)?$ &#123; expires 1h; &#125; #日志格式设定 log_format access '$remote_addr - $remote_user [$time_local] \"$request\" ' '$status $body_bytes_sent \"$http_referer\" ' '\"$http_user_agent\" $http_x_forwarded_for'; #定义本虚拟主机的访问日志 access_log /var/log/nginx/ha97access.log access; #对 \"/\" 启用反向代理 location / &#123; proxy_pass http://127.0.0.1:88; proxy_redirect off; proxy_set_header X-Real-IP $remote_addr; #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; #以下是一些反向代理的配置，可选。 proxy_set_header Host $host; client_max_body_size 10m; #允许客户端请求的最大单文件字节数 client_body_buffer_size 128k; #缓冲区代理缓冲用户端请求的最大字节数， proxy_connect_timeout 90; #nginx跟后端服务器连接超时时间(代理连接超时) proxy_send_timeout 90; #后端服务器数据回传时间(代理发送超时) proxy_read_timeout 90; #连接成功后，后端服务器响应时间(代理接收超时) proxy_buffer_size 4k; #设置代理服务器（nginx）保存用户头信息的缓冲区大小 proxy_buffers 4 32k; #proxy_buffers缓冲区，网页平均在32k以下的设置 proxy_busy_buffers_size 64k; #高负荷下缓冲大小（proxy_buffers*2） proxy_temp_file_write_size 64k; #设定缓存文件夹大小，大于这个值，将从upstream服务器传 &#125; #设定查看Nginx状态的地址 location /NginxStatus &#123; stub_status on; access_log on; auth_basic \"NginxStatus\"; auth_basic_user_file conf/htpasswd; #htpasswd文件的内容可以用apache提供的htpasswd工具来产生。 &#125; #本地动静分离反向代理配置 #所有jsp的页面均交由tomcat或resin处理 location ~ .(jsp|jspx|do)?$ &#123; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_pass http://127.0.0.1:8080; &#125; #所有静态文件由nginx直接读取不经过tomcat或resin location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$ &#123; expires 15d; &#125; location ~ .*.(js|css)?$ &#123; expires 1h; &#125; &#125;&#125; 更详细的模块参数可以参考：http://wiki.nginx.org/Main","tags":[{"name":"nginx","slug":"nginx","permalink":"https://opstrip.com/tags/nginx/"},{"name":"配置模板","slug":"配置模板","permalink":"https://opstrip.com/tags/配置模板/"},{"name":"参考样例","slug":"参考样例","permalink":"https://opstrip.com/tags/参考样例/"}]},{"title":"CentOS 配置 console登录","date":"2017-01-09T06:46:44.000Z","path":"2017/01/09/open-console-on-centos6-centos7/","text":"创建KVM镜像时，为管理方便，需要镜像支持console登录。以下说说分别在centos6/centos7中配置console登录的方法。 CentOS6 配置 console 登录1. 添加ttyS0的许可，允许root登录1# echo \"ttyS0\" &gt;&gt; /etc/securetty 2. 修改 /etc/grub.conf 文件 在/etc/grub.conf文件中kernel行末尾追加console=ttyS0 3. 修改/etc/inittab文件（可省略） 在/etc/inittab中加入1S0:12345:respawn:/sbin/agetty ttyS0 115200 4. 重启1# reboot CentOS7 配置 console 登录1. 编辑文件/etc/sysconfig/grub 在GRUB_CMD_LINELINUX行末尾添加console=ttyS0，类似以下这样：123456GRUB_TIMEOUT=5GRUB_DEFAULT=savedGRUB_DISABLE_SUBMENU=trueGRUB_TERMINAL_OUTPUT=\"console\"GRUB_CMDLINE_LINUX=\"rd.lvm.lv=centos/root rd.lvm.lv=centos/swap crashkernel=auto rhgb quiet console=ttyS0\"GRUB_DISABLE_RECOVERY=\"true\" 2. 并以root权限运行以下命令： 123stty -F /dev/ttyS0 speed 9600grub2-mkconfig -o /boot/grub2/grub.cfgsystemctl start getty@ttyS0 完成后验证。","tags":[{"name":"console","slug":"console","permalink":"https://opstrip.com/tags/console/"},{"name":"centos6","slug":"centos6","permalink":"https://opstrip.com/tags/centos6/"},{"name":"centos7","slug":"centos7","permalink":"https://opstrip.com/tags/centos7/"}]},{"title":"CentOS7版本的新特性","date":"2016-12-05T05:42:35.000Z","path":"2016/12/05/the-new-features-of-centos7/","text":"综述XFS 比 EXT 4更适合大文件处理，但消耗的CPU资源是EXT4的两倍 XFS 最大支持单文件16TB，EXT4:50TB 最小1GB/建议每个逻辑CPU 1GB 逻辑CPU:核数，而非线程数 lscpu可查看 一CPU多核，一二级缓存是独立的，三级缓存是所有核共享的 NUMA :非一致性内存访问UMA 换成GRUB2GPT: 单硬盘超过2TB(RAID后),一个硬盘最多可分配128个主分区 支持非linux文件系统苹果的扩展分层文件系统（HFS+)微软的NTFS(只是grub2支持，不一定是内核支持) 内核版本3.10支持大的crashkernel大小 以前kdump会把内存128M专用于保存内核信息，内存小于2GB时会启动失败。现在比128M更大了 swap内存压缩 将内核模块列入黑名单 动态内核补丁（不需要重新编译内核了） 集群Pacemaker keepalived HAProxy 替换Piranha initrd=initrd.img驱动模块 命令新增命令纠错功能 新增参数/选项补齐功能 服务原来在：/etc/init.d/ 现在： */usr/lib/systemd /usr/lib/systemd/system 系统启动的第一个进程（进程号1）是systemd，代替了原来的init pstree可以看到1234567891011121314systemctl status|start|stop|restart|reload UNIT systemctl enable|disable UNIT systemctl mask UNIT # 完全disable,使unit不被手动启动或开机启动 systemctl unmask UNITsystemctl list-unit-files [--type=service] # 相当于chkconfig --list (但多了一种状态：static，表示这个服务不能单独启动，而是由其它服务调用带动启动)systemctl list-units [--type=service] [--all] # 其中all表示也显示inactive的systemctl --failed --type=service # 查看失败的服务systemctl list-dependencies UNITsystemctl reboot|poweroffsystemctl get-defaultsystemctl set-defalut graphical.target | muti-user.target 只查类型是service的Unit123systemctl --type=servicesystemctl status sshd.service -l # 查看更详细信息systemctl is-active | is-enabled sshd.service 修改root密码：1、重启2、在boot loader界面按任何键3、光标移至需要启动的条目,按e4、光标移到以linux16开头的那行5、在行末添加rd.break6、按ctrl+x启动7、启动后执行以下命令来重置root密码1234mount -o remount,rw /sysrootchroot /sysrootpasswd roottouch /.autorelabel 最后两次exit退出 YUMyum 从网络下载安装时，不仅有是Y和N选项，还有d选项，实现只下载，不安装。保存路径默认为:/var/cache/yum。注意，只适用于从网络安装，如果是本地目录为yum源（baseurl=file://）则不生效 而以前的版本只可以实现安装时顺便缓存在本址，需要修改配置文件：vim /etc/yum.conf1keepcache=1 yum clean all 可以清除所有下载的包 时间管理1234timedatectltimedatectl list-timezonetimedatectl set-timezone Asia/Shanghaitimedatectl set-time 9:00:00 以前/etc/ntp.conf 现在/etc/chrony.conf 服务：chronyd1chronyc sources -v # 查看同步过程 日志管理journalctl 可以查看指定条件的日志，比如按owner、时间段、产生的进程等 -x， –catelog 只查看/var/logmessages -n 指定行数，默认10行 例如：1journalctl --since 9:00:00 --until 9:30:00 __SYSTEM_UNIT=httpd.service GPT分区以前超过2T的硬盘用fdisk分区最多只能用2T，所以以前用parted:123parted /dev/sdbmklabel gptmkpart 83 1 2621440 即使这样分区后，用fdisk -l /dev/sdb查看分区大小时，刚才创建的分区仍是2T123红帽/centos 5：partprobe红帽/centos 6：partx -a红帽/contos 7: partprobe 或 kpartx 现在不用parted，改用gdisk1234gdisk /dev/sdc2n1 # 最多可以分128个分区 -2G 负数表示从后往前分2G空间，数据放在硬盘的最外面，性能最好。负数表示从里往外分，即先分性能差的部分 格式化12345mkfs.xfs /dev/sdc1xfs_info /dev/sdc1xfs_growfs # 在线拉伸，不支持缩小xfsdump # 备份xfsrestore # 还原 网络管理网络接口命名,实际是被systemd-udevd改了 可以通过dmesg | grep eth查看 命名由三部分组成： 1、 en是以太网，wl是WLAN, ww是WWAN2、 o是板载on board的，s是热插拔，p是PCI3、 数字，代表索引、ID或port 如果无法匹配，则用传统命名12nmcli con shownmcli dev status 疑问centos7中，网卡配置文件需要加NM_CONTROLLED=”no”，否则： 改网卡配置文件（如改IP）再service network restart 不生效这种情况下要生效需要重启或执行以下命令： 1234nmcli con reloadnmcli con shownmcli con down \"...\"nmcli con up \"...\" 改计算机名现在是/etc/hostname 以前是/etc/sysocnfig/network 防火墙默认改成firewalld12systemctl mask iptables.servicesystemctl start firewalled 用firewalled配置的内容还是可以通过iptables -L查看 9个zone:1、trusted允许所有进来的流量2、home拒绝所有进来的流量，除非是与出去的流量相关或者匹配ssh,mdsn,ipp-client,samba-client,dhcpv6-client以前的iptables是通过这样实现匹配出去相关的流量：iptables -I INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT3、internal和home是一样的4、word和home基本一样，但默认允许的程序只有：ssh,ipp-client,dhcpv6-client5、public和home基本一样，但默认允许的程序只有：ssh,dhcpv6-client是新加的网络接口的默认zone6、external和home类似，但默认允许的程序只有ssh.还可以作为masqueraded(SNAT)7、dmz和home类似，但默认允许的程序只有ssh8、block和home类似,但没有默认允许的程序9、drop和home类似，但不用ICMP errors包响应 每个zone里的组成： 12345678serviceportmasquerading (SNAT)port forwarding (DNAT)icmp filterrich rules 优先级最高interfacesource 配置文件：/etc/firewalld 1234567891011121314151617181920firewall-config 图形界面配置firewall-cmd 命令行界面配置firewall-cmd --get-zonesfirewall-cmd --get-default-zonefirewall-cmd --set-default-zone=homefirewall-cmd --get-active-zonesfirewall-cmd --source=&lt;CIDR&gt; [--zone=&lt;zone&gt;] 如不指定zone则改变当前的zonefirewall-cmd --remove-source=&lt;CIDR&gt;[--zone=&lt;zone&gt;]firewall-cmd --add-interface=&lt;interface&gt;[--zone=&lt;zone&gt;]firewall-cmd --change-interface=&lt;interface&gt;[--zone=&lt;zone&gt;]--list-all 当前的zone的规则，可加[--zone=&lt;zone&gt;]指定其它zone--list-all-zomes 所有zones--add-service=&lt;service&gt; [--zone=&lt;zone&gt;]--remove-service=&lt;service&gt; [--zone=&lt;zone&gt;]--add-port=&lt;port/protocol&gt; [--zone=&lt;zone&gt;]--remove-port=&lt;port/protocol&gt; [--zone=&lt;zone&gt;]--reload firewalld-cmd --permanent --add-service=sambafirewalld-cmd --permanent --remove-service=samba runtime立刻生效,但下次重启不生效 不加--permanent则默认就是runtime的 permanent下次加载生效，可以通过 firewalld-cmd --reload 立刻生效1firewalld-cmd --permanent --add-port=80/tcp rich rules优先级最高1234firewall-cmd --permanent --new-zone=test # 注意，只能添加permanent 的zonefirewall-cmd --permanent --zone=classroom --add-rich-rule='rule family=ipv4 source address=192.168.0.1/32 reject'firewall-cmd --add-rich-rule='rule service name=ftp limit value=2/m accept' # 每分钟只接受两个包firewall-cmd --add-rich-rule='rule protocol value=esp drop' 规则位置：/usr/lib/firewalld/zones/ iscsi target12yum install targetclisystemctl enable target;systemctl start target 以前服务是tgtd,现在是target.(客户端是iscsi)12firewalld-cmd --permanent --add-port=3260/tcpfirewalld-cmd reload targetcli 进入target命令行模式12345/backstores/block/ create serverX.disk1 /dev/iSCSI_vg/disk1_lv/iscsi create iqn.2014-06.com.example:serverX/iscsi/iqn.2014-06.com.example:serverX/tpg1/acls/ create iqn.2014-06.com.example:desktopX/iscsi/iqn.2014-06.com.example:serverX/tpg1/luns create /backstores/block/serverX.disk1/iscsi/iqn.2014-06.com.example:serverX/tpg1portals create 172.25.1.11 # 最后这个IP是自己的IP,即开启监听。不加的话不是监听所有，而是都不监听，可以设成0.0.0.0 监听所有 启动流程一、 加电自检 二、 选择启动设备 1、读取启动设备第一个扇区，读取引导程序2、引导程序读取配置文件 /boot/grub2/grub.cfg #不要编辑此文件上面文件是grub2-mkconfig命令（用这两个文件/etc/default/grub,/etc/grub.d）生成的3、加载内核，并且以只读方式加载根分区4、加载init ram disk 三、 加载systemd进程 1、读取/etc/fstab2、读取所选择的target,如multi-user.target3、启动该级别的服务4、/etc/rc.d/rc.local开机脚本 (现在应该是在/usr/lib/systemd/下) 四、 login12345pvscan;vgscan;lvscanlvchange -a y /dev/rhel/homemknod /dev/rhel/home b 253 1xfs_repare /dev/rhel/homesystemd.unit=emergency.target 运行级别：1234567graphical.target # 相当于原来的level 5multi-user.target # 相当于原来的level 3rescue.target # 相当于原来的level 1。单用户模式，不启动服务。但不同的是，现在需要密码才能进入。powerof.target # 相当于原来的level 0reboot.target # 相当于原来的level 6emergency.target # 救援，文件系统故障rd.break 以前可以定义某些服务只在3级别自动启动，而5级别不启动 现在graphical.target 调用multi-user.target，所以没法这么做了。 123456systemctl get-default # 显示当前targetsystemctl isolate multi-user.targe # 相当于以前的init 3命令systemctl list-dependencies graphical.target | grep targetsystemctl list-units --type=targe --allsystemctl list-unit-files --type=targe --allsystemctl isolate multi-user.targe 12dd if=/dev/zero of=/dev/sda bs=446 count=1grub2-install /dev/sda grub2-mkpasswd-pbkdf2加密 samba客户端多用户12echo 'username=brain' &gt;/root/smb-multiuser.txtecho 'password=redhat' &gt;&gt;/root/smb-multiuser.txt 1234vim /etc/fstab//serverX/smbshare /mnt/multiuser cifs credentials=root/smb-multiuser.txt,multiuser,sec=ntlmssp 0mount /mnt/multiusersu -","tags":[{"name":"CentOS7","slug":"CentOS7","permalink":"https://opstrip.com/tags/CentOS7/"},{"name":"新特性","slug":"新特性","permalink":"https://opstrip.com/tags/新特性/"},{"name":"系统变更","slug":"系统变更","permalink":"https://opstrip.com/tags/系统变更/"}]},{"title":"使用Python发送邮件分享","date":"2016-12-02T11:39:02.000Z","path":"2016/12/02/sendmail-with-python2/","text":"分享一个使用Python发送邮件的脚本，Python版本2.7.5.代码如下：123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122#!/usr/bin/env python# -*- coding: utf-8 -*-# -*- coding: gbk -*-\"\"\"@Date: Tue Nov 8 14:43:58 2016@Author: Jeff &lt;370610810@qq.com&gt;@Link: @PythonVersion: v2.7.10@Filename: sendmail.py\"\"\"from email import encodersfrom email.header import Headerfrom email.mime.text import MIMETextfrom email.mime.image import MIMEImagefrom email.mime.multipart import MIMEMultipartfrom email.utils import parseaddr, formataddrimport smtplibimport os.pathimport codecsimport datetime,time def _format_addr(s): \"\"\"格式化邮件地址\"\"\" name, addr = parseaddr(s) return formataddr((Header(name, 'utf-8').encode(), addr)) class sendmail: \"\"\"使用Python以指定邮箱发送邮件\"\"\" mail_host = 'smtp.163.com' mail_from = 'lemoncn2014@163.com' mail_user = 'lemoncn2014' mail_passwd = 'jgyMJU&amp;,ki8' msg = MIMEMultipart() def __init__(self,mailContent,mailTo,getTitle,fileList): \"\"\"使用email函数库构造email内容\"\"\" # 对邮件内容、收件人、抄送人、标题、附件执行初始化 self.mail_content = mailContent self.mail_to = mailTo # 邮件抄送方：使用时可替换为真实的邮件地址 self.mail_cc = '*****@xxxxxx.com' self.get_title = getTitle self.file = fileList \"\"\"开始构造email ---构建带附件的邮件实例\"\"\" # 构建邮件头信息 sendmail.msg['From'] = _format_addr('&lt;%s&gt;' % sendmail.mail_from) sendmail.msg['To'] = _format_addr('&lt;%s&gt;' % self.mail_to) #sendmail.msg['To'] = ';'.join (self.mail_to) sendmail.msg['Cc'] = _format_addr('&lt;%s&gt;' % self.mail_cc) sendmail.msg['Subject'] = Header(self.get_title).encode('utf8') # sendmail.msg['Date'] = time.strftime('%a, %Y-%m-%d %H:%M:%S %z') # 构建邮件正文 sendmail.msg.attach(self.mail_content) # 如果附件列表不为空，则构建邮件附件 if self.file: print('Attachment(s) as follow：%s' % format(self.file)) #使用with安全地打开文件 with open(self.file, 'rb') as i: atta = MIMEText(i.read(), 'base64', 'utf8') atta[\"Content-Type\"] = 'application/octet-stream' atta[\"Content-Disposition\"] = 'attachment; filename=\"&#123;&#125;\"'.format(os.path.basename(self.file)) sendmail.msg.attach(atta) else: print('This message has no attachment.') with open(self.file, 'rb') as f: # 将图片附加到邮件正文 msgImage = MIMEImage(f.read()) # 定义图片 ID，在 HTML 文本中引用 msgImage.add_header('Content-ID', '&lt;image1&gt;') sendmail.msg.attach(msgImage) def send_mail(self): try: # 来源：http://www.oschina.net/code/snippet_2293291_55062 # ssl端口为465/994，非ssl协议的smtp端口是25 smtpObj = smtplib.SMTP_SSL(sendmail.mail_host, 994) # debug级别，1为开启；0关闭 smtpObj.set_debuglevel(1) smtpObj.login(sendmail.mail_user, sendmail.mail_passwd) smtpObj.sendmail(sendmail.mail_from, [self.mail_to,self.mail_cc], sendmail.msg.as_string()) print(time.strftime('%a, %Y-%m-%d %H:%M:%S %z'),'sendmail succeed.') except Exception as e: print(e) print(time.strftime('%a, %Y-%m-%d %H:%M:%S %z'),'sendmail failed.') finally: smtpObj.quit() def main(): # 指定邮件接收方，使用时请替换为真实的邮件地址。 mymail = 'ooxx@oooxxx.com' title = '[广告]有一个发财的机会正在向你招手，去看看吗？'.decode('utf8') # 指定邮件正文 # 定义邮件html格式正文 f = \"\"\" &lt;html&gt;&lt;title&gt;有一个发财的机会正在向你招手，去看看吗？&lt;/title&gt;&lt;body&gt; &lt;p&gt;由于这封邮件是通过程序自动发送的，它不能正常显示或是要是有什么问题，请及时 &lt;a href=\"mailto:shiyao.zh@gmail.com?subject=购买理财通发财变轻松的反馈&amp;cc=lemoncn2014@163.com\"&gt;反馈给××有钱&lt;/a&gt;， 非常感谢。&lt;/p&gt; &lt;p&gt;想做高富帅，请扫描下面的二维码并订阅；继续做穷逼，请&lt;a href=\"#\" onclick=\"alert('再见，穷逼！（作为有态度的媒体，我们不愿与穷逼说话。）')\"&gt;退订&lt;/a&gt;。&lt;/p&gt; &lt;center&gt;&lt;a href=\"http://opstrip.com/\" target=\"_blank\" alt=\"OPSTRIP.COM\"&gt;&lt;img src=\"cid:image1\" height=\"80px\" width=\"80px\" /&gt;&lt;/a&gt;&lt;/center&gt; &lt;p&gt;如需投诉，请直拨妖妖灵。&lt;/p&gt; &lt;p&gt;&lt;font size=\"-2\" color=\"gray\"&gt;以上段子纯属搞笑。&lt;/font&gt;&lt;/p&gt; &lt;hr&gt; &lt;p&gt;本段子由 &lt;a href=\"http://opstrip.com/\" target=\"_blank\"&gt;OPSTRIP&lt;/a&gt; 友情提供。不服你来点我呀！&lt;/p&gt; &lt;/body&gt;&lt;/html&gt; \"\"\" # 生成邮件正文 content = MIMEText(f,'html','utf-8') # 创建邮件附件 file = \"http://opstrip.com/assets/blogImg/qrcode.png\" # file = \"C:/Users/admin/Downloads/localhost.%s.log\" % ((datetime.datetime.now() - datetime.timedelta(days=1)).strftime(\"%Y-%m-%d\")) # 调用sendmail类发送邮件 sdm = sendmail(content,mymail,title,file) sdm.send_mail() if __name__ == '__main__': main()else: print(\"sendmail.py was imported!\") 注：本脚本使用的Python版本为2.7，仅作为测试用例使用。其他版本可能会有差异引起的不兼容问题；程序中的邮箱地址请替换为自己的真实邮箱地址。","tags":[{"name":"Python","slug":"Python","permalink":"https://opstrip.com/tags/Python/"},{"name":"sendmail","slug":"sendmail","permalink":"https://opstrip.com/tags/sendmail/"},{"name":"测试用例","slug":"测试用例","permalink":"https://opstrip.com/tags/测试用例/"},{"name":"福利","slug":"福利","permalink":"https://opstrip.com/tags/福利/"}]},{"title":"先秦穿越指南","date":"2016-11-30T14:19:39.000Z","path":"2016/11/30/Dynasty-PreQin-Crossing-Guide/","text":"某人穿越到先秦。「里边请，请问客官是打尖还是住店？」「打尖！来一碗西红柿鸡蛋面。」「那抱歉，客官，面条要到宋朝才能成形呢。而且西红柿是美洲货，清朝末年才传入中土。小店目前只有鸡蛋，要不您点一个？」 「什么鸟店！连碗面都没有，馒头包子总有吧？上一屉！」「这位爷，也没有。馒头包子得等到蜀汉诸葛丞相伐孟获才有，抱歉了您呢。」「擦！你们不会只供应白米饭吧？」「抱歉，咱是在关中，水稻原产亚热带，得翻过秦岭才能种，咱也没有。」「要死了！那就来个大侠套餐吧，二两女儿红，半斤熟牛肉……你捂我嘴干吗？」「客官，小点声！朝廷严禁私宰耕牛，被人告了可是充军流放的大罪，万万不敢啊！」「得得得，酒我也不喝了，茶水总有吧？」「茶？那玩意儿到汉朝才有，哪怕到唐朝也是士大夫喝的，咱也不可能有。」「干！那就不吃饭了，上点水果吧。大热天的，来半个西瓜。」「呃，西瓜是非洲特产，要到南宋汉人才有种植……」「没有西瓜，苹果总有吧？」「真抱歉，苹果十九世纪才从欧洲传入我国。客官，您别点水果了，我可以负责任地告诉您，像什么葡萄啦，芒果啦，石榴啦，草莓啦，菠萝啦……您现在都吃不到。」「你他娘的店里到底有什么？」「粟米的窝窝饼，您蘸肉酱吃，我还可以给您上一份烫白菜。」「敢情你开的是麻辣烫店啊？」「瞧您说的，辣椒到明代才引进呢，我想开麻辣烫也开不成啊！」「没有辣椒，用大蒜代替也行。」「真不好意思，大蒜的种子是西汉的张骞出使西域后带回来的。小店只有花椒，只麻不辣。」「那你们就不能炒个青菜？非要开水烫白菜？」「客官您有所不知，铁锅到宋朝后期才能生产，所以没法炒菜。况且炒菜要用菜油，菜油得等到明朝后期普遍种植油菜花以后才有。」「好吧，其实你们可以用花生油……」「花生可是美洲植物，哥伦布发现新大陆以后才开始传播。直到乾隆末年，花生都还十分罕见。」「顶你个肺啊！那就来份烫白菜吧，多加点香菜。」「嘿嘿，香菜原产地中海，张骞出使西域后……」「去你大爷的！我真恨不能一黄瓜拍死你！」「黄瓜？黄瓜原产印度，也是张骞出使西域带回来的。」「没有黄瓜，我就用茄子捅死你！」「嘻嘻，茄子来自东南亚，晋朝时传入我国的，隋炀帝就特别爱吃……不但爱吃它，还爱玩它。」「……」「客官您还要什么？」「……」「喂，客官……客官您别走啊！」 佚名《先秦穿越指南》","tags":[{"name":"穿越指南","slug":"穿越指南","permalink":"https://opstrip.com/tags/穿越指南/"},{"name":"西红柿","slug":"西红柿","permalink":"https://opstrip.com/tags/西红柿/"},{"name":"辣椒","slug":"辣椒","permalink":"https://opstrip.com/tags/辣椒/"},{"name":"花生油","slug":"花生油","permalink":"https://opstrip.com/tags/花生油/"}]},{"title":"一辆旧自行车","date":"2016-11-11T02:39:00.000Z","path":"2016/11/11/a-broken-bicycle/","text":"搬家以后因为地方较小离地铁又近于是为这辆闲置下来的旧自行车找个合适的去处就有点迫在眉睫了 自行车还是好几年前在浦东一条很偏僻的小巷子里买的当时上班的地方离住的地方有那么个几站地坐公车又不那么方便骑着自行车既便捷又健康————一合计，就买了它了 话说前几年的自行车的质量真是不错呀六七年的时间从小伙子到小胖子再到大胖子自行车也是陪我从一个地方再到另一个地方或饱经风吹日晒 或惨遭泥雨中骑行当然中间也免不了有些小小的修修补补：补胎、换车闸、换把手、换踏板、换胎、换车座……润滑油也是搽了一次又一次毫无疑问 它仍旧是当初那辆自行车虽未刻意保养 但使用起来毫无阻滞之感 依旧不减当年————真是一个可靠朴实的小伙伴 当我决定转让它的时候 我并未意识到这是一个多么糟糕的决定————因为它实在是太旧了于是拍照、写描述、注明地址、填上近乎白送的价格、敲上联系方式，最后发布接下来的两周内断断续续的有人看车更多的是看一眼然后摇摇头就走尽管我一再好心的提醒对方骑上去试试这车的性能两周以来，我不断的重复着这个过程但终归无济于事看来在这个快节奏的社会人们对一件事物的认知，其颜值还是远远大于其实际用途的 尽管后来总算有个收废品的愿意接收它当做废品处理时我已决定：“算了。这车，我不卖了！” 是的，这车，还是再骑两年吧，不卖了不卖了看着这辆陪我度过了六七年时光的小破车过去虽然一直没有怎么珍惜保养过但毕竟还是我最了解你呢 ————完————","tags":[{"name":"旧事","slug":"旧事","permalink":"https://opstrip.com/tags/旧事/"},{"name":"随笔","slug":"随笔","permalink":"https://opstrip.com/tags/随笔/"},{"name":"闲谈","slug":"闲谈","permalink":"https://opstrip.com/tags/闲谈/"}]},{"title":"创建页面","date":"2016-10-31T16:00:00.000Z","path":"2016/11/01/create-pages/","text":"本篇为 Hexo 框架部署 GitHub 博客的常见用法说明，更多用法详见 Hexo官方文档。使用中的其他问题可以在 troubleshooting 中找到答案，您也可以提交问题到 issues。 快速启动创建新的post页面1$ hexo new \"My New Post\" 更多用法详见: Writing 本地预览1$ hexo server 更多用法详见: Server 生成静态文件1$ hexo generate 更多用法详见: Generating 部署至远程网站1$ hexo deploy 更多用法详见: Deployment 创建分类页面添加一个分类页面，并在菜单中显示页面链接。 新建一个页面，命名为 categories 。命令如下： 1$ hexo new page categories 编辑刚新建的页面，将页面的类型设置为 categories ，主题将自动为这个页面显示所有分类。 1234title: 分类date: 2014-12-22 12:39:04layout: categories--- 注意：如果有启用多说或者Disqus评论，默认页面也会带有评论。需要关闭的话，请添加字段comments并将值设置为false。如：12345title: 分类date: 2014-12-22 12:39:04layout: categoriescomments: false--- 创建404公益页面添加一个404页面，在访问错误页面的时候就会展示这个公益页面。 新建一个页面，命名为404。命令如下： 1$ hexo new page 404 根据以上命令返回结果，找到刚刚创建的index.md，一般在/source/404/路径下，将以下内容替换掉index.md内容即可。 1234567title: Sorry, 404 Not Found #可自定义名称layout: pagetoc: false #目录功能关闭comments: false #评论关闭permalink: /404 #永久链接为404.html---&lt;script type=&quot;text/javascript&quot; src=&quot;http://www.qq.com/404/search_children.js&quot; charset=&quot;utf-8&quot; homepageurl=&quot;/&quot; homepagename=&quot;回到主页&quot;&gt;&lt;/script&gt; 创建标签页面添加一个标签页面，并在菜单中显示页面链接。 新建一个页面，命名为 tags 。命令如下： 1$ hexo new page tags 根据以上命令返回结果，找到刚刚创建的index.md，一般在/source/tags/路径下，将以下内容替换掉index.md内容。如： 12345title: 标签date: 2014-12-22 12:39:04layout: tagscomments: false--- 创建关于页面添加一个关于页面，并在菜单中显示页面链接。 新建一个页面，命名为 about 。命令如下： 1$ hexo new page about 根据以上命令返回结果，找到刚刚创建的index.md，一般在/source/about/路径下，将以下内容替换掉index.md内容。如： 12345title: 关于date: 2014-12-22 12:39:04layout: aboutcomments: false--- 完成后就可以在最下面添加一些有关网站的必要的说明。如：本站样例 最后在菜单中添加链接。打开主题的_config.yml，编辑menu中的如下内容，如下: 123456menu: home: / categories: /categories archives: /archives tags: /tags about: /about","tags":[{"name":"hexo","slug":"hexo","permalink":"https://opstrip.com/tags/hexo/"},{"name":"分类","slug":"分类","permalink":"https://opstrip.com/tags/分类/"},{"name":"GitHub","slug":"GitHub","permalink":"https://opstrip.com/tags/GitHub/"},{"name":"博客","slug":"博客","permalink":"https://opstrip.com/tags/博客/"}]}]